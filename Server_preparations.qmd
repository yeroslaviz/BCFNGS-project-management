---
title: "Server Preparations"
format: html
editor: visual
---

# Server Infrastructure

```{bash}

# Install Shiny Server on Ubuntu
sudo apt update
sudo apt install -y r-base nginx
sudo su - -c "R -e \"install.packages('shiny')\""
sudo su - -c "R -e \"install.packages('shinyjs')\""
# ... install all your R packages
sudo R -e "install.packages(c('shiny', 'shinyjs', 'DBI', 'RSQLite', 'digest', 'DT', 'shinyWidgets', 'mailR'))"

# Download and install Shiny Server
wget https://download3.rstudio.org/ubuntu-20.04/x86_64/shiny-server-1.5.23.1030-amd64.deb
sudo gdebi shiny-server-1.5.23.1030-amd64.deb

```

# removing the exisiting certifaicate

```{bash}

# Backup your current configuration
sudo cp /etc/apache2/sites-enabled/01-main.conf /etc/apache2/sites-enabled/01-main.conf.backup

# Remove old SSL certificates (optional - keep for backup)
sudo mkdir -p /etc/ssl/backup/
sudo mv /etc/ssl/certs/********.pem /etc/ssl/backup/
sudo mv /etc/ssl/private/********.pem /etc/ssl/backup/
sudo mv /etc/apache2/certificate/********.cer /etc/ssl/backup/

```

```
./
├── 01-main.conf -> ../sites-available/default-ssl.conf
├── 01-main.conf.backup
├── 02-testing.conf -> ../sites-available/02-testing.conf
└── auth_ldap.conf -> ../sites-available/auth_ldap.conf
```

# Installing Certbot for Let's encrypt

```{bash}

# Update package list
sudo apt update

# Install Certbot for Apache
sudo apt install -y certbot python3-certbot-apache

# Verify installation
certbot --version

```

```
certbot 2.9.0
```

# changing hostname to fit the apache2 config file

```{bash}

# Change the hostname
sudo hostnamectl set-hostname ngs-testing-vm.biochem.mpg.de

# Verify the change
hostnamectl status

```

```{bash}
nslookup ngs-testing-vm.biochem.mpg.de
ping ngs-testing-vm.biochem.mpg.de
```

```
Server:		127.0.0.53
Address:	127.0.0.53#53

Non-authoritative answer:
Name:	ngs-testing-vm.biochem.mpg.de
Address: 10.33.0.60

PING ngs-testing-vm.biochem.mpg.de (10.33.0.60) 56(84) bytes of data.
64 bytes from ngs-testing-vm.biochem.mpg.de (10.33.0.60): icmp_seq=1 ttl=64 time=0.079 ms
64 bytes from ngs-testing-vm.biochem.mpg.de (10.33.0.60): icmp_seq=2 ttl=64 time=0.074 ms

```

```{bash}

sudo systemctl restart apache2

```

# Automatic start-up

```{bash}

sudo systemctl enable apache2
sudo systemctl enable shiny-server

```

#  Monitoring


```{bash}

# Monitor Shiny Server logs
sudo tail -f /var/log/shiny-server/sequencing-app*.log

# Monitor Apache logs
sudo tail -f /var/log/apache2/sequencing-app-error.log

```


# Regular backups

This was not done yet. 

```{bash}

# Create backup script
sudo tee /usr/local/bin/backup_sequencing_db.sh <<'EOF'
#!/bin/bash
TIMESTAMP=$(date +%Y%m%d_%H%M%S)
BACKUP_DIR="/var/backups/sequencing-app"
mkdir -p $BACKUP_DIR
cp /srv/shiny-server/sequencing-app/sequencing_projects.db $BACKUP_DIR/sequencing_projects.db.$TIMESTAMP
# Keep only last 30 days of backups
find $BACKUP_DIR -name "sequencing_projects.db.*" -mtime +30 -delete
EOF

sudo chmod +x /usr/local/bin/backup_sequencing_db.sh

# Add to crontab for daily backups at 2 AM
sudo crontab -l | { cat; echo "0 2 * * * /usr/local/bin/backup_sequencing_db.sh"; } | sudo crontab -

```

# Create Clean Apache Configuration

```{bash}
<VirtualHost *:80>
    ServerName ngs-testing-vm
    ServerAlias ngs-testing-vm.biochem.mpg.de
    # Redirect all HTTP traffic to HTTPS
    Redirect permanent / https://ngs-testing-vm/
</VirtualHost>

<VirtualHost *:443>
    ServerName ngs-testing-vm
    ServerAlias ngs-testing-vm.biochem.mpg.de

    # SSL Configuration
    SSLEngine on
    SSLCertificateFile /etc/ssl/certs/ngs-testing-vm.crt
    SSLCertificateKeyFile /etc/ssl/private/ngs-testing-vm.key

    # Modern SSL configuration
    SSLProtocol all -SSLv3 -TLSv1 -TLSv1.1
    SSLCipherSuite ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384
    SSLHonorCipherOrder off

    # Reverse proxy for Shiny app
    ProxyPreserveHost On
    ProxyRequests Off
    ProxyPass / http://localhost:3838/sequencing-app/
    ProxyPassReverse / http://localhost:3838/sequencing-app/

    # WebSocket support
    RewriteEngine on
    RewriteCond %{HTTP:Upgrade} websocket [NC]
    RewriteCond %{HTTP:Connection} upgrade [NC]
    RewriteRule ^/(.*) "ws://localhost:3838/sequencing-app/$1" [P,L]

    # Security headers
    Header always set Strict-Transport-Security "max-age=63072000; includeSubDomains"
    Header always set X-Content-Type-Options nosniff
    Header always set X-Frame-Options SAMEORIGIN
    Header always set Referrer-Policy "strict-origin-when-cross-origin"

    ErrorLog ${APACHE_LOG_DIR}/sequencing-app-ssl-error.log
    CustomLog ${APACHE_LOG_DIR}/sequencing-app-ssl-access.log combined
</VirtualHost>
```


# Required Server Setup

/var/shiny-server/ 
├── sequencing-app/ 
│ ├── app.R 
│ ├── setup_database.R 
│ ├── sequencing_projects.db 
│ └── www/ 
  │ ├── logo.png 
  │ └── minerva.png

# Creates a Deployment Script

```{bash}

#| label: deploy.sh
#| 
#!/bin/bash

# Stop existing app
sudo systemctl stop shiny-server

# Backup current version
TIMESTAMP=$(date +%Y%m%d_%H%M%S)
sudo cp -r /var/shiny-server/sequencing-app /var/shiny-server/sequencing-app_backup_$TIMESTAMP

# Deploy new version
sudo cp -r /home/yeroslaviz/BCFNGS-project-management/sequencing-app /var/shiny-server/

# Set permissions
sudo chown -R shiny:shiny /var/shiny-server/sequencing-app
sudo chmod -R 755 /var/shiny-server/sequencing-app

# Initialize database (if first deployment)
sudo su - -c "R -e \"source('/var/shiny-server/sequencing-app/setup_database.R')\""

# Restart Shiny Server
sudo systemctl start shiny-server
sudo systemctl status shiny-server

```

# Github repository

In the home folder /home/yeroslaviz/ the github repository is stored. 

```
$ tree -L 1
.
├── BCFNGS-project-management
├── chemata
├── miniconda3
└── scripts
    └── deploy_shiny_server.sh
```

inside the Folder we can pull/push the changes we made to the repo from the local computer (AT WORK!!!).

the github repository on the local computer is at `/Documents/GitHub/BCFNGS-project-management`. 

To redeploy the server, one follows the following steps:

1. make the changes on the local computer (AT WORK!!!).
2. push the changes to the github repo
3. go to the folder `/home/yeroslaviz/BCFNGS-project-management` on the VM `ngs-testing-vm` and pull the changes. 
4. Execute the `deploy_shiny_server.sh` script to copy the new changes to the shiny-server folder and restart both apache2 and the shiny-server. 

# Setting Environment variables

```{bash}

# /var/shiny-server/.Renviron
TZ=Europe/Berlin
LANG=en_US.UTF-8
LC_ALL=en_US.UTF-8

```

# Install required system dependencies

```{bash}

sudo apt install -y libssl-dev libxml2-dev libcurl4-openssl-dev libudunits2-dev libgdal-dev

```

# Modify script for data base creation (setup_database.R -\> version 6 was modified here for production environment; app.R -\> version 6 was modified for interactive mode)

# Security

Not sure, if this is all necessary, will consult the IT when it is appropriate

## dedicated User

As we're planning to use the LDAP, I'm not sure, this is necessary.
I need a method to add specific users as admin

## Firewall

at the moment is not active, but maybe in the future.

```{bash}

sudo ufw allow 3838
sudo ufw allow 80
sudo ufw allow 443

```


# SSL Certificate (for HTTPS)

a certificate was applied for and is currently in the work. 

# LDAP


