---
title: "Server Preparations"
format: html
editor: visual
execute: 
  eval: false
---

```{r}
#| echo: false
#| eval: true

suppressPackageStartupMessages(
  {
  library(DBI)
  library(RSQLite)
  library(digest)
  library(shiny)
  library(shinyjs)
  library(DBI)
  library(RSQLite)
  library(digest)
  library(DT)
  library(shinyWidgets)
  library(mailR)
  library(ldapr)
})
```

# Server Infrastructure

```{bash}

# Install Shiny Server on Ubuntu
sudo apt update
sudo apt install -y r-base nginx
sudo apt install -y libfontconfig1-dev libfreetype6-dev libpng-dev libtiff5-dev \
    libjpeg-dev build-essential pkg-config libharfbuzz-dev libfribidi-dev
sudo apt install -y libldap2-dev libsasl2-dev

sudo su - -c "R -e \"install.packages('shiny')\""
sudo su - -c "R -e \"install.packages('shinyjs')\""
# ... install all your R packages
sudo R -e "install.packages(c('shiny', 'shinyjs', 'DBI', 'RSQLite', 'digest', 'DT', 'shinyWidgets', 'mailR'))"
# these two packages were added later on for the connection of the app to the LDAP server
sudo R -e "install.packages(c('devtools'))"
sudo R -e "devtools::install_github('liamgilbey/ldapr')"

# Download and install Shiny Server
wget https://download3.rstudio.org/ubuntu-20.04/x86_64/shiny-server-1.5.23.1030-amd64.deb
sudo gdebi shiny-server-1.5.23.1030-amd64.deb

```



## changing hostname to fit the apache2 config file

```{bash}

# Change the hostname
sudo hostnamectl set-hostname ngs-testing-vm.biochem.mpg.de

# Verify the change
hostnamectl status

```

```{bash}
nslookup ngs-testing-vm.biochem.mpg.de
ping ngs-testing-vm.biochem.mpg.de
```

```
Server:		127.0.0.53
Address:	127.0.0.53#53

Non-authoritative answer:
Name:	ngs-testing-vm.biochem.mpg.de
Address: 10.33.0.60

PING ngs-testing-vm.biochem.mpg.de (10.33.0.60) 56(84) bytes of data.
64 bytes from ngs-testing-vm.biochem.mpg.de (10.33.0.60): icmp_seq=1 ttl=64 time=0.079 ms
64 bytes from ngs-testing-vm.biochem.mpg.de (10.33.0.60): icmp_seq=2 ttl=64 time=0.074 ms

```

```{bash}

sudo systemctl restart apache2

```

## Automatic start-up

```{bash}

sudo systemctl enable apache2
sudo systemctl enable shiny-server

```

#  Monitoring

The shiny app server writes log files specific with date and time in the `/var/log/shiny-server` folder.


```{bash}

# Monitor Shiny Server logs
sudo tail -f /var/log/shiny-server/sequencing-app*.log

# Monitor Apache logs
sudo tail -f /var/log/apache2/sequencing-app-error.log

```

# Regular backups

The VM is regularly back-up every night. The SQL database backup setting are in the script, but for now commented out, as we're not in productive version.


## cron job for data base backup

If needed, we can also set up a cron job to backup the data base 

```{bash}

# Create backup script
sudo tee /usr/local/bin/backup_sequencing_db.sh <<'EOF'
#!/bin/bash
TIMESTAMP=$(date +%Y%m%d_%H%M%S)
BACKUP_DIR="/var/backups/sequencing-app"
mkdir -p $BACKUP_DIR
cp /srv/shiny-server/sequencing-app/sequencing_projects.db $BACKUP_DIR/sequencing_projects.db.$TIMESTAMP
# Keep only last 30 days of backups
find $BACKUP_DIR -name "sequencing_projects.db.*" -mtime +30 -delete
EOF

sudo chmod +x /usr/local/bin/backup_sequencing_db.sh

# Add to crontab for daily backups at 2 AM
sudo crontab -l | { cat; echo "0 2 * * * /usr/local/bin/backup_sequencing_db.sh"; } | sudo crontab -

```

# Create Clean Apache Configuration

```{bash}
<VirtualHost *:80>
    ServerName ngs-testing-vm
    ServerAlias ngs-testing-vm.biochem.mpg.de
    # Redirect all HTTP traffic to HTTPS
    Redirect permanent / https://ngs-testing-vm/
</VirtualHost>

<VirtualHost *:443>
    ServerName ngs-testing-vm
    ServerAlias ngs-testing-vm.biochem.mpg.de

    # SSL Configuration
    SSLEngine on
    SSLCertificateFile /etc/ssl/certs/2026_NGS_Cert.pem
    SSLCertificateKeyFile /etc/ssl/private/2026_private-key.pem
    SSLCertificateChainFile /etc/apache2/certificate/2026/NGS_2026_Issuer_ChainFile.cer

    # Modern SSL configuration
    SSLProtocol all -SSLv3 -TLSv1 -TLSv1.1
    SSLCipherSuite ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384
    SSLHonorCipherOrder off

    # Reverse proxy for Shiny app
    ProxyPreserveHost On
    ProxyRequests Off
    ProxyPass / http://localhost:3838/sequencing-app/
    ProxyPassReverse / http://localhost:3838/sequencing-app/

    # WebSocket support
    RewriteEngine on
    RewriteCond %{HTTP:Upgrade} websocket [NC]
    RewriteCond %{HTTP:Connection} upgrade [NC]
    RewriteRule ^/(.*) "ws://localhost:3838/sequencing-app/$1" [P,L]

    # Security headers
    Header always set Strict-Transport-Security "max-age=63072000; includeSubDomains"
    Header always set X-Content-Type-Options nosniff
    Header always set X-Frame-Options SAMEORIGIN
    Header always set Referrer-Policy "strict-origin-when-cross-origin"

    ErrorLog ${APACHE_LOG_DIR}/sequencing-app-ssl-error.log
    CustomLog ${APACHE_LOG_DIR}/sequencing-app-ssl-access.log combined
</VirtualHost>
```


# Required Server Setup

```
/var/shiny-server/ 
├── sequencing-app/ 
│ ├── app.R 
│ ├── setup_database.R 
│ ├── sequencing_projects.db 
│ └── www/ 
  │ ├── logo.png 
  │ └── minerva.png
```

# Github repository

## create Key gen for github connection

```{bash}

ssh-keygen -t ed25519 -f ngs-testing-vm.id_rsa -C "yeroslaviz@biochem.mpg.de"
### 1qazXSW@3edc
eval "$(ssh-agent -s)"
ssh-add ~/.ssh/ngs-testing-vm.id_rsa

cat ~/.ssh/ngs-testing-vm.id_rsa.pub # copy this to the github repo
PAT - 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
```


## Add the key to GitHub
-Go to GitHub.com
- Click your profile picture → Settings
- Go to SSH and GPG keys
- Click New SSH key
- Paste the public key you copied
- Give it a name like "VM access"
- In the home folder /home/yeroslaviz/ the github repository is stored. 


## check the connection 

```{bash}
ssh -T git@github.com
```

```
$ tree -L 1
.
├── BCFNGS-project-management
├── chemata
├── miniconda3
└── scripts
    └── deploy_shiny_server.sh
```

inside the Folder we can pull/push the changes we made to the repo from the local computer (AT WORK!!!).

the github repository on the local computer is at `/Documents/GitHub/BCFNGS-project-management`. 

To redeploy the server, one follows the following steps:

1. make the changes on the local computer (AT WORK!!!).
2. **commit** and **push** the changes to the github repo
3. go to the folder `/home/yeroslaviz/BCFNGS-project-management` on the VM `ngs-testing-vm` and pull the changes. 
4. Execute the `deploy_shiny_server.sh` script to copy the new changes to the shiny-server folder and restart both apache2 and the shiny-server. 
## git pull 

```{bash}
 git pull origin main
# Username for 'https://github.com': yeroslaviz
# Password for 'https://yeroslaviz@github.com':  HERE WE MUST INPUT THE PAT from above!!!
 ...
```



# Setting Environment variables

```{bash}

# /var/shiny-server/.Renviron
TZ=Europe/Berlin
LANG=en_US.UTF-8
LC_ALL=en_US.UTF-8

```

# Install required system dependencies

```{bash}

sudo apt install -y libssl-dev libxml2-dev libcurl4-openssl-dev libudunits2-dev libgdal-dev

```


# Security

Not sure, if this is all necessary, will consult the IT when it is appropriate

## dedicated User

As we're planning to use the LDAP, I'm not sure, this is necessary.
I need a method to add specific users as admin

## Firewall

at the moment is not active, but maybe in the future.

```{bash}

sudo ufw allow 3838
sudo ufw allow 80
sudo ufw allow 443

```

## SSL Certificate (for HTTPS)

the new setting of the certificates. I have three files.

The private key I created when applying for the certificate. The other two were downloaded, when the emial came
from Harica (the certificate provider).

the `PEM`  is the pem file and the `DER (issuer)` is the chain file. Both of them are needed.

Setting for the readability of the files:

```
cd /etc/apache2/certificate/2026
-rw------- 1 yeroslaviz b_mcf 3272 Nov 10 15:58 private-key.pem # udo chmod 600 /path/to/private.key  # Readable only by root
-rw-r--r-- 1 yeroslaviz b_mcf 1545 Nov 14 12:12 NGS_2026_Issuer_ChainFile.cer # sudo chmod 644 /path/to/chain.crt  # Readable by all
-rw-r--r-- 1 yeroslaviz b_mcf 2796 Nov 14 12:34 NGS_2026_Cert.pem # sudo chmod 644 /path/to/certificate.crt # Readable by all
```

All the files are saved under `/etc/apache2/certificate/2026`.

Now I created soft links for each of these files.

```{bash}
sudo ln -s /etc/apache2/certificate/2026/private-key.pem /etc/ssl/private/2026_private-key.pem
sudo ln -s /etc/apache2/certificate/2026/NGS_2026_Cert.pem /etc/ssl/certs/2026_NGS_Cert.pem

```

# Change connection to shiny server folder to https

The shiny app takes information from the config file under `/etc/shiny-server/shiny-server.conf`. Here we can see where the log files are written into and where the directory of the shiny app are stored. 

As the folder connected to the github repository is in my home directory `/home/yeroslaviz/BCFNGS-project-management`, I need to create a softlink to the folder used by the app, so that it dsoesn't need to be copy-pasted each time.

```{bash}
sudo usermod -a -G shiny $USER # add user yeroslaviz to group shiny
sudo chown -R $USER:shiny sequencing-app/ # make group shiny able to execute the scripts in the folder
sudo mv /srv/shiny-server/sequencing-app/ /srv/shiny-server/sequencing-app.backup # move the actual hard-coded folder to a backup (just in case)
```

The sequencing-app folder must be copied to the correct place after each modification was done and the new files were pulled to the VM. 

For that I have created a script called `deploy.sh`. The script copy the files from the github repo folder `/home/yeroslaviz/BCFNGS-project-management/sequencing-app/*` to were the shiny app needs them to be - `/srv/shiny-server/sequencing-app/`

The deploy script must be activated when loded

```{bash}
chmod +x deploy.sh
```


# Changes on 14.11.2026

1. I would Like you to show me where the admin email address can be changed, if I want to have a different user as admin.
1.1 Please show me the parts of the script where this can be changed. 

The admin apssword is set here:

```{bash}
# Insert default admin user
default_password <- digest::digest("admin123")
dbExecute(con, "
  INSERT OR IGNORE INTO users (username, password, email, is_admin) 
  VALUES ('admin', ?, 'yeroslaviz@biochem.mpg.de', 1)
", params = list(default_password))
```

1.2 Can this be changed without recreating the whole databank or restart the app?
1.3 How do I change the admin email address without recreating the db?

This can be changed without recreating the database, using two options:

* Option 1: Direct database update

Run this SQL command on your database:

```{sql}

UPDATE users SET email = 'newadmin@institute.org' WHERE username = 'admin';

```

To execute this, we can either log in directly to the database via the command line 

```{bash}
sqlite3 sequencing_projects.db
```
and execute

```{bash}
UPDATE users SET email = 'newadmin@institute.org' WHERE username = 'admin';
.exit
```

or via the R pormpt:

```{r}
library(DBI)
library(RSQLite)
con <- dbConnect(RSQLite::SQLite(), "sequencing_projects.db")
dbExecute(con, "UPDATE users SET email = 'newadmin@institute.org' WHERE username = 'admin'")
dbDisconnect(con)
```

**Don't forget to modify the `setup_database_*.R` script afterwards, so these information will be also kept, if the database is recreated!**

* Option 2: Through the app's user management (as admin)

In the  "Administer Projects" tab, one can click "Manage Users" and change (or add) the admin user and edit their email.

1.4 How can I turn on/off sending the notification mail to the admin, if not needed?

The admin notification email is sent in the `send_project_creation_email` function in the app file. 


2. When creating a new project, an email is being sent.
2.1 can you please tell me to whome this email is being sent?
2.2 Can you show me the part of the script where it is set up?
2.3 Now, the Email should be sent to budget holder and to user, who created the project, as well as to the admin. Can this be changed easily, if needed?

This was done also in point 1. The function `send_project_creation_email` set the users who gets an email, when a project is created. 
the row 

```
        to = c(budget_holder$email, user_email, admin_emails),
```

set the recipient of the mail. we can remove one of the elements, or even just add a specific mail address to the `to =` row. 


3. How do I make changes to the cost estimations w.o. Recreating the db?
3.1 Is it possible to modify existing columns, in case prices are changing? Or would deleting and making a new element would be easier?
3.2 If I change anything in these tables, Would it also change it in the SQL data base?

At the moment the tables `Service types` and ` Sequencing depths` are not editable. If prices change, the easiet option is to delete the row and recreate it using the new value. This way, the older projects will use the previous costs, while the new one will get the new costs. 

One can also directly use the SQL commands to apply these chages, similar to above

```{bash}
sqlite3 sequencing_projects.db
```
and execute

```{bash}
UPDATE service_types SET costs_per_sample = 55 WHERE service_type = 'single cell/low mRNAseq';
.exit
```


4. something is wrong with the Sequencing Cycles Management table. When I run the app, go to the Admin projects Tab and click the Sequencing Cycles - Manage Cycles, I see this message: 
"Error: An error has occurred. Check your logs or contact the app author for clarification."
4.1 which log files can I consult?

When working on the server, the best place to look for problems are the log files of either the `apache2` (`/var/log/apache2/`) or the `shiny-server` (`/var/log/shiny-server/`).


5. Do I have a weekly backup of the SQL db? 

there is an app for a bi-weekly automaic backup. The function is for now commented out, so not working. 

## modify registration page


```{bash}
sqlite3 sequencing_projects.db
```

we add information to the registration page, so the user must choose a group. This way we know which is the budget holder for this user.

After ward we added the information to the Registration Server Logic

```{bash}
dbExecute(con, "
INSERT INTO users (username, password, email, phone, research_group, is_admin)
VALUES (?, ?, ?, ?, ?, 0)
", params = list(
  input$reg_username,
  digest(input$reg_password),
  input$reg_email,
  input$reg_phone,
  input$reg_group
))
```

as well as modified the User registration modal


Now,  when a user register, he must choose a group from the given drop-down menu. this group is attached to the budget holder. When the user creates a new project, this budget holder (group) will automatically be assigned to the project (This can be manually changed, when the project is created).


I have changed the `setup_databases.R` script to load the budget holders information from a csv file, stored in the same folder as the script itself. 

We have a csv-formatted table with the information of the groups and their cost centers. This is an easy way to upload the information.

```
name,surname,email,cost_center
Kim,Rin-Ho,rkim@biochem.mpg.de,N.A.
Administrator,surname,rkim@biochem.mpg.de,N.A.
Baier,Herwig,herwig.baier@bi.mpg.de,P350
Baldwin,Maude,Maude.Baldwin@bi.mpg.de,P550
```

The registration process was change to make choosing a research group mandatory. The chosen research group is then set to also assign the cost center to the user. 

::: {.callout-note}
Some of the research groups have multiple cost centers. 

When a user registers, he must select a research group. The user then gets assigned a cost center based on the table of budget holders. If (and this applies only for some of the budget holders), this specific research group has multiple cost centers, it gets assigned the first one found by the app. BUT, manually the user still can change this in the app when applying for a project.
 
:::


## control for budegt holder info in the DB

```{r}
#| eval: true
con <- dbConnect(RSQLite::SQLite(), "sequencing_projects.db")
budget_holders <- dbGetQuery(con, "SELECT * FROM budget_holders")
# Print the data
print(budget_holders[1:3,])
dbGetQuery(con, "SELECT * FROM budget_holders")
dbGetQuery(con, "SELECT * FROM users")
on.exit(dbDisconnect(con))
```

## Budget holders can be read from an Excel sheet


# SSL Certificate (for HTTPS)

## Backup older settings

```{bash}

# Backup your current configuration
sudo cp /etc/apache2/sites-enabled/01-main.conf /etc/apache2/sites-enabled/01-main.conf.backup

# Remove old SSL certificates (optional - keep for backup)
sudo mkdir -p /etc/ssl/backup/
sudo mv /etc/ssl/certs/********.pem /etc/ssl/backup/
sudo mv /etc/ssl/private/********.pem /etc/ssl/backup/
sudo mv /etc/apache2/certificate/********.cer /etc/ssl/backup/

```

```
./
├── 01-main.conf -> ../sites-available/default-ssl.conf
├── 01-main.conf.backup
├── 02-testing.conf -> ../sites-available/02-testing.conf
└── auth_ldap.conf -> ../sites-available/auth_ldap.conf
```

## Applying for a new certificate from MPI/MPG

The new setting of the certificates. I have three files.

The private key I created when applying for the certificate. The other two were downloaded, when the emial came
from Harica (the certificate provider).

the `PEM`  is the pem file and the `DER (issuer)` is the chain file. Both of them are needed.

Setting for the readability of the files:
```
cd /etc/apache2/certificate/2026
-rw------- 1 yeroslaviz b_mcf 3272 Nov 10 15:58 private-key.pem # udo chmod 600 /path/to/private.key  # Readable only by root
-rw-r--r-- 1 yeroslaviz b_mcf 1545 Nov 14 12:12 NGS_2026_Issuer_ChainFile.cer # sudo chmod 644 /path/to/chain.crt  # Readable by all
-rw-r--r-- 1 yeroslaviz b_mcf 2796 Nov 14 12:34 NGS_2026_Cert.pem # sudo chmod 644 /path/to/certificate.crt # Readable by all
```

All the files are saved under `/etc/apache2/certificate/2026`.

Now I created soft links for each of these files.

```{bash}
sudo ln -s /etc/apache2/certificate/2026/private-key.pem /etc/ssl/private/2026_private-key.pem
sudo ln -s /etc/apache2/certificate/2026/NGS_2026_Cert.pem /etc/ssl/certs/2026_NGS_Cert.pem

```


# LDAP

To be followed!!! 
