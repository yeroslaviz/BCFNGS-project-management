---
title: "Server Preparations"
execute:
  eval: false
  echo: true
  warning: false
engine: knitr
author:
  - name: Assa Yeroslaviz
    orcid: 0000-0001-9638-4026
    corresponding: true
    email: yeroslaviz@biochem.mpg.de
    roles:
      - Investigation
      - Visualization
    affiliations:
      - Max-Planck-Institute for Biochemistry
keywords:
  - RNA-Seq
  - transcriptomics
  - P405
  - Marion
  - Peter
  - AG Murray
abstract: |
   t.b.d.
plain-language-summary: |
  s.a.
date: "Last compiled on `r format(Sys.time(), '%d %B, %Y')`"
number-sections: true
format:
  html:
    code-fold: true
    toc: true
    toc-depth: 4
    toc-expand: false
    number-sections: true
    number-depth: 4
qknitr:
  opts_chunk:
    comment: "#>"
    collapse: true
bibliography: /Users/yeroslaviz/ownCloud/ownCloud_projects/citations.bib
editor_options:
  chunk_output_type: inline
---

## Quick Start (How to run the app)

### Local dev — local mode

```r
Sys.setenv(APP_ENV = "dev", AUTH_MODE = "local")
shiny::runApp("sequencing-app")
```

### Local dev — LDAP simulation

```r
Sys.setenv(
  APP_ENV = "dev",
  AUTH_MODE = "ldap",
  DEV_REMOTE_USER = "your_username",
  LDAP_URI = "ldaps://ldapserv1.biochem.mpg.de:636,ldaps://ldapserv2.biochem.mpg.de:636,ldaps://ldapserv3.biochem.mpg.de:636",
  LDAP_BASE_DN = "dc=biochem,dc=mpg,dc=de"
)
shiny::runApp("sequencing-app")
```

### Local dev — unset

```r
Sys.unsetenv(c(
  "APP_ENV","AUTH_MODE","DEV_REMOTE_USER",
  "LDAP_BIND_DN","LDAP_BIND_PW",
  "LDAP_URI","LDAP_BASE_DN","LDAP_DEBUG"
))
```

### VM — LDAP mode (production)

```bash
sudo systemctl edit shiny-server
```

```ini
[Service]
Environment=AUTH_MODE=ldap
Environment=LDAP_URI=ldaps://ldapserv1.biochem.mpg.de:636,ldaps://ldapserv2.biochem.mpg.de:636,ldaps://ldapserv3.biochem.mpg.de:636
Environment=LDAP_BASE_DN=dc=biochem,dc=mpg,dc=de
```

```bash
sudo systemctl restart shiny-server
```

### VM — local mode (maintenance)

```ini
[Service]
Environment=AUTH_MODE=local
```

```bash
sudo systemctl restart shiny-server
```

### VM — unset (clear overrides)

```bash
sudo systemctl edit shiny-server
# remove AUTH_MODE/LDAP_* lines, save, then:
sudo systemctl restart shiny-server
```


```{r}
#| echo: false
#| eval: true

suppressPackageStartupMessages(
  {
  library(DBI)
  library(RSQLite)
  library(digest)
  library(shiny)
  library(shinyjs)
  library(DBI)
  library(RSQLite)
  library(digest)
  library(DT)
  library(shinyWidgets)
  library(mailR)
  library(ldapr)
})
```

# Server Infrastructure


## When and why to rebuild the database

You only need to rebuild the entire SQLite DB when the **schema** changes (for example: removing a status option from a `CHECK` constraint, adding/removing columns, or changing table constraints). If the app logic changes but the DB structure is the same, a rebuild is **not** required.

**When a full rebuild makes sense**

- The DB is still a test instance and you can afford to reset data.
- You changed `setup_database.R` and want a clean, consistent schema.
- You want to permanently remove a legacy status or constraint.

**When not to rebuild**

- You already have real production data.
- You only changed app logic or UI (no schema change).

**Rebuild procedure (VM)**

```bash
sudo systemctl stop shiny-server

# Backup first
cp /srv/shiny-server/sequencing-app/sequencing_projects.db   /srv/shiny-server/sequencing_projects.db.backup_$(date +%Y%m%d_%H%M)

# Remove DB
rm /srv/shiny-server/sequencing-app/sequencing_projects.db

# Recreate DB from schema
cd /home/yeroslaviz/BCFNGS-project-management/sequencing-app
sudo -u shiny Rscript setup_database.R

sudo systemctl start shiny-server
```

**Add admin users to an existing DB (no rebuild)**

```bash
sudo -u shiny sqlite3 /srv/shiny-server/sequencing-app/sequencing_projects.db \
"INSERT OR IGNORE INTO users (username, password, email, is_admin, research_group) VALUES
 ('yeroslaviz','ldap-only','yeroslaviz@biochem.mpg.de',1,'Cox'),
 ('rkim','ldap-only','rkim@biochem.mpg.de',1,'NGS Facility'),
 ('casper','ldap-only','casper@biochem.mpg.de',1,'NGS Facility'),
 ('gautsch','ldap-only','gautsch@biochem.mpg.de',1,'NGS Facility');"
```
## Install required system dependencies

```{bash}

sudo apt install -y libssl-dev libxml2-dev libcurl4-openssl-dev libudunits2-dev libgdal-dev

```

## Changing hostname to fit the apache2 config file

```{bash}

# Change the hostname
sudo hostnamectl set-hostname ngs-testing-vm.biochem.mpg.de

# Verify the change
hostnamectl status

```

```{bash}
nslookup ngs-testing-vm.biochem.mpg.de
ping ngs-testing-vm.biochem.mpg.de
```

```
Server:     127.0.0.53
Address:    127.0.0.53#53

Non-authoritative answer:
Name:   ngs-testing-vm.biochem.mpg.de
Address: 10.33.0.60

PING ngs-testing-vm.biochem.mpg.de (10.33.0.60) 56(84) bytes of data.
64 bytes from ngs-testing-vm.biochem.mpg.de (10.33.0.60): icmp_seq=1 ttl=64 time=0.079 ms
64 bytes from ngs-testing-vm.biochem.mpg.de (10.33.0.60): icmp_seq=2 ttl=64 time=0.074 ms
```

```{bash}

sudo systemctl restart apache2

```

## Automatic start-up

```{bash}

sudo systemctl enable apache2
sudo systemctl enable shiny-server

```

# Monitoring

The shiny app server writes log files specific with date and time in the `/var/log/shiny-server` folder.

```{bash}

# Monitor Shiny Server logs
sudo tail -f /var/log/shiny-server/sequencing-app*.log

# Monitor Apache logs
sudo tail -f /var/log/apache2/sequencing-app-error.log

```

# Regular backups

The VM is regularly back-up every night. The SQL database backup setting are in the script, but for now commented out, as we're not in productive version.

## cron job for data base backup

If needed, we can also set up a cron job to backup the data base

```{bash}

# Create backup script
sudo tee /usr/local/bin/backup_sequencing_db.sh <<'EOF'
#!/bin/bash
TIMESTAMP=$(date +%Y%m%d_%H%M%S)
BACKUP_DIR="/var/backups/sequencing-app"
mkdir -p $BACKUP_DIR
cp /srv/shiny-server/sequencing-app/sequencing_projects.db $BACKUP_DIR/sequencing_projects.db.$TIMESTAMP
# Keep only last 30 days of backups
find $BACKUP_DIR -name "sequencing_projects.db.*" -mtime +30 -delete
EOF

sudo chmod +x /usr/local/bin/backup_sequencing_db.sh

# Add to crontab for daily backups at 2 AM
sudo crontab -l | { cat; echo "0 2 * * * /usr/local/bin/backup_sequencing_db.sh"; } | sudo crontab -

```

# Required Server Setup

```
/srv/shiny-server/
├── sequencing-app/
│ ├── app.R
│ ├── setup_database.R
│ ├── sequencing_projects.db
│ └── www/
  │ ├── logo.png
  │ └── minerva.png
```

# Github repository

## Step 1: Generate SSH keys

```{bash}

# on the local machine (mac mini at work!!!)
cd ~/.ssh/
ssh-keygen -t ed25519 -C "yeroslaviz@biochem.mpg.de" -f ngs-testing-vm.id_macMini_rsa

# on the VM
cd ~/.ssh/
ssh-keygen -t ed25519 -C "yeroslaviz@biochem.mpg.de" -f ngs-testing-vm.id_rsa
```

If agent needs to be activated

```{bash}
eval "$(ssh-agent -s)"
ssh-add ~/.ssh/ngs-testing-vm.id_rsa # or the name of the local key
```

## Add both keys to the github repository

Copy for each of the two keys the `*pub` version and add it under `Settings → SSH and GPG keys → New SSH key`.

## Make sure we clone using ssh (not html)

First test if the connection exists already.

```{bash}
git remote -v
```

If the result is

```
origin  https://github.com/username/repository.git (fetch)
origin  https://github.com/username/repository.git (push)
```

it must be changed to ssh

```{bash}
git remote set-url origin git@github.com:username/repository.git
```

If we see

```
origin  git@github.com:yeroslaviz/BCFNGS-project-management.git (fetch)
origin  git@github.com:yeroslaviz/BCFNGS-project-management.git (push)
```

then we already use ssh.

## Test and check the connection

```{bash}
ssh -T git@github.com
```

this should return something like

```
Hi yeroslaviz! You've successfully authenticated, but GitHub does not provide shell access.
```

## Pulling/Pushing

the repository can be managed from the path `/home/yeroslaviz/BCFNGS-project-management` (the VM path is mentioned here).

inside the Folder we can pull/push the changes we made to the repo from the local computer (AT WORK!!!).

the github repository on the local computer is at `/Users/yeroslaviz/Documents/Github/BCFNGS-project-management`.

To redeploy the server, one follows the following steps:

1.  make the changes on the local computer (AT WORK!!!).
2.  **commit** and **push** the changes to the github repo
3.  go to the folder `/home/yeroslaviz/BCFNGS-project-management` on the VM `ngs-testing-vm` and pull the changes.
4.  Execute the `deploy.sh` script to copy the new changes to the shiny-server folder and restart both apache2 and the shiny-server.

## Production rollout checklist (quick reference)

This is the short checklist I use on production. Details for each step are below in the VM rollout HOW‑TO section.

1.  Confirm GitHub access and pull latest code.

```{bash}
ssh -T git@github.com
cd /home/yeroslaviz/BCFNGS-project-management
git pull origin main
```

2.  Take backups (app folder, SQLite DB, Apache config).

```{bash}
sudo rsync -av /srv/shiny-server/sequencing-app/ /srv/shiny-server/sequencing-app.backup_$(date +%Y%m%d_%H%M)/
cp /srv/shiny-server/sequencing-app/sequencing_projects.db \
  /srv/shiny-server/sequencing_projects.db.backup_$(date +%Y%m%d_%H%M)
sudo cp /etc/apache2/sites-enabled/01-main.conf \
  /etc/apache2/sites-enabled/01-main.conf.backup_$(date +%Y%m%d_%H%M)
```

3.  Deploy.

```{bash}
./deploy.sh
```

4.  Restart services.

```{bash}
sudo systemctl restart shiny-server
sudo systemctl restart apache2
```

5.  Smoke‑test login and app behavior.

```{bash}
curl -Ik https://ngs-testing-vm.biochem.mpg.de/
curl -Ik -u USER https://ngs-testing-vm.biochem.mpg.de/
curl -Ik -u USER https://ngs-testing-vm.biochem.mpg.de/sequencing-app/
```

6.  Roll back from backups if needed.

```{bash}
sudo rsync -av --delete /srv/shiny-server/sequencing-app.backup_YYYYMMDD_HHMM/ /srv/shiny-server/sequencing-app/
sudo systemctl restart shiny-server
sudo systemctl restart apache2
```

## VM rollout HOW‑TO (Git + deploy + safety)

This is the repeatable checklist I use when rolling out to a VM (first `ngs-testing-vm`, then `ngs-vm`).

### 1) Make sure GitHub access works on the VM

Check which remote is set:

```{bash}
git -C /home/yeroslaviz/BCFNGS-project-management remote -v
```

If the remote is SSH (`git@github.com:...`), verify SSH access:

```{bash}
ssh -T git@github.com
```

If SSH works but `git pull` still says **Permission denied (publickey)**, the VM key is **not added** to the repo. The fix is to add the VM public key as a **Deploy Key**:

```{bash}
cat ~/.ssh/id_ed25519.pub
```

Then add that key in GitHub:
`Repo → Settings → Deploy keys → Add deploy key` (read‑only is enough for pull).

### 2) Pull latest code

```{bash}
cd /home/yeroslaviz/BCFNGS-project-management
git pull origin main
```

If Git says **divergent branches**, I set merge as the default and pull again:

```{bash}
git config pull.rebase false
git pull origin main
```

If Git refuses because of the local SQLite DB file, I stop tracking the DB on the VM:

```{bash}
git rm --cached sequencing-app/sequencing_projects.db
git commit -m "Stop tracking local SQLite DB on VM"
git pull origin main
```

This does **not** delete the local DB file. It just removes it from Git so future pulls work.

### 3) Production safety backups (fast rollback)

```{bash}
sudo rsync -av /srv/shiny-server/sequencing-app/ /srv/shiny-server/sequencing-app.backup_$(date +%Y%m%d_%H%M)/
cp /srv/shiny-server/sequencing-app/sequencing_projects.db \
  /srv/shiny-server/sequencing-app/sequencing_projects.db.backup_$(date +%Y%m%d_%H%M)
sudo cp /etc/apache2/sites-enabled/01-main.conf \
  /etc/apache2/sites-enabled/01-main.conf.backup_$(date +%Y%m%d_%H%M)
```

### 4) Deploy

```{bash}
./deploy.sh
```

### 5) Restart and smoke‑test

```{bash}
sudo systemctl restart shiny-server
sudo systemctl restart apache2
```

Then open the app URL and verify:
- LDAP prompt appears
- login works
- app loads

### 6) Rollback (if needed)

```{bash}
sudo rsync -av --delete /srv/shiny-server/sequencing-app.backup_YYYYMMDD_HHMM/ /srv/shiny-server/sequencing-app/
sudo systemctl restart shiny-server
sudo systemctl restart apache2
```

# Security

Not sure, if this is all necessary, will consult the IT when it is appropriate

## Backup older settings

```{bash}

# Backup your current configuration
sudo cp /etc/apache2/sites-enabled/01-main.conf /etc/apache2/sites-enabled/01-main.conf.backup

# Remove old SSL certificates (optional - keep for backup)
sudo mkdir -p /etc/ssl/backup/
sudo mv /etc/ssl/certs/********.pem /etc/ssl/backup/
sudo mv /etc/ssl/private/********.pem /etc/ssl/backup/
sudo mv /etc/apache2/certificate/********.cer /etc/ssl/backup/

```

```
./
├── 01-main.conf -> ../sites-available/default-ssl.conf
├── 01-main.conf.backup
├── 02-testing.conf -> ../sites-available/02-testing.conf
└── auth_ldap.conf -> ../sites-available/auth_ldap.conf
```

## Applying for a new certificate from MPI/MPG

The new setting of the certificates. I have three files.

The private key I created when applying for the certificate. The other two were downloaded, when the emial came from Harica (the certificate provider).

the `PEM` is the pem file and the `DER (issuer)` is the chain file. Both of them are needed.

Setting for the readability of the files:

```
cd /etc/apache2/certificate/2026
-rw------- 1 yeroslaviz b_mcf 3272 Nov 10 15:58 private-key.pem # udo chmod 600 /path/to/private.key  # Readable only by root
-rw-r--r-- 1 yeroslaviz b_mcf 1545 Nov 14 12:12 NGS_2026_Issuer_ChainFile.cer # sudo chmod 644 /path/to/chain.crt  # Readable by all
-rw-r--r-- 1 yeroslaviz b_mcf 2796 Nov 14 12:34 NGS_2026_Cert.pem # sudo chmod 644 /path/to/certificate.crt # Readable by all
```

All the files are saved under `/etc/apache2/certificate/2026`.

Now I created soft links for each of these files.

```{bash}
sudo ln -s /etc/apache2/certificate/2026/private-key.pem /etc/ssl/private/2026_private-key.pem
sudo ln -s /etc/apache2/certificate/2026/NGS_2026_Cert.pem /etc/ssl/certs/2026_NGS_Cert.pem

```

## Firewall

at the moment is not active, but maybe in the future.

```{bash}

sudo ufw allow 3838
sudo ufw allow 80
sudo ufw allow 443

```

# Change connection to shiny server folder to https

The shiny app takes information from the config file under `/etc/shiny-server/shiny-server.conf`. Here we can see where the log files are written into and where the directory of the shiny app are stored.

```{bash}
sudo usermod -a -G shiny $USER # add user yeroslaviz to group shiny
sudo chown -R $USER:shiny sequencing-app/ # make group shiny able to execute the scripts in the folder
sudo mv /srv/shiny-server/sequencing-app/ /srv/shiny-server/sequencing-app.backup # move the actual hard-coded folder to a backup (just in case)
```

The sequencing-app folder must be copied to the correct place after each modification was done and the new files were pulled to the VM.

For that I have created a script called `deploy.sh`. The script synchronizes the files from the github repo folder `/home/yeroslaviz/BCFNGS-project-management/sequencing-app/` to where the Shiny app needs them to be: `/srv/shiny-server/sequencing-app/`.

The deploy script must be activated when loaded

```{bash}
chmod +x deploy.sh
```

The deploy.sh script uses `rsync` and **excludes** `sequencing_projects.db` so the production database is not overwritten during deploys.

If `rsync` is not installed on the VM:

```{bash}
sudo apt install -y rsync
```

It then resets permissions for all files (the DB file remains in place and keeps its permissions).

When this is done, it restart the shiny server.

**This script must be run each time the files inside the sequencing-app folder were changed**, but not if other changed were made in the repo.

# Changes on 12.02.2026

1.  Fixed LDAP URL impersonation risk by enforcing canonical `auth_user` handling in Apache: tampered `?auth_user=` values are rewritten to the authenticated LDAP user.
2.  Fixed redirect-loop behavior in the Apache auth rewrite logic and validated canonical redirect behavior with `curl` (expected `302` to the authenticated user).
3.  Confirmed and documented required shiny-server environment for LDAP mode:
    - `AUTH_MODE=ldap`
    - `TRUST_PROXY_AUTH_USER_QUERY=1`
4.  Extended `deploy.sh` with post-deploy LDAP smoke tests (canonical redirect, tampered query rewrite, final `200` response) and actionable failure hints.
5.  Added/merged troubleshooting guidance for LDAP login failures, disconnects, and redirect loops into the VM troubleshooting documentation.
6.  Improved Projects table readability in the Shiny UI (`sequencing-app/app.R`):
    - explicit DT column widths
    - wrapped long cell text
    - reliable column reflow on tab switch and resize
    - preserved horizontal scrolling and existing formatting.

# Changes on 11.02.2026

1.  Added a production rollout checklist with the exact commands for pull, backup, deploy, restart, and smoke‑tests.
2.  Added a dedicated section for **admin access in LDAP mode** (pre‑create vs promote after first login).
3.  Added a dedicated section on **switching between LDAP and local auth** on the VM (`AUTH_MODE` via systemd override).
4.  Added the full **pre‑create admin** example that includes `password`/`email` for NOT NULL constraints.
5.  Updated the canonical server path to `/srv/shiny-server` and corrected repo path on the local machine.
6.  Moved legacy/obsolete content to the end of the document under **Obsolete / now wrong**.
7.  Replaced the old deploy script reference (`deploy_shiny_server.sh`) with `deploy.sh`.

# Changes on 09.02.2026

1.  Added a VM rollout HOW‑TO (GitHub SSH/deploy keys, divergent branches, DB tracking fix, backups, deploy, restart, rollback).
2.  Documented production safeguards (app folder backup, DB backup, Apache config backup).
3.  Updated `deploy.sh` to restart Shiny only if `rsync` succeeds (prevents restarts on failed deploys).
4.  Cleaned up Apache LDAP logging (default to quiet logs; debug only when explicitly enabled).
5.  Made LDAP debug output in the Shiny app conditional on **both** `APP_ENV=dev` and `LDAP_DEBUG=1` to avoid production log noise.
6.  Documented the VM LDAP validation test (real user + service group user, and email routing behavior).

## VM rollout validation (what I tested and confirmed)

I verified end‑to‑end behavior on the VM after fixing the Apache proxy path:

-   **LDAP login works**: the browser prompts for username/password and redirects to `/sequencing-app/?auth_user=<user>`.
-   **User mapping works**: `yeroslaviz` (OU contains Cox) is mapped to the **Cox** group and the correct PI.
-   **User mapping works**: `yeroslaviz-test` (OU = **NGS Facility**) is treated as a service‑group user (no PI match).
-   **Email routing works**: research group users trigger mail to the PI **and** NGS.
-   **Email routing works**: service group users (no PI match) trigger mail to the **administrator**.

If all three happen, the LDAP→app→email flow is working as intended.

# Possible errors and fixes (VM LDAP rollout)

This section captures the real errors I hit during the VM rollout and the fixes that worked. It is meant as a troubleshooting reference.

## 1) Apache won’t restart after LDAP change

**Symptom**

```
AH00526: Syntax error ... Bad LDAP URL while parsing.
```

**Cause**

Apache’s `AuthLDAPURL` is very strict. Each URL must be complete (host + base DN + query), and some Apache builds don’t accept multiple URLs in a single directive.

**Fix**

Use a single server (most stable on my VM):

```
AuthLDAPURL "ldaps://ldapserv1.biochem.mpg.de:636/dc=biochem,dc=mpg,dc=de?uid?sub?(objectClass=posixAccount)"
```

If the multi‑server line fails, I keep one server and fall back manually if needed.

## 2) `LDAPTLS_CACERTDIR` breaks Apache

**Symptom**

```
Invalid command 'LDAPTLS_CACERTDIR'
```

**Cause**

`LDAPTLS_CACERTDIR` is **not** an Apache directive. It belongs to the OpenLDAP client config.

**Fix**

Remove it from Apache. If I need TLS trust, I configure it in `/etc/ldap/ldap.conf` instead.

## 3) LDAP login shows 500 Internal Server Error

**Symptom**

- Browser shows `Internal Server Error`
- Apache log shows:

```
ldap_simple_bind() failed][Can't contact LDAP server]
```

**Cause**

LDAP TLS handshake fails (certificate trust not configured).

**Fix**

1. Confirm port reachability:

```
nc -vz ldapserv1.biochem.mpg.de 636
```

2. Test LDAP with **TLS bypass** to confirm trust problem:

```
LDAPTLS_REQCERT=never ldapsearch -x -H ldaps://ldapserv1.biochem.mpg.de:636 \
  -b "dc=biochem,dc=mpg,dc=de" "(uid=USER)" mail
```

3. Fix trust in `/etc/ldap/ldap.conf`:

```
TLS_CACERTDIR /etc/ssl/certs
```

**Important:** I had a typo (`TLS_CACERETDIR`) which prevented TLS trust from loading. Fixing the spelling made LDAP work.

4. Verify normal LDAP now works:

```
ldapsearch -x -H ldaps://ldapserv1.biochem.mpg.de:636 \
  -b "dc=biochem,dc=mpg,dc=de" "(uid=USER)" mail
```

Then restart Apache:

```
sudo systemctl restart apache2
```

## 4) Shiny app runs locally but crashes via Apache

**Symptom**

- App works with `shiny::runApp()`
- But Apache shows 500 and Shiny worker terminates

**Cause**

LDAP authentication failure in Apache (not an app crash).

**Fix**

Check Apache log for `authnz_ldap` errors and fix TLS trust as above.

## 5) LDAP works, but `/sequencing-app/` returns 404

**Symptom**

- `curl -Ik -u USER https://host/sequencing-app/` returns **404**
- `curl -I http://localhost:3838/sequencing-app/` returns **200**

**Cause**

Apache is proxying the wrong path (often due to an older `ProxyPass /` rule or a backup file in `sites-enabled`).

**Fix**

1.  Ensure **only** these lines exist in the active config:

```
ProxyPass /sequencing-app/ http://localhost:3838/sequencing-app/
ProxyPassReverse /sequencing-app/ http://localhost:3838/sequencing-app/
```

2.  Remove or move any backup config files out of `/etc/apache2/sites-enabled` (Apache can accidentally parse them).
3.  Restart Apache:

```
sudo apache2ctl -t
sudo systemctl restart apache2
```

## 6) Debug logging too noisy (Apache or Shiny)

**Symptom**

Lots of LDAP debug output in logs during normal use.

**Fix (Apache)**

In `01-main.conf`, use normal logging:

```
LogLevel warn
# LogLevel authnz_ldap:debug ldap:debug   # enable only when debugging
```

**Fix (Shiny app)**

The app only prints LDAP debug logs when **both** are set:

- `APP_ENV=dev`
- `LDAP_DEBUG=1`

So for production:

- Remove `LDAP_DEBUG=1` from `/home/shiny/.Renviron` (or set it to `0`).
- Restart Shiny:

```
sudo systemctl restart shiny-server
```

If I need debugging later, I can temporarily set:

```
APP_ENV=dev
LDAP_DEBUG=1
```

and restart the service again.

## Comprehensive error‑checking checklist (VM LDAP + Shiny)

When something breaks, I run through this list in order:

1.  **Apache syntax**

```
sudo apache2ctl -t
```

2.  **Which vhost is active**

```
sudo apache2ctl -S
```

3.  **Proxy path**

```
sudo grep -n "ProxyPass" -R /etc/apache2/sites-enabled /etc/apache2/conf-enabled
```

4.  **LDAP connectivity + TLS**

```
nc -vz ldapserv1.biochem.mpg.de 636
ldapsearch -x -H ldaps://ldapserv1.biochem.mpg.de:636 \
  -b "dc=biochem,dc=mpg,dc=de" "(uid=USER)" mail
```

If that fails, verify `/etc/ldap/ldap.conf` has:

```
TLS_CACERTDIR /etc/ssl/certs
```

5.  **LDAP auth prompt vs app redirect**

```
curl -Ik https://HOST/
curl -Ik -u USER https://HOST/
```

Expected:
401 without user, 302 to `/sequencing-app/?auth_user=USER` with user.

6.  **Shiny backend is reachable**

```
curl -I http://localhost:3838/sequencing-app/
```

7.  **Apache app path**

```
curl -Ik -u USER https://HOST/sequencing-app/
```

8.  **Shiny logs**

```
sudo ls -t /var/log/shiny-server/ | head -n 1
sudo tail -n 200 /var/log/shiny-server/FILE.log
```

9.  **Shiny environment variables**

```
sudo systemctl show shiny-server --property=Environment
```

10. **Database permissions**

```
ls -l /srv/shiny-server/sequencing-app/sequencing_projects.db
```

11. **Reload after config change**

```
sudo systemctl restart apache2
sudo systemctl restart shiny-server
```

# Changes on 06.02.2026

1.  Added LDAP login flow in the Shiny app (auto‑login via `X-Remote-User`, local dev simulation, and optional attribute lookup).
2.  LDAP attribute lookup now works with anonymous bind; uses `ldapsearch` fallback for older `ldapr` versions.
3.  Added dev tools toggle (dev only) to switch between LDAP and local auth while testing.
4.  Mapped LDAP `ou` values to budget holders, auto‑selecting the correct PI in the project form (with partial match fallback).
5.  Added budget holder notices for multiple cost centers and missing cost center values.
6.  Added “Other / not listed” budget holder option so users can enter a new PI (name/surname required; cost center optional with a warning).
7.  Updated `deploy.sh` to use `rsync` and exclude `sequencing_projects.db`.
8.  Updated Apache LDAP configuration template and added local dev testing instructions + env var cleanup.
9.  I do **not** track SQLite DB files in git because they change constantly, are environment‑specific (local vs VM), and can contain sensitive data. I ignore `*.db`/`*.sqlite` and keep only the schema/seed files in git.

# Changes on 14.11.2026

1.  I would Like you to show me where the admin email address can be changed, if I want to have a different user as admin. 1.1 Please show me the parts of the script where this can be changed.

The admin password is set here:

```{bash}
# Insert default admin user
default_password <- digest::digest("admin123")
dbExecute(con, "
  INSERT OR IGNORE INTO users (username, password, email, is_admin)
  VALUES ('admin', ?, 'yeroslaviz@biochem.mpg.de', 1)
", params = list(default_password))
```

1.2 Can this be changed without recreating the whole databank or restart the app? 1.3 How do I change the admin email address without recreating the db?

This can be changed without recreating the database, using two options:

-   Option 1: Direct database update

Run this SQL command on your database:

```{sql}

UPDATE users SET email = 'newadmin@institute.org' WHERE username = 'admin';

```

To execute this, we can either log in directly to the database via the command line

```{bash}
sqlite3 sequencing_projects.db
```

and execute

```{bash}
UPDATE users SET email = 'newadmin@institute.org' WHERE username = 'admin';
.exit
```

or via the R pormpt:

```{r}
library(DBI)
library(RSQLite)
con <- dbConnect(RSQLite::SQLite(), "sequencing_projects.db")
dbExecute(con, "UPDATE users SET email = 'newadmin@institute.org' WHERE username = 'admin'")
dbDisconnect(con)
```

**Don't forget to modify the `setup_database_*.R` script afterwards, so these information will be also kept, if the database is recreated!**

-   Option 2: Through the app's user management (as admin)

In the "Administer Projects" tab, one can click "Manage Users" and change (or add) the admin user and edit their email.

1.4 How can I turn on/off sending the notification mail to the admin, if not needed?

The admin notification email is sent in the `send_project_creation_email` function in the app file.

2.  When creating a new project, an email is being sent. 2.1 can you please tell me to whome this email is being sent? 2.2 Can you show me the part of the script where it is set up? 2.3 Now, the Email should be sent to budget holder and to user, who created the project, as well as to the admin. Can this be changed easily, if needed?

This was done also in point 1. The function `send_project_creation_email` set the users who gets an email, when a project is created. the row

```
        to = c(budget_holder$email, user_email, admin_emails),
```

set the recipient of the mail. we can remove one of the elements, or even just add a specific mail address to the `to =` row.

3.  How do I make changes to the cost estimations w.o. Recreating the db? 3.1 Is it possible to modify existing columns, in case prices are changing? Or would deleting and making a new element would be easier? 3.2 If I change anything in these tables, Would it also change it in the SQL data base?

At the moment the tables `Service types` and `Sequencing depths` are not editable. If prices change, the easiet option is to delete the row and recreate it using the new value. This way, the older projects will use the previous costs, while the new one will get the new costs.

One can also directly use the SQL commands to apply these chages, similar to above

```{bash}
sqlite3 sequencing_projects.db
```

and execute

```{bash}
UPDATE service_types SET costs_per_sample = 55 WHERE service_type = 'single cell/low mRNAseq';
.exit
```

4.  something is wrong with the Sequencing Cycles Management table. When I run the app, go to the Admin projects Tab and click the Sequencing Cycles - Manage Cycles, I see this message: "Error: An error has occurred. Check your logs or contact the app author for clarification." 4.1 which log files can I consult?

When working on the server, the best place to look for problems are the log files of either the `apache2` (`/var/log/apache2/`) or the `shiny-server` (`/var/log/shiny-server/`).

5.  Do I have a weekly backup of the SQL db? 

there is an app for a bi-weekly automaic backup. The function is for now commented out, so not working.

## modify registration page

```{bash}
sqlite3 sequencing_projects.db
```

we add information to the registration page, so the user must choose a group. This way we know which is the budget holder for this user.

After ward we added the information to the Registration Server Logic

```{bash}
dbExecute(con, "
INSERT INTO users (username, password, email, phone, research_group, is_admin)
VALUES (?, ?, ?, ?, ?, 0)
", params = list(
  input$reg_username,
  digest(input$reg_password),
  input$reg_email,
  input$reg_phone,
  input$reg_group
))
```

as well as modified the User registration modal

Now, when a user register, he must choose a group from the given drop-down menu. this group is attached to the budget holder. When the user creates a new project, this budget holder (group) will automatically be assigned to the project (This can be manually changed, when the project is created).

I have changed the `setup_databases.R` script to load the budget holders information from a csv file, stored in the same folder as the script itself.

We have a csv-formatted table with the information of the groups and their cost centers. This is an easy way to upload the information.

```
name,surname,email,cost_center
Kim,Rin-Ho,rkim@biochem.mpg.de,N.A.
Administrator,surname,rkim@biochem.mpg.de,N.A.
Baier,Herwig,herwig.baier@bi.mpg.de,P350
Baldwin,Maude,Maude.Baldwin@bi.mpg.de,P550
```

The registration process was change to make choosing a research group mandatory. The chosen research group is then set to also assign the cost center to the user.

::: callout-note
Some of the research groups have multiple cost centers.

When a user registers, he must select a research group. The user then gets assigned a cost center based on the table of budget holders. If (and this applies only for some of the budget holders), this specific research group has multiple cost centers, it gets assigned the first one found by the app. BUT, manually the user still can change this in the app when applying for a project.
:::

## control for budegt holder info in the DB

```{r}
#| eval: true
con <- dbConnect(RSQLite::SQLite(), "sequencing_projects.db")
budget_holders <- dbGetQuery(con, "SELECT * FROM budget_holders")
# Print the data
print(budget_holders[1:3,])
dbGetQuery(con, "SELECT * FROM budget_holders")
dbGetQuery(con, "SELECT * FROM users")
on.exit(dbDisconnect(con))
```

## Budget holders can be read from an Excel sheet

# SSL Certificate (for HTTPS)

the new setting of the certificates. I have three files.

The private key I created when applying for the certificate. The other two were downloaded, when the emial came from Harica (the certificate provider).

the `PEM` is the pem file and the `DER (issuer)` is the chain file. Both of them are needed.

Setting for the readability of the files:

```
cd /etc/apache2/certificate/2026
-rw------- 1 yeroslaviz b_mcf 3272 Nov 10 15:58 private-key.pem # udo chmod 600 /path/to/private.key  # Readable only by root
-rw-r--r-- 1 yeroslaviz b_mcf 1545 Nov 14 12:12 NGS_2026_Issuer_ChainFile.cer # sudo chmod 644 /path/to/chain.crt  # Readable by all
-rw-r--r-- 1 yeroslaviz b_mcf 2796 Nov 14 12:34 NGS_2026_Cert.pem # sudo chmod 644 /path/to/certificate.crt # Readable by all
```

All the files are saved under `/etc/apache2/certificate/2026`.

Now I created soft links for each of these files.

```{bash}
sudo ln -s /etc/apache2/certificate/2026/private-key.pem /etc/ssl/private/2026_private-key.pem
sudo ln -s /etc/apache2/certificate/2026/NGS_2026_Cert.pem /etc/ssl/certs/2026_NGS_Cert.pem

```

# LDAP

The app uses Apache LDAP authentication in front of Shiny. The Apache config template is in `01-main.conf`.

Enable required Apache modules:

```{bash}
sudo a2enmod ldap authnz_ldap headers
sudo systemctl reload apache2
```

Test whether anonymous LDAP search works:

```{bash}
ldapsearch -x -H ldaps://ldapserv1.biochem.mpg.de -b "dc=biochem,dc=mpg,dc=de" "(uid=YOURUSER)"
```

If anonymous search fails, use bind credentials from IT and add them to the Apache config:

``` apache
AuthLDAPBindDN "cn=binduser,dc=biochem,dc=mpg,dc=de"
AuthLDAPBindPassword "REDACTED"
```

::: callout-warning
For production, **do not use a personal account** for LDAP binding. Ask IT for a dedicated **service bind account** with read‑only permissions and store those credentials securely.
:::

Set app environment variables for Shiny Server (systemd override recommended):

```{bash}
sudo systemctl edit shiny-server
```

``` ini
[Service]
Environment=AUTH_MODE=ldap
Environment=LDAP_URI=ldaps://ldapserv1.biochem.mpg.de:636,ldaps://ldapserv2.biochem.mpg.de:636,ldaps://ldapserv3.biochem.mpg.de:636
Environment=LDAP_BASE_DN=dc=biochem,dc=mpg,dc=de
# If you want to restrict search to the user OU:
# Environment=LDAP_BASE_DN=ou=People,dc=biochem,dc=mpg,dc=de
# Optional bind credentials (only if anonymous LDAP search is blocked):
# Environment=LDAP_BIND_DN=cn=binduser,dc=biochem,dc=mpg,dc=de
# Environment=LDAP_BIND_PW=REDACTED
```

Restart services after config changes:

```{bash}
sudo systemctl restart apache2
sudo systemctl restart shiny-server
```

## Admin access in LDAP mode (VM)

When `AUTH_MODE=ldap` is enabled, the local login form is disabled. To get admin access, I mark the **LDAP user** as admin in the SQLite database.

**Option 1: Pre‑create the user as admin (works even before first login)**

```{bash}
sudo -u shiny sqlite3 /srv/shiny-server/sequencing-app/sequencing_projects.db \
"INSERT OR IGNORE INTO users (username, is_admin) VALUES ('soyer', 1);"
```

If the insert is ignored because the table requires `password`/`email`, use:

```{bash}
sudo -u shiny sqlite3 /srv/shiny-server/sequencing-app/sequencing_projects.db \
"INSERT OR IGNORE INTO users (username, password, email, is_admin) VALUES ('soyer', 'ldap-only', 'soyer@biochem.mpg.de', 1);"
```

On first LDAP login, the app fills in email/phone/OU (if missing).

**Option 2: Promote after the user logs in once**

```{bash}
sudo -u shiny sqlite3 /srv/shiny-server/sequencing-app/sequencing_projects.db \
"UPDATE users SET is_admin=1 WHERE username='soyer';"
```

Note: `UPDATE` does nothing if the user row does **not** exist yet.

**Verify:**

```{bash}
sudo -u shiny sqlite3 /srv/shiny-server/sequencing-app/sequencing_projects.db \
"SELECT username, is_admin FROM users WHERE username IN ('yeroslaviz','soyer');"
```

## Switch between LDAP and local modes (VM)

I switch auth modes by changing the `AUTH_MODE` environment variable for the `shiny-server` service and restarting it.

Open the systemd override:

```{bash}
sudo systemctl edit shiny-server
```

**LDAP mode (production):**

```ini
[Service]
Environment=AUTH_MODE=ldap
Environment=LDAP_URI=ldaps://ldapserv1.biochem.mpg.de:636,ldaps://ldapserv2.biochem.mpg.de:636,ldaps://ldapserv3.biochem.mpg.de:636
Environment=LDAP_BASE_DN=dc=biochem,dc=mpg,dc=de
```

**Local mode (maintenance/testing):**

```ini
[Service]
Environment=AUTH_MODE=local
```

Apply changes:

```{bash}
sudo systemctl restart shiny-server
sudo systemctl show shiny-server --property=Environment
```

If I switch back to LDAP, I also remove any dev‑only variables like `DEV_REMOTE_USER`.

## Local dev testing (LDAP mode)

To test LDAP integration on your local machine without affecting production, run the app in dev mode and simulate the authenticated user. If LDAP attribute lookup is needed, provide a bind DN/password (personal credentials are OK for **local testing only**).

``` r
Sys.setenv(
  APP_ENV = "dev",
  AUTH_MODE = "ldap",
  DEV_REMOTE_USER = "your_username",
  LDAP_BIND_DN = "uid=your_username,ou=YourGroup,ou=Research Group,ou=People,dc=biochem,dc=mpg,dc=de",
  LDAP_BIND_PW = "YOUR_PASSWORD"
)
shiny::runApp("sequencing-app")
```

After login, verify the user record in SQLite:

``` r
con <- DBI::dbConnect(RSQLite::SQLite(), "sequencing-app/sequencing_projects.db")
DBI::dbGetQuery(con, "SELECT username, email, phone, research_group FROM users WHERE username='your_username'")
DBI::dbDisconnect(con)
```

To switch back to normal local login (no LDAP), run:

``` r
Sys.setenv(APP_ENV = "dev", AUTH_MODE = "local")
shiny::runApp("sequencing-app")
```

To fully clear the LDAP/testing variables in your R session:

``` r
Sys.unsetenv(c(
  "APP_ENV", "AUTH_MODE", "DEV_REMOTE_USER",
  "LDAP_BIND_DN", "LDAP_BIND_PW",
  "LDAP_URI", "LDAP_BASE_DN", "LDAP_DEBUG"
))
```

## How I run the app locally (my notes)

When I want the **normal local login**, I run:

```r
Sys.setenv(APP_ENV = "dev", AUTH_MODE = "local")
shiny::runApp("sequencing-app")
```

When I want to **simulate production LDAP login**, I run:

```r
Sys.setenv(
  APP_ENV = "dev",
  AUTH_MODE = "ldap",
  DEV_REMOTE_USER = "my_username",
  LDAP_URI = "ldaps://ldapserv1.biochem.mpg.de:636,ldaps://ldapserv2.biochem.mpg.de:636,ldaps://ldapserv3.biochem.mpg.de:636",
  LDAP_BASE_DN = "dc=biochem,dc=mpg,dc=de"
)
shiny::runApp("sequencing-app")
```

If I want to fully reset the session, I clear the env vars:

```r
Sys.unsetenv(c(
  "APP_ENV", "AUTH_MODE", "DEV_REMOTE_USER",
  "LDAP_BIND_DN", "LDAP_BIND_PW",
  "LDAP_URI", "LDAP_BASE_DN", "LDAP_DEBUG"
))
```

**Local vs LDAP mode (practical difference for me):**

- Local mode uses the SQLite users/passwords and shows the normal login screen.
- LDAP mode auto‑logs in with the LDAP user, pulls email/phone/OU, and hides the local login UI.
- LDAP mode needs network access to the institute LDAP servers.

**Dev badge:**
In dev mode, I see a small badge in the app header that shows `DEV · LDAP` or `DEV · LOCAL`, so I always know which mode I’m running.

## Budget holder auto-assignment (first login)

On first LDAP login, the app attempts to map the user to a budget holder based on the LDAP `ou` value.\
If the `ou` contains a group key in parentheses (e.g., `(... Cox)`), the app matches that key against `budget_holders` and stores the **full PI name** (e.g., `Cox Juergen`) in `users.research_group`.

When a new project is created, this `research_group` value is used to auto‑select the budget holder (and thus the cost center).\
If multiple cost centers exist for the same PI, the first match is selected by default and can be adjusted during project creation.

# Obsolete / now wrong (kept for reference)

These sections are retained to understand the history but should not be followed anymore.

## Legacy environment variable location (no longer used)

```{bash}

# /var/shiny-server/.Renviron
TZ=Europe/Berlin
LANG=en_US.UTF-8
LC_ALL=en_US.UTF-8

```

## Legacy folder layout (/var/shiny-server)

```
/var/shiny-server/
├── sequencing-app/
│ ├── app.R
│ ├── setup_database.R
│ ├── sequencing_projects.db
│ └── www/
  │ ├── logo.png
  │ └── minerva.png
```

## Legacy install steps (nginx-based, superseded by Apache setup)

```{bash}

# Install Shiny Server on Ubuntu
sudo apt update
sudo apt install -y r-base nginx
sudo apt install -y libfontconfig1-dev libfreetype6-dev libpng-dev libtiff5-dev \
    libjpeg-dev build-essential pkg-config libharfbuzz-dev libfribidi-dev
sudo apt install -y libldap2-dev libsasl2-dev

sudo su - -c "R -e \"install.packages('shiny')\""
sudo su - -c "R -e \"install.packages('shinyjs')\""
# ... install all your R packages
sudo R -e "install.packages(c('shiny', 'shinyjs', 'DBI', 'RSQLite', 'digest', 'DT', 'shinyWidgets', 'mailR'))"
# these two packages were added later on for the connection of the app to the LDAP server
sudo R -e "install.packages(c('devtools'))"
sudo R -e "devtools::install_github('liamgilbey/ldapr')"

# Download and install Shiny Server
wget https://download3.rstudio.org/ubuntu-20.04/x86_64/shiny-server-1.5.23.1030-amd64.deb
sudo gdebi shiny-server-1.5.23.1030-amd64.deb

```

## Legacy Apache config (old ProxyPass / path)

```{bash}
<VirtualHost *:80>
    ServerName ngs-testing-vm
    ServerAlias ngs-testing-vm.biochem.mpg.de
    # Redirect all HTTP traffic to HTTPS
    Redirect permanent / https://ngs-testing-vm/
</VirtualHost>

<VirtualHost *:443>
    ServerName ngs-testing-vm
    ServerAlias ngs-testing-vm.biochem.mpg.de

    # SSL Configuration
    SSLEngine on
    SSLCertificateFile /etc/ssl/certs/2026_NGS_Cert.pem
    SSLCertificateKeyFile /etc/ssl/private/2026_private-key.pem
    SSLCertificateChainFile /etc/apache2/certificate/2026/NGS_2026_Issuer_ChainFile.cer

    # Modern SSL configuration
    SSLProtocol all -SSLv3 -TLSv1 -TLSv1.1
    SSLCipherSuite ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384
    SSLHonorCipherOrder off

    # Reverse proxy for Shiny app
    ProxyPreserveHost On
    ProxyRequests Off
    ProxyPass / http://localhost:3838/sequencing-app/
    ProxyPassReverse / http://localhost:3838/sequencing-app/

    # WebSocket support
    RewriteEngine on
    RewriteCond %{HTTP:Upgrade} websocket [NC]
    RewriteCond %{HTTP:Connection} upgrade [NC]
    RewriteRule ^/(.*) "ws://localhost:3838/sequencing-app/$1" [P,L]

    # Security headers
    Header always set Strict-Transport-Security "max-age=63072000; includeSubDomains"
    Header always set X-Content-Type-Options nosniff
    Header always set X-Frame-Options SAMEORIGIN
    Header always set Referrer-Policy "strict-origin-when-cross-origin"

    ErrorLog ${APACHE_LOG_DIR}/sequencing-app-ssl-error.log
    CustomLog ${APACHE_LOG_DIR}/sequencing-app-ssl-access.log combined
</VirtualHost>
```

## Legacy deployment script name

The old notes referenced `deploy_shiny_server.sh`. This has been replaced by `deploy.sh` in the repo root.

## Legacy tree output (old VM layout example)

```
$ tree -L 1
.
├── BCFNGS-project-management
├── chemata
├── miniconda3
└── scripts
    └── deploy_shiny_server.sh
```

## Legacy git pull via HTTPS + PAT (no longer used)

```{bash}
 git pull origin main
# Username for 'https://github.com': yeroslaviz
# Password for 'https://yeroslaviz@github.com':  HERE WE MUST INPUT THE PAT from above!!!
 ...
```

## Legacy note: dedicated user (superseded)

As we're planning to use the LDAP, I'm not sure, this is necessary. I need a method to add specific users as admin.
