<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.315">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Assa Yeroslaviz">
<meta name="dcterms.date" content="2026-02-09">
<meta name="keywords" content="RNA-Seq, transcriptomics, P405, Marion, Peter, AG Murray">

<title>Server Preparations</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="Server_preparations_files/libs/clipboard/clipboard.min.js"></script>
<script src="Server_preparations_files/libs/quarto-html/quarto.js"></script>
<script src="Server_preparations_files/libs/quarto-html/popper.min.js"></script>
<script src="Server_preparations_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="Server_preparations_files/libs/quarto-html/anchor.min.js"></script>
<link href="Server_preparations_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="Server_preparations_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="Server_preparations_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="Server_preparations_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="Server_preparations_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">


</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active" data-toc-expanded="-1">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#server-infrastructure" id="toc-server-infrastructure" class="nav-link active" data-scroll-target="#server-infrastructure"><span class="header-section-number">1</span> Server Infrastructure</a>
  <ul>
  <li><a href="#install-required-system-dependencies" id="toc-install-required-system-dependencies" class="nav-link" data-scroll-target="#install-required-system-dependencies"><span class="header-section-number">1.1</span> Install required system dependencies</a></li>
  <li><a href="#setting-environment-variables" id="toc-setting-environment-variables" class="nav-link" data-scroll-target="#setting-environment-variables"><span class="header-section-number">1.2</span> Setting Environment variables</a></li>
  <li><a href="#install-shiny-app" id="toc-install-shiny-app" class="nav-link" data-scroll-target="#install-shiny-app"><span class="header-section-number">1.3</span> Install shiny app</a></li>
  <li><a href="#changing-hostname-to-fit-the-apache2-config-file" id="toc-changing-hostname-to-fit-the-apache2-config-file" class="nav-link" data-scroll-target="#changing-hostname-to-fit-the-apache2-config-file"><span class="header-section-number">1.4</span> Changing hostname to fit the apache2 config file</a></li>
  <li><a href="#automatic-start-up" id="toc-automatic-start-up" class="nav-link" data-scroll-target="#automatic-start-up"><span class="header-section-number">1.5</span> Automatic start-up</a></li>
  </ul></li>
  <li><a href="#monitoring" id="toc-monitoring" class="nav-link" data-scroll-target="#monitoring"><span class="header-section-number">2</span> Monitoring</a></li>
  <li><a href="#regular-backups" id="toc-regular-backups" class="nav-link" data-scroll-target="#regular-backups"><span class="header-section-number">3</span> Regular backups</a>
  <ul>
  <li><a href="#cron-job-for-data-base-backup" id="toc-cron-job-for-data-base-backup" class="nav-link" data-scroll-target="#cron-job-for-data-base-backup"><span class="header-section-number">3.1</span> cron job for data base backup</a></li>
  </ul></li>
  <li><a href="#create-clean-apache-configuration" id="toc-create-clean-apache-configuration" class="nav-link" data-scroll-target="#create-clean-apache-configuration"><span class="header-section-number">4</span> Create Clean Apache Configuration</a></li>
  <li><a href="#required-server-setup" id="toc-required-server-setup" class="nav-link" data-scroll-target="#required-server-setup"><span class="header-section-number">5</span> Required Server Setup</a></li>
  <li><a href="#github-repository" id="toc-github-repository" class="nav-link" data-scroll-target="#github-repository"><span class="header-section-number">6</span> Github repository</a>
  <ul>
  <li><a href="#step-1-generate-ssh-keys" id="toc-step-1-generate-ssh-keys" class="nav-link" data-scroll-target="#step-1-generate-ssh-keys"><span class="header-section-number">6.1</span> Step 1: Generate SSH keys</a></li>
  <li><a href="#add-both-keys-to-the-github-repository" id="toc-add-both-keys-to-the-github-repository" class="nav-link" data-scroll-target="#add-both-keys-to-the-github-repository"><span class="header-section-number">6.2</span> Add both keys to the github repository</a></li>
  <li><a href="#make-sure-we-clone-using-ssh-not-html" id="toc-make-sure-we-clone-using-ssh-not-html" class="nav-link" data-scroll-target="#make-sure-we-clone-using-ssh-not-html"><span class="header-section-number">6.3</span> Make sure we clone using ssh (not html)</a></li>
  <li><a href="#test-and-check-the-connection" id="toc-test-and-check-the-connection" class="nav-link" data-scroll-target="#test-and-check-the-connection"><span class="header-section-number">6.4</span> Test and check the connection</a></li>
  <li><a href="#pullingpushing" id="toc-pullingpushing" class="nav-link" data-scroll-target="#pullingpushing"><span class="header-section-number">6.5</span> Pulling/Pushing</a></li>
  <li><a href="#vm-rollout-howto-git-deploy-safety" id="toc-vm-rollout-howto-git-deploy-safety" class="nav-link" data-scroll-target="#vm-rollout-howto-git-deploy-safety"><span class="header-section-number">6.6</span> VM rollout HOW‑TO (Git + deploy + safety)</a>
  <ul class="collapse">
  <li><a href="#make-sure-github-access-works-on-the-vm" id="toc-make-sure-github-access-works-on-the-vm" class="nav-link" data-scroll-target="#make-sure-github-access-works-on-the-vm"><span class="header-section-number">6.6.1</span> 1) Make sure GitHub access works on the VM</a></li>
  <li><a href="#pull-latest-code" id="toc-pull-latest-code" class="nav-link" data-scroll-target="#pull-latest-code"><span class="header-section-number">6.6.2</span> 2) Pull latest code</a></li>
  <li><a href="#production-safety-backups-fast-rollback" id="toc-production-safety-backups-fast-rollback" class="nav-link" data-scroll-target="#production-safety-backups-fast-rollback"><span class="header-section-number">6.6.3</span> 3) Production safety backups (fast rollback)</a></li>
  <li><a href="#deploy" id="toc-deploy" class="nav-link" data-scroll-target="#deploy"><span class="header-section-number">6.6.4</span> 4) Deploy</a></li>
  <li><a href="#restart-and-smoketest" id="toc-restart-and-smoketest" class="nav-link" data-scroll-target="#restart-and-smoketest"><span class="header-section-number">6.6.5</span> 5) Restart and smoke‑test</a></li>
  <li><a href="#rollback-if-needed" id="toc-rollback-if-needed" class="nav-link" data-scroll-target="#rollback-if-needed"><span class="header-section-number">6.6.6</span> 6) Rollback (if needed)</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#security" id="toc-security" class="nav-link" data-scroll-target="#security"><span class="header-section-number">7</span> Security</a>
  <ul>
  <li><a href="#backup-older-settings" id="toc-backup-older-settings" class="nav-link" data-scroll-target="#backup-older-settings"><span class="header-section-number">7.1</span> Backup older settings</a></li>
  <li><a href="#applying-for-a-new-certificate-from-mpimpg" id="toc-applying-for-a-new-certificate-from-mpimpg" class="nav-link" data-scroll-target="#applying-for-a-new-certificate-from-mpimpg"><span class="header-section-number">7.2</span> Applying for a new certificate from MPI/MPG</a></li>
  <li><a href="#dedicated-user" id="toc-dedicated-user" class="nav-link" data-scroll-target="#dedicated-user"><span class="header-section-number">7.3</span> dedicated User</a></li>
  <li><a href="#firewall" id="toc-firewall" class="nav-link" data-scroll-target="#firewall"><span class="header-section-number">7.4</span> Firewall</a></li>
  </ul></li>
  <li><a href="#change-connection-to-shiny-server-folder-to-https" id="toc-change-connection-to-shiny-server-folder-to-https" class="nav-link" data-scroll-target="#change-connection-to-shiny-server-folder-to-https"><span class="header-section-number">8</span> Change connection to shiny server folder to https</a></li>
  <li><a href="#changes-on-09.02.2026" id="toc-changes-on-09.02.2026" class="nav-link" data-scroll-target="#changes-on-09.02.2026"><span class="header-section-number">9</span> Changes on 09.02.2026</a>
  <ul>
  <li><a href="#vm-rollout-validation-what-i-tested-and-confirmed" id="toc-vm-rollout-validation-what-i-tested-and-confirmed" class="nav-link" data-scroll-target="#vm-rollout-validation-what-i-tested-and-confirmed"><span class="header-section-number">9.1</span> VM rollout validation (what I tested and confirmed)</a></li>
  </ul></li>
  <li><a href="#possible-errors-and-fixes-vm-ldap-rollout" id="toc-possible-errors-and-fixes-vm-ldap-rollout" class="nav-link" data-scroll-target="#possible-errors-and-fixes-vm-ldap-rollout"><span class="header-section-number">10</span> Possible errors and fixes (VM LDAP rollout)</a>
  <ul>
  <li><a href="#apache-wont-restart-after-ldap-change" id="toc-apache-wont-restart-after-ldap-change" class="nav-link" data-scroll-target="#apache-wont-restart-after-ldap-change"><span class="header-section-number">10.1</span> 1) Apache won’t restart after LDAP change</a></li>
  <li><a href="#ldaptls_cacertdir-breaks-apache" id="toc-ldaptls_cacertdir-breaks-apache" class="nav-link" data-scroll-target="#ldaptls_cacertdir-breaks-apache"><span class="header-section-number">10.2</span> 2) <code>LDAPTLS_CACERTDIR</code> breaks Apache</a></li>
  <li><a href="#ldap-login-shows-500-internal-server-error" id="toc-ldap-login-shows-500-internal-server-error" class="nav-link" data-scroll-target="#ldap-login-shows-500-internal-server-error"><span class="header-section-number">10.3</span> 3) LDAP login shows 500 Internal Server Error</a></li>
  <li><a href="#shiny-app-runs-locally-but-crashes-via-apache" id="toc-shiny-app-runs-locally-but-crashes-via-apache" class="nav-link" data-scroll-target="#shiny-app-runs-locally-but-crashes-via-apache"><span class="header-section-number">10.4</span> 4) Shiny app runs locally but crashes via Apache</a></li>
  <li><a href="#ldap-works-but-sequencing-app-returns-404" id="toc-ldap-works-but-sequencing-app-returns-404" class="nav-link" data-scroll-target="#ldap-works-but-sequencing-app-returns-404"><span class="header-section-number">10.5</span> 5) LDAP works, but <code>/sequencing-app/</code> returns 404</a></li>
  <li><a href="#debug-logging-too-noisy-apache-or-shiny" id="toc-debug-logging-too-noisy-apache-or-shiny" class="nav-link" data-scroll-target="#debug-logging-too-noisy-apache-or-shiny"><span class="header-section-number">10.6</span> 6) Debug logging too noisy (Apache or Shiny)</a></li>
  <li><a href="#comprehensive-errorchecking-checklist-vm-ldap-shiny" id="toc-comprehensive-errorchecking-checklist-vm-ldap-shiny" class="nav-link" data-scroll-target="#comprehensive-errorchecking-checklist-vm-ldap-shiny"><span class="header-section-number">10.7</span> Comprehensive error‑checking checklist (VM LDAP + Shiny)</a></li>
  </ul></li>
  <li><a href="#changes-on-06.02.2026" id="toc-changes-on-06.02.2026" class="nav-link" data-scroll-target="#changes-on-06.02.2026"><span class="header-section-number">11</span> Changes on 06.02.2026</a></li>
  <li><a href="#changes-on-14.11.2026" id="toc-changes-on-14.11.2026" class="nav-link" data-scroll-target="#changes-on-14.11.2026"><span class="header-section-number">12</span> Changes on 14.11.2026</a>
  <ul>
  <li><a href="#modify-registration-page" id="toc-modify-registration-page" class="nav-link" data-scroll-target="#modify-registration-page"><span class="header-section-number">12.1</span> modify registration page</a></li>
  <li><a href="#control-for-budegt-holder-info-in-the-db" id="toc-control-for-budegt-holder-info-in-the-db" class="nav-link" data-scroll-target="#control-for-budegt-holder-info-in-the-db"><span class="header-section-number">12.2</span> control for budegt holder info in the DB</a></li>
  <li><a href="#budget-holders-can-be-read-from-an-excel-sheet" id="toc-budget-holders-can-be-read-from-an-excel-sheet" class="nav-link" data-scroll-target="#budget-holders-can-be-read-from-an-excel-sheet"><span class="header-section-number">12.3</span> Budget holders can be read from an Excel sheet</a></li>
  </ul></li>
  <li><a href="#ssl-certificate-for-https" id="toc-ssl-certificate-for-https" class="nav-link" data-scroll-target="#ssl-certificate-for-https"><span class="header-section-number">13</span> SSL Certificate (for HTTPS)</a></li>
  <li><a href="#ldap" id="toc-ldap" class="nav-link" data-scroll-target="#ldap"><span class="header-section-number">14</span> LDAP</a>
  <ul>
  <li><a href="#local-dev-testing-ldap-mode" id="toc-local-dev-testing-ldap-mode" class="nav-link" data-scroll-target="#local-dev-testing-ldap-mode"><span class="header-section-number">14.1</span> Local dev testing (LDAP mode)</a></li>
  <li><a href="#how-i-run-the-app-locally-my-notes" id="toc-how-i-run-the-app-locally-my-notes" class="nav-link" data-scroll-target="#how-i-run-the-app-locally-my-notes"><span class="header-section-number">14.2</span> How I run the app locally (my notes)</a></li>
  <li><a href="#budget-holder-auto-assignment-first-login" id="toc-budget-holder-auto-assignment-first-login" class="nav-link" data-scroll-target="#budget-holder-auto-assignment-first-login"><span class="header-section-number">14.3</span> Budget holder auto-assignment (first login)</a></li>
  </ul></li>
  </ul>
</nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Server Preparations</h1>
</div>


<div class="quarto-title-meta-author">
  <div class="quarto-title-meta-heading">Author</div>
  <div class="quarto-title-meta-heading">Affiliation</div>
  
    <div class="quarto-title-meta-contents">
    <p class="author">Assa Yeroslaviz <a href="mailto:yeroslaviz@biochem.mpg.de" class="quarto-title-author-email"><i class="bi bi-envelope"></i></a> <a href="https://orcid.org/0000-0001-9638-4026" class="quarto-title-author-orcid"> <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA2ZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDo1N0NEMjA4MDI1MjA2ODExOTk0QzkzNTEzRjZEQTg1NyIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDozM0NDOEJGNEZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDozM0NDOEJGM0ZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M1IE1hY2ludG9zaCI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOkZDN0YxMTc0MDcyMDY4MTE5NUZFRDc5MUM2MUUwNEREIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjU3Q0QyMDgwMjUyMDY4MTE5OTRDOTM1MTNGNkRBODU3Ii8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+84NovQAAAR1JREFUeNpiZEADy85ZJgCpeCB2QJM6AMQLo4yOL0AWZETSqACk1gOxAQN+cAGIA4EGPQBxmJA0nwdpjjQ8xqArmczw5tMHXAaALDgP1QMxAGqzAAPxQACqh4ER6uf5MBlkm0X4EGayMfMw/Pr7Bd2gRBZogMFBrv01hisv5jLsv9nLAPIOMnjy8RDDyYctyAbFM2EJbRQw+aAWw/LzVgx7b+cwCHKqMhjJFCBLOzAR6+lXX84xnHjYyqAo5IUizkRCwIENQQckGSDGY4TVgAPEaraQr2a4/24bSuoExcJCfAEJihXkWDj3ZAKy9EJGaEo8T0QSxkjSwORsCAuDQCD+QILmD1A9kECEZgxDaEZhICIzGcIyEyOl2RkgwAAhkmC+eAm0TAAAAABJRU5ErkJggg=="></a></p>
  </div>
    <div class="quarto-title-meta-contents">
        <p class="affiliation">
            Max-Planck-Institute for Biochemistry
          </p>
      </div>
    </div>

<div class="quarto-title-meta">

      
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">February 9, 2026</p>
    </div>
  </div>
  
    
  </div>
  
<div>
  <div class="abstract">
    <div class="block-title">Abstract</div>
    <p>t.b.d.</p>
  </div>
</div>

<div>
  <div class="keywords">
    <div class="block-title">Keywords</div>
    <p>RNA-Seq, transcriptomics, P405, Marion, Peter, AG Murray</p>
  </div>
</div>

</header>

<section id="server-infrastructure" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> Server Infrastructure</h1>
<section id="install-required-system-dependencies" class="level2" data-number="1.1">
<h2 data-number="1.1" class="anchored" data-anchor-id="install-required-system-dependencies"><span class="header-section-number">1.1</span> Install required system dependencies</h2>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> apt install <span class="at">-y</span> libssl-dev libxml2-dev libcurl4-openssl-dev libudunits2-dev libgdal-dev</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="setting-environment-variables" class="level2" data-number="1.2">
<h2 data-number="1.2" class="anchored" data-anchor-id="setting-environment-variables"><span class="header-section-number">1.2</span> Setting Environment variables</h2>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="co"># /var/shiny-server/.Renviron</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="va">TZ</span><span class="op">=</span>Europe/Berlin</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="va">LANG</span><span class="op">=</span>en_US.UTF-8</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="va">LC_ALL</span><span class="op">=</span>en_US.UTF-8</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="install-shiny-app" class="level2" data-number="1.3">
<h2 data-number="1.3" class="anchored" data-anchor-id="install-shiny-app"><span class="header-section-number">1.3</span> Install shiny app</h2>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Install Shiny Server on Ubuntu</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> apt update</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> apt install <span class="at">-y</span> r-base nginx</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> apt install <span class="at">-y</span> libfontconfig1-dev libfreetype6-dev libpng-dev libtiff5-dev <span class="dt">\</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>    libjpeg-dev build-essential pkg-config libharfbuzz-dev libfribidi-dev</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> apt install <span class="at">-y</span> libldap2-dev libsasl2-dev</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> su <span class="at">-</span> <span class="at">-c</span> <span class="st">"R -e </span><span class="dt">\"</span><span class="st">install.packages('shiny')</span><span class="dt">\"</span><span class="st">"</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> su <span class="at">-</span> <span class="at">-c</span> <span class="st">"R -e </span><span class="dt">\"</span><span class="st">install.packages('shinyjs')</span><span class="dt">\"</span><span class="st">"</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a><span class="co"># ... install all your R packages</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> R <span class="at">-e</span> <span class="st">"install.packages(c('shiny', 'shinyjs', 'DBI', 'RSQLite', 'digest', 'DT', 'shinyWidgets', 'mailR'))"</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a><span class="co"># these two packages were added later on for the connection of the app to the LDAP server</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> R <span class="at">-e</span> <span class="st">"install.packages(c('devtools'))"</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> R <span class="at">-e</span> <span class="st">"devtools::install_github('liamgilbey/ldapr')"</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Download and install Shiny Server</span></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a><span class="fu">wget</span> https://download3.rstudio.org/ubuntu-20.04/x86_64/shiny-server-1.5.23.1030-amd64.deb</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> gdebi shiny-server-1.5.23.1030-amd64.deb</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="changing-hostname-to-fit-the-apache2-config-file" class="level2" data-number="1.4">
<h2 data-number="1.4" class="anchored" data-anchor-id="changing-hostname-to-fit-the-apache2-config-file"><span class="header-section-number">1.4</span> Changing hostname to fit the apache2 config file</h2>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Change the hostname</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> hostnamectl set-hostname ngs-testing-vm.biochem.mpg.de</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Verify the change</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="ex">hostnamectl</span> status</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="ex">nslookup</span> ngs-testing-vm.biochem.mpg.de</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ping</span> ngs-testing-vm.biochem.mpg.de</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<pre><code>Server:     127.0.0.53
Address:    127.0.0.53#53

Non-authoritative answer:
Name:   ngs-testing-vm.biochem.mpg.de
Address: 10.33.0.60

PING ngs-testing-vm.biochem.mpg.de (10.33.0.60) 56(84) bytes of data.
64 bytes from ngs-testing-vm.biochem.mpg.de (10.33.0.60): icmp_seq=1 ttl=64 time=0.079 ms
64 bytes from ngs-testing-vm.biochem.mpg.de (10.33.0.60): icmp_seq=2 ttl=64 time=0.074 ms</code></pre>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> systemctl restart apache2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="automatic-start-up" class="level2" data-number="1.5">
<h2 data-number="1.5" class="anchored" data-anchor-id="automatic-start-up"><span class="header-section-number">1.5</span> Automatic start-up</h2>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> systemctl enable apache2</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> systemctl enable shiny-server</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
</section>
<section id="monitoring" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> Monitoring</h1>
<p>The shiny app server writes log files specific with date and time in the <code>/var/log/shiny-server</code> folder.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Monitor Shiny Server logs</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> tail <span class="at">-f</span> /var/log/shiny-server/sequencing-app<span class="pp">*</span>.log</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Monitor Apache logs</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> tail <span class="at">-f</span> /var/log/apache2/sequencing-app-error.log</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="regular-backups" class="level1" data-number="3">
<h1 data-number="3"><span class="header-section-number">3</span> Regular backups</h1>
<p>The VM is regularly back-up every night. The SQL database backup setting are in the script, but for now commented out, as we’re not in productive version.</p>
<section id="cron-job-for-data-base-backup" class="level2" data-number="3.1">
<h2 data-number="3.1" class="anchored" data-anchor-id="cron-job-for-data-base-backup"><span class="header-section-number">3.1</span> cron job for data base backup</h2>
<p>If needed, we can also set up a cron job to backup the data base</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Create backup script</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> tee /usr/local/bin/backup_sequencing_db.sh <span class="op">&lt;&lt;'EOF'</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="st">#!/bin/bash</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="st">TIMESTAMP=$(date +%Y%m%d_%H%M%S)</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a><span class="st">BACKUP_DIR="/var/backups/sequencing-app"</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a><span class="st">mkdir -p $BACKUP_DIR</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a><span class="st">cp /srv/shiny-server/sequencing-app/sequencing_projects.db $BACKUP_DIR/sequencing_projects.db.$TIMESTAMP</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a><span class="st"># Keep only last 30 days of backups</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a><span class="st">find $BACKUP_DIR -name "sequencing_projects.db.*" -mtime +30 -delete</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a><span class="op">EOF</span></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> chmod +x /usr/local/bin/backup_sequencing_db.sh</span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Add to crontab for daily backups at 2 AM</span></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> crontab <span class="at">-l</span> <span class="kw">|</span> <span class="kw">{</span> <span class="fu">cat</span><span class="kw">;</span> <span class="bu">echo</span> <span class="st">"0 2 * * * /usr/local/bin/backup_sequencing_db.sh"</span><span class="kw">;</span> <span class="kw">}</span> <span class="kw">|</span> <span class="fu">sudo</span> crontab <span class="at">-</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
</section>
<section id="create-clean-apache-configuration" class="level1" data-number="4">
<h1 data-number="4"><span class="header-section-number">4</span> Create Clean Apache Configuration</h1>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;</span>VirtualHost <span class="ex">*:80</span><span class="op">&gt;</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>    <span class="ex">ServerName</span> ngs-testing-vm</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>    <span class="ex">ServerAlias</span> ngs-testing-vm.biochem.mpg.de</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Redirect all HTTP traffic to HTTPS</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>    <span class="ex">Redirect</span> permanent / https://ngs-testing-vm/</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;</span>/VirtualHost<span class="op">&gt;</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;</span>VirtualHost <span class="ex">*:443</span><span class="op">&gt;</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>    <span class="ex">ServerName</span> ngs-testing-vm</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>    <span class="ex">ServerAlias</span> ngs-testing-vm.biochem.mpg.de</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># SSL Configuration</span></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>    <span class="ex">SSLEngine</span> on</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>    <span class="ex">SSLCertificateFile</span> /etc/ssl/certs/2026_NGS_Cert.pem</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>    <span class="ex">SSLCertificateKeyFile</span> /etc/ssl/private/2026_private-key.pem</span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>    <span class="ex">SSLCertificateChainFile</span> /etc/apache2/certificate/2026/NGS_2026_Issuer_ChainFile.cer</span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Modern SSL configuration</span></span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>    <span class="ex">SSLProtocol</span> all <span class="at">-SSLv3</span> <span class="at">-TLSv1</span> <span class="at">-TLSv1.1</span></span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>    <span class="ex">SSLCipherSuite</span> ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384</span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>    <span class="ex">SSLHonorCipherOrder</span> off</span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Reverse proxy for Shiny app</span></span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a>    <span class="ex">ProxyPreserveHost</span> On</span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a>    <span class="ex">ProxyRequests</span> Off</span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a>    <span class="ex">ProxyPass</span> / http://localhost:3838/sequencing-app/</span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a>    <span class="ex">ProxyPassReverse</span> / http://localhost:3838/sequencing-app/</span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a>    <span class="co"># WebSocket support</span></span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a>    <span class="ex">RewriteEngine</span> on</span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a>    <span class="ex">RewriteCond</span> %{HTTP:Upgrade} websocket <span class="pp">[</span><span class="ss">NC</span><span class="pp">]</span></span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a>    <span class="ex">RewriteCond</span> %{HTTP:Connection} upgrade <span class="pp">[</span><span class="ss">NC</span><span class="pp">]</span></span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true" tabindex="-1"></a>    <span class="ex">RewriteRule</span> ^/<span class="er">(</span><span class="bu">.</span><span class="pp">*</span><span class="kw">)</span> <span class="st">"ws://localhost:3838/sequencing-app/</span><span class="va">$1</span><span class="st">"</span> <span class="pp">[</span><span class="ss">P,L</span><span class="pp">]</span></span>
<span id="cb11-34"><a href="#cb11-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-35"><a href="#cb11-35" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Security headers</span></span>
<span id="cb11-36"><a href="#cb11-36" aria-hidden="true" tabindex="-1"></a>    <span class="ex">Header</span> always set Strict-Transport-Security <span class="st">"max-age=63072000; includeSubDomains"</span></span>
<span id="cb11-37"><a href="#cb11-37" aria-hidden="true" tabindex="-1"></a>    <span class="ex">Header</span> always set X-Content-Type-Options nosniff</span>
<span id="cb11-38"><a href="#cb11-38" aria-hidden="true" tabindex="-1"></a>    <span class="ex">Header</span> always set X-Frame-Options SAMEORIGIN</span>
<span id="cb11-39"><a href="#cb11-39" aria-hidden="true" tabindex="-1"></a>    <span class="ex">Header</span> always set Referrer-Policy <span class="st">"strict-origin-when-cross-origin"</span></span>
<span id="cb11-40"><a href="#cb11-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-41"><a href="#cb11-41" aria-hidden="true" tabindex="-1"></a>    <span class="ex">ErrorLog</span> <span class="va">${APACHE_LOG_DIR}</span>/sequencing-app-ssl-error.log</span>
<span id="cb11-42"><a href="#cb11-42" aria-hidden="true" tabindex="-1"></a>    <span class="ex">CustomLog</span> <span class="va">${APACHE_LOG_DIR}</span>/sequencing-app-ssl-access.log combined</span>
<span id="cb11-43"><a href="#cb11-43" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;</span>/VirtualHost<span class="op">&gt;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="required-server-setup" class="level1" data-number="5">
<h1 data-number="5"><span class="header-section-number">5</span> Required Server Setup</h1>
<pre><code>/var/shiny-server/
├── sequencing-app/
│ ├── app.R
│ ├── setup_database.R
│ ├── sequencing_projects.db
│ └── www/
  │ ├── logo.png
  │ └── minerva.png</code></pre>
</section>
<section id="github-repository" class="level1" data-number="6">
<h1 data-number="6"><span class="header-section-number">6</span> Github repository</h1>
<section id="step-1-generate-ssh-keys" class="level2" data-number="6.1">
<h2 data-number="6.1" class="anchored" data-anchor-id="step-1-generate-ssh-keys"><span class="header-section-number">6.1</span> Step 1: Generate SSH keys</h2>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="co"># on the local machine (mac mini at work!!!)</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> ~/.ssh/</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="fu">ssh-keygen</span> <span class="at">-t</span> ed25519 <span class="at">-C</span> <span class="st">"yeroslaviz@biochem.mpg.de"</span> <span class="at">-f</span> ngs-testing-vm.id_macMini_rsa</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a><span class="co"># on the VM</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> ~/.ssh/</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a><span class="fu">ssh-keygen</span> <span class="at">-t</span> ed25519 <span class="at">-C</span> <span class="st">"yeroslaviz@biochem.mpg.de"</span> <span class="at">-f</span> ngs-testing-vm.id_rsa</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>If agent needs to be activated</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="bu">eval</span> <span class="st">"</span><span class="va">$(</span><span class="fu">ssh-agent</span> <span class="at">-s</span><span class="va">)</span><span class="st">"</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ssh-add</span> ~/.ssh/ngs-testing-vm.id_rsa <span class="co"># or the name of the local key</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="add-both-keys-to-the-github-repository" class="level2" data-number="6.2">
<h2 data-number="6.2" class="anchored" data-anchor-id="add-both-keys-to-the-github-repository"><span class="header-section-number">6.2</span> Add both keys to the github repository</h2>
<p>Copy for each of the two keys the <code>*pub</code> version and add it under <code>Settings → SSH and GPG keys → New SSH key</code>.</p>
</section>
<section id="make-sure-we-clone-using-ssh-not-html" class="level2" data-number="6.3">
<h2 data-number="6.3" class="anchored" data-anchor-id="make-sure-we-clone-using-ssh-not-html"><span class="header-section-number">6.3</span> Make sure we clone using ssh (not html)</h2>
<p>First test if the connection exists already.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> remote <span class="at">-v</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>If the result is</p>
<pre><code>origin  https://github.com/username/repository.git (fetch)
origin  https://github.com/username/repository.git (push)</code></pre>
<p>it must be changed to ssh</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> remote set-url origin git@github.com:username/repository.git</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>If we see</p>
<pre><code>origin  git@github.com:yeroslaviz/BCFNGS-project-management.git (fetch)
origin  git@github.com:yeroslaviz/BCFNGS-project-management.git (push)</code></pre>
<p>then we already use ssh.</p>
</section>
<section id="test-and-check-the-connection" class="level2" data-number="6.4">
<h2 data-number="6.4" class="anchored" data-anchor-id="test-and-check-the-connection"><span class="header-section-number">6.4</span> Test and check the connection</h2>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ssh</span> <span class="at">-T</span> git@github.com</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>this should return something like</p>
<pre><code>Hi yeroslaviz! You've successfully authenticated, but GitHub does not provide shell access.</code></pre>
</section>
<section id="pullingpushing" class="level2" data-number="6.5">
<h2 data-number="6.5" class="anchored" data-anchor-id="pullingpushing"><span class="header-section-number">6.5</span> Pulling/Pushing</h2>
<p>the repository can be managed from the path <code>/home/yeroslaviz/BCFNGS-project-management</code> (the VM path is mentioned here).</p>
<pre><code>$ tree -L 1
.
├── BCFNGS-project-management
├── chemata
├── miniconda3
└── scripts
    └── deploy_shiny_server.sh</code></pre>
<p>inside the Folder we can pull/push the changes we made to the repo from the local computer (AT WORK!!!).</p>
<p>the github repository on the local computer is at <code>/Documents/GitHub/BCFNGS-project-management</code>.</p>
<p>To redeploy the server, one follows the following steps:</p>
<ol type="1">
<li>make the changes on the local computer (AT WORK!!!).</li>
<li><strong>commit</strong> and <strong>push</strong> the changes to the github repo</li>
<li>go to the folder <code>/home/yeroslaviz/BCFNGS-project-management</code> on the VM <code>ngs-testing-vm</code> and pull the changes.</li>
<li>Execute the <code>deploy_shiny_server.sh</code> script to copy the new changes to the shiny-server folder and restart both apache2 and the shiny-server. ## git pull</li>
</ol>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a> <span class="fu">git</span> pull origin main</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Username for 'https://github.com': yeroslaviz</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Password for 'https://yeroslaviz@github.com':  HERE WE MUST INPUT THE PAT from above!!!</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a> <span class="ex">...</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="vm-rollout-howto-git-deploy-safety" class="level2" data-number="6.6">
<h2 data-number="6.6" class="anchored" data-anchor-id="vm-rollout-howto-git-deploy-safety"><span class="header-section-number">6.6</span> VM rollout HOW‑TO (Git + deploy + safety)</h2>
<p>This is the repeatable checklist I use when rolling out to a VM (first <code>ngs-testing-vm</code>, then <code>ngs-vm</code>).</p>
<section id="make-sure-github-access-works-on-the-vm" class="level3" data-number="6.6.1">
<h3 data-number="6.6.1" class="anchored" data-anchor-id="make-sure-github-access-works-on-the-vm"><span class="header-section-number">6.6.1</span> 1) Make sure GitHub access works on the VM</h3>
<p>Check which remote is set:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> <span class="at">-C</span> /home/yeroslaviz/BCFNGS-project-management remote <span class="at">-v</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>If the remote is SSH (<code>git@github.com:...</code>), verify SSH access:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ssh</span> <span class="at">-T</span> git@github.com</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>If SSH works but <code>git pull</code> still says <strong>Permission denied (publickey)</strong>, the VM key is <strong>not added</strong> to the repo. The fix is to add the VM public key as a <strong>Deploy Key</strong>:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span> ~/.ssh/id_ed25519.pub</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Then add that key in GitHub: <code>Repo → Settings → Deploy keys → Add deploy key</code> (read‑only is enough for pull).</p>
</section>
<section id="pull-latest-code" class="level3" data-number="6.6.2">
<h3 data-number="6.6.2" class="anchored" data-anchor-id="pull-latest-code"><span class="header-section-number">6.6.2</span> 2) Pull latest code</h3>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> /home/yeroslaviz/BCFNGS-project-management</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> pull origin main</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>If Git says <strong>divergent branches</strong>, I set merge as the default and pull again:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> config pull.rebase false</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> pull origin main</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>If Git refuses because of the local SQLite DB file, I stop tracking the DB on the VM:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> rm <span class="at">--cached</span> sequencing-app/sequencing_projects.db</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> commit <span class="at">-m</span> <span class="st">"Stop tracking local SQLite DB on VM"</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> pull origin main</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>This does <strong>not</strong> delete the local DB file. It just removes it from Git so future pulls work.</p>
</section>
<section id="production-safety-backups-fast-rollback" class="level3" data-number="6.6.3">
<h3 data-number="6.6.3" class="anchored" data-anchor-id="production-safety-backups-fast-rollback"><span class="header-section-number">6.6.3</span> 3) Production safety backups (fast rollback)</h3>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> rsync <span class="at">-av</span> /srv/shiny-server/sequencing-app/ /srv/shiny-server/sequencing-app.backup_<span class="va">$(</span><span class="fu">date</span> +%Y%m%d_%H%M<span class="va">)</span>/</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cp</span> /srv/shiny-server/sequencing-app/sequencing_projects.db <span class="dt">\</span></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>  /srv/shiny-server/sequencing-app/sequencing_projects.db.backup_<span class="va">$(</span><span class="fu">date</span> +%Y%m%d_%H%M<span class="va">)</span></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> cp /etc/apache2/sites-enabled/01-main.conf <span class="dt">\</span></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>  /etc/apache2/sites-enabled/01-main.conf.backup_<span class="va">$(</span><span class="fu">date</span> +%Y%m%d_%H%M<span class="va">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="deploy" class="level3" data-number="6.6.4">
<h3 data-number="6.6.4" class="anchored" data-anchor-id="deploy"><span class="header-section-number">6.6.4</span> 4) Deploy</h3>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="ex">./deploy.sh</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="restart-and-smoketest" class="level3" data-number="6.6.5">
<h3 data-number="6.6.5" class="anchored" data-anchor-id="restart-and-smoketest"><span class="header-section-number">6.6.5</span> 5) Restart and smoke‑test</h3>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> systemctl restart shiny-server</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> systemctl restart apache2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Then open the app URL and verify: - LDAP prompt appears - login works - app loads</p>
</section>
<section id="rollback-if-needed" class="level3" data-number="6.6.6">
<h3 data-number="6.6.6" class="anchored" data-anchor-id="rollback-if-needed"><span class="header-section-number">6.6.6</span> 6) Rollback (if needed)</h3>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> rsync <span class="at">-av</span> <span class="at">--delete</span> /srv/shiny-server/sequencing-app.backup_YYYYMMDD_HHMM/ /srv/shiny-server/sequencing-app/</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> systemctl restart shiny-server</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> systemctl restart apache2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
</section>
</section>
<section id="security" class="level1" data-number="7">
<h1 data-number="7"><span class="header-section-number">7</span> Security</h1>
<p>Not sure, if this is all necessary, will consult the IT when it is appropriate</p>
<section id="backup-older-settings" class="level2" data-number="7.1">
<h2 data-number="7.1" class="anchored" data-anchor-id="backup-older-settings"><span class="header-section-number">7.1</span> Backup older settings</h2>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Backup your current configuration</span></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> cp /etc/apache2/sites-enabled/01-main.conf /etc/apache2/sites-enabled/01-main.conf.backup</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Remove old SSL certificates (optional - keep for backup)</span></span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> mkdir <span class="at">-p</span> /etc/ssl/backup/</span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> mv /etc/ssl/certs/<span class="pp">********</span>.pem /etc/ssl/backup/</span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> mv /etc/ssl/private/<span class="pp">********</span>.pem /etc/ssl/backup/</span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> mv /etc/apache2/certificate/<span class="pp">********</span>.cer /etc/ssl/backup/</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<pre><code>./
├── 01-main.conf -&gt; ../sites-available/default-ssl.conf
├── 01-main.conf.backup
├── 02-testing.conf -&gt; ../sites-available/02-testing.conf
└── auth_ldap.conf -&gt; ../sites-available/auth_ldap.conf</code></pre>
</section>
<section id="applying-for-a-new-certificate-from-mpimpg" class="level2" data-number="7.2">
<h2 data-number="7.2" class="anchored" data-anchor-id="applying-for-a-new-certificate-from-mpimpg"><span class="header-section-number">7.2</span> Applying for a new certificate from MPI/MPG</h2>
<p>The new setting of the certificates. I have three files.</p>
<p>The private key I created when applying for the certificate. The other two were downloaded, when the emial came from Harica (the certificate provider).</p>
<p>the <code>PEM</code> is the pem file and the <code>DER (issuer)</code> is the chain file. Both of them are needed.</p>
<p>Setting for the readability of the files:</p>
<pre><code>cd /etc/apache2/certificate/2026
-rw------- 1 yeroslaviz b_mcf 3272 Nov 10 15:58 private-key.pem # udo chmod 600 /path/to/private.key  # Readable only by root
-rw-r--r-- 1 yeroslaviz b_mcf 1545 Nov 14 12:12 NGS_2026_Issuer_ChainFile.cer # sudo chmod 644 /path/to/chain.crt  # Readable by all
-rw-r--r-- 1 yeroslaviz b_mcf 2796 Nov 14 12:34 NGS_2026_Cert.pem # sudo chmod 644 /path/to/certificate.crt # Readable by all</code></pre>
<p>All the files are saved under <code>/etc/apache2/certificate/2026</code>.</p>
<p>Now I created soft links for each of these files.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> ln <span class="at">-s</span> /etc/apache2/certificate/2026/private-key.pem /etc/ssl/private/2026_private-key.pem</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> ln <span class="at">-s</span> /etc/apache2/certificate/2026/NGS_2026_Cert.pem /etc/ssl/certs/2026_NGS_Cert.pem</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="dedicated-user" class="level2" data-number="7.3">
<h2 data-number="7.3" class="anchored" data-anchor-id="dedicated-user"><span class="header-section-number">7.3</span> dedicated User</h2>
<p>As we’re planning to use the LDAP, I’m not sure, this is necessary. I need a method to add specific users as admin</p>
</section>
<section id="firewall" class="level2" data-number="7.4">
<h2 data-number="7.4" class="anchored" data-anchor-id="firewall"><span class="header-section-number">7.4</span> Firewall</h2>
<p>at the moment is not active, but maybe in the future.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> ufw allow 3838</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> ufw allow 80</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> ufw allow 443</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
</section>
<section id="change-connection-to-shiny-server-folder-to-https" class="level1" data-number="8">
<h1 data-number="8"><span class="header-section-number">8</span> Change connection to shiny server folder to https</h1>
<p>The shiny app takes information from the config file under <code>/etc/shiny-server/shiny-server.conf</code>. Here we can see where the log files are written into and where the directory of the shiny app are stored.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> usermod <span class="at">-a</span> <span class="at">-G</span> shiny <span class="va">$USER</span> <span class="co"># add user yeroslaviz to group shiny</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> chown <span class="at">-R</span> <span class="va">$USER</span>:shiny sequencing-app/ <span class="co"># make group shiny able to execute the scripts in the folder</span></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> mv /srv/shiny-server/sequencing-app/ /srv/shiny-server/sequencing-app.backup <span class="co"># move the actual hard-coded folder to a backup (just in case)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>The sequencing-app folder must be copied to the correct place after each modification was done and the new files were pulled to the VM.</p>
<p>For that I have created a script called <code>deploy.sh</code>. The script synchronizes the files from the github repo folder <code>/home/yeroslaviz/BCFNGS-project-management/sequencing-app/</code> to where the Shiny app needs them to be: <code>/srv/shiny-server/sequencing-app/</code>.</p>
<p>The deploy script must be activated when loaded</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="fu">chmod</span> +x deploy.sh</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>The deploy.sh script uses <code>rsync</code> and <strong>excludes</strong> <code>sequencing_projects.db</code> so the production database is not overwritten during deploys.</p>
<p>If <code>rsync</code> is not installed on the VM:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> apt install <span class="at">-y</span> rsync</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>It then resets permissions for all files (the DB file remains in place and keeps its permissions).</p>
<p>When this is done, it restart the shiny server.</p>
<p><strong>This script must be run each time the files inside the sequencing-app folder were changed</strong>, but not if other changed were made in the repo.</p>
</section>
<section id="changes-on-09.02.2026" class="level1" data-number="9">
<h1 data-number="9"><span class="header-section-number">9</span> Changes on 09.02.2026</h1>
<ol type="1">
<li>Added a VM rollout HOW‑TO (GitHub SSH/deploy keys, divergent branches, DB tracking fix, backups, deploy, restart, rollback).</li>
<li>Documented production safeguards (app folder backup, DB backup, Apache config backup).</li>
<li>Updated <code>deploy.sh</code> to restart Shiny only if <code>rsync</code> succeeds (prevents restarts on failed deploys).</li>
<li>Cleaned up Apache LDAP logging (default to quiet logs; debug only when explicitly enabled).</li>
<li>Made LDAP debug output in the Shiny app conditional on <strong>both</strong> <code>APP_ENV=dev</code> and <code>LDAP_DEBUG=1</code> to avoid production log noise.</li>
<li>Documented the VM LDAP validation test (real user + service group user, and email routing behavior).</li>
</ol>
<section id="vm-rollout-validation-what-i-tested-and-confirmed" class="level2" data-number="9.1">
<h2 data-number="9.1" class="anchored" data-anchor-id="vm-rollout-validation-what-i-tested-and-confirmed"><span class="header-section-number">9.1</span> VM rollout validation (what I tested and confirmed)</h2>
<p>I verified end‑to‑end behavior on the VM after fixing the Apache proxy path:</p>
<ul>
<li><strong>LDAP login works</strong>: the browser prompts for username/password and redirects to <code>/sequencing-app/?auth_user=&lt;user&gt;</code>.</li>
<li><strong>User mapping works</strong>: <code>yeroslaviz</code> (OU contains Cox) is mapped to the <strong>Cox</strong> group and the correct PI.</li>
<li><strong>User mapping works</strong>: <code>yeroslaviz-test</code> (OU = <strong>NGS Facility</strong>) is treated as a service‑group user (no PI match).</li>
<li><strong>Email routing works</strong>: research group users trigger mail to the PI <strong>and</strong> NGS.</li>
<li><strong>Email routing works</strong>: service group users (no PI match) trigger mail to the <strong>administrator</strong>.</li>
</ul>
<p>If all three happen, the LDAP→app→email flow is working as intended.</p>
</section>
</section>
<section id="possible-errors-and-fixes-vm-ldap-rollout" class="level1" data-number="10">
<h1 data-number="10"><span class="header-section-number">10</span> Possible errors and fixes (VM LDAP rollout)</h1>
<p>This section captures the real errors I hit during the VM rollout and the fixes that worked. It is meant as a troubleshooting reference.</p>
<section id="apache-wont-restart-after-ldap-change" class="level2" data-number="10.1">
<h2 data-number="10.1" class="anchored" data-anchor-id="apache-wont-restart-after-ldap-change"><span class="header-section-number">10.1</span> 1) Apache won’t restart after LDAP change</h2>
<p><strong>Symptom</strong></p>
<pre><code>AH00526: Syntax error ... Bad LDAP URL while parsing.</code></pre>
<p><strong>Cause</strong></p>
<p>Apache’s <code>AuthLDAPURL</code> is very strict. Each URL must be complete (host + base DN + query), and some Apache builds don’t accept multiple URLs in a single directive.</p>
<p><strong>Fix</strong></p>
<p>Use a single server (most stable on my VM):</p>
<pre><code>AuthLDAPURL "ldaps://ldapserv1.biochem.mpg.de:636/dc=biochem,dc=mpg,dc=de?uid?sub?(objectClass=posixAccount)"</code></pre>
<p>If the multi‑server line fails, I keep one server and fall back manually if needed.</p>
</section>
<section id="ldaptls_cacertdir-breaks-apache" class="level2" data-number="10.2">
<h2 data-number="10.2" class="anchored" data-anchor-id="ldaptls_cacertdir-breaks-apache"><span class="header-section-number">10.2</span> 2) <code>LDAPTLS_CACERTDIR</code> breaks Apache</h2>
<p><strong>Symptom</strong></p>
<pre><code>Invalid command 'LDAPTLS_CACERTDIR'</code></pre>
<p><strong>Cause</strong></p>
<p><code>LDAPTLS_CACERTDIR</code> is <strong>not</strong> an Apache directive. It belongs to the OpenLDAP client config.</p>
<p><strong>Fix</strong></p>
<p>Remove it from Apache. If I need TLS trust, I configure it in <code>/etc/ldap/ldap.conf</code> instead.</p>
</section>
<section id="ldap-login-shows-500-internal-server-error" class="level2" data-number="10.3">
<h2 data-number="10.3" class="anchored" data-anchor-id="ldap-login-shows-500-internal-server-error"><span class="header-section-number">10.3</span> 3) LDAP login shows 500 Internal Server Error</h2>
<p><strong>Symptom</strong></p>
<ul>
<li>Browser shows <code>Internal Server Error</code></li>
<li>Apache log shows:</li>
</ul>
<pre><code>ldap_simple_bind() failed][Can't contact LDAP server]</code></pre>
<p><strong>Cause</strong></p>
<p>LDAP TLS handshake fails (certificate trust not configured).</p>
<p><strong>Fix</strong></p>
<ol type="1">
<li>Confirm port reachability:</li>
</ol>
<pre><code>nc -vz ldapserv1.biochem.mpg.de 636</code></pre>
<ol start="2" type="1">
<li>Test LDAP with <strong>TLS bypass</strong> to confirm trust problem:</li>
</ol>
<pre><code>LDAPTLS_REQCERT=never ldapsearch -x -H ldaps://ldapserv1.biochem.mpg.de:636 \
  -b "dc=biochem,dc=mpg,dc=de" "(uid=USER)" mail</code></pre>
<ol start="3" type="1">
<li>Fix trust in <code>/etc/ldap/ldap.conf</code>:</li>
</ol>
<pre><code>TLS_CACERTDIR /etc/ssl/certs</code></pre>
<p><strong>Important:</strong> I had a typo (<code>TLS_CACERETDIR</code>) which prevented TLS trust from loading. Fixing the spelling made LDAP work.</p>
<ol start="4" type="1">
<li>Verify normal LDAP now works:</li>
</ol>
<pre><code>ldapsearch -x -H ldaps://ldapserv1.biochem.mpg.de:636 \
  -b "dc=biochem,dc=mpg,dc=de" "(uid=USER)" mail</code></pre>
<p>Then restart Apache:</p>
<pre><code>sudo systemctl restart apache2</code></pre>
</section>
<section id="shiny-app-runs-locally-but-crashes-via-apache" class="level2" data-number="10.4">
<h2 data-number="10.4" class="anchored" data-anchor-id="shiny-app-runs-locally-but-crashes-via-apache"><span class="header-section-number">10.4</span> 4) Shiny app runs locally but crashes via Apache</h2>
<p><strong>Symptom</strong></p>
<ul>
<li>App works with <code>shiny::runApp()</code></li>
<li>But Apache shows 500 and Shiny worker terminates</li>
</ul>
<p><strong>Cause</strong></p>
<p>LDAP authentication failure in Apache (not an app crash).</p>
<p><strong>Fix</strong></p>
<p>Check Apache log for <code>authnz_ldap</code> errors and fix TLS trust as above.</p>
</section>
<section id="ldap-works-but-sequencing-app-returns-404" class="level2" data-number="10.5">
<h2 data-number="10.5" class="anchored" data-anchor-id="ldap-works-but-sequencing-app-returns-404"><span class="header-section-number">10.5</span> 5) LDAP works, but <code>/sequencing-app/</code> returns 404</h2>
<p><strong>Symptom</strong></p>
<ul>
<li><code>curl -Ik -u USER https://host/sequencing-app/</code> returns <strong>404</strong></li>
<li><code>curl -I http://localhost:3838/sequencing-app/</code> returns <strong>200</strong></li>
</ul>
<p><strong>Cause</strong></p>
<p>Apache is proxying the wrong path (often due to an older <code>ProxyPass /</code> rule or a backup file in <code>sites-enabled</code>).</p>
<p><strong>Fix</strong></p>
<ol type="1">
<li>Ensure <strong>only</strong> these lines exist in the active config:</li>
</ol>
<pre><code>ProxyPass /sequencing-app/ http://localhost:3838/sequencing-app/
ProxyPassReverse /sequencing-app/ http://localhost:3838/sequencing-app/</code></pre>
<ol start="2" type="1">
<li>Remove or move any backup config files out of <code>/etc/apache2/sites-enabled</code> (Apache can accidentally parse them).</li>
<li>Restart Apache:</li>
</ol>
<pre><code>sudo apache2ctl -t
sudo systemctl restart apache2</code></pre>
</section>
<section id="debug-logging-too-noisy-apache-or-shiny" class="level2" data-number="10.6">
<h2 data-number="10.6" class="anchored" data-anchor-id="debug-logging-too-noisy-apache-or-shiny"><span class="header-section-number">10.6</span> 6) Debug logging too noisy (Apache or Shiny)</h2>
<p><strong>Symptom</strong></p>
<p>Lots of LDAP debug output in logs during normal use.</p>
<p><strong>Fix (Apache)</strong></p>
<p>In <code>01-main.conf</code>, use normal logging:</p>
<pre><code>LogLevel warn
# LogLevel authnz_ldap:debug ldap:debug   # enable only when debugging</code></pre>
<p><strong>Fix (Shiny app)</strong></p>
<p>The app only prints LDAP debug logs when <strong>both</strong> are set:</p>
<ul>
<li><code>APP_ENV=dev</code></li>
<li><code>LDAP_DEBUG=1</code></li>
</ul>
<p>So for production:</p>
<ul>
<li>Remove <code>LDAP_DEBUG=1</code> from <code>/home/shiny/.Renviron</code> (or set it to <code>0</code>).</li>
<li>Restart Shiny:</li>
</ul>
<pre><code>sudo systemctl restart shiny-server</code></pre>
<p>If I need debugging later, I can temporarily set:</p>
<pre><code>APP_ENV=dev
LDAP_DEBUG=1</code></pre>
<p>and restart the service again.</p>
</section>
<section id="comprehensive-errorchecking-checklist-vm-ldap-shiny" class="level2" data-number="10.7">
<h2 data-number="10.7" class="anchored" data-anchor-id="comprehensive-errorchecking-checklist-vm-ldap-shiny"><span class="header-section-number">10.7</span> Comprehensive error‑checking checklist (VM LDAP + Shiny)</h2>
<p>When something breaks, I run through this list in order:</p>
<ol type="1">
<li><strong>Apache syntax</strong></li>
</ol>
<pre><code>sudo apache2ctl -t</code></pre>
<ol start="2" type="1">
<li><strong>Which vhost is active</strong></li>
</ol>
<pre><code>sudo apache2ctl -S</code></pre>
<ol start="3" type="1">
<li><strong>Proxy path</strong></li>
</ol>
<pre><code>sudo grep -n "ProxyPass" -R /etc/apache2/sites-enabled /etc/apache2/conf-enabled</code></pre>
<ol start="4" type="1">
<li><strong>LDAP connectivity + TLS</strong></li>
</ol>
<pre><code>nc -vz ldapserv1.biochem.mpg.de 636
ldapsearch -x -H ldaps://ldapserv1.biochem.mpg.de:636 \
  -b "dc=biochem,dc=mpg,dc=de" "(uid=USER)" mail</code></pre>
<p>If that fails, verify <code>/etc/ldap/ldap.conf</code> has:</p>
<pre><code>TLS_CACERTDIR /etc/ssl/certs</code></pre>
<ol start="5" type="1">
<li><strong>LDAP auth prompt vs app redirect</strong></li>
</ol>
<pre><code>curl -Ik https://HOST/
curl -Ik -u USER https://HOST/</code></pre>
<p>Expected: 401 without user, 302 to <code>/sequencing-app/?auth_user=USER</code> with user.</p>
<ol start="6" type="1">
<li><strong>Shiny backend is reachable</strong></li>
</ol>
<pre><code>curl -I http://localhost:3838/sequencing-app/</code></pre>
<ol start="7" type="1">
<li><strong>Apache app path</strong></li>
</ol>
<pre><code>curl -Ik -u USER https://HOST/sequencing-app/</code></pre>
<ol start="8" type="1">
<li><strong>Shiny logs</strong></li>
</ol>
<pre><code>sudo ls -t /var/log/shiny-server/ | head -n 1
sudo tail -n 200 /var/log/shiny-server/FILE.log</code></pre>
<ol start="9" type="1">
<li><strong>Shiny environment variables</strong></li>
</ol>
<pre><code>sudo systemctl show shiny-server --property=Environment</code></pre>
<ol start="10" type="1">
<li><strong>Database permissions</strong></li>
</ol>
<pre><code>ls -l /srv/shiny-server/sequencing-app/sequencing_projects.db</code></pre>
<ol start="11" type="1">
<li><strong>Reload after config change</strong></li>
</ol>
<pre><code>sudo systemctl restart apache2
sudo systemctl restart shiny-server</code></pre>
</section>
</section>
<section id="changes-on-06.02.2026" class="level1" data-number="11">
<h1 data-number="11"><span class="header-section-number">11</span> Changes on 06.02.2026</h1>
<ol type="1">
<li>Added LDAP login flow in the Shiny app (auto‑login via <code>X-Remote-User</code>, local dev simulation, and optional attribute lookup).</li>
<li>LDAP attribute lookup now works with anonymous bind; uses <code>ldapsearch</code> fallback for older <code>ldapr</code> versions.</li>
<li>Added dev tools toggle (dev only) to switch between LDAP and local auth while testing.</li>
<li>Mapped LDAP <code>ou</code> values to budget holders, auto‑selecting the correct PI in the project form (with partial match fallback).</li>
<li>Added budget holder notices for multiple cost centers and missing cost center values.</li>
<li>Added “Other / not listed” budget holder option so users can enter a new PI (name/surname required; cost center optional with a warning).</li>
<li>Updated <code>deploy.sh</code> to use <code>rsync</code> and exclude <code>sequencing_projects.db</code>.</li>
<li>Updated Apache LDAP configuration template and added local dev testing instructions + env var cleanup.</li>
<li>I do <strong>not</strong> track SQLite DB files in git because they change constantly, are environment‑specific (local vs VM), and can contain sensitive data. I ignore <code>*.db</code>/<code>*.sqlite</code> and keep only the schema/seed files in git.</li>
</ol>
</section>
<section id="changes-on-14.11.2026" class="level1" data-number="12">
<h1 data-number="12"><span class="header-section-number">12</span> Changes on 14.11.2026</h1>
<ol type="1">
<li>I would Like you to show me where the admin email address can be changed, if I want to have a different user as admin. 1.1 Please show me the parts of the script where this can be changed.</li>
</ol>
<p>The admin password is set here:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Insert default admin user</span></span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a><span class="ex">default_password</span> <span class="op">&lt;</span>- digest::digest<span class="er">(</span><span class="st">"admin123"</span><span class="kw">)</span></span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a><span class="ex">dbExecute</span><span class="er">(</span><span class="ex">con,</span> <span class="st">"</span></span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a><span class="st">  INSERT OR IGNORE INTO users (username, password, email, is_admin)</span></span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a><span class="st">  VALUES ('admin', ?, 'yeroslaviz@biochem.mpg.de', 1)</span></span>
<span id="cb67-6"><a href="#cb67-6" aria-hidden="true" tabindex="-1"></a><span class="st">"</span>, params = list<span class="er">(</span><span class="ex">default_password</span><span class="kw">))</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>1.2 Can this be changed without recreating the whole databank or restart the app? 1.3 How do I change the admin email address without recreating the db?</p>
<p>This can be changed without recreating the database, using two options:</p>
<ul>
<li>Option 1: Direct database update</li>
</ul>
<p>Run this SQL command on your database:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a><span class="kw">UPDATE</span> users <span class="kw">SET</span> email <span class="op">=</span> <span class="st">'newadmin@institute.org'</span> <span class="kw">WHERE</span> username <span class="op">=</span> <span class="st">'admin'</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>To execute this, we can either log in directly to the database via the command line</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="ex">sqlite3</span> sequencing_projects.db</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>and execute</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="ex">UPDATE</span> users SET email = <span class="st">'newadmin@institute.org'</span> WHERE username = <span class="st">'admin'</span><span class="kw">;</span></span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a><span class="ex">.exit</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>or via the R pormpt:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(DBI)</span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(RSQLite)</span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a>con <span class="ot">&lt;-</span> <span class="fu">dbConnect</span>(RSQLite<span class="sc">::</span><span class="fu">SQLite</span>(), <span class="st">"sequencing_projects.db"</span>)</span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a><span class="fu">dbExecute</span>(con, <span class="st">"UPDATE users SET email = 'newadmin@institute.org' WHERE username = 'admin'"</span>)</span>
<span id="cb71-5"><a href="#cb71-5" aria-hidden="true" tabindex="-1"></a><span class="fu">dbDisconnect</span>(con)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p><strong>Don’t forget to modify the <code>setup_database_*.R</code> script afterwards, so these information will be also kept, if the database is recreated!</strong></p>
<ul>
<li>Option 2: Through the app’s user management (as admin)</li>
</ul>
<p>In the “Administer Projects” tab, one can click “Manage Users” and change (or add) the admin user and edit their email.</p>
<p>1.4 How can I turn on/off sending the notification mail to the admin, if not needed?</p>
<p>The admin notification email is sent in the <code>send_project_creation_email</code> function in the app file.</p>
<ol start="2" type="1">
<li>When creating a new project, an email is being sent. 2.1 can you please tell me to whome this email is being sent? 2.2 Can you show me the part of the script where it is set up? 2.3 Now, the Email should be sent to budget holder and to user, who created the project, as well as to the admin. Can this be changed easily, if needed?</li>
</ol>
<p>This was done also in point 1. The function <code>send_project_creation_email</code> set the users who gets an email, when a project is created. the row</p>
<pre><code>        to = c(budget_holder$email, user_email, admin_emails),</code></pre>
<p>set the recipient of the mail. we can remove one of the elements, or even just add a specific mail address to the <code>to =</code> row.</p>
<ol start="3" type="1">
<li>How do I make changes to the cost estimations w.o. Recreating the db? 3.1 Is it possible to modify existing columns, in case prices are changing? Or would deleting and making a new element would be easier? 3.2 If I change anything in these tables, Would it also change it in the SQL data base?</li>
</ol>
<p>At the moment the tables <code>Service types</code> and <code>Sequencing depths</code> are not editable. If prices change, the easiet option is to delete the row and recreate it using the new value. This way, the older projects will use the previous costs, while the new one will get the new costs.</p>
<p>One can also directly use the SQL commands to apply these chages, similar to above</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="ex">sqlite3</span> sequencing_projects.db</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>and execute</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="ex">UPDATE</span> service_types SET costs_per_sample = 55 WHERE service_type = <span class="st">'single cell/low mRNAseq'</span><span class="kw">;</span></span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a><span class="ex">.exit</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<ol start="4" type="1">
<li>something is wrong with the Sequencing Cycles Management table. When I run the app, go to the Admin projects Tab and click the Sequencing Cycles - Manage Cycles, I see this message: “Error: An error has occurred. Check your logs or contact the app author for clarification.” 4.1 which log files can I consult?</li>
</ol>
<p>When working on the server, the best place to look for problems are the log files of either the <code>apache2</code> (<code>/var/log/apache2/</code>) or the <code>shiny-server</code> (<code>/var/log/shiny-server/</code>).</p>
<ol start="5" type="1">
<li>Do I have a weekly&nbsp;backup of the SQL db?&nbsp;</li>
</ol>
<p>there is an app for a bi-weekly automaic backup. The function is for now commented out, so not working.</p>
<section id="modify-registration-page" class="level2" data-number="12.1">
<h2 data-number="12.1" class="anchored" data-anchor-id="modify-registration-page"><span class="header-section-number">12.1</span> modify registration page</h2>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="ex">sqlite3</span> sequencing_projects.db</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>we add information to the registration page, so the user must choose a group. This way we know which is the budget holder for this user.</p>
<p>After ward we added the information to the Registration Server Logic</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="ex">dbExecute</span><span class="er">(</span><span class="ex">con,</span> <span class="st">"</span></span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a><span class="st">INSERT INTO users (username, password, email, phone, research_group, is_admin)</span></span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a><span class="st">VALUES (?, ?, ?, ?, ?, 0)</span></span>
<span id="cb76-4"><a href="#cb76-4" aria-hidden="true" tabindex="-1"></a><span class="st">"</span>, params = list<span class="er">(</span></span>
<span id="cb76-5"><a href="#cb76-5" aria-hidden="true" tabindex="-1"></a>  <span class="ex">input</span><span class="va">$reg_username</span><span class="ex">,</span></span>
<span id="cb76-6"><a href="#cb76-6" aria-hidden="true" tabindex="-1"></a>  <span class="ex">digest</span><span class="er">(</span><span class="ex">input</span><span class="va">$reg_password</span><span class="kw">)</span><span class="ex">,</span></span>
<span id="cb76-7"><a href="#cb76-7" aria-hidden="true" tabindex="-1"></a>  <span class="ex">input</span><span class="va">$reg_email</span><span class="ex">,</span></span>
<span id="cb76-8"><a href="#cb76-8" aria-hidden="true" tabindex="-1"></a>  <span class="ex">input</span><span class="va">$reg_phone</span><span class="ex">,</span></span>
<span id="cb76-9"><a href="#cb76-9" aria-hidden="true" tabindex="-1"></a>  <span class="ex">input</span><span class="va">$reg_group</span></span>
<span id="cb76-10"><a href="#cb76-10" aria-hidden="true" tabindex="-1"></a><span class="kw">))</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>as well as modified the User registration modal</p>
<p>Now, when a user register, he must choose a group from the given drop-down menu. this group is attached to the budget holder. When the user creates a new project, this budget holder (group) will automatically be assigned to the project (This can be manually changed, when the project is created).</p>
<p>I have changed the <code>setup_databases.R</code> script to load the budget holders information from a csv file, stored in the same folder as the script itself.</p>
<p>We have a csv-formatted table with the information of the groups and their cost centers. This is an easy way to upload the information.</p>
<pre><code>name,surname,email,cost_center
Kim,Rin-Ho,rkim@biochem.mpg.de,N.A.
Administrator,surname,rkim@biochem.mpg.de,N.A.
Baier,Herwig,herwig.baier@bi.mpg.de,P350
Baldwin,Maude,Maude.Baldwin@bi.mpg.de,P550</code></pre>
<p>The registration process was change to make choosing a research group mandatory. The chosen research group is then set to also assign the cost center to the user.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Some of the research groups have multiple cost centers.</p>
<p>When a user registers, he must select a research group. The user then gets assigned a cost center based on the table of budget holders. If (and this applies only for some of the budget holders), this specific research group has multiple cost centers, it gets assigned the first one found by the app. BUT, manually the user still can change this in the app when applying for a project.</p>
</div>
</div>
</section>
<section id="control-for-budegt-holder-info-in-the-db" class="level2" data-number="12.2">
<h2 data-number="12.2" class="anchored" data-anchor-id="control-for-budegt-holder-info-in-the-db"><span class="header-section-number">12.2</span> control for budegt holder info in the DB</h2>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a>con <span class="ot">&lt;-</span> <span class="fu">dbConnect</span>(RSQLite<span class="sc">::</span><span class="fu">SQLite</span>(), <span class="st">"sequencing_projects.db"</span>)</span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a>budget_holders <span class="ot">&lt;-</span> <span class="fu">dbGetQuery</span>(con, <span class="st">"SELECT * FROM budget_holders"</span>)</span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Print the data</span></span>
<span id="cb78-4"><a href="#cb78-4" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(budget_holders[<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>,])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>  id          name surname cost_center                  email
1  1           Kim  Rin-Ho        N.A.    rkim@biochem.mpg.de
2  2 Administrator surname        N.A.    rkim@biochem.mpg.de
3  3         Baier  Herwig        P350 herwig.baier@bi.mpg.de
           created_at
1 2025-11-28 16:12:05
2 2025-11-28 16:12:05
3 2025-11-28 16:12:05</code></pre>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dbGetQuery</span>(con, <span class="st">"SELECT * FROM budget_holders"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>   id          name      surname     cost_center
1   1           Kim       Rin-Ho            N.A.
2   2 Administrator      surname            N.A.
3   3         Baier       Herwig            P350
4   4       Baldwin        Maude            P550
5   5    Baumeister     Wolfgang            K190
6   6        Borner        Georg            N.A.
7   7         Borst    Alexander            P300
8   8         Conti        Elena            K230
9   9           Cox      Juergen            K435
10 10           Cox      Juergen            K000
11 11    Duderstadt         Karl            N.A.
12 12          Fenk         Lisa            P865
13 13         Hartl Franz-Ulrich            K120
14 14         Hartl Franz-Ulrich     PSBIOC_533A
15 15       Fässler     Rainhard            N.A.
16 16       Gerisch      Günther            N.A.
17 17      Harbauer     Angelika            P835
18 18      Harbauer     Angelika          PSY350
19 19      Jungmann         Ralf            N.A.
20 20         Klein     Ruediger            P400
21 21       Kuepper      Clemens  M.TN.APSY00002
22 22   Hayer-Hartl      Manajit            N.A.
23 23          Mann      Mathias            K250
24 24         Mayer    Christian   M.TN-PSY00001
25 25         Mayer    Christian      P.S.PSY331
26 26         Mayer    Christian            P870
27 27      Meissner        Felix            N.A.
28 28        Murray        Peter            K442
29 29        Murray        Peter      PSBIOC5034
30 30       Mueller        Juerg            K411
31 31    Nedialkova        Danny            K446
32 32    Nedialkova        Danny M.TN.A.BIOC0006
33 33           NGS          NGS            N.A.
34 34       Pfander        Boris       PSBIOC459
35 35      Schulman       Brenda            K085
36 36       Sourjik       Victor            N.A.
37 37         Spatz      Joachim             130
38 38      Schwille        Petra            N.A.
39 39     Tachibana        Kikue            K050
40 40     Tachibana        Kikue    P.S.BIOC5027
41 41     Zachariae     Wolfgang            N.A.
42 42       unknown         user            N.A.
                               email          created_at
1                rkim@biochem.mpg.de 2025-11-28 16:12:05
2                rkim@biochem.mpg.de 2025-11-28 16:12:05
3             herwig.baier@bi.mpg.de 2025-11-28 16:12:05
4            Maude.Baldwin@bi.mpg.de 2025-11-28 16:12:05
5            baumeist@biochem.mpg.de 2025-11-28 16:12:05
6              borner@biochem.mpg.de 2025-11-28 16:12:05
7          alexander.borst@bi.mpg.de 2025-11-28 16:12:05
8               conti@biochem.mpg.de 2025-11-28 16:12:05
9          yeroslaviz@biochem.mpg.de 2025-11-28 16:12:05
10         yeroslaviz@biochem.mpg.de 2025-11-28 16:12:05
11         duderstadt@biochem.mpg.de 2025-11-28 16:12:05
12               lisa.fenk@bi.mpg.de 2025-11-28 16:12:05
13             uhartl@biochem.mpg.de 2025-11-28 16:12:05
14             uhartl@biochem.mpg.de 2025-11-28 16:12:05
15           faessler@biochem.mpg.de 2025-11-28 16:12:05
16            gerisch@biochem.mpg.de 2025-11-28 16:12:05
17       angelika.harbauer@bi.mpg.de 2025-11-28 16:12:05
18       angelika.harbauer@bi.mpg.de 2025-11-28 16:12:05
19           jungmann@biochem.mpg.de 2025-11-28 16:12:05
20          ruediger.klein@bi.mpg.de 2025-11-28 16:12:05
21         clemens.kuepper@bi.mpg.de 2025-11-28 16:12:05
22             mhartl@biochem.mpg.de 2025-11-28 16:12:05
23            msteger@biochem.mpg.de 2025-11-28 16:12:05
24         christian.mayer@bi.mpg.de 2025-11-28 16:12:05
25         christian.mayer@bi.mpg.de 2025-11-28 16:12:05
26         christian.mayer@bi.mpg.de 2025-11-28 16:12:05
27           meissner@biochem.mpg.de 2025-11-28 16:12:05
28             murray@biochem.mpg.de 2025-11-28 16:12:05
29             murray@biochem.mpg.de 2025-11-28 16:12:05
30           muellerj@biochem.mpg.de 2025-11-28 16:12:05
31         nedialkova@biochem.mpg.de 2025-11-28 16:12:05
32         nedialkova@biochem.mpg.de 2025-11-28 16:12:05
33               rkim@biochem.mpg.de 2025-11-28 16:12:05
34           bpfander@biochem.mpg.de 2025-11-28 16:12:05
35           schulman@biochem.mpg.de 2025-11-28 16:12:05
36 victor.sourjik@mpi-marburg.mpg.de 2025-11-28 16:12:05
37           joachim.spatz@mr.mpg.de 2025-11-28 16:12:05
38           schwille@biochem.mpg.de 2025-11-28 16:12:05
39          tachibana@biochem.mpg.de 2025-11-28 16:12:05
40          tachibana@biochem.mpg.de 2025-11-28 16:12:05
41             zachar@biochem.mpg.de 2025-11-28 16:12:05
42               rkim@biochem.mpg.de 2025-11-28 16:12:05</code></pre>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dbGetQuery</span>(con, <span class="st">"SELECT * FROM users"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>  id username                         password                     email
1  1    admin dc43507128bef0083ad8d45d7ba36c8c        ngs@biochem.mpg.de
2  2   admin2 26cd89c4ed458cd233b9f0768d82af31 yeroslaviz@biochem.mpg.de
3  3    user1 181cca7dbd1ce97d37943fe985ee1686       user1@institute.org
4  4    user2 c98c2ee24533f8f615c33a3c7f0d17ba       user2@institute.org
            phone research_group is_admin          created_at
1            &lt;NA&gt;            Kim        1 2025-11-28 16:12:05
2            &lt;NA&gt;            Cox        1 2025-11-28 16:12:05
3 +49 89 12345678            Cox        0 2025-11-28 16:12:05
4 +49 89 87654321          Baier        0 2025-11-28 16:12:05</code></pre>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a><span class="fu">on.exit</span>(<span class="fu">dbDisconnect</span>(con))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="budget-holders-can-be-read-from-an-excel-sheet" class="level2" data-number="12.3">
<h2 data-number="12.3" class="anchored" data-anchor-id="budget-holders-can-be-read-from-an-excel-sheet"><span class="header-section-number">12.3</span> Budget holders can be read from an Excel sheet</h2>
</section>
</section>
<section id="ssl-certificate-for-https" class="level1" data-number="13">
<h1 data-number="13"><span class="header-section-number">13</span> SSL Certificate (for HTTPS)</h1>
<p>the new setting of the certificates. I have three files.</p>
<p>The private key I created when applying for the certificate. The other two were downloaded, when the emial came from Harica (the certificate provider).</p>
<p>the <code>PEM</code> is the pem file and the <code>DER (issuer)</code> is the chain file. Both of them are needed.</p>
<p>Setting for the readability of the files:</p>
<pre><code>cd /etc/apache2/certificate/2026
-rw------- 1 yeroslaviz b_mcf 3272 Nov 10 15:58 private-key.pem # udo chmod 600 /path/to/private.key  # Readable only by root
-rw-r--r-- 1 yeroslaviz b_mcf 1545 Nov 14 12:12 NGS_2026_Issuer_ChainFile.cer # sudo chmod 644 /path/to/chain.crt  # Readable by all
-rw-r--r-- 1 yeroslaviz b_mcf 2796 Nov 14 12:34 NGS_2026_Cert.pem # sudo chmod 644 /path/to/certificate.crt # Readable by all</code></pre>
<p>All the files are saved under <code>/etc/apache2/certificate/2026</code>.</p>
<p>Now I created soft links for each of these files.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> ln <span class="at">-s</span> /etc/apache2/certificate/2026/private-key.pem /etc/ssl/private/2026_private-key.pem</span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> ln <span class="at">-s</span> /etc/apache2/certificate/2026/NGS_2026_Cert.pem /etc/ssl/certs/2026_NGS_Cert.pem</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="ldap" class="level1" data-number="14">
<h1 data-number="14"><span class="header-section-number">14</span> LDAP</h1>
<p>The app uses Apache LDAP authentication in front of Shiny. The Apache config template is in <code>01-main.conf</code>.</p>
<p>Enable required Apache modules:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb87"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> a2enmod ldap authnz_ldap headers</span>
<span id="cb87-2"><a href="#cb87-2" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> systemctl reload apache2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Test whether anonymous LDAP search works:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb88"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a><span class="ex">ldapsearch</span> <span class="at">-x</span> <span class="at">-H</span> ldaps://ldapserv1.biochem.mpg.de <span class="at">-b</span> <span class="st">"dc=biochem,dc=mpg,dc=de"</span> <span class="st">"(uid=YOURUSER)"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>If anonymous search fails, use bind credentials from IT and add them to the Apache config:</p>
<div class="sourceCode" id="cb89"><pre class="sourceCode apache code-with-copy"><code class="sourceCode apache"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a>AuthLDAPBindDN<span class="st"> "cn=binduser,dc=biochem,dc=mpg,dc=de"</span></span>
<span id="cb89-2"><a href="#cb89-2" aria-hidden="true" tabindex="-1"></a>AuthLDAPBindPassword<span class="st"> "REDACTED"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Warning
</div>
</div>
<div class="callout-body-container callout-body">
<p>For production, <strong>do not use a personal account</strong> for LDAP binding. Ask IT for a dedicated <strong>service bind account</strong> with read‑only permissions and store those credentials securely.</p>
</div>
</div>
<p>Set app environment variables for Shiny Server (systemd override recommended):</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb90"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> systemctl edit shiny-server</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="sourceCode" id="cb91"><pre class="sourceCode ini code-with-copy"><code class="sourceCode ini"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a><span class="kw">[Service]</span></span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a><span class="dt">Environment</span><span class="ot">=</span><span class="st">AUTH_MODE=ldap</span></span>
<span id="cb91-3"><a href="#cb91-3" aria-hidden="true" tabindex="-1"></a><span class="dt">Environment</span><span class="ot">=</span><span class="st">LDAP_URI=ldaps://ldapserv1.biochem.mpg.de:636,ldaps://ldapserv2.biochem.mpg.de:636,ldaps://ldapserv3.biochem.mpg.de:636</span></span>
<span id="cb91-4"><a href="#cb91-4" aria-hidden="true" tabindex="-1"></a><span class="dt">Environment</span><span class="ot">=</span><span class="st">LDAP_BASE_DN=dc=biochem,dc=mpg,dc=de</span></span>
<span id="cb91-5"><a href="#cb91-5" aria-hidden="true" tabindex="-1"></a><span class="co"># If you want to restrict search to the user OU:</span></span>
<span id="cb91-6"><a href="#cb91-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Environment=LDAP_BASE_DN=ou=People,dc=biochem,dc=mpg,dc=de</span></span>
<span id="cb91-7"><a href="#cb91-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Optional bind credentials (only if anonymous LDAP search is blocked):</span></span>
<span id="cb91-8"><a href="#cb91-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Environment=LDAP_BIND_DN=cn=binduser,dc=biochem,dc=mpg,dc=de</span></span>
<span id="cb91-9"><a href="#cb91-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Environment=LDAP_BIND_PW=REDACTED</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Restart services after config changes:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb92"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> systemctl restart apache2</span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> systemctl restart shiny-server</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="local-dev-testing-ldap-mode" class="level2" data-number="14.1">
<h2 data-number="14.1" class="anchored" data-anchor-id="local-dev-testing-ldap-mode"><span class="header-section-number">14.1</span> Local dev testing (LDAP mode)</h2>
<p>To test LDAP integration on your local machine without affecting production, run the app in dev mode and simulate the authenticated user. If LDAP attribute lookup is needed, provide a bind DN/password (personal credentials are OK for <strong>local testing only</strong>).</p>
<div class="sourceCode" id="cb93"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a><span class="fu">Sys.setenv</span>(</span>
<span id="cb93-2"><a href="#cb93-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">APP_ENV =</span> <span class="st">"dev"</span>,</span>
<span id="cb93-3"><a href="#cb93-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">AUTH_MODE =</span> <span class="st">"ldap"</span>,</span>
<span id="cb93-4"><a href="#cb93-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">DEV_REMOTE_USER =</span> <span class="st">"your_username"</span>,</span>
<span id="cb93-5"><a href="#cb93-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">LDAP_BIND_DN =</span> <span class="st">"uid=your_username,ou=YourGroup,ou=Research Group,ou=People,dc=biochem,dc=mpg,dc=de"</span>,</span>
<span id="cb93-6"><a href="#cb93-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">LDAP_BIND_PW =</span> <span class="st">"YOUR_PASSWORD"</span></span>
<span id="cb93-7"><a href="#cb93-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb93-8"><a href="#cb93-8" aria-hidden="true" tabindex="-1"></a>shiny<span class="sc">::</span><span class="fu">runApp</span>(<span class="st">"sequencing-app"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>After login, verify the user record in SQLite:</p>
<div class="sourceCode" id="cb94"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a>con <span class="ot">&lt;-</span> DBI<span class="sc">::</span><span class="fu">dbConnect</span>(RSQLite<span class="sc">::</span><span class="fu">SQLite</span>(), <span class="st">"sequencing-app/sequencing_projects.db"</span>)</span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a>DBI<span class="sc">::</span><span class="fu">dbGetQuery</span>(con, <span class="st">"SELECT username, email, phone, research_group FROM users WHERE username='your_username'"</span>)</span>
<span id="cb94-3"><a href="#cb94-3" aria-hidden="true" tabindex="-1"></a>DBI<span class="sc">::</span><span class="fu">dbDisconnect</span>(con)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>To switch back to normal local login (no LDAP), run:</p>
<div class="sourceCode" id="cb95"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a><span class="fu">Sys.setenv</span>(<span class="at">APP_ENV =</span> <span class="st">"dev"</span>, <span class="at">AUTH_MODE =</span> <span class="st">"local"</span>)</span>
<span id="cb95-2"><a href="#cb95-2" aria-hidden="true" tabindex="-1"></a>shiny<span class="sc">::</span><span class="fu">runApp</span>(<span class="st">"sequencing-app"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>To fully clear the LDAP/testing variables in your R session:</p>
<div class="sourceCode" id="cb96"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a><span class="fu">Sys.unsetenv</span>(<span class="fu">c</span>(</span>
<span id="cb96-2"><a href="#cb96-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">"APP_ENV"</span>, <span class="st">"AUTH_MODE"</span>, <span class="st">"DEV_REMOTE_USER"</span>,</span>
<span id="cb96-3"><a href="#cb96-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">"LDAP_BIND_DN"</span>, <span class="st">"LDAP_BIND_PW"</span>,</span>
<span id="cb96-4"><a href="#cb96-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">"LDAP_URI"</span>, <span class="st">"LDAP_BASE_DN"</span>, <span class="st">"LDAP_DEBUG"</span></span>
<span id="cb96-5"><a href="#cb96-5" aria-hidden="true" tabindex="-1"></a>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="how-i-run-the-app-locally-my-notes" class="level2" data-number="14.2">
<h2 data-number="14.2" class="anchored" data-anchor-id="how-i-run-the-app-locally-my-notes"><span class="header-section-number">14.2</span> How I run the app locally (my notes)</h2>
<p>When I want the <strong>normal local login</strong>, I run:</p>
<div class="sourceCode" id="cb97"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a><span class="fu">Sys.setenv</span>(<span class="at">APP_ENV =</span> <span class="st">"dev"</span>, <span class="at">AUTH_MODE =</span> <span class="st">"local"</span>)</span>
<span id="cb97-2"><a href="#cb97-2" aria-hidden="true" tabindex="-1"></a>shiny<span class="sc">::</span><span class="fu">runApp</span>(<span class="st">"sequencing-app"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>When I want to <strong>simulate production LDAP login</strong>, I run:</p>
<div class="sourceCode" id="cb98"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a><span class="fu">Sys.setenv</span>(</span>
<span id="cb98-2"><a href="#cb98-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">APP_ENV =</span> <span class="st">"dev"</span>,</span>
<span id="cb98-3"><a href="#cb98-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">AUTH_MODE =</span> <span class="st">"ldap"</span>,</span>
<span id="cb98-4"><a href="#cb98-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">DEV_REMOTE_USER =</span> <span class="st">"my_username"</span>,</span>
<span id="cb98-5"><a href="#cb98-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">LDAP_URI =</span> <span class="st">"ldaps://ldapserv1.biochem.mpg.de:636,ldaps://ldapserv2.biochem.mpg.de:636,ldaps://ldapserv3.biochem.mpg.de:636"</span>,</span>
<span id="cb98-6"><a href="#cb98-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">LDAP_BASE_DN =</span> <span class="st">"dc=biochem,dc=mpg,dc=de"</span></span>
<span id="cb98-7"><a href="#cb98-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb98-8"><a href="#cb98-8" aria-hidden="true" tabindex="-1"></a>shiny<span class="sc">::</span><span class="fu">runApp</span>(<span class="st">"sequencing-app"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>If I want to fully reset the session, I clear the env vars:</p>
<div class="sourceCode" id="cb99"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a><span class="fu">Sys.unsetenv</span>(<span class="fu">c</span>(</span>
<span id="cb99-2"><a href="#cb99-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">"APP_ENV"</span>, <span class="st">"AUTH_MODE"</span>, <span class="st">"DEV_REMOTE_USER"</span>,</span>
<span id="cb99-3"><a href="#cb99-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">"LDAP_BIND_DN"</span>, <span class="st">"LDAP_BIND_PW"</span>,</span>
<span id="cb99-4"><a href="#cb99-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">"LDAP_URI"</span>, <span class="st">"LDAP_BASE_DN"</span>, <span class="st">"LDAP_DEBUG"</span></span>
<span id="cb99-5"><a href="#cb99-5" aria-hidden="true" tabindex="-1"></a>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Local vs LDAP mode (practical difference for me):</strong></p>
<ul>
<li>Local mode uses the SQLite users/passwords and shows the normal login screen.</li>
<li>LDAP mode auto‑logs in with the LDAP user, pulls email/phone/OU, and hides the local login UI.</li>
<li>LDAP mode needs network access to the institute LDAP servers.</li>
</ul>
<p><strong>Dev badge:</strong> In dev mode, I see a small badge in the app header that shows <code>DEV · LDAP</code> or <code>DEV · LOCAL</code>, so I always know which mode I’m running.</p>
</section>
<section id="budget-holder-auto-assignment-first-login" class="level2" data-number="14.3">
<h2 data-number="14.3" class="anchored" data-anchor-id="budget-holder-auto-assignment-first-login"><span class="header-section-number">14.3</span> Budget holder auto-assignment (first login)</h2>
<p>On first LDAP login, the app attempts to map the user to a budget holder based on the LDAP <code>ou</code> value.<br>
If the <code>ou</code> contains a group key in parentheses (e.g., <code>(... Cox)</code>), the app matches that key against <code>budget_holders</code> and stores the <strong>full PI name</strong> (e.g., <code>Cox Juergen</code>) in <code>users.research_group</code>.</p>
<p>When a new project is created, this <code>research_group</code> value is used to auto‑select the budget holder (and thus the cost center).<br>
If multiple cost centers exist for the same PI, the first match is selected by default and can be adjusted during project creation.</p>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        for (let i = 0; i < 2; i++) {
          container.appendChild(note.children[i].cloneNode(true));
        }
        return container.innerHTML
      } else {
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      return note.innerHTML;
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        console.log("RESIZE");
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>