<VirtualHost *:80>
    ServerName ngs-testing-vm
    ServerAlias ngs-testing-vm.biochem.mpg.de
    # Redirect all HTTP traffic to HTTPS
    Redirect permanent / https://ngs-testing-vm/
</VirtualHost>

<VirtualHost *:443>
    ServerName ngs-testing-vm
    ServerAlias ngs-testing-vm.biochem.mpg.de

    # SSL Configuration
    SSLEngine on
    SSLCertificateFile /etc/ssl/certs/2026_NGS_Cert.pem
    SSLCertificateKeyFile /etc/ssl/private/2026_private-key.pem
    SSLCertificateChainFile /etc/apache2/certificate/2026/NGS_2026_Issuer_ChainFile.cer

    # Modern SSL configuration
    SSLProtocol all -SSLv3 -TLSv1 -TLSv1.1
    SSLCipherSuite ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384
    SSLHonorCipherOrder off

    # Reverse proxy for Shiny app
    ProxyPreserveHost On
    ProxyRequests Off
    ProxyPass / http://localhost:3838/sequencing-app/
    ProxyPassReverse / http://localhost:3838/sequencing-app/

    # LDAP Authentication for Shiny app
    <Location />
        AuthType Basic
        AuthName "LDAP Authentication"
        AuthBasicProvider ldap
        AuthLDAPURL "ldaps://ldapserv1.biochem.mpg.de ldaps://ldapserv2.biochem.mpg.de ldaps://ldapserv3.biochem.mpg.de/dc=biochem,dc=mpg,dc=de?uid?sub?(objectClass=posixAccount)"
        Require valid-user

        # TLS trust for LDAP
        LDAPTLS_CACERTDIR /etc/ssl/certs

        # If anonymous LDAP search fails, uncomment and set bind credentials:
        # AuthLDAPBindDN "cn=binduser,dc=biochem,dc=mpg,dc=de"
        # AuthLDAPBindPassword "REDACTED"

        # Forward authenticated user to Shiny
        RequestHeader set X-Remote-User %{REMOTE_USER}e
    </Location>

    # WebSocket support
    RewriteEngine on
    RewriteCond %{HTTP:Upgrade} websocket [NC]
    RewriteCond %{HTTP:Connection} upgrade [NC]
    RewriteRule ^/(.*) "ws://localhost:3838/sequencing-app/$1" [P,L]

    # Security headers
    Header always set Strict-Transport-Security "max-age=63072000; includeSubDomains"
    Header always set X-Content-Type-Options nosniff
    Header always set X-Frame-Options SAMEORIGIN
    Header always set Referrer-Policy "strict-origin-when-cross-origin"

    ErrorLog ${APACHE_LOG_DIR}/sequencing-app-ssl-error.log
    CustomLog ${APACHE_LOG_DIR}/sequencing-app-ssl-access.log combined
</VirtualHost>
