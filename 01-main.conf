<VirtualHost *:80>
    ServerName ngs-testing-vm
    ServerAlias ngs-testing-vm.biochem.mpg.de
    # Redirect all HTTP traffic to HTTPS
    Redirect permanent / https://ngs-testing-vm/
</VirtualHost>

<VirtualHost *:443>
    ServerName ngs-testing-vm
    ServerAlias ngs-testing-vm.biochem.mpg.de

#    Header always set X-Debug-Remote-User "%{REMOTE_USER}e"

    # SSL Configuration
    SSLEngine on
    SSLCertificateFile /etc/ssl/certs/2026_NGS_Cert.pem
    SSLCertificateKeyFile /etc/ssl/private/2026_private-key.pem
    SSLCertificateChainFile /etc/apache2/certificate/2026/NGS_2026_Issuer_ChainFile.cer
    
    # Apache needs to trust the LDAP server certificate.
#    LDAPTrustedGlobalCert CA_BASE64 /etc/ssl/certs/ca-certificates.crt

    # Modern SSL configuration
    SSLProtocol all -SSLv3 -TLSv1 -TLSv1.1
    SSLCipherSuite ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384
    SSLHonorCipherOrder off

    # Redirect root to the app without exposing user identity in query params.
    RewriteEngine On
    RewriteRule ^/$ /sequencing-app/ [R=302,L]

    # Reverse proxy for Shiny app (serve app under /sequencing-app/)
    ProxyPreserveHost On
    ProxyRequests Off
    ProxyPass /sequencing-app/ http://localhost:3838/sequencing-app/
    ProxyPassReverse /sequencing-app/ http://localhost:3838/sequencing-app/

    # Make REMOTE_USER available to headers
#    RewriteEngine On
#    RewriteRule .* - [E=REMOTE_USER:%{LA-U:REMOTE_USER},NS]

    # LDAP Authentication for Shiny app
    <Location />
        AuthType Basic
        AuthName "LDAP Authentication"
        AuthBasicProvider ldap
#	AuthLDAPURL "ldaps://ldapserv1.biochem.mpg.de:636/dc=biochem,dc=mpg,dc=de?uid?sub?(objectClass=posixAccount) ldaps://ldapserv2.biochem.mpg.de:636/dc=biochem,dc=mpg,dc=de?uid?sub?(objectClass=posixAccount) ldaps://ldapserv3.biochem.mpg.de:636/dc=biochem,dc=mpg,dc=de?uid?sub?(objectClass=posixAccount)"
        # testing with just one server works nicely.
	AuthLDAPURL "ldaps://ldapserv1.biochem.mpg.de:636/dc=biochem,dc=mpg,dc=de?uid?sub?(objectClass=posixAccount)"
        Require valid-user

        # Forward only Apache-authenticated identity to Shiny.
        # Clear any incoming spoofed headers first.
        RequestHeader unset X-Remote-User
        RequestHeader unset X-Forwarded-User
        RequestHeader set X-Remote-User "%{REMOTE_USER}e"
        RequestHeader set X-Forwarded-User "%{REMOTE_USER}e"

	# TLS trust for LDAP
	# DAPTLS_CACERTDIR is not an Apache directive (it’s an OpenLDAP client config option). That’s why Apache fails to parse it even though the ldap modules are enabled.     
	#LDAPTLS_CACERTDIR /etc/ssl/certs

        # If anonymous LDAP search fails, uncomment and set bind credentials:
        # AuthLDAPBindDN "cn=binduser,dc=biochem,dc=mpg,dc=de"
        # AuthLDAPBindPassword "REDACTED"

        # (Optional) Cookie fallback (kept for reference)
        # RewriteEngine On
        # RewriteCond %{REMOTE_USER} (.+)
        # RewriteRule .* - [CO=auth_user:%1:ngs-testing-vm.biochem.mpg.de:0:/]

        # Optional header forwarding (kept for future use)
        # RequestHeader set X-Remote-User "%{AUTH_USER}e"
        # RequestHeader set X-Forwarded-User "%{AUTH_USER}e"
    </Location>

    # WebSocket support
    RewriteEngine on
    RewriteCond %{HTTP:Upgrade} websocket [NC]
    RewriteCond %{HTTP:Connection} upgrade [NC]
    RewriteRule ^/sequencing-app/(.*) "ws://localhost:3838/sequencing-app/$1" [P,L]

    # Security headers
    Header always set Strict-Transport-Security "max-age=63072000; includeSubDomains"
    Header always set X-Content-Type-Options nosniff
    Header always set X-Frame-Options SAMEORIGIN
    Header always set Referrer-Policy "strict-origin-when-cross-origin"

    # Keep logs quiet in production. Enable the next line only for LDAP debugging.
    LogLevel warn
    # LogLevel authnz_ldap:debug ldap:debug
    ErrorLog ${APACHE_LOG_DIR}/sequencing-app-ssl-error.log
    CustomLog ${APACHE_LOG_DIR}/sequencing-app-ssl-access.log combined
</VirtualHost>
