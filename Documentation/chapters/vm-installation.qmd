---
title: "VM Installation Guide (ngs-vm & bcf-vm)"
execute:
  eval: false
  echo: true
  warning: false
---

## VM Installation Guide (ngs-vm & bcf-vm)

### Contents

- [Scope](#scope)
- [Port strategy (recommended)](#port-strategy-recommended)
- [Prerequisites (both VMs)](#prerequisites-both-vms)
- [GitHub connection on a fresh VM](#github-connection-on-a-fresh-vm)
- [bcf-vm: clean install](#bcf-vm-clean-install)
- [ngs-vm: parallel install next to perl system](#ngs-vm-parallel-install-next-to-perl-system)
- [Legacy data migration (perl-VM → shiny-VM)](#legacy-data-migration-perl-vm--shiny-vm)
- [Cutover and rollback](#cutover-and-rollback)
- [Post-install verification](#post-install-verification)

## Scope

This guide covers a full installation of the Shiny app on two Ubuntu 24 VMs:

- `bcf-vm`: clean install, no HTTPS cert (self-signed OK for testing).
- `ngs-vm`: already running the legacy Perl system; install the Shiny app in parallel, then redirect the public hostname when ready.

## Port strategy (recommended)

Recommended for parallel operation on `ngs-vm`:

- Shiny Server stays on `:3838` (default).
- Apache vhost for the **new** system listens on `:8443` (HTTPS) or another high port (e.g. `:1234` if you prefer).
- Existing legacy system remains on `:443`.

Why `8443`: it is standard for HTTPS on alternate ports and avoids conflicts.

## Prerequisites (both VMs)

Run the requirement check script:

```bash
bash /Users/yeroslaviz/Documents/Github/BCFNGS-project-management/scripts/check_requirements.sh
```

Install missing apt packages:

```bash
bash /Users/yeroslaviz/Documents/Github/BCFNGS-project-management/scripts/check_requirements.sh --install
```

Install missing R packages (including `rJava`):

```bash
bash /Users/yeroslaviz/Documents/Github/BCFNGS-project-management/scripts/check_requirements.sh --install-r
```

The requirement check reports missing `rJava`/`mailR` and missing Java tools (`java`, `javac`) explicitly.

Manual steps still required after package install:

- Install Shiny Server from the `.deb` package (see [bcf-vm Step 2](#bcf-install-shiny-server)).
- Install Java + R mail dependencies for email notifications (see [bcf-vm Step 2b](#bcf-java-mail)).
- Install LDAP client/build dependencies + `ldapr` (see [bcf-vm Step 2d](#bcf-ldap-deps)).
- Ensure the `shiny` user exists and app-folder permissions are correct (see [bcf-vm Step 2c](#bcf-shiny-user-perms)).
- Configure Apache vhost, LDAP, and systemd environment (see [bcf-vm Step 6](#bcf-configure-ldap-systemd), [bcf-vm Step 7](#bcf-configure-apache-vhost), and [ngs-vm Step 2](#ngs-parallel-shiny-vhost)).

## GitHub connection on a fresh VM

Before cloning on either VM, configure GitHub access.

Use these sections in **Git & GitHub**:

- [GitHub connection on VM (clone/pull/push)](git-github.qmd#github-connection-on-vm-clonepullpush)
- [Enable push from the VM](git-github.qmd#enable-push-from-the-vm)
- [Repo setup on the VM](git-github.qmd#repo-setup-on-the-vm)

Minimum check before clone:

```bash
ssh -T git@github.com
```

If this fails, do not continue with clone/deploy until SSH access is fixed.

## bcf-vm: clean install

### 1) Install base packages

```bash
sudo apt-get update
sudo apt-get install -y git curl rsync apache2 apache2-utils openssl sqlite3 ldap-utils \
  build-essential libcurl4-openssl-dev libssl-dev libxml2-dev r-base
```

### 2) Install Shiny Server {#bcf-install-shiny-server}

Copy the `.deb` to the VM and install it:

```bash
sudo apt-get install -y gdebi-core
wget https://download3.rstudio.org/ubuntu-20.04/x86_64/shiny-server-1.5.23.1030-amd64.deb
sudo gdebi shiny-server-1.5.23.1030-amd64.deb
```

### 2b) Configure Java + mail packages (required for email notifications) {#bcf-java-mail}

The app sends emails via `mailR`, which requires Java / `rJava`.
This is for **email notifications**, not for LDAP auth itself.

```bash
sudo apt-get install -y default-jdk
sudo R CMD javareconf
sudo Rscript --vanilla -e 'install.packages(c("rJava","mailR"), repos="https://cloud.r-project.org")'
```

Apply the same on `ngs-vm` and `bcf-vm`.

### 2c) Create `shiny` user + app-folder permissions {#bcf-shiny-user-perms}

Shiny Server runs the app as the `shiny` service user.

```bash
getent passwd shiny || sudo useradd --system --home /var/lib/shiny-server --shell /usr/sbin/nologin shiny
sudo mkdir -p /srv/shiny-server/sequencing-app
sudo chown -R shiny:shiny /srv/shiny-server/sequencing-app
sudo chmod 755 /srv/shiny-server /srv/shiny-server/sequencing-app
sudo usermod -a -G shiny "$USER"
```

If you are configuring a different account, replace `"$USER"` with that username.

### 2d) LDAP packages (Ubuntu + R) {#bcf-ldap-deps}

Install LDAP client tools and build dependencies:

```bash
sudo apt-get install -y ldap-utils libldap2-dev libsasl2-dev ca-certificates
```

Configure OpenLDAP client trust in `/etc/ldap/ldap.conf`:

```bash
sudo tee /etc/ldap/ldap.conf >/dev/null <<'EOF'
BASE            dc=biochem,dc=mpg,dc=de
URI             ldaps://ldapserv1.biochem.mpg.de ldaps://ldapserv2.biochem.mpg.de ldaps://ldapserv3.biochem.mpg.de
TLS_REQCERT     hard
TLS_CACERTDIR   /etc/ssl/certs
EOF
```

Install the R LDAP package:

```bash
sudo Rscript --vanilla -e 'install.packages("ldapr", repos="https://cloud.r-project.org")'
```

Fallback if CRAN install is unavailable on this VM:

```bash
sudo Rscript --vanilla -e 'if (!requireNamespace("remotes", quietly=TRUE)) install.packages("remotes", repos="https://cloud.r-project.org"); remotes::install_github("liamgilbey/ldapr")'
```

Quick checks:

```bash
ldapsearch -x -H ldaps://ldapserv1.biochem.mpg.de:636 -b "dc=biochem,dc=mpg,dc=de" "(uid=<user>)" mail
sudo -u shiny Rscript --vanilla -e 'library(ldapr); cat("ldapr OK\n")'
```

If `ldapsearch` only works with `LDAPTLS_REQCERT=never`, your `/etc/ldap/ldap.conf` trust settings are incomplete or incorrect.

### 3) Create a self-signed certificate (test only)

```bash
sudo mkdir -p /etc/ssl/localcerts
sudo openssl req -x509 -nodes -days 365 \
  -newkey rsa:2048 \
  -keyout /etc/ssl/localcerts/bcf-vm.key \
  -out /etc/ssl/localcerts/bcf-vm.crt
```

### 4) Clone repo and set app folder

```bash
cd /home/<user>
git clone git@github.com:yeroslaviz/BCFNGS-project-management.git
sudo rsync -av /home/<user>/BCFNGS-project-management/sequencing-app/ /srv/shiny-server/sequencing-app/
sudo chown -R shiny:shiny /srv/shiny-server/sequencing-app
```

### 5) Initialize the SQLite DB

```bash
cd /srv/shiny-server/sequencing-app
sudo -u shiny Rscript setup_database.R
```

### 6) Configure LDAP mode (systemd override) {#bcf-configure-ldap-systemd}

```bash
sudo systemctl edit shiny-server
```

```ini
[Service]
Environment=AUTH_MODE=ldap
Environment=LDAP_URI=ldaps://ldapserv1.biochem.mpg.de:636,ldaps://ldapserv2.biochem.mpg.de:636,ldaps://ldapserv3.biochem.mpg.de:636
Environment=LDAP_BASE_DN=dc=biochem,dc=mpg,dc=de
```

```bash
sudo systemctl restart shiny-server
```

### 7) Configure Apache (test HTTPS redirect) {#bcf-configure-apache-vhost}

Create a vhost that redirects `:80` to `:443` and proxies to Shiny:

Apache config file path for this step: `/etc/apache2/sites-available/bcf-vm.conf`

```apache
<VirtualHost *:80>
    ServerName bcf-vm
    Redirect permanent / https://bcf-vm/
</VirtualHost>

<VirtualHost *:443>
    ServerName bcf-vm
    SSLEngine on
    SSLCertificateFile /etc/ssl/localcerts/bcf-vm.crt
    SSLCertificateKeyFile /etc/ssl/localcerts/bcf-vm.key

    ProxyPreserveHost On
    ProxyPass / http://localhost:3838/sequencing-app/
    ProxyPassReverse / http://localhost:3838/sequencing-app/
</VirtualHost>
```

Enable the site and restart Apache:

```bash
sudo a2enmod ssl proxy proxy_http headers rewrite
sudo a2ensite bcf-vm.conf # this creates symlink to sites-enabled
sudo apache2ctl -t
sudo systemctl restart apache2
```

## ngs-vm: parallel install next to perl system

### 1) Keep legacy system on `:443`

Leave the current `01-main.conf` active for the Perl system.

### 2) Add a parallel Shiny vhost on `:8443` (or `:1234`) {#ngs-parallel-shiny-vhost}

Create a new vhost file, for example `ngs-vm-shiny.conf`:

Apache config file path for this step:

`/etc/apache2/sites-available/ngs-vm-shiny.conf`

```apache
<VirtualHost *:8443>
    ServerName ngs-vm.biochem.mpg.de

    SSLEngine on
    SSLCertificateFile /etc/ssl/certs/ngs-cert.pem
    SSLCertificateKeyFile /etc/ssl/private/2026_private-key.pem
    SSLCertificateChainFile /etc/apache2/certificate/2026_Cert_binary.cer

    ProxyPreserveHost On
    RequestHeader set X-Forwarded-Proto "https"

    RedirectMatch 302 ^/$ /sequencing-app/

    ProxyPass        /sequencing-app/  http://127.0.0.1:3838/sequencing-app/
    ProxyPassReverse /sequencing-app/  http://127.0.0.1:3838/sequencing-app/
</VirtualHost>
```

Enable and reload:

```bash
grep -q '^Listen 8443$' /etc/apache2/ports.conf || echo 'Listen 8443' | sudo tee -a /etc/apache2/ports.conf
sudo a2enmod ssl proxy proxy_http headers rewrite ldap authnz_ldap
sudo a2ensite ngs-vm-shiny.conf
sudo apache2ctl -t
sudo systemctl restart apache2
```

### 3) Validate parallel access

```bash
curl -Ik https://ngs-vm.biochem.mpg.de:8443/
curl -Ik -u USER https://ngs-vm.biochem.mpg.de:8443/sequencing-app/
```

If hostname/port tests fail, validate locally against the vhost:

```bash
curl -kI -H 'Host: ngs-vm.biochem.mpg.de' https://127.0.0.1:8443/
curl -kI -u USER -H 'Host: ngs-vm.biochem.mpg.de' https://127.0.0.1:8443/sequencing-app/
```

If the app returns HTTP 500 with `mailR/rJava` errors on ngs-vm, apply this runtime fix:

```bash
sudo apt-get install -y openjdk-17-jdk r-cran-rjava
export JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64
sudo env JAVA_HOME="$JAVA_HOME" /usr/bin/R CMD javareconf
sudo env JAVA_HOME="$JAVA_HOME" /usr/bin/Rscript --vanilla -e 'install.packages("mailR", repos="https://cloud.r-project.org", INSTALL_opts="--no-test-load")'
sudo systemctl restart shiny-server
```


## Legacy data migration (perl-VM → shiny-VM)

Follow the SQL Handling chapter for the export/import workflow:

- `/Users/yeroslaviz/Documents/Github/BCFNGS-project-management/Documentation/chapters/sql-handling.qmd`

This includes:

- PostgreSQL export query
- UTF‑8 normalization if needed
- CSV transfer
- SQLite import on the shiny-VM

## Cutover and rollback

### Cutover (switch public hostname to Shiny)

Option A (redirect 443 to new port):

```apache
Redirect permanent / https://ngs-vm.biochem.mpg.de:8443/
```

Option B (replace the 443 vhost with the Shiny proxy):

- Disable legacy vhost.
- Enable Shiny vhost on `:443`.

### Rollback

To revert quickly:

- Remove the redirect line or disable the Shiny vhost.
- Re-enable the legacy `ngs-vm_01-main.conf`.
- Reload Apache.

## Post-install verification

Run these checks after install:

```bash
curl -Ik https://<host>/
curl -Ik -u USER https://<host>/sequencing-app/
```

Confirm:

- LDAP prompt appears.
- Login succeeds.
- App loads and lists projects.
