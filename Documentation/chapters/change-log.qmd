---
title: "Change Log"
execute:
  eval: false
  echo: true
  warning: false
---

## Change Log

### Contents

- [Changes on 25.02.2026](#changes-on-25.02.2026)
- [Changes on 23.02.2026](#changes-on-23.02.2026)
- [Changes on 20.02.2026](#changes-on-20.02.2026)
- [Changes on 16.02.2026](#changes-on-16.02.2026)
- [Changes on 13.02.2026](#changes-on-13.02.2026)
- [Changes on 12.02.2026](#changes-on-12.02.2026)
- [Changes on 11.02.2026](#changes-on-11.02.2026)
- [Changes on 09.02.2026](#changes-on-09.02.2026)
- [Changes on 06.02.2026](#changes-on-06.02.2026)
- [Changes on 14.11.2026](#changes-on-14.11.2026)

## Changes on 25.02.2026

1.  Added a production cutover runbook for `ngs-vm` with the final target routing:
    - `https://ngs-vm.biochem.mpg.de` -> Shiny on `:443`
    - `https://ngs-vm.biochem.mpg.de:9443` -> Perl fallback
2.  Added new Apache templates for this routing model:
    - `scripts/ngs-vm-shiny-443.conf`
    - `scripts/ngs-vm-perl-9443.conf`
3.  Added a dedicated cutover automation helper:
    - `scripts/cutover_ngs_vm_ports.sh` (`cutover` / `rollback`)
4.  Updated **Deploy & Operations** with explicit deploy scope:
    - `scripts/deploy.sh` remains code-only (no rebuild/import)
    - restart does not delete DB content
    - snapshot/rebuild/restore runbook documented as separate maintenance flow
5.  Updated **VM Installation Guide** with manual and scripted cutover steps, plus post-cutover validation and rollback commands.
6.  Updated **Troubleshooting** with new cutover-specific checks:
    - no-port URL still serving Perl
    - `:9443` fallback connection refused
    - LDAP works on `:8443` but not on `:443`
7.  Marked `scripts/switch_vhosts.sh` as legacy (hostname-redirect strategy) and pointed to the new port-based cutover script.
8.  Improved `scripts/cutover_ngs_vm_ports.sh` to auto-disable competing `:443` sites (including `default-ssl.conf` when enabled) and made rollback re-enable the first available legacy `:443` site (`PERL_443_SITE` -> `02-testing.conf` -> `default-ssl.conf`).

## Changes on 23.02.2026

1.  Expanded VM installation documentation with explicit GitHub onboarding for fresh VMs (SSH key setup, deploy key vs user key decision, clone/pull/push workflow, and handling local changes on pull‑only VMs).
2.  Added cross‑references in the VM prerequisites section so summary bullets link directly to the detailed install/config sections.
3.  Added explicit Java and R mail dependency guidance (`default-jdk`, `rJava`, `mailR`) and clarified that Java is needed for email notifications, not LDAP authentication itself.
4.  Added an explicit `shiny` service-user setup step with required permissions for `/srv/shiny-server/sequencing-app`.
5.  Added LDAP dependency/install instructions to docs (Ubuntu packages + R `ldapr` install), including fallback install from GitHub via `remotes::install_github("liamgilbey/ldapr")`.
6.  Updated `scripts/check_requirements.sh` to check/install LDAP build dependencies (`libldap2-dev`, `libsasl2-dev`), Java toolchain (`default-jdk`, `java`, `javac`), and `rJava` in the R package checks/installer.
7.  Clarified deploy smoke-test guidance to use the canonical Apache template path `01-main.conf` in this repo.
8.  Expanded ngs-vm Apache parallel-vhost instructions for `:8443`, including the concrete config file path (`/etc/apache2/sites-available/ngs-vm-shiny.conf`), `RequestHeader set X-Forwarded-Proto`, root redirect to `/sequencing-app/`, and scoped `ProxyPass` rules for `/sequencing-app/`.
9.  Added missing Apache activation steps for ngs-vm rollout (`Listen 8443` in `ports.conf`, required modules including `headers`, and site enable/restart sequence).
10. Added host-header based local validation commands (`curl -kI -H 'Host: ...' https://127.0.0.1:8443/...`) for diagnosing vhost routing issues before DNS/firewall checks.
11. Added ngs-vm runtime recovery notes for `mailR`/`rJava` startup failures (HTTP 500), including JDK alignment and explicit reinstall guidance to restore Shiny startup.

## Changes on 20.02.2026

1.  Fixed local dev compatibility when the SQLite DB is missing `users.full_name` by falling back to `u.username` in project list queries.
2.  Fixed project ID sorting in the Projects table: IDs now sort numerically while still displaying as `P<id>`; default sort is newest first (e.g. `P1035` at the top).
3.  Added edit buttons + edit dialogs for the missing Admin panels:
    - Budget holders
    - Project types
    - Sequencing platforms
    - Reference genomes
4.  Added “Contents” section links to all Documentation chapters for consistent navigation.
5.  Standardized step-style headings in Deploy & Operations (`Step 1:` / `Step 2:` …) where headings previously used `1)` / `2)` formatting.

## Changes on 16.02.2026

1.  Replaced the old “New Projects” instruction list with two announcement/service blocks (boxed items) shown after login in both local and LDAP modes.
2.  Added dedicated styles for the new announcement/service panels and boxed items.
3.  Added a **Modify Text (Announcements)** section in **Setup & Infrastructure** with the edit location.
4.  Restructured the service block into grouped boxes with bullet lists and added the Inter font (extralight italic) for announcement panels.
5.  Updated **Setup & Infrastructure** quick‑resume references and removed redundant numbering from sub‑headings.
6.  Softened the announcement box border color.
7.  Made project deletion admin‑only (UI hides delete for non‑admins; backend enforces admin‑only delete).
8.  Documented admin‑only delete policy and rollback steps in **Deploy & Operations**.
9.  Added troubleshooting note for Quarto search requiring a local web server.
10. Added full‑name support for users (LDAP full name mapping, `users.full_name`, and full‑name display in project lists).
11. Added a legacy import workflow and script for perl‑VM → shiny‑VM migration, plus a separate vhost cutover script.
12. Fixed the perl‑VM PostgreSQL legacy export query to match the real schema (`ref_genome.genome`, `sample_type.type`, `type.type`, `budget_group.budget`).
13. Documented CSV encoding normalization (mojibake fix) and post‑import budget holder placeholder cleanup.

## Changes on 13.02.2026

1.  New project emails now **prefix the subject with the project ID** (e.g., `P2 - ...`).
2.  Project description (if provided) is appended to the email body.
3.  Email recipients changed to **budget holder + project creator + `ngs@biochem.mpg.de`**.  
    Admin broadcast is retained in the code but **commented out** for easy rollback.
4.  Notes were converted from `.md` to `.qmd` with a consistent header template, and the booklet generator now reads the `.qmd` sources.


## Changes on 12.02.2026

1.  Fixed LDAP URL impersonation risk by enforcing canonical `auth_user` handling in Apache: tampered `?auth_user=` values are rewritten to the authenticated LDAP user.
2.  Fixed redirect-loop behavior in the Apache auth rewrite logic and validated canonical redirect behavior with `curl` (expected `302` to the authenticated user).
3.  Confirmed and documented required shiny-server environment for LDAP mode:
    - `AUTH_MODE=ldap`
    - `TRUST_PROXY_AUTH_USER_QUERY=1`
4.  Extended `scripts/deploy.sh` with post-deploy LDAP smoke tests (canonical redirect, tampered query rewrite, final `200` response) and actionable failure hints.
5.  Added/merged troubleshooting guidance for LDAP login failures, disconnects, and redirect loops into the VM troubleshooting documentation.
6.  Improved Projects table readability in the Shiny UI (`sequencing-app/app.R`):
    - explicit DT column widths
    - wrapped long cell text
    - reliable column reflow on tab switch and resize
    - preserved horizontal scrolling and existing formatting.


## Changes on 11.02.2026

1.  Added a production rollout checklist with the exact commands for pull, backup, deploy, restart, and smoke‑tests.
2.  Added a dedicated section for **admin access in LDAP mode** (pre‑create vs promote after first login).
3.  Added a dedicated section on **switching between LDAP and local auth** on the VM (`AUTH_MODE` via systemd override).
4.  Added the full **pre‑create admin** example that includes `password`/`email` for NOT NULL constraints.
5.  Updated the canonical server path to `/srv/shiny-server` and corrected repo path on the local machine.
6.  Moved legacy/obsolete content to the end of the document under **Obsolete / now wrong**.
7.  Replaced the old deploy script reference (`deploy_shiny_server.sh`) with `scripts/deploy.sh`.


## Changes on 09.02.2026

1.  Added a VM rollout HOW‑TO (GitHub SSH/deploy keys, divergent branches, DB tracking fix, backups, deploy, restart, rollback).
2.  Documented production safeguards (app folder backup, DB backup, Apache config backup).
3.  Updated `scripts/deploy.sh` to restart Shiny only if `rsync` succeeds (prevents restarts on failed deploys).
4.  Cleaned up Apache LDAP logging (default to quiet logs; debug only when explicitly enabled).
5.  Made LDAP debug output in the Shiny app conditional on **both** `APP_ENV=dev` and `LDAP_DEBUG=1` to avoid production log noise.
6.  Documented the VM LDAP validation test (real user + service group user, and email routing behavior).

### VM rollout validation (what I tested and confirmed)

I verified end‑to‑end behavior on the VM after fixing the Apache proxy path:

-   **LDAP login works**: the browser prompts for username/password and redirects to `/sequencing-app/?auth_user=<user>`.
-   **User mapping works**: `yeroslaviz` (OU contains Cox) is mapped to the **Cox** group and the correct PI.
-   **User mapping works**: `yeroslaviz-test` (OU = **NGS Facility**) is treated as a service‑group user (no PI match).
-   **Email routing works**: research group users trigger mail to the PI **and** NGS.
-   **Email routing works**: service group users (no PI match) trigger mail to the **administrator**.

If all three happen, the LDAP→app→email flow is working as intended.


## Changes on 06.02.2026

1.  Added LDAP login flow in the Shiny app (auto‑login via `X-Remote-User`, local dev simulation, and optional attribute lookup).
2.  LDAP attribute lookup now works with anonymous bind; uses `ldapsearch` fallback for older `ldapr` versions.
3.  Added dev tools toggle (dev only) to switch between LDAP and local auth while testing.
4.  Mapped LDAP `ou` values to budget holders, auto‑selecting the correct PI in the project form (with partial match fallback).
5.  Added budget holder notices for multiple cost centers and missing cost center values.
6.  Added “Other / not listed” budget holder option so users can enter a new PI (name/surname required; cost center optional with a warning).
7.  Updated `scripts/deploy.sh` to use `rsync` and exclude `sequencing_projects.db`.
8.  Updated Apache LDAP configuration template and added local dev testing instructions + env var cleanup.
9.  I do **not** track SQLite DB files in git because they change constantly, are environment‑specific (local vs VM), and can contain sensitive data. I ignore `*.db`/`*.sqlite` and keep only the schema/seed files in git.


## Changes on 14.11.2026

1. changing admin email address
2. add editing possibilities to the tables containing costs information.
3. bi-weekly backup is added, but still commented out. 
4. list of group leaders can now be read from an Excel sheet (must be in the same folder)
5. SQL‑related commands and explanations (admin email updates, service cost updates, registration/budget holder DB updates, and DB inspection) were moved to **`notes/sql-handling.qmd`**.
