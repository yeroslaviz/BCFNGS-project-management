---
title: "SQL Handling"
execute:
  eval: false
  echo: true
  warning: false
---

## SQL handling

### Contents

- [Database locations](#database-locations)
- [Inspect database structure](#inspect-database-structure)
- [Admin users in LDAP mode](#admin-users-in-ldap-mode)
- [Update budget holders (CSV vs DB)](#update-budget-holders-csv-vs-db)
- [Rebuild the database (when/why/how)](#rebuild-the-database-whenwhyhow)
- [Legacy import (perl‑VM → shiny‑VM)](#legacy-import-perlvm--shinyvm)
- [Backups and retention](#backups-and-retention)
- [Git tracking for DB files](#git-tracking-for-db-files)
- [Common fixes](#common-fixes)

### Database locations

- **Local dev**: `sequencing-app/sequencing_projects.db`
- **VM**: `/srv/shiny-server/sequencing-app/sequencing_projects.db`

On the VM, run SQL commands as the `shiny` user:

```bash
sudo -u shiny sqlite3 /srv/shiny-server/sequencing-app/sequencing_projects.db "SELECT 1;"
```

### Inspect database structure

**Show all tables**

```bash
sudo -u shiny sqlite3 /srv/shiny-server/sequencing-app/sequencing_projects.db ".tables"
```

**Show table schema**

```bash
sudo -u shiny sqlite3 /srv/shiny-server/sequencing-app/sequencing_projects.db \
"PRAGMA table_info(users);"
```

**Show CREATE statement**

```bash
sudo -u shiny sqlite3 /srv/shiny-server/sequencing-app/sequencing_projects.db \
".schema users"
```

**Preview rows**

```bash
sudo -u shiny sqlite3 /srv/shiny-server/sequencing-app/sequencing_projects.db \
"SELECT username, email, is_admin FROM users LIMIT 20;"
```

### Admin users in LDAP mode

When `AUTH_MODE=ldap` is enabled, local login is disabled.  
To grant admin access, mark the LDAP user as admin in SQLite.

**Option 1: Pre‑create the user as admin (before first login)**

```bash
sudo -u shiny sqlite3 /srv/shiny-server/sequencing-app/sequencing_projects.db \
"INSERT OR IGNORE INTO users (username, is_admin) VALUES ('soyer', 1);"
```

If the insert is ignored because `password`/`email` are NOT NULL, use:

```bash
sudo -u shiny sqlite3 /srv/shiny-server/sequencing-app/sequencing_projects.db \
"INSERT OR IGNORE INTO users (username, password, email, is_admin) VALUES ('soyer', 'ldap-only', 'soyer@biochem.mpg.de', 1);"
```

**Option 2: Promote after first login**

```bash
sudo -u shiny sqlite3 /srv/shiny-server/sequencing-app/sequencing_projects.db \
"UPDATE users SET is_admin=1 WHERE username='soyer';"
```

**List all admin users**

```bash
sudo -u shiny sqlite3 /srv/shiny-server/sequencing-app/sequencing_projects.db \
"SELECT username, email, is_admin FROM users WHERE is_admin = 1;"
```

### Update budget holders (CSV vs DB)

The app reads **budget holders from the SQLite DB**, not directly from the CSV.  
Editing the Excel/CSV file does **not** change the running app unless you rebuild the DB.

**Option A — Update via the app (safe, no rebuild)**  
Use **Administer Projects → Manage Budget Holders**. Changes are written to the DB immediately.

**Option B — Update via SQL (safe, no rebuild)**

```bash
# Update cost center
sudo -u shiny sqlite3 /srv/shiny-server/sequencing-app/sequencing_projects.db \
"UPDATE budget_holders SET cost_center='P350' WHERE name='Cox' AND surname='Juergen';"

# Add a new PI
sudo -u shiny sqlite3 /srv/shiny-server/sequencing-app/sequencing_projects.db \
"INSERT INTO budget_holders (name, surname, cost_center, email) VALUES ('NewPI','Lastname','P999','newpi@biochem.mpg.de');"
```

**Option C — Rebuild DB from CSV (destructive)**  
See the rebuild section below.

### Rebuild the database (when/why/how)

You only need a full rebuild when the **schema** changes (e.g., CHECK constraints, new columns, removed columns).

**When a rebuild makes sense**

- Test instance and it’s OK to reset.
- `setup_database.R` changed and you want a clean schema.
- You want to permanently remove a legacy status/constraint.

**When *not* to rebuild**

- You already have production data.
- You only changed app logic/UI.

**Rebuild procedure (VM)**

The rebuild **must run inside** `/srv/shiny-server/sequencing-app` so relative paths (e.g., `budget_holders.csv`) resolve correctly.

```bash
sudo systemctl stop shiny-server

# Backup first
cp /srv/shiny-server/sequencing-app/sequencing_projects.db \
  /srv/shiny-server/sequencing_projects.db.backup_$(date +%Y%m%d_%H%M)

# Remove DB
rm /srv/shiny-server/sequencing-app/sequencing_projects.db

# Recreate DB from schema (run in the live app folder)
cd /srv/shiny-server/sequencing-app
sudo -u shiny Rscript setup_database.R

sudo systemctl start shiny-server
```

### Legacy import (perl‑VM → shiny‑VM)

This workflow imports legacy projects from the perl‑VM (PostgreSQL) into the shiny‑VM (SQLite).

**Step 1 — Export CSV on perl‑VM (PostgreSQL)**

Run this on the perl‑VM (adjust DB user if needed):

```bash
psql -U letunic -h 127.0.0.1 -d mpiseq2_db -c "\
\\copy (\
  SELECT \
    p.id AS legacy_id, \
    p.name AS project_name, \
    m.login AS login, \
    m.name AS user_full_name, \
    l.name AS group_name, \
    COALESCE(p.ref_genome_legacy, rg.genome) AS reference_genome, \
    COALESCE(p.sample_type_legacy, st.type) AS sample_type, \
    t.type AS type_label, \
    p.sequencing_length AS sequencing_length, \
    COALESCE(p.budget_group_legacy, bg.budget) AS budget_group, \
    p.sequencing_platform AS sequencing_platform, \
    COALESCE(p.sequencing_kit_legacy, p.sequencing_kit) AS sequencing_kit, \
    p.sequencing_index AS sequencing_index, \
    p.note AS note \
  FROM project.project p \
  LEFT JOIN people.member m ON p.user_id = m.id \
  LEFT JOIN people.lab l ON m.lab_id = l.id \
  LEFT JOIN project.ref_genome rg ON p.ref_genome_id = rg.id \
  LEFT JOIN project.sample_type st ON p.sample_type_id = st.id \
  LEFT JOIN project.type t ON p.type_id = t.id \
  LEFT JOIN project.budget_group bg ON p.budget_group_id = bg.id \
  ORDER BY p.id\
) TO '/www/mpiseq2/exports/legacy_projects.csv' CSV HEADER"
```

**Step 2 — Normalize encoding (optional)**

If names look like `MÃ¼ller` in the CSV, normalize the file before import.

**Recommended (robust)**

```bash
sudo python3 - <<'PY'
src = "/www/mpiseq2/exports/legacy_projects.csv"
dst = "/www/mpiseq2/exports/legacy_projects.utf8.csv"
with open(src, "r", encoding="utf-8", errors="ignore") as f, \
     open(dst, "w", encoding="utf-8") as out:
    for line in f:
        if "Ã" in line or "Â" in line:
            line = line.encode("latin1", errors="ignore").decode("utf-8", errors="ignore")
        out.write(line)
PY
```

**Alternative (iconv)**

```bash
sudo sh -c "iconv -f UTF-8 -t ISO-8859-1 /www/mpiseq2/exports/legacy_projects.csv \
  | iconv -f ISO-8859-1 -t UTF-8 \
  > /www/mpiseq2/exports/legacy_projects.utf8.csv"
```

Use the `.utf8.csv` file in the next steps if you ran this.

**Step 3 — Copy CSV to shiny‑VM (if needed)**

If perl‑VM and shiny‑VM are different machines, copy the CSV:

```bash
scp /www/mpiseq2/exports/legacy_projects.csv USER@shiny-vm:/home/yeroslaviz/BCFNGS-project-management/exports/
```

If you normalized, copy the `.utf8.csv` instead.

**Step 4 — Run the import script on shiny‑VM**

Stop Shiny Server first (avoids open DB handles) and run the import as the `shiny` user (the DB is owned by `shiny` on the VM).

```bash
sudo systemctl stop shiny-server
cd /srv/shiny-server/sequencing-app
sudo -u shiny python3 /home/yeroslaviz/BCFNGS-project-management/scripts/import_legacy_projects.py \
  --db /srv/shiny-server/sequencing-app/sequencing_projects.db \
  --csv /home/yeroslaviz/BCFNGS-project-management/exports/legacy_projects.csv
sudo systemctl start shiny-server
```

If you normalized, point `--csv` at `legacy_projects.utf8.csv`.

**What the import does**

- Preserves legacy IDs (`project_id = legacy_id` → UI shows `P<id>`).
- Sets `status = "Legacy project"`.
- Stores `responsible_user` as the **full name** (from the CSV).
- Maps **Type → `types`** and **Sample type → `service_types`** (no legacy suffix).
- Creates placeholders if a budget holder is missing (reported at the end).
- Adds `users.full_name` and extends the status constraint to allow `Legacy project` if missing.

**Post‑import: resolve placeholder budget holders (if any)**

If the import prints missing groups and creates placeholder `budget_holders` rows (typically `surname = 'Legacy'`), you can repoint projects to the real PI/cost center and then delete placeholders.

1. List placeholder budget holders:

```bash
sudo -u shiny sqlite3 /srv/shiny-server/sequencing-app/sequencing_projects.db \
"SELECT id, surname, name, email, cost_center FROM budget_holders WHERE surname='Legacy' ORDER BY id;"
```

2. Find the “real” budget holder IDs (example by cost center):

```bash
sudo -u shiny sqlite3 /srv/shiny-server/sequencing-app/sequencing_projects.db \
"SELECT id, surname, name, email, cost_center FROM budget_holders WHERE cost_center IN ('K120','K250','K411');"
```

3. Repoint projects from placeholder IDs to the real IDs, then delete placeholders (example):

```bash
sudo -u shiny sqlite3 /srv/shiny-server/sequencing-app/sequencing_projects.db \
"UPDATE projects SET budget_id = 30 WHERE budget_id = 47;
 UPDATE projects SET budget_id = 13 WHERE budget_id = 50;
 UPDATE projects SET budget_id = 23 WHERE budget_id = 51;
 DELETE FROM budget_holders WHERE id IN (47,50,51);"
```

4. Verify no projects still reference placeholders:

```bash
sudo -u shiny sqlite3 /srv/shiny-server/sequencing-app/sequencing_projects.db \
"SELECT budget_id, COUNT(*) FROM projects WHERE budget_id IN (47,50,51) GROUP BY budget_id;"
```

**Verify**

```bash
sudo -u shiny sqlite3 /srv/shiny-server/sequencing-app/sequencing_projects.db \
"SELECT project_id, project_name, status FROM projects WHERE status='Legacy project' ORDER BY project_id LIMIT 10;"
```

### Backups and retention

If the VM backup script is enabled, it typically copies the DB with a timestamp and deletes old backups:

```bash
cp /srv/shiny-server/sequencing-app/sequencing_projects.db $BACKUP_DIR/sequencing_projects.db.$TIMESTAMP
find $BACKUP_DIR -name "sequencing_projects.db.*" -mtime +30 -delete
```

### Git tracking for DB files

SQLite DB files change constantly and are environment‑specific.  
They should **not** be tracked in git.

If a DB file is accidentally tracked:

```bash
git rm --cached sequencing-app/sequencing_projects.db
git commit -m "Stop tracking local SQLite DB"
```

This **does not** delete the local DB file — it only stops tracking it.

### Common fixes

**Readonly database error**

Run SQL as the `shiny` user and fix permissions:

```bash
sudo chown shiny:shiny /srv/shiny-server/sequencing-app/sequencing_projects.db
sudo chmod 664 /srv/shiny-server/sequencing-app/sequencing_projects.db
```

**Update admin email**

```bash
sudo -u shiny sqlite3 /srv/shiny-server/sequencing-app/sequencing_projects.db \
"UPDATE users SET email='newadmin@institute.org' WHERE username='admin';"
```

**Update service type costs**

```bash
sudo -u shiny sqlite3 /srv/shiny-server/sequencing-app/sequencing_projects.db \
"UPDATE service_types SET costs_per_sample = 55 WHERE service_type = 'single cell/low mRNAseq';"
```

**Verify LDAP user attributes in SQLite**

```r
con <- DBI::dbConnect(RSQLite::SQLite(), "sequencing-app/sequencing_projects.db")
DBI::dbGetQuery(con, "SELECT username, email, phone, research_group FROM users WHERE username='your_username'")
DBI::dbDisconnect(con)
```
