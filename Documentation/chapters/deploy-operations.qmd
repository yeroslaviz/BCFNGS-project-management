---
title: "Deploy & Operations"
execute:
  eval: false
  echo: true
  warning: false
---

## Deploy & Operations

### Contents

- [Project Deletion Permissions](#project-deletion-permissions)
- [Deploy Workflow](#deploy-workflow)
- [Deploy Scope and DB Behavior](#deploy-scope-and-db-behavior)
- [LDAP Deploy Smoke Tests](#ldap-deploy-smoke-tests)
- [Backups (summary)](#backups-summary)
- [ngs-vm Cutover (443/9443)](#ngs-vm-cutover-4439443)

## Project Deletion Permissions

Deletion is **admin-only**:

- The Delete button is only shown when `user$is_admin` is true.
- The backend also enforces admin-only deletion.
- A delete performs a hard remove from the SQL DB: `DELETE FROM projects WHERE id = ?`.

### Re-enable delete for non-admin users

In `/Users/yeroslaviz/Documents/Github/BCFNGS-project-management/sequencing-app/app.R`:

1. In `output$user_interface`, render the button unconditionally (remove the `if (user$is_admin)` guard around `delete_project_btn`).
2. In the `observeEvent(input$delete_project_btn)` handler, allow owners again:
   - Change `can_delete <- user$is_admin` back to:
     - `can_delete <- user$is_admin || project$user_id == user$user_id`

Rebuild/redeploy after changes.

## Deploy Workflow

### Production rollout checklist (quick reference)

This is the short checklist I use on production. Details for each step are below in the VM rollout HOW‑TO section.

1.  Confirm GitHub access and pull latest code.

```{bash}
ssh -T git@github.com
cd /home/yeroslaviz/BCFNGS-project-management
git pull origin main
```

2.  Take backups (app folder, SQLite DB, Apache config).

```{bash}
sudo rsync -av /srv/shiny-server/sequencing-app/ /srv/shiny-server/sequencing-app.backup_$(date +%Y%m%d_%H%M)/
cp /srv/shiny-server/sequencing-app/sequencing_projects.db \
  /srv/shiny-server/sequencing_projects.db.backup_$(date +%Y%m%d_%H%M)
sudo cp /etc/apache2/sites-enabled/01-main.conf \
  /etc/apache2/sites-enabled/01-main.conf.backup_$(date +%Y%m%d_%H%M)
```

3.  Deploy.

```{bash}
./scripts/deploy.sh
```

4.  Restart services.

```{bash}
sudo systemctl restart shiny-server
sudo systemctl restart apache2
```

5.  Smoke‑test login and app behavior.

```{bash}
curl -Ik https://ngs-testing-vm.biochem.mpg.de/
curl -Ik -u USER https://ngs-testing-vm.biochem.mpg.de/
curl -Ik -u USER https://ngs-testing-vm.biochem.mpg.de/sequencing-app/
```

6.  Roll back from backups if needed.

```{bash}
sudo rsync -av --delete /srv/shiny-server/sequencing-app.backup_YYYYMMDD_HHMM/ /srv/shiny-server/sequencing-app/
sudo systemctl restart shiny-server
sudo systemctl restart apache2
```


### VM rollout HOW‑TO (Git + deploy + safety)

This is the repeatable checklist I use when rolling out to a VM (first `ngs-testing-vm`, then `ngs-vm`).

#### Step 1: Make sure GitHub access works on the VM

Check which remote is set:

```{bash}
git -C /home/yeroslaviz/BCFNGS-project-management remote -v
```

If the remote is SSH (`git@github.com:...`), verify SSH access:

```{bash}
ssh -T git@github.com
```

If SSH works but `git pull` still says **Permission denied (publickey)**, the VM key is **not added** to the repo. The fix is to add the VM public key as a **Deploy Key**:

```{bash}
cat ~/.ssh/id_ed25519.pub
```

Then add that key in GitHub:
`Repo → Settings → Deploy keys → Add deploy key` (read‑only is enough for pull).

#### Step 2: Pull latest code

```{bash}
cd /home/yeroslaviz/BCFNGS-project-management
git pull origin main
```

If Git says **divergent branches**, I set merge as the default and pull again:

```{bash}
git config pull.rebase false
git pull origin main
```

If Git refuses because of the local SQLite DB file, I stop tracking the DB on the VM:

```{bash}
git rm --cached sequencing-app/sequencing_projects.db
git commit -m "Stop tracking local SQLite DB on VM"
git pull origin main
```

This does **not** delete the local DB file. It just removes it from Git so future pulls work.

#### Step 3: Production safety backups (fast rollback)

```{bash}
sudo rsync -av /srv/shiny-server/sequencing-app/ /srv/shiny-server/sequencing-app.backup_$(date +%Y%m%d_%H%M)/
cp /srv/shiny-server/sequencing-app/sequencing_projects.db \
  /srv/shiny-server/sequencing-app/sequencing_projects.db.backup_$(date +%Y%m%d_%H%M)
sudo cp /etc/apache2/sites-enabled/01-main.conf \
  /etc/apache2/sites-enabled/01-main.conf.backup_$(date +%Y%m%d_%H%M)
```

#### Step 4: Deploy

```{bash}
./scripts/deploy.sh
```

#### Step 5: Restart and smoke‑test

```{bash}
sudo systemctl restart shiny-server
sudo systemctl restart apache2
```

Then open the app URL and verify:
- LDAP prompt appears
- login works
- app loads

#### Step 6: Rollback (if needed)

```{bash}
sudo rsync -av --delete /srv/shiny-server/sequencing-app.backup_YYYYMMDD_HHMM/ /srv/shiny-server/sequencing-app/
sudo systemctl restart shiny-server
sudo systemctl restart apache2
```

## Deploy Scope and DB Behavior

`scripts/deploy.sh` is **code deployment only**:

- syncs app files from repo -> `/srv/shiny-server/sequencing-app/`
- excludes `sequencing_projects.db`
- restarts `shiny-server`
- runs LDAP smoke tests (unless `SKIP_SMOKE_TEST=1`)

It does **not**:

- rebuild the DB
- import legacy CSV
- run `setup_database.R`

### When to run deploy

Run deploy after changes to app code/config in:

- `/home/yeroslaviz/BCFNGS-project-management/sequencing-app/`

Do not use deploy for Apache-only changes; apply Apache config separately.

### Restart vs rebuild

- Restarting `shiny-server` does not remove DB content.
- Rebuild is a manual, explicit action (`setup_database.R`) and should be done only when needed.

### Safe DB snapshot around risky maintenance

```bash
sudo systemctl stop shiny-server
sudo cp /srv/shiny-server/sequencing-app/sequencing_projects.db /srv/shiny-server/sequencing-app/sequencing_projects.db.bak.$(date +%F-%H%M%S)
sudo systemctl start shiny-server
```

Restore snapshot:

```bash
sudo systemctl stop shiny-server
sudo cp /srv/shiny-server/sequencing-app/sequencing_projects.db.bak.<timestamp> /srv/shiny-server/sequencing-app/sequencing_projects.db
sudo chown shiny:shiny /srv/shiny-server/sequencing-app/sequencing_projects.db
sudo systemctl start shiny-server
```


## LDAP Deploy Smoke Tests

### Step 1: Deploy with built-in smoke tests

Run on VM:

```bash
cd ~/BCFNGS-project-management
./scripts/deploy.sh
```

The script now:

1. Deploys app files to `/srv/shiny-server/sequencing-app/`
2. Restarts `shiny-server`
3. Runs LDAP smoke tests:
   - `/sequencing-app/` returns `302` to canonical `?auth_user=<logged-user>`
   - tampered `?auth_user=other` is rewritten to `?auth_user=<logged-user>`
   - final app load returns `200`

It exits with non-zero status and prints remediation hints if any check fails.

## Backups (summary)

This project currently has three backup mechanisms:

1. Manual **pre-deploy rollback backups** (recommended before any deploy/maintenance): copy the app folder, the SQLite DB, and the Apache vhost config with a timestamp. See “Production safety backups (fast rollback)” above.
2. Manual **in-app backup/restore** (Admin UI): admins can download a `.sqlite` backup and restore it later (restore makes a pre-restore copy first).
3. **Automatic bi-weekly backups**: present in the app code but **commented out / disabled** by default.

Note:

- `scripts/deploy.sh` syncs app code only. If you changed Apache config, apply/restart Apache separately, then run curl checks.


### Step 2: Non-interactive usage (optional)

If you do not want password prompts:

```bash
LDAP_TEST_USER="yeroslaviz-test" LDAP_TEST_PASSWORD="YOUR_PASSWORD" ./scripts/deploy.sh
```

Skip smoke tests only when needed:

```bash
SKIP_SMOKE_TEST=1 ./scripts/deploy.sh
```

Override target base URL:

```bash
PUBLIC_BASE_URL="https://ngs-vm.biochem.mpg.de" ./scripts/deploy.sh
```

## ngs-vm Cutover (443/9443)

Target state:

- `https://ngs-vm.biochem.mpg.de` -> Shiny on `:443`
- `https://ngs-vm.biochem.mpg.de:9443` -> Perl fallback

This avoids TLS hostname mismatch (same hostname for both endpoints).

### Step 1: Prepare vhost templates

Use these repo templates:

- `scripts/ngs-vm-shiny-443.conf`
- `scripts/ngs-vm-perl-9443.conf`

Copy to Apache:

```bash
sudo cp /home/yeroslaviz/BCFNGS-project-management/scripts/ngs-vm-shiny-443.conf /etc/apache2/sites-available/ngs-vm-shiny-443.conf
sudo cp /home/yeroslaviz/BCFNGS-project-management/scripts/ngs-vm-perl-9443.conf /etc/apache2/sites-available/ngs-vm-perl-9443.conf
```

### Step 2: Enable routing and switch traffic

```bash
grep -q '^Listen 9443$' /etc/apache2/ports.conf || echo 'Listen 9443' | sudo tee -a /etc/apache2/ports.conf
sudo a2enmod ssl proxy proxy_http proxy_wstunnel rewrite headers ldap authnz_ldap
sudo a2ensite ngs-vm-shiny-443.conf
sudo a2ensite ngs-vm-perl-9443.conf
sudo a2dissite 02-testing.conf
sudo apache2ctl -t
sudo systemctl restart apache2
```

### Step 3: Validate

```bash
curl -kI https://ngs-vm.biochem.mpg.de/
curl -kI -u USER https://ngs-vm.biochem.mpg.de/sequencing-app/
curl -kI https://ngs-vm.biochem.mpg.de:9443/
```

### Step 4: Rollback

```bash
sudo a2ensite 02-testing.conf
sudo a2dissite ngs-vm-shiny-443.conf
sudo a2dissite ngs-vm-perl-9443.conf
sudo apache2ctl -t
sudo systemctl restart apache2
```

### Step 5: Scripted switch (optional)

Use:

```bash
cd /home/yeroslaviz/BCFNGS-project-management
./scripts/cutover_ngs_vm_ports.sh cutover
```

Rollback:

```bash
cd /home/yeroslaviz/BCFNGS-project-management
./scripts/cutover_ngs_vm_ports.sh rollback
```
