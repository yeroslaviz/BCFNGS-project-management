---
title: "Deploy & Operations"
execute:
  eval: false
  echo: true
  warning: false
---

## Deploy Workflow

### Production rollout checklist (quick reference)

This is the short checklist I use on production. Details for each step are below in the VM rollout HOW‑TO section.

1.  Confirm GitHub access and pull latest code.

```{bash}
ssh -T git@github.com
cd /home/yeroslaviz/BCFNGS-project-management
git pull origin main
```

2.  Take backups (app folder, SQLite DB, Apache config).

```{bash}
sudo rsync -av /srv/shiny-server/sequencing-app/ /srv/shiny-server/sequencing-app.backup_$(date +%Y%m%d_%H%M)/
cp /srv/shiny-server/sequencing-app/sequencing_projects.db \
  /srv/shiny-server/sequencing_projects.db.backup_$(date +%Y%m%d_%H%M)
sudo cp /etc/apache2/sites-enabled/01-main.conf \
  /etc/apache2/sites-enabled/01-main.conf.backup_$(date +%Y%m%d_%H%M)
```

3.  Deploy.

```{bash}
./deploy.sh
```

4.  Restart services.

```{bash}
sudo systemctl restart shiny-server
sudo systemctl restart apache2
```

5.  Smoke‑test login and app behavior.

```{bash}
curl -Ik https://ngs-testing-vm.biochem.mpg.de/
curl -Ik -u USER https://ngs-testing-vm.biochem.mpg.de/
curl -Ik -u USER https://ngs-testing-vm.biochem.mpg.de/sequencing-app/
```

6.  Roll back from backups if needed.

```{bash}
sudo rsync -av --delete /srv/shiny-server/sequencing-app.backup_YYYYMMDD_HHMM/ /srv/shiny-server/sequencing-app/
sudo systemctl restart shiny-server
sudo systemctl restart apache2
```


### VM rollout HOW‑TO (Git + deploy + safety)

This is the repeatable checklist I use when rolling out to a VM (first `ngs-testing-vm`, then `ngs-vm`).

#### 1) Make sure GitHub access works on the VM

Check which remote is set:

```{bash}
git -C /home/yeroslaviz/BCFNGS-project-management remote -v
```

If the remote is SSH (`git@github.com:...`), verify SSH access:

```{bash}
ssh -T git@github.com
```

If SSH works but `git pull` still says **Permission denied (publickey)**, the VM key is **not added** to the repo. The fix is to add the VM public key as a **Deploy Key**:

```{bash}
cat ~/.ssh/id_ed25519.pub
```

Then add that key in GitHub:
`Repo → Settings → Deploy keys → Add deploy key` (read‑only is enough for pull).

#### 2) Pull latest code

```{bash}
cd /home/yeroslaviz/BCFNGS-project-management
git pull origin main
```

If Git says **divergent branches**, I set merge as the default and pull again:

```{bash}
git config pull.rebase false
git pull origin main
```

If Git refuses because of the local SQLite DB file, I stop tracking the DB on the VM:

```{bash}
git rm --cached sequencing-app/sequencing_projects.db
git commit -m "Stop tracking local SQLite DB on VM"
git pull origin main
```

This does **not** delete the local DB file. It just removes it from Git so future pulls work.

#### 3) Production safety backups (fast rollback)

```{bash}
sudo rsync -av /srv/shiny-server/sequencing-app/ /srv/shiny-server/sequencing-app.backup_$(date +%Y%m%d_%H%M)/
cp /srv/shiny-server/sequencing-app/sequencing_projects.db \
  /srv/shiny-server/sequencing-app/sequencing_projects.db.backup_$(date +%Y%m%d_%H%M)
sudo cp /etc/apache2/sites-enabled/01-main.conf \
  /etc/apache2/sites-enabled/01-main.conf.backup_$(date +%Y%m%d_%H%M)
```

#### 4) Deploy

```{bash}
./deploy.sh
```

#### 5) Restart and smoke‑test

```{bash}
sudo systemctl restart shiny-server
sudo systemctl restart apache2
```

Then open the app URL and verify:
- LDAP prompt appears
- login works
- app loads

#### 6) Rollback (if needed)

```{bash}
sudo rsync -av --delete /srv/shiny-server/sequencing-app.backup_YYYYMMDD_HHMM/ /srv/shiny-server/sequencing-app/
sudo systemctl restart shiny-server
sudo systemctl restart apache2
```


## LDAP Deploy Smoke Tests

### 1) Deploy with built-in smoke tests

Run on VM:

```bash
cd ~/BCFNGS-project-management
./deploy.sh
```

The script now:

1. Deploys app files to `/srv/shiny-server/sequencing-app/`
2. Restarts `shiny-server`
3. Runs LDAP smoke tests:
   - `/sequencing-app/` returns `302` to canonical `?auth_user=<logged-user>`
   - tampered `?auth_user=other` is rewritten to `?auth_user=<logged-user>`
   - final app load returns `200`

It exits with non-zero status and prints remediation hints if any check fails.

Note:

- `deploy.sh` syncs app code only. If you changed Apache config (`01-main.conf`), apply/restart Apache separately, then run the curl checks in section 4.


### 2) Non-interactive usage (optional)

If you do not want password prompts:

```bash
LDAP_TEST_USER="yeroslaviz-test" LDAP_TEST_PASSWORD="YOUR_PASSWORD" ./deploy.sh
```

Skip smoke tests only when needed:

```bash
SKIP_SMOKE_TEST=1 ./deploy.sh
```

Override target base URL:

```bash
PUBLIC_BASE_URL="https://ngs-testing-vm.biochem.mpg.de" ./deploy.sh
```


### 3) Baseline environment checks

#### Shiny environment must include:

```bash
sudo systemctl show shiny-server --property=Environment
```

Required values:

- `AUTH_MODE=ldap`
- `TRUST_PROXY_AUTH_USER_QUERY=1`

If missing, update:

```bash
sudo systemctl edit shiny-server
```

Then restart:

```bash
sudo systemctl daemon-reload
sudo systemctl restart shiny-server
```


### 4) Manual curl validation (reference)

These should match the smoke test behavior.

```bash
curl -ki -u yeroslaviz-test "https://ngs-testing-vm.biochem.mpg.de/sequencing-app/" | sed -n '1,20p'
```

Expected:

- `HTTP/1.1 302 Found`
- `Location: .../sequencing-app/?auth_user=yeroslaviz-test`

```bash
curl -ki -u yeroslaviz-test "https://ngs-testing-vm.biochem.mpg.de/sequencing-app/?auth_user=yeroslaviz" | sed -n '1,20p'
```

Expected:

- `HTTP/1.1 302 Found`
- `Location: .../sequencing-app/?auth_user=yeroslaviz-test`

```bash
curl -k -L -u yeroslaviz-test -o /dev/null -s -w "%{http_code}\n" "https://ngs-testing-vm.biochem.mpg.de/sequencing-app/"
```

Expected:

- `200`
