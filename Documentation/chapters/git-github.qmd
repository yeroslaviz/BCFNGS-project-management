---
title: "Git & GitHub"
execute:
  eval: false
  echo: true
  warning: false
---

## Git & GitHub

### Contents

- [GitHub Auth (new laptop)](#github-auth-new-laptop)
- [GitHub connection on VM (clone/pull/push)](#github-connection-on-vm-clonepullpush)
- [Enable push from the VM](#enable-push-from-the-vm)
- [Repo Setup on the VM](#repo-setup-on-the-vm)
- [Daily VM Git workflow](#daily-vm-git-workflow)
- [Feature Branch Workflow (Recommended)](#feature-branch-workflow-recommended)
- [Quick Branch-To-Production Flow](#quick-branch-to-production-flow)

## GitHub Auth (new laptop)

### Fix GitHub auth error on a new laptop

Error message:

```
remote: Invalid username or token.
Password authentication is not supported for Git operations.
```

This means Git is trying to use HTTPS + password. GitHub no longer accepts account passwords for Git operations.

### Recommended fix (SSH)

1. Check current remote:

```bash
git remote -v
```

2. Create an SSH key (if you do not already have one):

```bash
ssh-keygen -t ed25519 -C "your_email@biochem.mpg.de"
```

3. Start agent and add the key:

```bash
eval "$(ssh-agent -s)"
ssh-add ~/.ssh/id_ed25519
```

4. Copy public key and add it to GitHub:

```bash
cat ~/.ssh/id_ed25519.pub
```

GitHub: `Settings -> SSH and GPG keys -> New SSH key`

5. Switch repo remote to SSH:

```bash
git remote set-url origin git@github.com:yeroslaviz/BCFNGS-project-management.git
```

6. Test and pull:

```bash
ssh -T git@github.com
git pull origin main
```

### Fallback fix (HTTPS + PAT)

If SSH is not possible, use a Personal Access Token (PAT), not your account password.

1. Keep/set HTTPS remote:

```bash
git remote set-url origin https://github.com/yeroslaviz/BCFNGS-project-management.git
```

2. Pull/push and enter:
- Username: your GitHub username
- Password: your PAT token

3. Optional (store credentials on macOS keychain):

```bash
git config --global credential.helper osxkeychain
```

### Quick sanity check

```bash
git remote -v
git fetch origin
git status
```

For VM-side Git troubleshooting (divergent branches, stash/pull, merge conflicts), see **VM Troubleshooting Guide → Git / GitHub**.

## GitHub connection on VM (clone/pull/push)

Use SSH on the VM.

### Step 1: Create a VM SSH key

```bash
mkdir -p ~/.ssh
chmod 700 ~/.ssh
ssh-keygen -t ed25519 -C "<your-github-email>" -f ~/.ssh/id_ed25519_bcfngs_vm
chmod 600 ~/.ssh/id_ed25519_bcfngs_vm
chmod 644 ~/.ssh/id_ed25519_bcfngs_vm.pub
```

### Step 2: Load key and pin it in SSH config

```bash
eval "$(ssh-agent -s)"
ssh-add ~/.ssh/id_ed25519_bcfngs_vm
```

```bash
cat >> ~/.ssh/config <<'EOF'
Host github.com
  HostName github.com
  User git
  IdentityFile ~/.ssh/id_ed25519_bcfngs_vm
  IdentitiesOnly yes
EOF
chmod 600 ~/.ssh/config
```

### Step 3: Add key in GitHub

```bash
cat ~/.ssh/id_ed25519_bcfngs_vm.pub
```

Copy the full output (public key) and paste it in GitHub.
Do **not** paste the private key file.

Choose one:

1. **Deploy key (read-only)** on this repo: clone + pull only.
2. **User/account SSH key (write access)**: clone + pull + push.

Where to paste:

- Deploy key: [GitHub repo `BCFNGS-project-management`](https://github.com/yeroslaviz/BCFNGS-project-management) -> `Settings` -> `Deploy keys` -> `Add deploy key`.
- User key: GitHub account -> `Settings` -> `SSH and GPG keys` -> `New SSH key`.

After choosing:

( for bcf-vm, we choose only deploy key, since we don't plan to push changes from here.)

```
If we do make any local changes, we must run the following before pulling new changes (since they will probably fail)

git stash push -m "vm-local"
git pull --ff-only origin main
git stash pop

```

- If you chose **Deploy key (read-only)**:

```bash
cd /home/<user>
git clone git@github.com:yeroslaviz/BCFNGS-project-management.git
cd /home/<user>/BCFNGS-project-management
git pull --ff-only origin main
```

- If you chose **User/account SSH key (write access)**:

```bash
cd /home/<user>
git clone git@github.com:yeroslaviz/BCFNGS-project-management.git
cd /home/<user>/BCFNGS-project-management
git checkout -b <your-branch>
git push -u origin <your-branch>
```

Recommendation:

- On `ngs-vm` (production): use **Deploy key (read-only)**.
- On `bcf-vm` or local dev machines: use **User/account key** if you need push.

If you make local changes on a pull-only VM:

- Changes remain local.
- `git pull` can fail if local edits conflict with incoming changes.
- Safe pull pattern:

```bash
cd /home/<user>/BCFNGS-project-management
git stash push -m "local-vm-work"
git pull --ff-only origin main
git stash pop
```

If `stash pop` conflicts, resolve conflicts manually.

### Step 4: Verify access

```bash
ssh -T git@github.com
git ls-remote git@github.com:yeroslaviz/BCFNGS-project-management.git
```

## Enable push from the VM

If the VM currently uses a deploy key, push will be denied.
To allow push, use an SSH key attached to a GitHub user that has write permission.

Set Git identity on the VM:

```bash
git config --global user.name "Assa Yeroslaviz"
git config --global user.email "yeroslaviz@biochem.mpg.de"
git config --global pull.rebase false
```

Optional write test:

```bash
cd /home/<user>/BCFNGS-project-management
git checkout -b test/vm-write-check
git push -u origin test/vm-write-check
```

If push succeeds, delete the test branch:

```bash
git checkout main
git branch -D test/vm-write-check
git push origin --delete test/vm-write-check
```


## Repo Setup on the VM

Clone once:

```bash
cd /home/<user>
git clone git@github.com:yeroslaviz/BCFNGS-project-management.git
cd /home/<user>/BCFNGS-project-management
git remote -v
```

If the repo already exists with HTTPS remote, switch it to SSH:

```bash
cd /home/<user>/BCFNGS-project-management
git remote set-url origin git@github.com:yeroslaviz/BCFNGS-project-management.git
```

Expected server layout:

```
/srv/shiny-server/
├── sequencing-app/
│ ├── app.R
│ ├── setup_database.R
│ ├── sequencing_projects.db
│ └── www/
  │ ├── logo.png
  │ └── minerva.png
```

## Daily VM Git workflow

Pull latest `main`:

```bash
cd /home/<user>/BCFNGS-project-management
git checkout main
git pull --no-rebase origin main
```

Push your changes:

```bash
git checkout -b <your-branch>
git add .
git commit -m "your message"
git push -u origin <your-branch>
```

For pull conflicts/divergent branches, see **Troubleshooting → Git / GitHub**.

## Feature Branch Workflow (Recommended)

Use this flow for new features and bug fixes.

### Step 1: Start from updated `main`

```bash
cd /home/<user>/BCFNGS-project-management
git checkout main
git pull --ff-only origin main
```

### Step 2: Create and switch to a feature branch

```bash
git checkout -b codex/<short-feature-name>
```

### Step 3: Commit your work on the feature branch

```bash
git add <files>
git commit -m "<clear message>"
```

### Step 4: Push branch and open PR

```bash
git push -u origin codex/<short-feature-name>
```

Open a Pull Request from `codex/<short-feature-name>` -> `main`.

### Step 5: Test on VM from the same branch (optional but recommended)

```bash
cd /home/<user>/BCFNGS-project-management
git fetch origin
git checkout codex/<short-feature-name>
git pull --ff-only origin codex/<short-feature-name>
PUBLIC_BASE_URL="https://<vm-hostname>" ./scripts/deploy.sh
```

### Step 6: Merge PR, then sync local/VM to `main`

```bash
git checkout main
git pull --ff-only origin main
```

Optional cleanup:

```bash
git branch -d codex/<short-feature-name>
git push origin --delete codex/<short-feature-name>
```

## Quick Branch-To-Production Flow

Use this as the short operational checklist for normal feature delivery.

### Step 1: Start feature branch (local machine)

```bash
cd /Users/yeroslaviz/Documents/Github/BCFNGS-project-management
git checkout main
git pull --ff-only origin main
git checkout -b <feature-branch>
```

### Step 2: Commit and push (local machine)

```bash
git add <files>
git commit -m "<message>"
git push -u origin <feature-branch>
```

### Step 3: Test branch on test VM (`bcf-vm` or `ngs-testing-vm`)

```bash
cd /home/<user>/BCFNGS-project-management
git fetch origin
git checkout --track origin/<feature-branch>   # first time only
# or: git checkout <feature-branch>            # if local branch already exists
git pull --ff-only origin <feature-branch>
PUBLIC_BASE_URL="https://<vm-hostname>" ./scripts/deploy.sh
```

### Step 4: Merge PR on GitHub

Create PR from `<feature-branch>` to `main`, review, then merge.

### Step 5: Sync local `main` after merge

```bash
cd /Users/yeroslaviz/Documents/Github/BCFNGS-project-management
git checkout main
git pull --ff-only origin main
```

### Step 6: Deploy `main` to production (`ngs-vm`)

```bash
cd /home/yeroslaviz/BCFNGS-project-management
git checkout main
git pull --ff-only origin main
PUBLIC_BASE_URL="https://ngs-vm.biochem.mpg.de" ./scripts/deploy.sh
```

### Step 7: Optional branch cleanup

```bash
# local
git branch -d <feature-branch>

# remote
git push origin --delete <feature-branch>

# test VM (optional)
cd /home/<user>/BCFNGS-project-management
git checkout main
git branch -d <feature-branch>
```

### Notes

- `--ff-only` avoids accidental merge commits on pull.
- `deploy.sh` deploys code and restarts app; it does not rebuild DB.
- Production deployment should use `main` unless an explicit pre-merge production test is required.
