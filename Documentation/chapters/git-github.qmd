---
title: "Git & GitHub"
execute:
  eval: false
  echo: true
  warning: false
---

## Git & GitHub

### Contents

- [GitHub Auth (new laptop)](#github-auth-new-laptop)
- [GitHub connection on VM (clone/pull/push)](#github-connection-on-vm-clonepullpush)
- [Enable push from the VM](#enable-push-from-the-vm)
- [Repo Setup on the VM](#repo-setup-on-the-vm)
- [Daily VM Git workflow](#daily-vm-git-workflow)

## GitHub Auth (new laptop)

### Fix GitHub auth error on a new laptop

Error message:

```
remote: Invalid username or token.
Password authentication is not supported for Git operations.
```

This means Git is trying to use HTTPS + password. GitHub no longer accepts account passwords for Git operations.

### Recommended fix (SSH)

1. Check current remote:

```bash
git remote -v
```

2. Create an SSH key (if you do not already have one):

```bash
ssh-keygen -t ed25519 -C "your_email@biochem.mpg.de"
```

3. Start agent and add the key:

```bash
eval "$(ssh-agent -s)"
ssh-add ~/.ssh/id_ed25519
```

4. Copy public key and add it to GitHub:

```bash
cat ~/.ssh/id_ed25519.pub
```

GitHub: `Settings -> SSH and GPG keys -> New SSH key`

5. Switch repo remote to SSH:

```bash
git remote set-url origin git@github.com:yeroslaviz/BCFNGS-project-management.git
```

6. Test and pull:

```bash
ssh -T git@github.com
git pull origin main
```

### Fallback fix (HTTPS + PAT)

If SSH is not possible, use a Personal Access Token (PAT), not your account password.

1. Keep/set HTTPS remote:

```bash
git remote set-url origin https://github.com/yeroslaviz/BCFNGS-project-management.git
```

2. Pull/push and enter:
- Username: your GitHub username
- Password: your PAT token

3. Optional (store credentials on macOS keychain):

```bash
git config --global credential.helper osxkeychain
```

### Quick sanity check

```bash
git remote -v
git fetch origin
git status
```

For VM-side Git troubleshooting (divergent branches, stash/pull, merge conflicts), see **VM Troubleshooting Guide → Git / GitHub**.

## GitHub connection on VM (clone/pull/push)

Use SSH on the VM.

### Step 1: Create a VM SSH key

```bash
mkdir -p ~/.ssh
chmod 700 ~/.ssh
ssh-keygen -t ed25519 -C "<your-github-email>" -f ~/.ssh/id_ed25519_bcfngs_vm
chmod 600 ~/.ssh/id_ed25519_bcfngs_vm
chmod 644 ~/.ssh/id_ed25519_bcfngs_vm.pub
```

### Step 2: Load key and pin it in SSH config

```bash
eval "$(ssh-agent -s)"
ssh-add ~/.ssh/id_ed25519_bcfngs_vm
```

```bash
cat >> ~/.ssh/config <<'EOF'
Host github.com
  HostName github.com
  User git
  IdentityFile ~/.ssh/id_ed25519_bcfngs_vm
  IdentitiesOnly yes
EOF
chmod 600 ~/.ssh/config
```

### Step 3: Add key in GitHub

```bash
cat ~/.ssh/id_ed25519_bcfngs_vm.pub
```

Choose one:

1. **Deploy key (read-only)** on this repo: clone + pull only.
2. **User/account SSH key (write access)**: clone + pull + push.

After choosing:

- If you chose **Deploy key (read-only)**:

```bash
cd /home/<user>
git clone git@github.com:yeroslaviz/BCFNGS-project-management.git
cd /home/<user>/BCFNGS-project-management
git pull --ff-only origin main
```

- If you chose **User/account SSH key (write access)**:

```bash
cd /home/<user>
git clone git@github.com:yeroslaviz/BCFNGS-project-management.git
cd /home/<user>/BCFNGS-project-management
git checkout -b <your-branch>
git push -u origin <your-branch>
```

Recommendation:

- On `ngs-vm` (production): use **Deploy key (read-only)**.
- On `bcf-vm` or local dev machines: use **User/account key** if you need push.

If you make local changes on a pull-only VM:

- Changes remain local.
- `git pull` can fail if local edits conflict with incoming changes.
- Safe pull pattern:

```bash
cd /home/<user>/BCFNGS-project-management
git stash push -m "local-vm-work"
git pull --ff-only origin main
git stash pop
```

If `stash pop` conflicts, resolve conflicts manually.

### Step 4: Verify access

```bash
ssh -T git@github.com
git ls-remote git@github.com:yeroslaviz/BCFNGS-project-management.git
```

## Enable push from the VM

If the VM currently uses a deploy key, push will be denied.  
To allow push, use an SSH key attached to a GitHub user that has write permission.

Set Git identity on the VM:

```bash
git config --global user.name "Assa Yeroslaviz"
git config --global user.email "yeroslaviz@biochem.mpg.de"
git config --global pull.rebase false
```

Optional write test:

```bash
cd /home/<user>/BCFNGS-project-management
git checkout -b test/vm-write-check
git push -u origin test/vm-write-check
```

If push succeeds, delete the test branch:

```bash
git checkout main
git branch -D test/vm-write-check
git push origin --delete test/vm-write-check
```


## Repo Setup on the VM

Clone once:

```bash
cd /home/<user>
git clone git@github.com:yeroslaviz/BCFNGS-project-management.git
cd /home/<user>/BCFNGS-project-management
git remote -v
```

If the repo already exists with HTTPS remote, switch it to SSH:

```bash
cd /home/<user>/BCFNGS-project-management
git remote set-url origin git@github.com:yeroslaviz/BCFNGS-project-management.git
```

Expected server layout:

```
/srv/shiny-server/
├── sequencing-app/
│ ├── app.R
│ ├── setup_database.R
│ ├── sequencing_projects.db
│ └── www/
  │ ├── logo.png
  │ └── minerva.png
```

## Daily VM Git workflow

Pull latest `main`:

```bash
cd /home/<user>/BCFNGS-project-management
git checkout main
git pull --no-rebase origin main
```

Push your changes:

```bash
git checkout -b <your-branch>
git add .
git commit -m "your message"
git push -u origin <your-branch>
```

For pull conflicts/divergent branches, see **Troubleshooting → Git / GitHub**.
