---
title: "app.R Deep Breakdown"
execute:
  eval: false
  echo: true
  warning: false
---

# app.R Deep Breakdown

This file is a comprehensive companion to `/Users/yeroslaviz/Documents/Github/BCFNGS-project-management/sequencing-app/app.R` (currently ~5,884 lines).
It is intentionally verbose and written for readers with limited R/Shiny background.

## How to Use This Companion

1. Read **Top-level execution map** first to understand architecture.
2. Use **UI <-> Server wiring maps** to trace where each button/input/output is connected.
3. Use **Function catalog** and **Event catalog** for behavior details and side-effects.
4. Open `app.R` side-by-side and jump to line numbers noted here.

## Update Addendum (27.02.2026)

This addendum captures the latest behavior changes added after the first draft of this breakdown.

### 1) New DB-backed additional-cost feature

- New project field in `projects` table: `additional_cost` (nullable `REAL`).
- Runtime auto-migration is now performed at app startup:
  - `projects_has_additional_cost(con)` checks schema.
  - `ensure_projects_additional_cost_column(con)` runs `ALTER TABLE projects ADD COLUMN additional_cost REAL` when missing.
- `get_db_connection()` now enforces the migration automatically for every new connection.
- `validate_and_repair_database()` also ensures the column exists during health checks.

### 2) Cost calculation logic split

- `calculate_base_cost(...)` now computes preparation + sequencing-only base cost.
- `calculate_total_cost(..., additional_cost)` now adds admin-entered additional costs to base cost.
- `parse_additional_cost(...)` validates non-negative decimals (supports comma/dot normalization).
- `format_cost_amount(...)` enforces standardized `%.2f` display.

### 3) UI wiring changes in Edit Project

- New admin-only input: `edit_additional_cost` (`textInput`).
- New admin-only button in modal footer: `send_notification_btn` (label `Notifications`, green style).
- Cost summary blocks now show:
  - Preparation Cost
  - Sequencing Cost
  - Additional costs
  - Total Estimated Cost

### 4) Email behavior split

- Project creation email (`send_project_creation_email`) now notifies only `ngs@biochem.mpg.de`.
- New function `send_project_cost_notification_email(...)` sends the detailed cost-estimation mail to:
  - project creator
  - budget holder
  - `ngs@biochem.mpg.de`
- Notification email format is HTML; total cost line is bold + underlined.

### 5) New event flow

- `observeEvent(input$send_notification_btn)` triggers the new notification email path.
- `observeEvent(input$update_project_btn)` now validates and stores `additional_cost` (admin only) and recomputes `total_cost`.

### 6) Create/Edit form labeling and field order updates

- In both Create and Edit modals:
  - `Project Type` label was renamed to `Sample Type`.
  - `Sample Type` is now shown above `Service Type`.
  - `Sequencing Depth` label was renamed to `Data Amount (Total Reads)`.
  - `Sequencing Cycles` label was renamed to `Read Length (Cycles)`.
- Helper texts were added below depth/cycles fields with compact `11px` styling to reduce visual noise while keeping examples visible.

## Top-Level Execution Map

| Line range | Block | What it does |
|---|---|---|
| `1-238` | Global libraries + markdown/announcement rendering helpers | High-level block in app startup/runtime path. |
| `239-656` | UI definition (login screen, main app shell, CSS, JS helpers) | High-level block in app startup/runtime path. |
| `658-709` | Server bootstrap + LDAP debug logging | High-level block in app startup/runtime path. |
| `710-831` | Announcement storage helpers (schema creation/seed/load) | High-level block in app startup/runtime path. |
| `832-919` | Database validation and debug modal utilities | High-level block in app startup/runtime path. |
| `921-946` | Reactive state containers | High-level block in app startup/runtime path. |
| `947-1779` | Authentication and LDAP helper stack | High-level block in app startup/runtime path. |
| `1781-2259` | Status config, DB access helpers, pricing + email functions | High-level block in app startup/runtime path. |
| `2265-2605` | Registration and LDAP auto-login orchestration | High-level block in app startup/runtime path. |
| `2607-2894` | Login/logout flow and high-level UI output renderers | High-level block in app startup/runtime path. |
| `2902-3318` | Create project workflow + project table rendering | High-level block in app startup/runtime path. |
| `3321-4047` | Admin modals + landing text management + admin table renderers | High-level block in app startup/runtime path. |
| `4048-4889` | Admin CRUD handlers for all reference tables | High-level block in app startup/runtime path. |
| `4892-5708` | Edit/delete/update project workflows + status updates + cost-notification flow | High-level block in app startup/runtime path. |
| `5710-5881` | Backup/restore and optional auto-backup block (commented) | High-level block in app startup/runtime path. |
| `5884-5884` | Application entrypoint (`shinyApp(ui, server)`) | High-level block in app startup/runtime path. |

## UI <-> Server Wiring (Outputs)

Each row below connects an output placeholder declared in UI (`uiOutput`, `DTOutput`, `textOutput`, etc.) with the matching server renderer (`renderUI`, `renderDT`, `renderText`, `downloadHandler`).

| Output ID | UI declaration line(s) | Server renderer line(s) | Relationship summary |
|---|---:|---|---|
| `admin_interface` | 2720 | 2813 (renderUI) | UI placeholder waits for server-calculated content. |
| `admin_projects_table` | 2897 | - | UI placeholder exists but no renderer found in this file (likely pending/legacy). |
| `announcement_blocks_ui` | 2715, 2725 | 2666 (renderUI) | UI placeholder waits for server-calculated content. |
| `announcement_items_table_admin` | 3607 | 3621 (renderDT) | UI placeholder waits for server-calculated content. |
| `budget_holder_notice` | 2964 | 2507 (renderUI) | UI placeholder waits for server-calculated content. |
| `budget_holder_other_fields` | 2965 | 2511 (renderUI) | UI placeholder waits for server-calculated content. |
| `budget_holders_table_admin` | 3353 | 3666 (renderDT) | UI placeholder waits for server-calculated content. |
| `cost_calculation_display` | 2989 | 3035 (renderUI) | UI placeholder waits for server-calculated content. |
| `dev_login_ui` | 614 | 2483 (renderUI) | UI placeholder waits for server-calculated content. |
| `dev_mode_badge` | 644 | 2500 (renderUI) | UI placeholder waits for server-calculated content. |
| `dev_tools_ui` | 613 | 2440 (renderUI) | UI placeholder waits for server-calculated content. |
| `download_db_btn` | 2884 | 5357 (downloadHandler) | UI placeholder waits for server-calculated content. |
| `edit_budget_holder_notice` | 4961 | 2519 (renderUI) | UI placeholder waits for server-calculated content. |
| `edit_budget_holder_other_fields` | 4962 | 2523 (renderUI) | UI placeholder waits for server-calculated content. |
| `edit_cost_calculation_display` | 4989 | 5006 (renderUI) | UI placeholder waits for server-calculated content. |
| `genomes_table_admin` | 3511 | 3726 (renderDT) | UI placeholder waits for server-calculated content. |
| `login_error` | - | 2628 (renderText) | Server output exists; placeholder is created dynamically in modal or nested UI. |
| `main_content` | 652 | 2678 (renderUI) | UI placeholder waits for server-calculated content. |
| `projects_table` | 2807 | 3189 (renderDT) | UI placeholder waits for server-calculated content. |
| `sequencing_cycles_table_admin` | 3450 | 3696 (renderDT) | UI placeholder waits for server-calculated content. |
| `sequencing_depths_table_admin` | 3422 | 3686 (renderDT) | UI placeholder waits for server-calculated content. |
| `sequencing_platforms_table_admin` | 3563 | 3751 (renderDT) | UI placeholder waits for server-calculated content. |
| `service_types_table_admin` | 3388 | 3676 (renderDT) | UI placeholder waits for server-calculated content. |
| `types_table_admin` | 3537 | 3737 (renderDT) | UI placeholder waits for server-calculated content. |
| `user_interface` | 2716, 2726 | 2781 (renderUI) | UI placeholder waits for server-calculated content. |
| `users_table_admin` | 3488 | 3710 (renderDT) | UI placeholder waits for server-calculated content. |
| `welcome_user` | 643 | 2660 (renderText) | UI placeholder waits for server-calculated content. |

## UI <-> Server Wiring (Inputs)

This table maps every detected UI input control ID to where it is referenced in server logic.
When a line appears multiple times, it usually means validation + DB action + notifications all happen for the same control.

| Input ID | Declared line(s) | Control type(s) | Server reference line(s) | Main panel/area |
|---|---:|---|---|---|
| `add_budget_holder_btn` | 3347 | actionButton | 4051 | Administer Projects -> Budget Holders |
| `add_genome_btn` | 3505 | actionButton | 4541 | Administer Projects -> Reference Genomes |
| `add_sequencing_cycles_btn` | 3444 | actionButton | 4468 | Administer Projects -> Sequencing Cycles |
| `add_sequencing_depth_btn` | 3416 | actionButton | 4387 | Administer Projects -> Sequencing Depths |
| `add_sequencing_platform_btn` | 3557 | actionButton | 4591 | Administer Projects -> Sequencing Platforms |
| `add_service_type_btn` | 3382 | actionButton | 4096 | Administer Projects -> Service Types |
| `add_type_btn` | 3531 | actionButton | 4568 | Administer Projects -> Sample Types |
| `add_user_admin_btn` | 3482 | actionButton | 4495 | Administer Projects -> Users |
| `announcement_add_btn` | 3610 | actionButton | 3765 | Administer Projects -> Landing Text |
| `announcement_delete_btn` | 3614 | actionButton | 3911 | Administer Projects -> Landing Text |
| `announcement_edit_btn` | 3611 | actionButton | 3841 | Administer Projects -> Landing Text |
| `announcement_move_down_btn` | 3613 | actionButton | 4002 | Administer Projects -> Landing Text |
| `announcement_move_up_btn` | 3612 | actionButton | 3956 | Administer Projects -> Landing Text |
| `budget_id` | 2952 | selectInput | 2508, 2512, 3095, 3111 | Administer Projects -> Budget Holders |
| `confirm_delete_announcement_item_btn` | 3928 | actionButton | 3933 | Administer Projects -> Landing Text |
| `confirm_delete_btn` | 5215 | actionButton | 5220 | General / Shared |
| `confirm_delete_budget_holder_btn` | 4630 | actionButton | 4635 | Administer Projects -> Budget Holders |
| `confirm_delete_genome_btn` | 4805 | actionButton | 4810 | Administer Projects -> Reference Genomes |
| `confirm_delete_sequencing_cycles_btn` | 4732 | actionButton | 4737 | Administer Projects -> Sequencing Cycles |
| `confirm_delete_sequencing_depth_btn` | 4698 | actionButton | 4703 | Administer Projects -> Sequencing Depths |
| `confirm_delete_sequencing_platform_btn` | 4873 | actionButton | 4878 | Administer Projects -> Sequencing Platforms |
| `confirm_delete_service_type_btn` | 4664 | actionButton | 4669 | Administer Projects -> Service Types |
| `confirm_delete_type_btn` | 4839 | actionButton | 4844 | Administer Projects -> Sample Types |
| `confirm_delete_user_btn` | 4771 | actionButton | 4776 | Administer Projects -> Users |
| `confirm_restore_btn` | 5409 | actionButton | 5414 | Administer Projects -> Database Management |
| `confirm_status_update_btn` | 5649 | actionButton | 5665 | Apply for Projects / Projects table |
| `create_project_btn` | 3106 | actionButton | 3278 | Apply for Projects / Projects table |
| `debug_db_btn` | 882 | actionButton | 891 | Administer Projects -> Database Management |
| `delete_budget_holder_btn` | 3356 | actionButton | 4616 | Administer Projects -> Budget Holders |
| `delete_genome_btn` | 3514 | actionButton | 4791 | Administer Projects -> Reference Genomes |
| `delete_project_btn` | 2792 | actionButton | 5194 | Apply for Projects / Projects table |
| `delete_sequencing_cycles_btn` | 3451 | actionButton | 4718 | Administer Projects -> Sequencing Cycles |
| `delete_sequencing_depth_btn` | 3425 | actionButton | 4684 | Administer Projects -> Sequencing Depths |
| `delete_sequencing_platform_btn` | 3566 | actionButton | 4859 | Administer Projects -> Sequencing Platforms |
| `delete_service_type_btn` | 3391 | actionButton | 4650 | Administer Projects -> Service Types |
| `delete_type_btn` | 3540 | actionButton | 4825 | Administer Projects -> Sample Types |
| `delete_user_admin_btn` | 3489 | actionButton | 4752 | Administer Projects -> Users |
| `dev_auth_mode` | 2446 | radioButtons | 2454, 2455, 2456 | Authentication / Login area |
| `dev_login_btn` | 2495 | actionButton | 2531 | Authentication / Login area |
| `dev_login_username` | 2494 | textInput | 2533, 2534, 2535, 2536 | Authentication / Login area |
| `edit_bh_cost_center` | 4171 | textInput | 4181, 4185, 4197, 4211 | Administer Projects -> Budget Holders |
| `edit_bh_email` | 4172 | textInput | 4181, 4186, 4212 | Administer Projects -> Budget Holders |
| `edit_bh_name` | 4169 | textInput | 4181, 4183, 4209 | Administer Projects -> Budget Holders |
| `edit_bh_surname` | 4170 | textInput | 4181, 4184, 4210 | Administer Projects -> Budget Holders |
| `edit_budget_holder_btn` | 3355 | actionButton | 4153 | Administer Projects -> Budget Holders |
| `edit_budget_id` | 4952 | selectInput | 2520, 2524, 5053, 5094 | Administer Projects -> Budget Holders |
| `edit_depth_cost_150` | 4438 | numericInput | 4457, 4457 | Administer Projects -> Sequencing Depths |
| `edit_depth_cost_300` | 4439 | numericInput | 4458, 4458 | Administer Projects -> Sequencing Depths |
| `edit_depth_description` | 4437 | textInput | 4456 | Administer Projects -> Sequencing Depths |
| `edit_genome_btn` | 3513 | actionButton | 4222 | Administer Projects -> Reference Genomes |
| `edit_genome_name` | 4238 | textInput | 4247, 4248 | Administer Projects -> Reference Genomes |
| `edit_kickoff_meeting` | 4966 | radioButtons | 5085 | General / Shared |
| `edit_additional_cost` | 5200 | textInput | 5242, 5353, 5493 | Apply for Projects / Edit Project modal |
| `edit_num_samples` | 4925 | numericInput | 5007, 5013, 5088, 5126, 5152 | General / Shared |
| `edit_project_btn` | 2986 | actionButton | 5094 | Apply for Projects / Projects table |
| `edit_project_description` | 4980 | textAreaInput | 5125, 5151 | Apply for Projects / Projects table |
| `edit_project_name` | 4924 | textInput | 5120, 5146 | Apply for Projects / Projects table |
| `edit_project_status` | 4996 | selectInput | 5076 | Apply for Projects / Projects table |
| `edit_reference_genome` | 4939 | selectInput | 5121, 5147 | Administer Projects -> Reference Genomes |
| `edit_responsible_user` | 4963 | selectInput | 5124, 5150, 5176 | Administer Projects -> Users |
| `edit_sequencing_cycles_id` | 4947 | selectInput | 5008, 5089, 5129, 5155 | Administer Projects -> Sequencing Cycles |
| `edit_sequencing_depth_btn` | 3424 | actionButton | 4420 | Administer Projects -> Sequencing Depths |
| `edit_sequencing_depth_id` | 4942 | selectInput | 5008, 5011, 5089, 5128, 5154 | Administer Projects -> Sequencing Depths |
| `edit_sequencing_platform` | 4926 | selectInput | 5127, 5153 | Administer Projects -> Sequencing Platforms |
| `edit_sequencing_platform_btn` | 3565 | actionButton | 4317 | Administer Projects -> Sequencing Platforms |
| `edit_sequencing_platform_name2` | 4333 | textInput | 4342, 4343 | Administer Projects -> Sequencing Platforms |
| `edit_service_cost` | 4148 | numericInput | 4378 | Administer Projects -> Service Types |
| `edit_service_kit` | 4147 | textInput | 4377 | Administer Projects -> Service Types |
| `edit_service_type` | 4146 | textInput | 4376 | Administer Projects -> Service Types |
| `edit_service_type_btn` | 3390 | actionButton | 4129 | Administer Projects -> Service Types |
| `edit_service_type_id` | 4932 | selectInput | 5007, 5010, 5088, 5122, 5148 | Administer Projects -> Service Types |
| `edit_type_btn` | 3539 | actionButton | 4270 | Administer Projects -> Sample Types |
| `edit_type_id` | 4929 | selectInput | 5132, 5157 | Administer Projects -> Sample Types |
| `edit_type_name` | 4286 | textInput | 4295, 4296 | Administer Projects -> Sample Types |
| `item_active` | 3781, 3862 | checkboxInput | 3832, 3900 | General / Shared |
| `kickoff_meeting` | 2971 | radioButtons | 3146 | General / Shared |
| `ldap_profile_cancel_btn` | 1611 | actionButton | 2589 | Authentication / Login area |
| `ldap_profile_email` | 1614 | textInput | 2542, 2542, 2550 | Authentication / Login area |
| `ldap_profile_group` | 1616 | textInput | 2552 | Authentication / Login area |
| `ldap_profile_phone` | 1615 | textInput | 2551 | Authentication / Login area |
| `ldap_profile_save_btn` | 1612 | actionButton | 2539 | Authentication / Login area |
| `login_btn` | 607 | actionButton | 2608 | Authentication / Login area |
| `login_password` | 606 | passwordInput | 2614, 2624 | Authentication / Login area |
| `login_username` | 605 | textInput | 2614, 2621 | Authentication / Login area |
| `logout_btn` | 645 | actionButton | 2633 | General / Shared |
| `manage_announcements_btn` | 2871 | actionButton | 3571 | Administer Projects -> Landing Text |
| `manage_budget_holders_btn` | 2829 | actionButton | 3324 | Administer Projects -> Budget Holders |
| `manage_genomes_btn` | 2835 | actionButton | 3493 | Administer Projects -> Reference Genomes |
| `manage_sequencing_cycles_btn` | 2859 | actionButton | 3432 | Administer Projects -> Sequencing Cycles |
| `manage_sequencing_depths_btn` | 2853 | actionButton | 3398 | Administer Projects -> Sequencing Depths |
| `manage_sequencing_platforms_btn` | 2865 | actionButton | 3545 | Administer Projects -> Sequencing Platforms |
| `manage_service_types_btn` | 2847 | actionButton | 3362 | Administer Projects -> Service Types |
| `manage_types_btn` | 2841 | actionButton | 3519 | Administer Projects -> Sample Types |
| `manage_users_btn` | 2823 | actionButton | 3456 | Administer Projects -> Users |
| `new_bh_cost_center` | 3339 | textInput | 4052, 4054, 4065, 4079 | Administer Projects -> Budget Holders |
| `new_bh_email` | 3342 | textInput | 4052, 4054, 4080 | Administer Projects -> Budget Holders |
| `new_bh_name` | 3333 | textInput | 4052, 4054, 4077 | Administer Projects -> Budget Holders |
| `new_bh_surname` | 3336 | textInput | 4052, 4054, 4078 | Administer Projects -> Budget Holders |
| `new_cycles_description` | 3441 | textInput | 4469, 4471, 4476, 4487 | Administer Projects -> Sequencing Cycles |
| `new_depth_cost_150` | 3410 | numericInput | 4408, 4408 | Administer Projects -> Sequencing Depths |
| `new_depth_cost_300` | 3413 | numericInput | 4409, 4409 | Administer Projects -> Sequencing Depths |
| `new_depth_description` | 3407 | textInput | 4388, 4390, 4395, 4407 | Administer Projects -> Sequencing Depths |
| `new_genome_name` | 3502 | textInput | 4542, 4544, 4549, 4560 | Administer Projects -> Reference Genomes |
| `new_project_btn` | 2787 | actionButton | 2903 | Apply for Projects / Projects table |
| `new_project_status` | 5261 | selectInput | 5286 | Apply for Projects / Projects table |
| `new_sequencing_platform_name` | 3554 | textInput | 4592, 4594, 4599, 4607 | Administer Projects -> Sequencing Platforms |
| `new_service_cost` | 3377 | numericInput | 4097, 4118 | Administer Projects -> Service Types |
| `new_service_kit` | 3374 | textInput | 4097, 4117 | Administer Projects -> Service Types |
| `new_service_type` | 3371 | textInput | 4097, 4099, 4104, 4116 | Administer Projects -> Service Types |
| `new_type_name` | 3528 | textInput | 4569, 4571, 4576, 4584 | Administer Projects -> Sample Types |
| `new_user_admin` | 3481 | checkboxInput | 4527 | Administer Projects -> Users |
| `new_user_confirm_password` | 3476 | passwordInput | 4498 | Administer Projects -> Users |
| `new_user_email` | 3468 | textInput | 4496, 4526 | Administer Projects -> Users |
| `new_user_password` | 3473 | passwordInput | 4496, 4498, 4503, 4525 | Administer Projects -> Users |
| `new_user_username` | 3465 | textInput | 4496, 4513, 4524 | Administer Projects -> Users |
| `num_samples` | 2915 | numericInput | 3036, 3042, 3104, 3142, 3169 | General / Shared |
| `project_description` | 2978 | textAreaInput | 3141, 3167 | Apply for Projects / Projects table |
| `project_name` | 2914 | textInput | 3135, 3166 | Apply for Projects / Projects table |
| `reference_genome` | 2934 | selectInput | 3138 | Administer Projects -> Reference Genomes |
| `reg_confirm_password` | 2286 | passwordInput | 2298, 2300 | General / Shared |
| `reg_email` | 2284 | textInput | 2298, 2343, 2354 | General / Shared |
| `reg_full_name` | 2283 | textInput | 2330 | General / Shared |
| `reg_group` | 2288 | selectInput | 2310, 2310, 2345, 2356 | General / Shared |
| `reg_password` | 2285 | passwordInput | 2298, 2300, 2305, 2342, 2353 | General / Shared |
| `reg_phone` | 2287 | textInput | 2344, 2355 | General / Shared |
| `reg_username` | 2282 | textInput | 2298, 2321, 2332, 2340, 2352 | Administer Projects -> Users |
| `register_btn` | 2279 | actionButton | 2297 | Authentication / Login area |
| `responsible_user` | 2966 | selectInput | 3137, 3168 | Administer Projects -> Users |
| `restore_db_btn` | 2886 | fileInput | 5395, 5396, 5403, 5423 | Administer Projects -> Database Management |
| `save_announcement_item_btn` | 3779 | actionButton | 3793 | Administer Projects -> Landing Text |
| `send_notification_btn` | 5126 | actionButton | 5473 | Apply for Projects / Edit Project modal (admin) |
| `sequencing_cycles_id` | 2944 | selectInput | 3037, 3105, 3145 | Administer Projects -> Sequencing Cycles |
| `sequencing_depth_id` | 2936 | selectInput | 3037, 3040, 3105, 3144, 3171 | Administer Projects -> Sequencing Depths |
| `sequencing_platform` | 2916 | selectInput | 3143 | Administer Projects -> Sequencing Platforms |
| `service_type_id` | 2924 | selectInput | 3036, 3039, 3104, 3139, 3170 | Administer Projects -> Service Types |
| `show_register_btn` | 610 | actionLink | 2266 | Authentication / Login area |
| `status_notes` | 5265 | textAreaInput | - | Apply for Projects / Projects table |
| `type_id` | 2918 | selectInput | 3147 | Administer Projects -> Sample Types |
| `update_announcement_item_btn` | 3860 | actionButton | 3873 | Administer Projects -> Landing Text |
| `update_budget_holder_btn` | 4167 | actionButton | 4176 | Administer Projects -> Budget Holders |
| `update_genome_btn` | 4236 | actionButton | 4242 | Administer Projects -> Reference Genomes |
| `update_project_btn` | 5131 | actionButton | 5286 | Apply for Projects / Projects table |
| `update_sequencing_depth_btn` | 4434 | actionButton | 4444 | Administer Projects -> Sequencing Depths |
| `update_sequencing_platform_update_btn` | 4331 | actionButton | 4337 | Administer Projects -> Sequencing Platforms |
| `update_service_type_btn` | 4143 | actionButton | 4364 | Administer Projects -> Service Types |
| `update_status_btn` | 2997 | actionButton | 5630 | Apply for Projects / Projects table |
| `update_type_btn` | 4284 | actionButton | 4290 | Administer Projects -> Sample Types |
| `validate_db_btn` | 2887 | actionButton | 5350 | Administer Projects -> Database Management |

## Function Catalog (All Detected Functions)

For each function: **purpose**, **key behavior**, and **where it is called**.

### `default_announcement_seed` {#fn-default-announcement-seed}
- **Defined at:** `/Users/yeroslaviz/Documents/Github/BCFNGS-project-management/sequencing-app/app.R:14`
- **Signature line:** `default_announcement_seed <- function() {`
- **Purpose:** Returns the default two-panel landing-page content (Announcement + service info) used for first-time DB seeding.
- **Called/referenced at:** not detected directly (may be invoked via nested closure/runtime path).

### `is_safe_markdown_href` {#fn-is-safe-markdown-href}
- **Defined at:** `/Users/yeroslaviz/Documents/Github/BCFNGS-project-management/sequencing-app/app.R:60`
- **Signature line:** `is_safe_markdown_href <- function(href) {`
- **Purpose:** Allows only safe link protocols in markdown links (`http`, `https`, `mailto`, `smb`).
- **Called/referenced at:** not detected directly (may be invoked via nested closure/runtime path).

### `escape_inline_markdown` {#fn-escape-inline-markdown}
- **Defined at:** `/Users/yeroslaviz/Documents/Github/BCFNGS-project-management/sequencing-app/app.R:65`
- **Signature line:** `escape_inline_markdown <- function(text) {`
- **Purpose:** HTML-escapes plain text and then converts `**bold**` markup into `<strong>` safely.
- **Called/referenced at:** not detected directly (may be invoked via nested closure/runtime path).

### `render_inline_markdown` {#fn-render-inline-markdown}
- **Defined at:** `/Users/yeroslaviz/Documents/Github/BCFNGS-project-management/sequencing-app/app.R:70`
- **Signature line:** `render_inline_markdown <- function(text) {`
- **Purpose:** Parses one inline text fragment, converts markdown links, and safely escapes all other text.
- **Called/referenced at:** not detected directly (may be invoked via nested closure/runtime path).

### `markdown_lite_to_html` {#fn-markdown-lite-to-html}
- **Defined at:** `/Users/yeroslaviz/Documents/Github/BCFNGS-project-management/sequencing-app/app.R:122`
- **Signature line:** `markdown_lite_to_html <- function(markdown_text) {`
- **Purpose:** Converts simplified markdown (paragraphs, lists, bold, links) into safe HTML for info boxes.
- **Called/referenced at:** not detected directly (may be invoked via nested closure/runtime path).

### `flush_paragraph` {#fn-flush-paragraph}
- **Defined at:** `/Users/yeroslaviz/Documents/Github/BCFNGS-project-management/sequencing-app/app.R:134`
- **Signature line:** `flush_paragraph <- function() {`
- **Purpose:** Internal helper: finalizes accumulated paragraph lines during markdown parsing.
- **Called/referenced at:** not detected directly (may be invoked via nested closure/runtime path).

### `flush_list` {#fn-flush-list}
- **Defined at:** `/Users/yeroslaviz/Documents/Github/BCFNGS-project-management/sequencing-app/app.R:144`
- **Signature line:** `flush_list <- function() {`
- **Purpose:** Internal helper: finalizes accumulated list items (ordered/unordered) during markdown parsing.
- **Called/referenced at:** not detected directly (may be invoked via nested closure/runtime path).

### `announcement_blocks` {#fn-announcement-blocks}
- **Defined at:** `/Users/yeroslaviz/Documents/Github/BCFNGS-project-management/sequencing-app/app.R:197`
- **Signature line:** `announcement_blocks <- function(announcement_data) {`
- **Purpose:** Builds landing-page panels from DB data and renders each row as one `.info-box`.
- **Called/referenced at:** not detected directly (may be invoked via nested closure/runtime path).

### `server` {#fn-server}
- **Defined at:** `/Users/yeroslaviz/Documents/Github/BCFNGS-project-management/sequencing-app/app.R:658`
- **Signature line:** `server <- function(input, output, session) {`
- **Purpose:** Main Shiny server function: owns all reactive state, auth, DB operations, outputs, and event handlers.
- **Called/referenced at:** not detected directly (may be invoked via nested closure/runtime path).

### `ensure_announcement_tables` {#fn-ensure-announcement-tables}
- **Defined at:** `/Users/yeroslaviz/Documents/Github/BCFNGS-project-management/sequencing-app/app.R:714`
- **Signature line:** `ensure_announcement_tables <- function(con) {`
- **Purpose:** Creates `announcement_panels` and `announcement_items` tables when missing.
- **Called/referenced at:** not detected directly (may be invoked via nested closure/runtime path).

### `seed_announcement_defaults` {#fn-seed-announcement-defaults}
- **Defined at:** `/Users/yeroslaviz/Documents/Github/BCFNGS-project-management/sequencing-app/app.R:742`
- **Signature line:** `seed_announcement_defaults <- function(con, updated_by = "system") {`
- **Purpose:** Seeds default landing text only for newly inserted panel keys (non-destructive for existing panels).
- **Called/referenced at:** not detected directly (may be invoked via nested closure/runtime path).

### `load_announcement_content` {#fn-load-announcement-content}
- **Defined at:** `/Users/yeroslaviz/Documents/Github/BCFNGS-project-management/sequencing-app/app.R:794`
- **Signature line:** `load_announcement_content <- function(con = NULL, active_only = TRUE) {`
- **Purpose:** Loads panel metadata + ordered rows from DB, optionally active-only.
- **Called/referenced at:** not detected directly (may be invoked via nested closure/runtime path).

### `validate_and_repair_database` {#fn-validate-and-repair-database}
- **Defined at:** `/Users/yeroslaviz/Documents/Github/BCFNGS-project-management/sequencing-app/app.R:837`
- **Signature line:** `validate_and_repair_database <- function() {`
- **Purpose:** Checks critical table presence and minimal DB readability; shows diagnostics when unhealthy.
- **Called/referenced at:** not detected directly (may be invoked via nested closure/runtime path).

### `get_auth_mode` {#fn-get-auth-mode}
- **Defined at:** `/Users/yeroslaviz/Documents/Github/BCFNGS-project-management/sequencing-app/app.R:956`
- **Signature line:** `get_auth_mode <- function() auth_mode_val()`
- **Purpose:** Returns current auth mode (`local` or `ldap`) from reactive value.
- **Called/referenced at:** not detected directly (may be invoked via nested closure/runtime path).

### `to_bool` {#fn-to-bool}
- **Defined at:** `/Users/yeroslaviz/Documents/Github/BCFNGS-project-management/sequencing-app/app.R:958`
- **Signature line:** `to_bool <- function(x) {`
- **Purpose:** Normalizes env-flag style strings (1/true/yes/on) to logical.
- **Called/referenced at:** not detected directly (may be invoked via nested closure/runtime path).

### ``%||%`` {#fn-or-null-operator}
- **Defined at:** `/Users/yeroslaviz/Documents/Github/BCFNGS-project-management/sequencing-app/app.R:983`
- **Signature line:** ``%||%` <- function(x, y) {`
- **Purpose:** Null/empty fallback operator used heavily for robust text handling.
- **Called/referenced at:** `/Users/yeroslaviz/Documents/Github/BCFNGS-project-management/sequencing-app/app.R:697, 698, 699, 997, 1451, 1452, 1453, 1454, 1565, 1614, 1615, 1616, 1628, 1629, 1630, 1651, 1652, 1653, 1654, 1687, 1690, 1691, 1701, 1702, 1747 ... (+38 more)`

### `scalar_text` {#fn-scalar-text-core}
- **Defined at:** `/Users/yeroslaviz/Documents/Github/BCFNGS-project-management/sequencing-app/app.R:987`
- **Signature line:** `scalar_text <- function(x) {`
- **Purpose:** Normalizes potentially vector/empty values into a single trimmed string or NULL.
- **Called/referenced at:** not detected directly (may be invoked via nested closure/runtime path).

### `get_req_header` {#fn-get-req-header}
- **Defined at:** `/Users/yeroslaviz/Documents/Github/BCFNGS-project-management/sequencing-app/app.R:1004`
- **Signature line:** `get_req_header <- function(req, header_name) {`
- **Purpose:** Reads HTTP headers from multiple possible request structures and canonicalizes retrieval.
- **Called/referenced at:** not detected directly (may be invoked via nested closure/runtime path).

### `get_proxy_authenticated_user` {#fn-get-proxy-authenticated-user}
- **Defined at:** `/Users/yeroslaviz/Documents/Github/BCFNGS-project-management/sequencing-app/app.R:1030`
- **Signature line:** `get_proxy_authenticated_user <- function(session) {`
- **Purpose:** Extracts authenticated username from trusted proxy headers.
- **Called/referenced at:** not detected directly (may be invoked via nested closure/runtime path).

### `base64_decode_raw` {#fn-base64-decode-raw}
- **Defined at:** `/Users/yeroslaviz/Documents/Github/BCFNGS-project-management/sequencing-app/app.R:1043`
- **Signature line:** `base64_decode_raw <- function(encoded) {`
- **Purpose:** Decodes Base64 for Basic auth parsing without external dependency.
- **Called/referenced at:** not detected directly (may be invoked via nested closure/runtime path).

### `parse_basic_auth_username` {#fn-parse-basic-auth-username}
- **Defined at:** `/Users/yeroslaviz/Documents/Github/BCFNGS-project-management/sequencing-app/app.R:1079`
- **Signature line:** `parse_basic_auth_username <- function(auth_header) {`
- **Purpose:** Parses `Authorization: Basic ...` and returns the username part only.
- **Called/referenced at:** not detected directly (may be invoked via nested closure/runtime path).

### `get_auth_username` {#fn-get-auth-username}
- **Defined at:** `/Users/yeroslaviz/Documents/Github/BCFNGS-project-management/sequencing-app/app.R:1103`
- **Signature line:** `get_auth_username <- function(session) {`
- **Purpose:** Primary LDAP identity resolver; checks trusted headers, canonicalized query, optional dev fallback.
- **Called/referenced at:** not detected directly (may be invoked via nested closure/runtime path).

### `parse_auth_user_from_qs` {#fn-parse-auth-user-from-qs}
- **Defined at:** `/Users/yeroslaviz/Documents/Github/BCFNGS-project-management/sequencing-app/app.R:1117`
- **Signature line:** `parse_auth_user_from_qs <- function(qs) {`
- **Purpose:** Internal helper to extract `auth_user` from query string safely.
- **Called/referenced at:** not detected directly (may be invoked via nested closure/runtime path).

### `parse_ldap_uris` {#fn-parse-ldap-uris}
- **Defined at:** `/Users/yeroslaviz/Documents/Github/BCFNGS-project-management/sequencing-app/app.R:1169`
- **Signature line:** `parse_ldap_uris <- function(uri_string) {`
- **Purpose:** Parses comma-separated LDAP URIs into host/port/SSL target objects.
- **Called/referenced at:** not detected directly (may be invoked via nested closure/runtime path).

### `extract_ldap_attr` {#fn-extract-ldap-attr}
- **Defined at:** `/Users/yeroslaviz/Documents/Github/BCFNGS-project-management/sequencing-app/app.R:1191`
- **Signature line:** `extract_ldap_attr <- function(result, attr) {`
- **Purpose:** Extracts one LDAP attribute from heterogeneous result formats.
- **Called/referenced at:** not detected directly (may be invoked via nested closure/runtime path).

### `ldap_lookup_user` {#fn-ldap-lookup-user}
- **Defined at:** `/Users/yeroslaviz/Documents/Github/BCFNGS-project-management/sequencing-app/app.R:1207`
- **Signature line:** `ldap_lookup_user <- function(username) {`
- **Purpose:** Performs LDAP attribute lookup (email/phone/ou/full_name) with bind and `ldapsearch` fallback.
- **Called/referenced at:** not detected directly (may be invoked via nested closure/runtime path).

### `ldap_try_bind` {#fn-ldap-try-bind}
- **Defined at:** `/Users/yeroslaviz/Documents/Github/BCFNGS-project-management/sequencing-app/app.R:1239`
- **Signature line:** `ldap_try_bind <- function(conn, bind_dn, bind_pw) {`
- **Purpose:** Attempts LDAP bind using configured bind user/password or anonymous fallback.
- **Called/referenced at:** not detected directly (may be invoked via nested closure/runtime path).

### `ldap_search` {#fn-ldap-search}
- **Defined at:** `/Users/yeroslaviz/Documents/Github/BCFNGS-project-management/sequencing-app/app.R:1276`
- **Signature line:** `ldap_search <- function(conn, base_dn, filter, attrs) {`
- **Purpose:** Executes LDAP search using compatible parameter names for different package variants.
- **Called/referenced at:** not detected directly (may be invoked via nested closure/runtime path).

### `ldapsearch_lookup` {#fn-ldapsearch-lookup}
- **Defined at:** `/Users/yeroslaviz/Documents/Github/BCFNGS-project-management/sequencing-app/app.R:1294`
- **Signature line:** `ldapsearch_lookup <- function(uri, base_dn, filter, attrs, bind_dn, bind_pw) {`
- **Purpose:** Runs shell `ldapsearch` fallback and captures output for parsing.
- **Called/referenced at:** not detected directly (may be invoked via nested closure/runtime path).

### `normalize_ldap_lines` {#fn-normalize-ldap-lines}
- **Defined at:** `/Users/yeroslaviz/Documents/Github/BCFNGS-project-management/sequencing-app/app.R:1339`
- **Signature line:** `normalize_ldap_lines <- function(lines) {`
- **Purpose:** Normalizes folded LDAP output lines into full logical lines.
- **Called/referenced at:** not detected directly (may be invoked via nested closure/runtime path).

### `parse_ldapsearch_output` {#fn-parse-ldapsearch-output}
- **Defined at:** `/Users/yeroslaviz/Documents/Github/BCFNGS-project-management/sequencing-app/app.R:1355`
- **Signature line:** `parse_ldapsearch_output <- function(lines, key) {`
- **Purpose:** Extracts one key value from ldapsearch text output.
- **Called/referenced at:** not detected directly (may be invoked via nested closure/runtime path).

### `normalize_group_key` {#fn-normalize-group-key}
- **Defined at:** `/Users/yeroslaviz/Documents/Github/BCFNGS-project-management/sequencing-app/app.R:1464`
- **Signature line:** `normalize_group_key <- function(value) {`
- **Purpose:** Lowercases/trims group text for matching.
- **Called/referenced at:** not detected directly (may be invoked via nested closure/runtime path).

### `extract_group_key_from_ou` {#fn-extract-group-key-from-ou}
- **Defined at:** `/Users/yeroslaviz/Documents/Github/BCFNGS-project-management/sequencing-app/app.R:1469`
- **Signature line:** `extract_group_key_from_ou <- function(ou_value) {`
- **Purpose:** Extracts compact group key from LDAP OU text (prefers `(Group)` substring).
- **Called/referenced at:** not detected directly (may be invoked via nested closure/runtime path).

### `map_group_from_ldap_ou` {#fn-map-group-from-ldap-ou}
- **Defined at:** `/Users/yeroslaviz/Documents/Github/BCFNGS-project-management/sequencing-app/app.R:1480`
- **Signature line:** `map_group_from_ldap_ou <- function(ou_value, con) {`
- **Purpose:** Maps LDAP OU/group text to existing budget-holder full names.
- **Called/referenced at:** not detected directly (may be invoked via nested closure/runtime path).

### `budget_holder_notice_ui` {#fn-budget-holder-notice-ui}
- **Defined at:** `/Users/yeroslaviz/Documents/Github/BCFNGS-project-management/sequencing-app/app.R:1508`
- **Signature line:** `budget_holder_notice_ui <- function(selected_id) {`
- **Purpose:** Renders inline warnings when selected budget holder has missing/multiple cost-center contexts.
- **Called/referenced at:** not detected directly (may be invoked via nested closure/runtime path).

### `budget_holder_other_fields_ui` {#fn-budget-holder-other-fields-ui}
- **Defined at:** `/Users/yeroslaviz/Documents/Github/BCFNGS-project-management/sequencing-app/app.R:1548`
- **Signature line:** `budget_holder_other_fields_ui <- function(prefix = "") {`
- **Purpose:** Renders “Other / not listed” PI input fields for budget holder creation-on-the-fly.
- **Called/referenced at:** not detected directly (may be invoked via nested closure/runtime path).

### `budget_holder_other_notice_ui` {#fn-budget-holder-other-notice-ui}
- **Defined at:** `/Users/yeroslaviz/Documents/Github/BCFNGS-project-management/sequencing-app/app.R:1564`
- **Signature line:** `budget_holder_other_notice_ui <- function(cost_center_value) {`
- **Purpose:** Warns when free-text budget holder has no cost center.
- **Called/referenced at:** not detected directly (may be invoked via nested closure/runtime path).

### `complete_login` {#fn-complete-login}
- **Defined at:** `/Users/yeroslaviz/Documents/Github/BCFNGS-project-management/sequencing-app/app.R:1574`
- **Signature line:** `complete_login <- function(user_data) {`
- **Purpose:** Sets logged-in state, user identity, admin flag, and refreshes reference data.
- **Called/referenced at:** not detected directly (may be invoked via nested closure/runtime path).

### `show_profile_modal` {#fn-show-profile-modal}
- **Defined at:** `/Users/yeroslaviz/Documents/Github/BCFNGS-project-management/sequencing-app/app.R:1601`
- **Signature line:** `show_profile_modal <- function(username, attrs, is_new) {`
- **Purpose:** Shows required LDAP profile completion modal for missing user attributes.
- **Called/referenced at:** not detected directly (may be invoked via nested closure/runtime path).

### `maybe_prompt_profile_update` {#fn-maybe-prompt-profile-update}
- **Defined at:** `/Users/yeroslaviz/Documents/Github/BCFNGS-project-management/sequencing-app/app.R:1621`
- **Signature line:** `maybe_prompt_profile_update <- function(user_row, attrs) {`
- **Purpose:** Prompts existing users to fill missing mandatory profile fields.
- **Called/referenced at:** not detected directly (may be invoked via nested closure/runtime path).

### `handle_ldap_login` {#fn-handle-ldap-login}
- **Defined at:** `/Users/yeroslaviz/Documents/Github/BCFNGS-project-management/sequencing-app/app.R:1635`
- **Signature line:** `handle_ldap_login <- function(username) {`
- **Purpose:** End-to-end LDAP login orchestration: user lookup/create/update + mapping + completion flow.
- **Called/referenced at:** not detected directly (may be invoked via nested closure/runtime path).

### `make_status_choices` {#fn-make-status-choices}
- **Defined at:** `/Users/yeroslaviz/Documents/Github/BCFNGS-project-management/sequencing-app/app.R:1802`
- **Signature line:** `make_status_choices <- function(current_status = NULL) {`
- **Purpose:** Builds status select choices while preserving unknown legacy statuses.
- **Called/referenced at:** not detected directly (may be invoked via nested closure/runtime path).

### `get_db_connection` {#fn-get-db-connection}
- **Defined at:** `/Users/yeroslaviz/Documents/Github/BCFNGS-project-management/sequencing-app/app.R:1811`
- **Signature line:** `get_db_connection <- function() {`
- **Purpose:** Returns SQLite connection to `sequencing_projects.db` in app working directory.
- **Called/referenced at:** not detected directly (may be invoked via nested closure/runtime path).

### `users_has_full_name` {#fn-users-has-full-name}
- **Defined at:** `/Users/yeroslaviz/Documents/Github/BCFNGS-project-management/sequencing-app/app.R:1815`
- **Signature line:** `users_has_full_name <- function(con) {`
- **Purpose:** Schema-compat helper: checks whether `users.full_name` exists.
- **Called/referenced at:** not detected directly (may be invoked via nested closure/runtime path).

### `refresh_announcements` {#fn-refresh-announcements}
- **Defined at:** `/Users/yeroslaviz/Documents/Github/BCFNGS-project-management/sequencing-app/app.R:1821`
- **Signature line:** `refresh_announcements <- function() {`
- **Purpose:** Reactive invalidation trigger to force landing text re-render after edits.
- **Called/referenced at:** not detected directly (may be invoked via nested closure/runtime path).

### `get_announcement_panels` {#fn-get-announcement-panels}
- **Defined at:** `/Users/yeroslaviz/Documents/Github/BCFNGS-project-management/sequencing-app/app.R:1825`
- **Signature line:** `get_announcement_panels <- function(con = NULL, active_only = FALSE) {`
- **Purpose:** Returns panel rows for admin management, active or all.
- **Called/referenced at:** not detected directly (may be invoked via nested closure/runtime path).

### `get_announcement_items_for_panel` {#fn-get-announcement-items-for-panel}
- **Defined at:** `/Users/yeroslaviz/Documents/Github/BCFNGS-project-management/sequencing-app/app.R:1847`
- **Signature line:** `get_announcement_items_for_panel <- function(panel_key, con = NULL, active_only = FALSE) {`
- **Purpose:** Returns ordered rows for one landing panel.
- **Called/referenced at:** not detected directly (may be invoked via nested closure/runtime path).

### `normalize_announcement_item_order` {#fn-normalize-announcement-item-order}
- **Defined at:** `/Users/yeroslaviz/Documents/Github/BCFNGS-project-management/sequencing-app/app.R:1877`
- **Signature line:** `normalize_announcement_item_order <- function(con, panel_id) {`
- **Purpose:** Compacts/resequences display order after deletes/reordering.
- **Called/referenced at:** not detected directly (may be invoked via nested closure/runtime path).

### `validate_announcement_markdown` {#fn-validate-announcement-markdown}
- **Defined at:** `/Users/yeroslaviz/Documents/Github/BCFNGS-project-management/sequencing-app/app.R:1895`
- **Signature line:** `validate_announcement_markdown <- function(markdown_text) {`
- **Purpose:** Validates announcement item text for non-empty and max-length constraints.
- **Called/referenced at:** not detected directly (may be invoked via nested closure/runtime path).

### `selected_announcement_item` {#fn-selected-announcement-item}
- **Defined at:** `/Users/yeroslaviz/Documents/Github/BCFNGS-project-management/sequencing-app/app.R:1906`
- **Signature line:** `selected_announcement_item <- function() {`
- **Purpose:** Returns currently selected item row from admin DT selection state.
- **Called/referenced at:** not detected directly (may be invoked via nested closure/runtime path).

### `get_all_usernames` {#fn-get-all-usernames}
- **Defined at:** `/Users/yeroslaviz/Documents/Github/BCFNGS-project-management/sequencing-app/app.R:1926`
- **Signature line:** `get_all_usernames <- function() {`
- **Purpose:** Builds responsible-user dropdown values (full name preferred, username fallback).
- **Called/referenced at:** not detected directly (may be invoked via nested closure/runtime path).

### `load_budget_holders` {#fn-load-budget-holders}
- **Defined at:** `/Users/yeroslaviz/Documents/Github/BCFNGS-project-management/sequencing-app/app.R:1942`
- **Signature line:** `load_budget_holders <- function() {`
- **Purpose:** Loads budget holders reference data.
- **Called/referenced at:** not detected directly (may be invoked via nested closure/runtime path).

### `load_service_types` {#fn-load-service-types}
- **Defined at:** `/Users/yeroslaviz/Documents/Github/BCFNGS-project-management/sequencing-app/app.R:1950`
- **Signature line:** `load_service_types <- function() {`
- **Purpose:** Loads service type reference data (including per-sample cost).
- **Called/referenced at:** not detected directly (may be invoked via nested closure/runtime path).

### `load_sequencing_depths` {#fn-load-sequencing-depths}
- **Defined at:** `/Users/yeroslaviz/Documents/Github/BCFNGS-project-management/sequencing-app/app.R:1958`
- **Signature line:** `load_sequencing_depths <- function() {`
- **Purpose:** Loads depth/reference pricing tiers.
- **Called/referenced at:** not detected directly (may be invoked via nested closure/runtime path).

### `load_sequencing_cycles` {#fn-load-sequencing-cycles}
- **Defined at:** `/Users/yeroslaviz/Documents/Github/BCFNGS-project-management/sequencing-app/app.R:1966`
- **Signature line:** `load_sequencing_cycles <- function() {`
- **Purpose:** Loads cycle/read-length options.
- **Called/referenced at:** not detected directly (may be invoked via nested closure/runtime path).

### `load_reference_genomes` {#fn-load-reference-genomes}
- **Defined at:** `/Users/yeroslaviz/Documents/Github/BCFNGS-project-management/sequencing-app/app.R:1974`
- **Signature line:** `load_reference_genomes <- function() {`
- **Purpose:** Loads genome list.
- **Called/referenced at:** not detected directly (may be invoked via nested closure/runtime path).

### `load_types` {#fn-load-types}
- **Defined at:** `/Users/yeroslaviz/Documents/Github/BCFNGS-project-management/sequencing-app/app.R:1982`
- **Signature line:** `load_types <- function() {`
- **Purpose:** Loads sample type list (`types` table).
- **Called/referenced at:** not detected directly (may be invoked via nested closure/runtime path).

### `load_sequencing_platforms` {#fn-load-sequencing-platforms}
- **Defined at:** `/Users/yeroslaviz/Documents/Github/BCFNGS-project-management/sequencing-app/app.R:1990`
- **Signature line:** `load_sequencing_platforms <- function() {`
- **Purpose:** Loads platform list.
- **Called/referenced at:** not detected directly (may be invoked via nested closure/runtime path).

### `load_admin_data` {#fn-load-admin-data}
- **Defined at:** `/Users/yeroslaviz/Documents/Github/BCFNGS-project-management/sequencing-app/app.R:2088`
- **Signature line:** `load_admin_data <- function() {`
- **Purpose:** Loads all admin-maintained reference tables and user table.
- **Called/referenced at:** not detected directly (may be invoked via nested closure/runtime path).

### `projects_has_additional_cost` {#fn-projects-has-additional-cost}
- **Defined at:** `/Users/yeroslaviz/Documents/Github/BCFNGS-project-management/sequencing-app/app.R:1838`
- **Signature line:** `projects_has_additional_cost <- function(con) {`
- **Purpose:** Checks whether `projects.additional_cost` is present in the current DB schema.
- **Called/referenced at:** startup DB migration helpers and health checks.

### `ensure_projects_additional_cost_column` {#fn-ensure-projects-additional-cost-column}
- **Defined at:** `/Users/yeroslaviz/Documents/Github/BCFNGS-project-management/sequencing-app/app.R:1844`
- **Signature line:** `ensure_projects_additional_cost_column <- function(con) {`
- **Purpose:** Applies in-place migration (`ALTER TABLE`) when `additional_cost` is missing.
- **Called/referenced at:** `get_db_connection()`, `validate_and_repair_database()`.

### `format_cost_amount` {#fn-format-cost-amount}
- **Defined at:** `/Users/yeroslaviz/Documents/Github/BCFNGS-project-management/sequencing-app/app.R:1851`
- **Signature line:** `format_cost_amount <- function(value) {`
- **Purpose:** Normalizes numeric display to two decimals for all cost summaries.
- **Called/referenced at:** create/edit cost UI blocks and notification message generation.

### `parse_additional_cost` {#fn-parse-additional-cost}
- **Defined at:** `/Users/yeroslaviz/Documents/Github/BCFNGS-project-management/sequencing-app/app.R:1857`
- **Signature line:** `parse_additional_cost <- function(value) {`
- **Purpose:** Validates admin-entered additional cost as non-negative decimal; supports comma/dot input.
- **Called/referenced at:** edit-cost preview, project update write path, notification-send handler.

### `calculate_base_cost` {#fn-calculate-base-cost}
- **Defined at:** `/Users/yeroslaviz/Documents/Github/BCFNGS-project-management/sequencing-app/app.R:2110`
- **Signature line:** `calculate_base_cost <- function(num_samples, service_type_id, sequencing_depth_id, sequencing_cycles_id) {`
- **Purpose:** Computes preparation + sequencing baseline before optional admin surcharge.
- **Called/referenced at:** create modal cost preview and edit modal cost preview.

### `calculate_total_cost` {#fn-calculate-total-cost}
- **Defined at:** `/Users/yeroslaviz/Documents/Github/BCFNGS-project-management/sequencing-app/app.R:2140`
- **Signature line:** `calculate_total_cost <- function(num_samples, service_type_id, sequencing_depth_id, sequencing_cycles_id, additional_cost = 0) {`
- **Purpose:** Computes final estimated cost (base cost + optional admin-entered additional cost).
- **Called/referenced at:** not detected directly (may be invoked via nested closure/runtime path).

### `send_project_creation_email` {#fn-send-project-creation-email}
- **Defined at:** `/Users/yeroslaviz/Documents/Github/BCFNGS-project-management/sequencing-app/app.R:2150`
- **Signature line:** `send_project_creation_email <- function(project_data, budget_holder, user_email) {`
- **Purpose:** Builds and sends project-created email to NGS facility mailbox only (`ngs@biochem.mpg.de`).
- **Called/referenced at:** not detected directly (may be invoked via nested closure/runtime path).

### `send_project_cost_notification_email` {#fn-send-project-cost-notification-email}
- **Defined at:** `/Users/yeroslaviz/Documents/Github/BCFNGS-project-management/sequencing-app/app.R:2260`
- **Signature line:** `send_project_cost_notification_email <- function(project_data, budget_holder, user_email) {`
- **Purpose:** Sends admin-triggered cost-estimation notification to creator + budget holder + NGS mailbox.
- **Called/referenced at:** `observeEvent(input$send_notification_btn)`.

### `send_data_released_email` {#fn-send-data-released-email}
- **Defined at:** `/Users/yeroslaviz/Documents/Github/BCFNGS-project-management/sequencing-app/app.R:2348`
- **Signature line:** `send_data_released_email <- function(project_data) {`
- **Purpose:** Sends automatic “Data released” email to responsible user and `omicsdesk` target.
- **Called/referenced at:** not detected directly (may be invoked via nested closure/runtime path).

### `load_projects` {#fn-load-projects}
- **Defined at:** `/Users/yeroslaviz/Documents/Github/BCFNGS-project-management/sequencing-app/app.R:2929`
- **Signature line:** `load_projects <- function() {`
- **Purpose:** Queries projects table with joins, role filtering, and display-preparation columns.
- **Called/referenced at:** not detected directly (may be invoked via nested closure/runtime path).

### `get_or_create_budget_holder` {#fn-get-or-create-budget-holder}
- **Defined at:** `/Users/yeroslaviz/Documents/Github/BCFNGS-project-management/sequencing-app/app.R:3254`
- **Signature line:** `get_or_create_budget_holder <- function(con, name, surname, cost_center, email) {`
- **Purpose:** Finds existing budget holder or inserts one from “Other / not listed” modal fields.
- **Called/referenced at:** not detected directly (may be invoked via nested closure/runtime path).

### `scalar_text` {#fn-scalar-text-update-flow}
- **Defined at:** `/Users/yeroslaviz/Documents/Github/BCFNGS-project-management/sequencing-app/app.R:5321`
- **Signature line:** `scalar_text <- function(x, default = "") {`
- **Purpose:** Normalizes potentially vector/empty values into a single trimmed string or NULL.
- **Called/referenced at:** not detected directly (may be invoked via nested closure/runtime path).
- **Important note:** this later local `scalar_text()` shadows the earlier helper inside `update_project_btn` scope, to normalize DB bind params safely.

### `scalar_numeric` {#fn-scalar-numeric}
- **Defined at:** `/Users/yeroslaviz/Documents/Github/BCFNGS-project-management/sequencing-app/app.R:5328`
- **Signature line:** `scalar_numeric <- function(x, default = NA_real_) {`
- **Purpose:** Normalizes potentially vector numeric input to one safe scalar for DB binding.
- **Called/referenced at:** not detected directly (may be invoked via nested closure/runtime path).

## Reactive Event Catalog (All `observeEvent`)

Every event trigger is listed with the panel it belongs to and what action it performs.

| Line | Trigger | UI panel/area | What happens |
|---:|---|---|---|
| 891 | `input$debug_db_btn` | Administer Projects -> Database Management | Shows modal with table counts and SQLite file metadata for quick diagnostics. |
| 995 | `input$client_url_search` | General / Shared | Caches browser query-string reactively for auth canonicalization logic. |
| 2266 | `input$show_register_btn` | Authentication / Login area | Opens user self-registration modal. |
| 2297 | `input$register_btn` | Authentication / Login area | Validates registration inputs and inserts user into DB. |
| 2454 | `input$dev_auth_mode` | Authentication / Login area | Switches between local/LDAP dev modes and resets session state. |
| 2531 | `input$dev_login_btn` | Authentication / Login area | Simulates LDAP login in development by setting `DEV_REMOTE_USER`. |
| 2539 | `input$ldap_profile_save_btn` | Authentication / Login area | Persists profile-completion values for LDAP user and finalizes login. |
| 2589 | `input$ldap_profile_cancel_btn` | Authentication / Login area | Cancels profile completion flow and asks user to reload later. |
| 2598 | `input$ldap_relogin_btn` | Authentication / Login area | Unblocks LDAP login after a profile interruption. |
| 2608 | `input$login_btn` | Authentication / Login area | Processes local password login (disabled in LDAP mode). |
| 2633 | `input$logout_btn` | General / Shared | Handles local logout or LDAP end-session guidance modal. |
| 3100 | `input$new_project_btn` | Apply for Projects / Projects table | Opens project-create modal and auto-selects budget holder by group mapping. |
| 3278 | `input$create_project_btn` | Apply for Projects / Projects table | Validates, inserts new project, sends creation email to NGS mailbox, and refreshes project table. |
| 3315 | `user$logged_in` | General / Shared | Loads project list after successful login. |
| 3324 | `input$manage_budget_holders_btn` | Administer Projects -> Budget Holders | Opens admin management modal for the selected reference-data domain. |
| 3362 | `input$manage_service_types_btn` | Administer Projects -> Service Types | Opens admin management modal for the selected reference-data domain. |
| 3398 | `input$manage_sequencing_depths_btn` | Administer Projects -> Sequencing Depths | Opens admin management modal for the selected reference-data domain. |
| 3432 | `input$manage_sequencing_cycles_btn` | Administer Projects -> Sequencing Cycles | Opens admin management modal for the selected reference-data domain. |
| 3456 | `input$manage_users_btn` | Administer Projects -> Users | Opens admin management modal for the selected reference-data domain. |
| 3493 | `input$manage_genomes_btn` | Administer Projects -> Reference Genomes | Opens admin management modal for the selected reference-data domain. |
| 3519 | `input$manage_types_btn` | Administer Projects -> Sample Types | Opens admin management modal for the selected reference-data domain. |
| 3545 | `input$manage_sequencing_platforms_btn` | Administer Projects -> Sequencing Platforms | Opens admin management modal for the selected reference-data domain. |
| 3571 | `input$manage_announcements_btn` | Administer Projects -> Landing Text | Opens landing-text management modal with panel selector and item table. |
| 3765 | `input$announcement_add_btn` | Administer Projects -> Landing Text | Handles landing-text CRUD/reordering flow in admin panel. |
| 3793 | `input$save_announcement_item_btn` | Administer Projects -> Landing Text | Reactive event handler tied to this trigger; see linked line for exact logic. |
| 3841 | `input$announcement_edit_btn` | Administer Projects -> Landing Text | Handles landing-text CRUD/reordering flow in admin panel. |
| 3873 | `input$update_announcement_item_btn` | Administer Projects -> Landing Text | Applies updates from edit modal to DB and refreshes affected reactive tables. |
| 3911 | `input$announcement_delete_btn` | Administer Projects -> Landing Text | Handles landing-text CRUD/reordering flow in admin panel. |
| 3933 | `input$confirm_delete_announcement_item_btn` | Administer Projects -> Landing Text | Executes confirmed delete, then reloads related data. |
| 3956 | `input$announcement_move_up_btn` | Administer Projects -> Landing Text | Handles landing-text CRUD/reordering flow in admin panel. |
| 4002 | `input$announcement_move_down_btn` | Administer Projects -> Landing Text | Handles landing-text CRUD/reordering flow in admin panel. |
| 4051 | `input$add_budget_holder_btn` | Administer Projects -> Budget Holders | Validates form fields and inserts a new row into the corresponding reference table. |
| 4096 | `input$add_service_type_btn` | Administer Projects -> Service Types | Validates form fields and inserts a new row into the corresponding reference table. |
| 4129 | `input$edit_service_type_btn` | Administer Projects -> Service Types | Opens edit modal for currently selected row in the matching admin table. |
| 4153 | `input$edit_budget_holder_btn` | Administer Projects -> Budget Holders | Opens edit modal for currently selected row in the matching admin table. |
| 4176 | `input$update_budget_holder_btn` | Administer Projects -> Budget Holders | Applies updates from edit modal to DB and refreshes affected reactive tables. |
| 4222 | `input$edit_genome_btn` | Administer Projects -> Reference Genomes | Opens edit modal for currently selected row in the matching admin table. |
| 4242 | `input$update_genome_btn` | Administer Projects -> Reference Genomes | Applies updates from edit modal to DB and refreshes affected reactive tables. |
| 4270 | `input$edit_type_btn` | Administer Projects -> Sample Types | Opens edit modal for currently selected row in the matching admin table. |
| 4290 | `input$update_type_btn` | Administer Projects -> Sample Types | Applies updates from edit modal to DB and refreshes affected reactive tables. |
| 4317 | `input$edit_sequencing_platform_btn` | Administer Projects -> Sequencing Platforms | Opens edit modal for currently selected row in the matching admin table. |
| 4337 | `input$update_sequencing_platform_update_btn` | Administer Projects -> Sequencing Platforms | Applies updates from edit modal to DB and refreshes affected reactive tables. |
| 4364 | `input$update_service_type_btn` | Administer Projects -> Service Types | Applies updates from edit modal to DB and refreshes affected reactive tables. |
| 4387 | `input$add_sequencing_depth_btn` | Administer Projects -> Sequencing Depths | Validates form fields and inserts a new row into the corresponding reference table. |
| 4420 | `input$edit_sequencing_depth_btn` | Administer Projects -> Sequencing Depths | Opens edit modal for currently selected row in the matching admin table. |
| 4444 | `input$update_sequencing_depth_btn` | Administer Projects -> Sequencing Depths | Applies updates from edit modal to DB and refreshes affected reactive tables. |
| 4468 | `input$add_sequencing_cycles_btn` | Administer Projects -> Sequencing Cycles | Validates form fields and inserts a new row into the corresponding reference table. |
| 4495 | `input$add_user_admin_btn` | Administer Projects -> Users | Validates form fields and inserts a new row into the corresponding reference table. |
| 4541 | `input$add_genome_btn` | Administer Projects -> Reference Genomes | Validates form fields and inserts a new row into the corresponding reference table. |
| 4568 | `input$add_type_btn` | Administer Projects -> Sample Types | Validates form fields and inserts a new row into the corresponding reference table. |
| 4591 | `input$add_sequencing_platform_btn` | Administer Projects -> Sequencing Platforms | Validates form fields and inserts a new row into the corresponding reference table. |
| 4616 | `input$delete_budget_holder_btn` | Administer Projects -> Budget Holders | Opens delete confirmation for selected row. |
| 4635 | `input$confirm_delete_budget_holder_btn` | Administer Projects -> Budget Holders | Executes confirmed delete, then reloads related data. |
| 4650 | `input$delete_service_type_btn` | Administer Projects -> Service Types | Opens delete confirmation for selected row. |
| 4669 | `input$confirm_delete_service_type_btn` | Administer Projects -> Service Types | Executes confirmed delete, then reloads related data. |
| 4684 | `input$delete_sequencing_depth_btn` | Administer Projects -> Sequencing Depths | Opens delete confirmation for selected row. |
| 4703 | `input$confirm_delete_sequencing_depth_btn` | Administer Projects -> Sequencing Depths | Executes confirmed delete, then reloads related data. |
| 4718 | `input$delete_sequencing_cycles_btn` | Administer Projects -> Sequencing Cycles | Opens delete confirmation for selected row. |
| 4737 | `input$confirm_delete_sequencing_cycles_btn` | Administer Projects -> Sequencing Cycles | Executes confirmed delete, then reloads related data. |
| 4752 | `input$delete_user_admin_btn` | Administer Projects -> Users | Opens delete confirmation for selected row. |
| 4776 | `input$confirm_delete_user_btn` | Administer Projects -> Users | Executes confirmed delete, then reloads related data. |
| 4791 | `input$delete_genome_btn` | Administer Projects -> Reference Genomes | Opens delete confirmation for selected row. |
| 4810 | `input$confirm_delete_genome_btn` | Administer Projects -> Reference Genomes | Executes confirmed delete, then reloads related data. |
| 4825 | `input$delete_type_btn` | Administer Projects -> Sample Types | Opens delete confirmation for selected row. |
| 4844 | `input$confirm_delete_type_btn` | Administer Projects -> Sample Types | Executes confirmed delete, then reloads related data. |
| 4859 | `input$delete_sequencing_platform_btn` | Administer Projects -> Sequencing Platforms | Opens delete confirmation for selected row. |
| 4878 | `input$confirm_delete_sequencing_platform_btn` | Administer Projects -> Sequencing Platforms | Executes confirmed delete, then reloads related data. |
| 5094 | `input$edit_project_btn` | Apply for Projects / Projects table | Opens edit modal for selected project with permission checks. |
| 5286 | `input$update_project_btn` | Apply for Projects / Projects table | Updates selected project row, validates/stores `additional_cost` (admin), and optionally sends data-released email. |
| 5473 | `input$send_notification_btn` | Apply for Projects / Edit Project modal (admin) | Sends explicit cost-estimation notification email (creator + budget holder + NGS) without changing project status. |
| 5194 | `input$delete_project_btn` | Apply for Projects / Projects table | Shows admin-only delete confirmation for selected project. |
| 5220 | `input$confirm_delete_btn` | General / Shared | Deletes project row from DB and refreshes table. |
| 5630 | `input$update_status_btn` | Apply for Projects / Projects table | Opens status-update modal (admin only). |
| 5665 | `input$confirm_status_update_btn` | Apply for Projects / Projects table | Writes new status and sends data-released email when applicable. |
| 5350 | `input$validate_db_btn` | Administer Projects -> Database Management | Runs DB validation and reports health status. |
| 5395 | `input$restore_db_btn` | Administer Projects -> Database Management | Starts DB restore flow after backup-file selection. |
| 5414 | `input$confirm_restore_btn` | Administer Projects -> Database Management | Performs restore (with safety backup) and restarts app state expectations. |

## Reactive Observer Blocks (`observe`)

| Line | Purpose |
|---:|---|
| 873 | Runs startup DB validation and opens warning modal if required tables are missing. |
| 2368 | Shows/hides login screen depending on LDAP header/dev state and current session login state. |
| 2383 | Main LDAP auto-login observer: resolves username from trusted sources and executes `handle_ldap_login()`. |

## SQL Behavior Map (Query/Write Intent by Domain)

### Line-by-Line SQL Index

The table below indexes each detected DB call (`dbGetQuery`, `dbExecute`) in `app.R` so you can jump from behavior to exact query line.

| Line | Active | Call | SQL verb | Table(s) | Query preview |
|---:|---|---|---|---|---|
| `715` | Yes | `dbExecute` | `CREATE TABLE` | `announcement_panels` | CREATE TABLE IF NOT EXISTS announcement_panels ( id INTEGER PRIMARY KEY AUTOINCREMENT, panel_key TEXT UNIQUE NOT NULL, title TEXT, subtitle TEXT, display_order INTEGER NOT NULL,... |
| `728` | Yes | `dbExecute` | `CREATE TABLE` | `announcement_items` | CREATE TABLE IF NOT EXISTS announcement_items ( id INTEGER PRIMARY KEY AUTOINCREMENT, panel_id INTEGER NOT NULL, display_order INTEGER NOT NULL, markdown_text TEXT NOT NULL, is_... |
| `746` | Yes | `dbGetQuery` | `SELECT` | `announcement_panels` | SELECT id, panel_key FROM announcement_panels |
| `757` | Yes | `dbExecute` | `INSERT` | `announcement_panels` | INSERT INTO announcement_panels (panel_key, title, subtitle, display_order, is_active, updated_by) VALUES (?, ?, ?, ?, 1, ?) |
| `768` | Yes | `dbGetQuery` | `SELECT` | `announcement_panels` | SELECT id FROM announcement_panels WHERE panel_key = ? |
| `780` | Yes | `dbExecute` | `INSERT` | `announcement_items` | INSERT INTO announcement_items (panel_id, display_order, markdown_text, is_active, updated_by) VALUES (?, ?, ?, 1, ?) |
| `822` | Yes | `dbGetQuery` | `unknown` | `(dynamic/unknown)` | (query provided via variable/expression) |
| `823` | Yes | `dbGetQuery` | `unknown` | `(dynamic/unknown)` | (query provided via variable/expression) |
| `862` | Yes | `dbGetQuery` | `SELECT` | `(dynamic/unknown)` | SELECT 1 as test |
| `896` | Yes | `dbGetQuery` | `SELECT` | `(dynamic/unknown)` | SELECT COUNT(*) as count FROM |
| `1487` | Yes | `dbGetQuery` | `SELECT` | `budget_holders` | SELECT id, name, surname, cost_center FROM budget_holders |
| `1639` | Yes | `dbGetQuery` | `SELECT` | `users` | SELECT * FROM users WHERE username = ? |
| `1682` | Yes | `dbExecute` | `INSERT` | `users` | INSERT INTO users (username, full_name, password, email, phone, research_group, is_admin) VALUES (?, ?, ?, ?, ?, ?, 0) |
| `1694` | Yes | `dbExecute` | `INSERT` | `users` | INSERT INTO users (username, password, email, phone, research_group, is_admin) VALUES (?, ?, ?, ?, ?, 0) |
| `1706` | Yes | `dbGetQuery` | `SELECT` | `users` | SELECT * FROM users WHERE username = ? |
| `1715` | Yes | `dbExecute` | `UPDATE` | `users` | UPDATE users SET research_group = ? WHERE username = ? |
| `1719` | Yes | `dbGetQuery` | `SELECT` | `users` | SELECT * FROM users WHERE username = ? |
| `1743` | Yes | `dbExecute` | `UPDATE` | `users` | UPDATE users SET email = ?, phone = ?, research_group = ?, full_name = ? WHERE username = ? |
| `1754` | Yes | `dbExecute` | `UPDATE` | `users` | UPDATE users SET email = ?, phone = ?, research_group = ? WHERE username = ? |
| `1765` | Yes | `dbGetQuery` | `SELECT` | `users` | SELECT * FROM users WHERE username = ? |
| `1817` | Yes | `dbGetQuery` | `PRAGMA` | `table_info` | PRAGMA table_info(users) |
| `1844` | Yes | `dbGetQuery` | `unknown` | `(dynamic/unknown)` | (query provided via variable/expression) |
| `1858` | Yes | `dbGetQuery` | `SELECT` | `announcement_panels` | SELECT id FROM announcement_panels WHERE panel_key = ? |
| `1874` | Yes | `dbGetQuery` | `unknown` | `(dynamic/unknown)` | (query provided via variable/expression) |
| `1878` | Yes | `dbGetQuery` | `SELECT` | `announcement_items` | SELECT id FROM announcement_items WHERE panel_id = ? ORDER BY display_order, id |
| `1886` | Yes | `dbExecute` | `UPDATE` | `announcement_items` | UPDATE announcement_items SET display_order = ?, updated_at = CURRENT_TIMESTAMP WHERE id = ? |
| `1930` | Yes | `dbGetQuery` | `SELECT` | `users` | SELECT username, full_name FROM users ORDER BY username |
| `1932` | Yes | `dbGetQuery` | `SELECT` | `users` | SELECT username FROM users ORDER BY username |
| `1945` | Yes | `dbGetQuery` | `SELECT` | `budget_holders` | SELECT id, name, surname, cost_center, email FROM budget_holders ORDER BY name, surname |
| `1953` | Yes | `dbGetQuery` | `SELECT` | `service_types` | SELECT id, service_type, kit, costs_per_sample FROM service_types ORDER BY service_type |
| `1961` | Yes | `dbGetQuery` | `SELECT` | `sequencing_depths` | SELECT id, depth_description, cost_upto_150_cycles, cost_upto_300_cycles FROM sequencing_depths ORDER BY depth_description |
| `1969` | Yes | `dbGetQuery` | `SELECT` | `sequencing_cycles` | SELECT id, cycles_description FROM sequencing_cycles ORDER BY cycles_description |
| `1977` | Yes | `dbGetQuery` | `SELECT` | `reference_genomes` | SELECT name FROM reference_genomes ORDER BY name |
| `1985` | Yes | `dbGetQuery` | `SELECT` | `types` | SELECT id, name FROM types ORDER BY name |
| `1993` | Yes | `dbGetQuery` | `SELECT` | `sequencing_platforms` | SELECT id, name FROM sequencing_platforms ORDER BY name |
| `2004` | Yes | `dbGetQuery` | `SELECT` | `users` | SELECT id, username, full_name, email, phone, research_group, is_admin FROM users |
| `2006` | Yes | `dbGetQuery` | `SELECT` | `users` | SELECT id, username, email, phone, research_group, is_admin FROM users |
| `2061` | Yes | `dbGetQuery` | `SELECT` | `email_templates` | SELECT subject, body_template FROM email_templates WHERE template_name = 'project_creation' AND is_active = 1 |
| `2076` | No (commented) | `dbGetQuery` | `SELECT` | `users` | SELECT email FROM users WHERE is_admin = 1 |
| `2161` | Yes | `dbGetQuery` | `SELECT` | `users` | SELECT username, full_name, email FROM users WHERE username = ? LIMIT 1 |
| `2167` | Yes | `dbGetQuery` | `SELECT` | `users` | SELECT username, full_name, email FROM users WHERE full_name = ? LIMIT 1 |
| `2176` | Yes | `dbGetQuery` | `SELECT` | `users` | SELECT username, full_name, email FROM users WHERE id = ? LIMIT 1 |
| `2184` | Yes | `dbGetQuery` | `SELECT` | `users` | SELECT username, email FROM users WHERE username = ? LIMIT 1 |
| `2192` | Yes | `dbGetQuery` | `SELECT` | `users` | SELECT username, email FROM users WHERE id = ? LIMIT 1 |
| `2269` | Yes | `dbGetQuery` | `SELECT` | `budget_holders` | SELECT DISTINCT name, surname FROM budget_holders ORDER BY name, surname |
| `2319` | Yes | `dbGetQuery` | `SELECT` | `users` | SELECT id FROM users WHERE username = ? |
| `2336` | Yes | `dbExecute` | `INSERT` | `users` | INSERT INTO users (username, full_name, password, email, phone, research_group, is_admin) VALUES (?, ?, ?, ?, ?, ?, 0) |
| `2348` | Yes | `dbExecute` | `INSERT` | `users` | INSERT INTO users (username, password, email, phone, research_group, is_admin) VALUES (?, ?, ?, ?, ?, 0) |
| `2564` | Yes | `dbExecute` | `INSERT` | `users` | INSERT INTO users (username, password, email, phone, research_group, is_admin) VALUES (?, ?, ?, ?, ?, 0) |
| `2569` | Yes | `dbExecute` | `UPDATE` | `users` | UPDATE users SET email = ?, phone = ?, research_group = ? WHERE username = ? |
| `2581` | Yes | `dbGetQuery` | `SELECT` | `users` | SELECT * FROM users WHERE username = ? |
| `2619` | Yes | `dbGetQuery` | `SELECT` | `users` | SELECT * FROM users WHERE username = ? |
| `2743` | Yes | `dbGetQuery` | `SELECT` | `projects, users, types, budget_holders, service_types, sequencing_depths, sequencing_cycles` | SELECT p.*, as created_by, t.name as type_name, bh.name as budget_holder_name, bh.surname as budget_holder_surname, bh.cost_center, st.service_type, sd.depth_description, sc.cyc... |
| `2761` | Yes | `dbGetQuery` | `SELECT` | `projects, users, types, budget_holders, service_types, sequencing_depths, sequencing_cycles` | SELECT p.*, as created_by, t.name as type_name, bh.name as budget_holder_name, bh.surname as budget_holder_surname, bh.cost_center, st.service_type, sd.depth_description, sc.cyc... |
| `2997` | Yes | `dbGetQuery` | `SELECT` | `users` | SELECT research_group FROM users WHERE id = ? |
| `3061` | Yes | `dbGetQuery` | `SELECT` | `budget_holders` | SELECT id FROM budget_holders WHERE name = ? AND surname = ? AND cost_center = ? |
| `3068` | Yes | `dbExecute` | `INSERT` | `budget_holders` | INSERT INTO budget_holders (name, surname, cost_center, email) VALUES (?, ?, ?, ?) |
| `3073` | Yes | `dbGetQuery` | `SELECT` | `budget_holders` | SELECT id FROM budget_holders WHERE name = ? AND surname = ? AND cost_center = ? |
| `3128` | Yes | `dbExecute` | `INSERT` | `projects` | INSERT INTO projects (project_name, user_id, responsible_user, reference_genome, service_type_id, budget_id, description, num_samples, sequencing_platform, sequencing_depth_id, ... |
| `3152` | Yes | `dbGetQuery` | `SELECT` | `(dynamic/unknown)` | SELECT last_insert_rowid() AS id |
| `3153` | Yes | `dbGetQuery` | `SELECT` | `projects` | SELECT project_id FROM projects WHERE id = ? |
| `3176` | Yes | `dbGetQuery` | `SELECT` | `budget_holders` | SELECT * FROM budget_holders WHERE id = ? |
| `3177` | Yes | `dbGetQuery` | `SELECT` | `users` | SELECT email FROM users WHERE id = ? |
| `3809` | Yes | `dbGetQuery` | `SELECT` | `announcement_panels` | SELECT id FROM announcement_panels WHERE panel_key = ? |
| `3819` | Yes | `dbGetQuery` | `SELECT` | `announcement_items` | SELECT COALESCE(MAX(display_order), 0) + 1 AS next_order FROM announcement_items WHERE panel_id = ? |
| `3825` | Yes | `dbExecute` | `INSERT` | `announcement_items` | INSERT INTO announcement_items (panel_id, display_order, markdown_text, is_active, updated_by) VALUES (?, ?, ?, ?, ?) admin |
| `3894` | Yes | `dbExecute` | `UPDATE` | `announcement_items` | UPDATE announcement_items SET markdown_text = ?, is_active = ?, updated_at = CURRENT_TIMESTAMP, updated_by = ? WHERE id = ? admin |
| `3948` | Yes | `dbExecute` | `DELETE` | `announcement_items` | DELETE FROM announcement_items WHERE id = ? |
| `3981` | Yes | `dbExecute` | `UPDATE` | `announcement_items` | UPDATE announcement_items SET display_order = ?, updated_at = CURRENT_TIMESTAMP, updated_by = ? WHERE id = ? admin |
| `3989` | Yes | `dbExecute` | `UPDATE` | `announcement_items` | UPDATE announcement_items SET display_order = ?, updated_at = CURRENT_TIMESTAMP, updated_by = ? WHERE id = ? admin |
| `4027` | Yes | `dbExecute` | `UPDATE` | `announcement_items` | UPDATE announcement_items SET display_order = ?, updated_at = CURRENT_TIMESTAMP, updated_by = ? WHERE id = ? admin |
| `4035` | Yes | `dbExecute` | `UPDATE` | `announcement_items` | UPDATE announcement_items SET display_order = ?, updated_at = CURRENT_TIMESTAMP, updated_by = ? WHERE id = ? admin |
| `4063` | Yes | `dbGetQuery` | `SELECT` | `budget_holders` | SELECT id FROM budget_holders WHERE cost_center = ? |
| `4073` | Yes | `dbExecute` | `INSERT` | `budget_holders` | INSERT INTO budget_holders (name, surname, cost_center, email) VALUES (?, ?, ?, ?) |
| `4112` | Yes | `dbExecute` | `INSERT` | `service_types` | INSERT INTO service_types (service_type, kit, costs_per_sample) VALUES (?, ?, ?) |
| `4194` | Yes | `dbGetQuery` | `SELECT` | `budget_holders` | SELECT id FROM budget_holders WHERE cost_center = ? AND id != ? |
| `4204` | Yes | `dbExecute` | `UPDATE` | `budget_holders` | UPDATE budget_holders SET name = ?, surname = ?, cost_center = ?, email = ? WHERE id = ? |
| `4262` | Yes | `dbExecute` | `UPDATE` | `reference_genomes` | UPDATE reference_genomes SET name = ? WHERE name = ? |
| `4309` | Yes | `dbExecute` | `UPDATE` | `types` | UPDATE types SET name = ? WHERE id = ? |
| `4356` | Yes | `dbExecute` | `UPDATE` | `sequencing_platforms` | UPDATE sequencing_platforms SET name = ? WHERE id = ? |
| `4371` | Yes | `dbExecute` | `UPDATE` | `service_types` | UPDATE service_types SET service_type = ?, kit = ?, costs_per_sample = ? WHERE id = ? |
| `4403` | Yes | `dbExecute` | `INSERT` | `sequencing_depths` | INSERT INTO sequencing_depths (depth_description, cost_upto_150_cycles, cost_upto_300_cycles) VALUES (?, ?, ?) |
| `4451` | Yes | `dbExecute` | `UPDATE` | `sequencing_depths` | UPDATE sequencing_depths SET depth_description = ?, cost_upto_150_cycles = ?, cost_upto_300_cycles = ? WHERE id = ? |
| `4484` | Yes | `dbExecute` | `INSERT` | `sequencing_cycles` | INSERT INTO sequencing_cycles (cycles_description) VALUES (?) |
| `4511` | Yes | `dbGetQuery` | `SELECT` | `users` | SELECT id FROM users WHERE username = ? |
| `4520` | Yes | `dbExecute` | `INSERT` | `users` | INSERT INTO users (username, password, email, is_admin) VALUES (?, ?, ?, ?) |
| `4557` | Yes | `dbExecute` | `INSERT` | `reference_genomes` | INSERT INTO reference_genomes (name) VALUES (?) |
| `4584` | Yes | `dbExecute` | `INSERT` | `types` | INSERT INTO types (name) VALUES (?) |
| `4607` | Yes | `dbExecute` | `INSERT` | `sequencing_platforms` | INSERT INTO sequencing_platforms (name) VALUES (?) |
| `4642` | Yes | `dbExecute` | `DELETE` | `budget_holders` | DELETE FROM budget_holders WHERE id = ? |
| `4676` | Yes | `dbExecute` | `DELETE` | `service_types` | DELETE FROM service_types WHERE service_type = ? |
| `4710` | Yes | `dbExecute` | `DELETE` | `sequencing_depths` | DELETE FROM sequencing_depths WHERE depth_description = ? |
| `4744` | Yes | `dbExecute` | `DELETE` | `sequencing_cycles` | DELETE FROM sequencing_cycles WHERE cycles_description = ? |
| `4783` | Yes | `dbExecute` | `DELETE` | `users` | DELETE FROM users WHERE id = ? |
| `4817` | Yes | `dbExecute` | `DELETE` | `reference_genomes` | DELETE FROM reference_genomes WHERE name = ? |
| `4851` | Yes | `dbExecute` | `DELETE` | `types` | DELETE FROM types WHERE name = ? |
| `4885` | Yes | `dbExecute` | `DELETE` | `sequencing_platforms` | DELETE FROM sequencing_platforms WHERE name = ? |
| `5111` | Yes | `dbExecute` | `UPDATE` | `projects` | UPDATE projects SET project_name = ?, reference_genome = ?, service_type_id = ?, budget_id = ?, responsible_user = ?, description = ?, updated_at = CURRENT_TIMESTAMP, num_sample... |
| `5137` | Yes | `dbExecute` | `UPDATE` | `projects` | UPDATE projects SET project_name = ?, reference_genome = ?, service_type_id = ?, budget_id = ?, responsible_user = ?, description = ?, updated_at = CURRENT_TIMESTAMP, num_sample... |
| `5227` | Yes | `dbExecute` | `DELETE` | `projects` | DELETE FROM projects WHERE id = ? |
| `5298` | Yes | `dbExecute` | `UPDATE` | `projects` | UPDATE projects SET status = ?, updated_at = CURRENT_TIMESTAMP WHERE id = ? |
| `5377` | Yes | `dbExecute` | `INSERT` | `backup_logs` | INSERT INTO backup_logs (backup_timestamp, backup_size, backed_up_by) VALUES (?, ?, ?) %Y-%m-%d %H:%M:%S |
| `5467` | No (commented) | `dbExecute` | `INSERT` | `backup_logs` | # INSERT INTO backup_logs (backup_timestamp, backup_size, backed_up_by) # VALUES (?, ?, ?) # %Y-%m-%d %H:%M:%S |

### Domain Summary

### `users` table

- **Reads:** login lookup, LDAP user lookup, responsible-user email/full-name resolution, admin user listing.
- **Writes:** self-registration insert, LDAP auto-create/update, admin add/delete user, profile completion updates.
- **Key lines:** 1639, 1682, 1694, 1715, 1735-1754, 1930-1932, 2004-2006, 2319, 2336/2348, 2564/2569, 2619, 4495-4535, 4783.

### `projects` table

- **Reads:** project list (admin/non-admin variants with joins), selected project retrieval in edit/delete/status flows.
- **Writes:** create project, update project fields, delete project, update status.
- **Key lines:** 2743/2761, 3128, 3152/3153, 5111/5137, 5227, 5298.

### `budget_holders` table

- **Reads:** reference list + group mapping + selected budget holder for emails.
- **Writes:** add/edit/delete and on-demand create via “Other / not listed”.
- **Key lines:** 1487, 1945, 2997, 3061/3068/3073, 4063/4073, 4194/4204, 4642.

### `service_types`, `sequencing_depths`, `sequencing_cycles`, `types`, `sequencing_platforms`, `reference_genomes`

- **Reads:** loaded into admin dropdowns and project joins.
- **Writes:** full admin CRUD via dedicated modals/buttons.
- **Key lines:** 1953-1993, 4112, 4371, 4403/4451/4710, 4484/4744, 4584/4309/4851, 4607/4356/4885, 4262/4557/4817.

### `announcement_panels` and `announcement_items`

- **Reads:** loaded for landing-page render and admin editing table.
- **Writes:** auto-create/seed at startup + CRUD/reordering through `Manage Landing Text`.
- **Key lines:** 714-831, 3809/3819/3825, 3894, 3948, 3981/3989/4027/4035.

### `email_templates` and `email_logs`

- **Reads:** loads template for project-creation message generation.
- **Writes:** logs email send status/failure metadata.
- **Key lines:** 2061, 2133-2144, 2234-2244.

### `backup_logs`

- **Writes:** backup metadata from manual backup download flow (and optional commented auto-backup block).
- **Key lines:** 5377, 5467 (commented block context).

## UI Panel Walkthrough (Human-Friendly)

### Login Screen (`login_screen`)

- Contains informational text, local username/password inputs, registration link, and optional dev tools.
- In LDAP production, local password login is blocked; session identity comes from Apache LDAP auth headers/query canonicalization.
- Server linkages: `output$dev_tools_ui`, `output$dev_login_ui`, `observeEvent(input$login_btn)`, `observeEvent(input$show_register_btn)`, LDAP observers at lines ~2368 and ~2383.

### Main App Header

- Shows welcome text (`output$welcome_user`), dev mode badge, and logout/end-session button.
- In LDAP mode, logout action intentionally shows guidance (“close tab/window”) rather than clearing server auth.

### Apply for Projects

- Landing text panels (`output$announcement_blocks_ui`) are DB-driven and admin-editable.
- Project actions for users: create, edit (delete hidden for non-admin).
- Primary flows: `input$new_project_btn` -> modal; `input$create_project_btn` writes DB + sends NGS-only creation email; `input$edit_project_btn` and `input$update_project_btn` modify rows; `input$send_notification_btn` sends explicit cost notifications.

### Administer Projects

- Entry point for all reference-data management (users, budget holders, genomes, sample types, service types, depth, cycles, platforms, landing text).
- Includes DB backup download, restore upload, and validation controls.
- Every admin button opens a modal, each modal has add/edit/delete handlers, and each handler performs DB write + reactive refresh + notification.

## Notification Strategy

- `showNotification()` is used for user feedback after every validation failure and successful action.
- Patterns used:

  - `type = "error"` for invalid inputs, auth failures, DB failures.
  - `type = "warning"` for missing selections or non-blocking problems.
  - `type = "message"` for successful CRUD/deploy-like user actions.
- This gives immediate UX confirmation at every CRUD/event step.

## Cross-Reference Quick Index

- **Create project modal**: `/Users/yeroslaviz/Documents/Github/BCFNGS-project-management/sequencing-app/app.R:3100` (open), `:3278` (submit).
- **Edit project modal**: `/Users/yeroslaviz/Documents/Github/BCFNGS-project-management/sequencing-app/app.R:5094` (open), `:5286` (submit).
- **Cost notification button**: `/Users/yeroslaviz/Documents/Github/BCFNGS-project-management/sequencing-app/app.R:5126` (UI), `:5473` (handler).
- **Status update modal**: `/Users/yeroslaviz/Documents/Github/BCFNGS-project-management/sequencing-app/app.R:5630` (open), `:5665` (submit).
- **Landing text management**: `/Users/yeroslaviz/Documents/Github/BCFNGS-project-management/sequencing-app/app.R:3770` and CRUD events `:3765` onward.
- **LDAP auto-login core**: `/Users/yeroslaviz/Documents/Github/BCFNGS-project-management/sequencing-app/app.R:2383` + helpers around `:1103` and `:1635`.
- **DB backup/restore UI**: `/Users/yeroslaviz/Documents/Github/BCFNGS-project-management/sequencing-app/app.R:3196-3213`; handlers at `:5744-5808`.

## Caveats and Technical Debt Notes

1. `scalar_text()` is defined twice (global helper and local normalization helper inside update flow). This works due local scope but can confuse readers.
2. `dbExecute`/`dbGetQuery` calls are spread across many event handlers; transaction wrapping could improve consistency for multi-step writes.
3. Email flow currently depends on Java/mail stack (`mailR`/`rJava`), which is sensitive to VM Java configuration.
4. Backup restore intentionally requires explicit confirmation to reduce accidental overwrites.
5. Announcement markdown is intentionally limited (safe subset) to avoid HTML/script injection.

## Reading Checklist for New Maintainers

1. Start with `validate_and_repair_database()` and auth mode setup to understand startup preconditions.
2. Follow `complete_login()` + `load_projects()` to understand post-login state.
3. Read one full CRUD chain end-to-end (e.g., service types) to understand modal -> validation -> SQL -> refresh pattern.
4. Read `send_project_creation_email()`, `send_project_cost_notification_email()`, and `send_data_released_email()` for notification side-effects.
5. Read backup/restore handlers before doing production maintenance.
