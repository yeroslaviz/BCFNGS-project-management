---
title: "LDAP Setup Summary (2026-02-06)"
execute:
  eval: false
---

## LDAP + Project Management App Summary (2026-02-06)

This file summarizes the work done today and how to run/test the app locally and on the VM.

### What Changed

- Added LDAP login flow with auto-login via `X-Remote-User` and local dev simulation via `DEV_REMOTE_USER`.
- LDAP attribute lookup now works without a bind account (anonymous bind), and falls back to `ldapsearch` for older `ldapr` versions.
- Added a dev-only auth toggle and mode badge (`DEV · LDAP` / `DEV · LOCAL`).
- Mapped LDAP `ou` values to budget holders, auto-selecting the correct PI in the project form (with partial match fallback).
- Added notices when a PI has multiple cost centers or missing cost center.
- Added “Other / not listed” budget holder option so users can enter a new PI (name + surname required; cost center optional with warning).
- `deploy.sh` now uses `rsync` and excludes the SQLite DB.
- Docs updated with LDAP setup, local testing, and env cleanup.
- `.gitignore` updated to ignore DB files and backup folders.

### Files Updated

- `sequencing-app/app.R`
- `deploy.sh`
- `01-main.conf`
- `Server_preparations.qmd`
- `.gitignore`
- `sequencing-app/budget_holders.csv`

### Local Run: Local Mode

```r
Sys.setenv(APP_ENV = "dev", AUTH_MODE = "local")
shiny::runApp("sequencing-app")
```

**Implications**
- Uses SQLite users/passwords.
- Shows normal login form.
- Works offline.

### Local Run: LDAP Mode (simulate production)

```r
Sys.setenv(
  APP_ENV = "dev",
  AUTH_MODE = "ldap",
  DEV_REMOTE_USER = "your_username",
  LDAP_URI = "ldaps://ldapserv1.biochem.mpg.de:636,ldaps://ldapserv2.biochem.mpg.de:636,ldaps://ldapserv3.biochem.mpg.de:636",
  LDAP_BASE_DN = "dc=biochem,dc=mpg,dc=de"
)
shiny::runApp("sequencing-app")
```

**Implications**
- Auto-login (no local password).
- Pulls `mail`, `telephoneNumber`, and `ou` via LDAP.
- Auto-creates user in SQLite if missing.
- Matches production behavior.

### Clear Dev Environment Variables

```r
Sys.unsetenv(c(
  "APP_ENV", "AUTH_MODE", "DEV_REMOTE_USER",
  "LDAP_BIND_DN", "LDAP_BIND_PW",
  "LDAP_URI", "LDAP_BASE_DN", "LDAP_DEBUG"
))
```

### Verify LDAP Attributes in SQLite

```r
con <- DBI::dbConnect(RSQLite::SQLite(), "sequencing-app/sequencing_projects.db")
DBI::dbGetQuery(con, "SELECT username, email, phone, research_group FROM users WHERE username='your_username'")
DBI::dbDisconnect(con)
```

### Budget Holder Behavior

- On first LDAP login, the app maps LDAP `ou` to a PI name in `budget_holders`.
- If multiple cost centers exist for a PI, the app displays a notice.
- If cost center is missing (`N.A.`/empty), the app displays a warning.
- “Other / not listed” allows users to enter a new PI and inserts into `budget_holders` automatically.

### Deploy (VM)

```bash
cd /home/yeroslaviz/BCFNGS-project-management
git pull
./deploy.sh
```

`deploy.sh` uses `rsync` and **does not overwrite** the SQLite DB.

### LDAP on VM (when ready)

1. Update Apache config (template in `01-main.conf`).
2. Enable modules:
   ```bash
   sudo a2enmod ldap authnz_ldap headers
   sudo systemctl reload apache2
   ```
3. Set Shiny env vars:
   ```bash
   sudo systemctl edit shiny-server
   ```
   ```ini
   [Service]
   Environment=AUTH_MODE=ldap
   Environment=LDAP_URI=ldaps://ldapserv1.biochem.mpg.de:636,ldaps://ldapserv2.biochem.mpg.de:636,ldaps://ldapserv3.biochem.mpg.de:636
   Environment=LDAP_BASE_DN=dc=biochem,dc=mpg,dc=de
   # Optional: restrict to People OU
   # Environment=LDAP_BASE_DN=ou=People,dc=biochem,dc=mpg,dc=de
   ```
4. Restart services:
   ```bash
   sudo systemctl restart apache2
   sudo systemctl restart shiny-server
   ```

### Switching Modes on VM

```bash
sudo systemctl edit shiny-server
```
- LDAP mode: `Environment=AUTH_MODE=ldap`
- Local mode: `Environment=AUTH_MODE=local` (or remove the line)

Restart:
```bash
sudo systemctl restart shiny-server
```

### Why DB Files Are Ignored

SQLite DBs change constantly, are environment-specific (local vs VM), and may contain sensitive data. We ignore `*.db` and `*.sqlite` and keep only schema/seed files in git.

### Tools Needed

- `ldapsearch` is required for LDAP attribute fallback:
  - Ubuntu: `sudo apt install -y ldap-utils`
  - macOS: `brew install openldap`

