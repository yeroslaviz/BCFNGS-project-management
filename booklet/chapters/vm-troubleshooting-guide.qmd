---
title: "VM Troubleshooting Guide (GitHub, LDAP, Apache, Shiny)"
execute:
  eval: false
---

## VM Troubleshooting Guide (GitHub, LDAP, Apache, Shiny)

This checklist covers the most common issues we hit and how to fix them quickly.

### AI session restart (quick resume)

If I need to resume work in a new AI session, I point it to:

1. `notes/vm-rollout-summary-2026-02-09.md` for the current state and validation.
2. `notes/ubuntu-bare-server-setup-howto.md` for the full setup flow.

### A) Git / GitHub sync problems

**1) Permission denied (publickey)**

Symptoms:

- `git@github.com: Permission denied (publickey)`
- `fatal: Could not read from remote repository`

Fix:

1. Verify SSH auth:

```
ssh -T git@github.com
```

2. Confirm repo URL:

```
git remote -v
```

3. Ensure the correct SSH key is loaded (or add it to `~/.ssh/config`).

**2) Divergent branches during pull**

Symptoms:

```
fatal: Need to specify how to reconcile divergent branches.
```

Fix:

```
git config pull.rebase false
# or git config pull.rebase true
```

**3) Local changes block pull**

Symptoms:

```
error: Your local changes ... would be overwritten by merge
```

Fix:

```
git stash push -m "vm local changes"
git pull origin main
git stash pop
```

Resolve conflicts if they appear.

**4) Merge conflict in config files**

Fix options:

```
# Keep repo version
git checkout --ours <file>

# Keep local version
git checkout --theirs <file>
```

**5) Untracked files in the VM**

Symptoms:

```
?? sequencing-app/test_detailed.R
```

Fix:

- Ignore, delete, or add to `.gitignore`.

### B) Apache / LDAP authentication issues

**1) Apache won’t restart after LDAP change**

Symptoms:

```
AH00526: Syntax error ... Bad LDAP URL while parsing.
```

Fix:

Use a single, complete LDAP URL:

```
AuthLDAPURL "ldaps://ldapserv1.biochem.mpg.de:636/dc=biochem,dc=mpg,dc=de?uid?sub?(objectClass=posixAccount)"
```

**2) Invalid command 'LDAPTLS_CACERTDIR'**

Cause:

`LDAPTLS_CACERTDIR` is **not** an Apache directive.

Fix:

Remove from Apache config. Put TLS trust in `/etc/ldap/ldap.conf` instead.

**3) ldap_simple_bind() failed: Can't contact LDAP server**

Fix:

1. Check port:

```
nc -vz ldapserv1.biochem.mpg.de 636
```

2. Test TLS bypass:

```
LDAPTLS_REQCERT=never ldapsearch -x -H ldaps://ldapserv1.biochem.mpg.de:636 \
  -b "dc=biochem,dc=mpg,dc=de" "(uid=USER)" mail
```

3. Fix `/etc/ldap/ldap.conf`:

```
TLS_CACERTDIR /etc/ssl/certs
```

**4) LDAPTrustedGlobalCert error**

Symptoms:

```
LDAPTrustedGlobalCert cannot occur within <VirtualHost> section
```

Fix:

Move it to a global Apache config or comment it out (if not needed).

### C) Admin access in LDAP mode

**Problem**

Local login is disabled when `AUTH_MODE=ldap`, so the built‑in `admin` user cannot log in.

**Fix**

Promote the LDAP user in SQLite.

**Option 1: Pre‑create the user as admin (before first login)**

```
sudo -u shiny sqlite3 /srv/shiny-server/sequencing-app/sequencing_projects.db \
"INSERT OR IGNORE INTO users (username, is_admin) VALUES ('soyer', 1);"
```

If the user row does **not** insert, the table likely has `NOT NULL` columns (e.g., `password`, `email`). In that case use:

```
sudo -u shiny sqlite3 /srv/shiny-server/sequencing-app/sequencing_projects.db \
"INSERT OR IGNORE INTO users (username, password, email, is_admin) VALUES ('soyer', 'ldap-only', 'soyer@biochem.mpg.de', 1);"
```

**Option 2: Promote after first login**

```
sudo -u shiny sqlite3 /srv/shiny-server/sequencing-app/sequencing_projects.db \
"UPDATE users SET is_admin=1 WHERE username='soyer';"
```

If the user already exists and you want to update email at the same time, use:

```
sudo -u shiny sqlite3 /srv/shiny-server/sequencing-app/sequencing_projects.db \
"UPDATE users SET is_admin=1, email='soyer@biochem.mpg.de' WHERE username='soyer';"
```

**Verify**

```
sudo -u shiny sqlite3 /srv/shiny-server/sequencing-app/sequencing_projects.db \
"SELECT username, is_admin FROM users WHERE username IN ('yeroslaviz','soyer');"
```

### D) SQLite quick reference (inspect DB structure)

**Show all tables**

```
sudo -u shiny sqlite3 /srv/shiny-server/sequencing-app/sequencing_projects.db ".tables"
```

**Show table schema**

```
sudo -u shiny sqlite3 /srv/shiny-server/sequencing-app/sequencing_projects.db \
"PRAGMA table_info(users);"
```

**Show full CREATE statement**

```
sudo -u shiny sqlite3 /srv/shiny-server/sequencing-app/sequencing_projects.db \
".schema users"
```

**Preview rows**

```
sudo -u shiny sqlite3 /srv/shiny-server/sequencing-app/sequencing_projects.db \
"SELECT username, email, is_admin FROM users LIMIT 20;"
```

### E) Switching between LDAP and local auth

**LDAP mode**

```
sudo systemctl edit shiny-server
```

```
[Service]
Environment=AUTH_MODE=ldap
Environment=LDAP_URI=ldaps://ldapserv1.biochem.mpg.de:636,ldaps://ldapserv2.biochem.mpg.de:636,ldaps://ldapserv3.biochem.mpg.de:636
Environment=LDAP_BASE_DN=dc=biochem,dc=mpg,dc=de
```

**Local mode**

```
[Service]
Environment=AUTH_MODE=local
```

Apply changes:

```
sudo systemctl restart shiny-server
sudo systemctl show shiny-server --property=Environment
```

### F) Apache proxy issues

**1) `/sequencing-app/` returns 404**

Symptoms:

- `curl -Ik -u USER https://host/sequencing-app/` returns 404
- `curl -I http://localhost:3838/sequencing-app/` returns 200

Cause:

Conflicting `ProxyPass /` rules or backup config files in `sites-enabled`.

Fix:

1. Ensure only these lines are active:

```
ProxyPass /sequencing-app/ http://localhost:3838/sequencing-app/
ProxyPassReverse /sequencing-app/ http://localhost:3838/sequencing-app/
```

2. Remove or move backup files from `/etc/apache2/sites-enabled`.

3. Restart Apache:

```
sudo apache2ctl -t
sudo systemctl restart apache2
```

**2) Redirect to `/` shows "No UI defined"**

Cause:

Root path is not proxied correctly.

Fix:

Use `/sequencing-app/` as the app path and update redirects accordingly.

### G) Shiny app issues

**1) App works locally but fails via Apache**

Check:

- Apache logs for LDAP errors
- Shiny logs for app startup errors

**2) LDAP mode enabled but no user**

Cause:

Shiny does not receive a user identity.

Fix:

- Use `/sequencing-app/?auth_user=<user>` redirect fallback.
- Confirm redirect works with `curl -Ik -u USER https://host/`.

**3) Missing environment variables in Shiny**

Check:

```
sudo systemctl show shiny-server --property=Environment
```

Restart after changes:

```
sudo systemctl restart shiny-server
```

### H) Deployment issues

**1) Deploy script ran but app unchanged**

Fix:

- Verify `deploy.sh` ran successfully.
- Confirm files in `/srv/shiny-server/sequencing-app/` updated.

**2) Database overwritten**

Fix:

- Ensure `deploy.sh` excludes `sequencing_projects.db`.
- Keep `*.db` ignored in git.

### I) LDAP deploy smoke tests and redirect/auth troubleshooting

#### 1) Run deploy with built-in smoke tests

Run on VM:

```bash
cd ~/BCFNGS-project-management
./deploy.sh
```

What `deploy.sh` now validates after restart:

- `/sequencing-app/` returns `302` to canonical `?auth_user=<authenticated-user>`
- tampered `?auth_user=other` is rewritten to authenticated user (`302`)
- final app response after redirects is `200`

Notes:

- `deploy.sh` syncs app code only. Apache config (`01-main.conf`) must still be copied/reloaded separately when changed.
- Script exits non-zero on smoke-test failures and prints remediation hints.

#### 2) Non-interactive deploy test options

```bash
LDAP_TEST_USER="yeroslaviz-test" LDAP_TEST_PASSWORD="YOUR_PASSWORD" ./deploy.sh
```

```bash
SKIP_SMOKE_TEST=1 ./deploy.sh
```

```bash
PUBLIC_BASE_URL="https://ngs-testing-vm.biochem.mpg.de" ./deploy.sh
```

#### 3) Required shiny-server environment

```bash
sudo systemctl show shiny-server --property=Environment
```

Must include:

- `AUTH_MODE=ldap`
- `TRUST_PROXY_AUTH_USER_QUERY=1`

If missing:

```bash
sudo systemctl edit shiny-server
sudo systemctl daemon-reload
sudo systemctl restart shiny-server
```

#### 4) Manual validation curls (reference)

```bash
curl -ki -u yeroslaviz-test "https://ngs-testing-vm.biochem.mpg.de/sequencing-app/" | sed -n '1,20p'
```

Expected:

- `HTTP/1.1 302 Found`
- `Location: .../sequencing-app/?auth_user=yeroslaviz-test`

```bash
curl -ki -u yeroslaviz-test "https://ngs-testing-vm.biochem.mpg.de/sequencing-app/?auth_user=yeroslaviz" | sed -n '1,20p'
```

Expected:

- `HTTP/1.1 302 Found`
- `Location: .../sequencing-app/?auth_user=yeroslaviz-test`

```bash
curl -k -L -u yeroslaviz-test -o /dev/null -s -w "%{http_code}\n" "https://ngs-testing-vm.biochem.mpg.de/sequencing-app/"
```

Expected:

- `200`

#### 5) Symptom-specific fixes

**A) `ERR_TOO_MANY_REDIRECTS`**

Cause:

- rewrite loop in Apache auth-user canonicalization.

Fix:

```bash
sudo cp ~/BCFNGS-project-management/01-main.conf /etc/apache2/sites-available/01-main.conf
sudo ln -sf /etc/apache2/sites-available/01-main.conf /etc/apache2/sites-enabled/01-main.conf
sudo apache2ctl configtest
sudo systemctl restart apache2
sudo systemctl restart shiny-server
```

Then rerun section I.4 curl checks.

**B) `LDAP mode enabled but no authenticated user found` (falls back to local page)**

Cause:

- LDAP mode active, but proxy-trust/query fallback not fully configured.

Fix:

1. Verify section I.3 environment values.
2. Ensure Apache canonicalizes `auth_user` to `REMOTE_USER` and reload Apache.

**C) `Disconnected from the server. Reload`**

Possible causes:

- Shiny worker terminated/restarted.
- Proxy/websocket routing issue.

Checks:

```bash
sudo journalctl -u shiny-server -n 200 --no-pager
sudo tail -n 200 /var/log/shiny-server/$(sudo ls -t /var/log/shiny-server | head -n 1)
sudo tail -n 200 /var/log/apache2/sequencing-app-ssl-error.log
```

And verify modules:

```bash
sudo apache2ctl -M | egrep 'headers_module|rewrite_module|proxy_module|proxy_http_module|proxy_wstunnel_module|ldap_module|authnz_ldap_module'
```

**D) User impersonation via query string**

Expected secure behavior:

- If user tampers `?auth_user=someone-else`, Apache rewrites it back to the authenticated LDAP user.

If not:

- Re-apply `01-main.conf` from repo and restart Apache + Shiny (section I.5A).

#### 6) Certificate warning note

If Apache restart logs:

- `AH01909: server certificate does NOT include an ID which matches the server name`

This is a certificate/SAN hostname warning and not the root cause of LDAP redirect/auth-user logic.

### Quick validation commands

```
# Apache
sudo apache2ctl -t
sudo apache2ctl -S

# LDAP
ldapsearch -x -H ldaps://ldapserv1.biochem.mpg.de:636 \
  -b "dc=biochem,dc=mpg,dc=de" "(uid=USER)" mail

# App (proxy)
curl -Ik -u USER https://ngs-testing-vm.biochem.mpg.de/sequencing-app/

# App (backend)
curl -I http://localhost:3838/sequencing-app/
```

### References

- `notes/ubuntu-bare-server-setup-howto.md`
- `notes/vm-rollout-summary-2026-02-09.md`
