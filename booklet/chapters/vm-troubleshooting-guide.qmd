---
title: "VM Troubleshooting Guide"
execute:
  eval: false
---

## VM Troubleshooting Guide (GitHub, LDAP, Apache, Shiny)

This checklist covers the most common issues we hit and how to fix them quickly.

### AI session restart (quick resume)

If I need to resume work in a new AI session, I point it to:

1. `Server_preparations.qmd` for the current state and validation.
2. `notes/sql-handling.qmd` for DB operations and maintenance.
3. `notes/ubuntu-bare-server-setup-howto.qmd` for the full setup flow.

### A) Git / GitHub sync problems

**1) Permission denied (publickey)**

Symptoms:

- `git@github.com: Permission denied (publickey)`
- `fatal: Could not read from remote repository`

Fix:

1. Verify SSH auth:

```
ssh -T git@github.com
```

2. Confirm repo URL:

```
git remote -v
```

3. Ensure the correct SSH key is loaded (or add it to `~/.ssh/config`).

**2) Divergent branches during pull**

Symptoms:

```
fatal: Need to specify how to reconcile divergent branches.
```

Fix:

```
git config pull.rebase false
# or git config pull.rebase true
```

**3) Local changes block pull**

Symptoms:

```
error: Your local changes ... would be overwritten by merge
```

Fix:

```
git stash push -m "vm local changes"
git pull origin main
git stash pop
```

Resolve conflicts if they appear.

**4) Merge conflict in config files**

Fix options:

```
# Keep repo version
git checkout --ours <file>

# Keep local version
git checkout --theirs <file>
```

**5) Untracked files in the VM**

Symptoms:

```
?? sequencing-app/test_detailed.R
```

Fix:

- Ignore, delete, or add to `.gitignore`.

### B) Apache / LDAP authentication issues

**1) Apache wonâ€™t restart after LDAP change**

Symptoms:

```
AH00526: Syntax error ... Bad LDAP URL while parsing.
```

Fix:

Use a single, complete LDAP URL:

```
AuthLDAPURL "ldaps://ldapserv1.biochem.mpg.de:636/dc=biochem,dc=mpg,dc=de?uid?sub?(objectClass=posixAccount)"
```

**2) Invalid command 'LDAPTLS_CACERTDIR'**

Cause:

`LDAPTLS_CACERTDIR` is **not** an Apache directive.

Fix:

Remove from Apache config. Put TLS trust in `/etc/ldap/ldap.conf` instead.

**3) ldap_simple_bind() failed: Can't contact LDAP server**

Fix:

1. Check port:

```
nc -vz ldapserv1.biochem.mpg.de 636
```

2. Test TLS bypass:

```
LDAPTLS_REQCERT=never ldapsearch -x -H ldaps://ldapserv1.biochem.mpg.de:636 \
  -b "dc=biochem,dc=mpg,dc=de" "(uid=USER)" mail
```

3. Fix `/etc/ldap/ldap.conf`:

```
TLS_CACERTDIR /etc/ssl/certs
```

**4) LDAPTrustedGlobalCert error**

Symptoms:

```
LDAPTrustedGlobalCert cannot occur within <VirtualHost> section
```

Fix:

Move it to a global Apache config or comment it out (if not needed).

### C) SQL handling (moved)

All SQL database commands and explanations were moved to **`notes/sql-handling.qmd`**.  
This includes admin promotion in LDAP mode, SQLite inspection commands, and budget holder updates.

### D) Switching between LDAP and local auth

**LDAP mode**

```
sudo systemctl edit shiny-server
```

```
[Service]
Environment=AUTH_MODE=ldap
Environment=LDAP_URI=ldaps://ldapserv1.biochem.mpg.de:636,ldaps://ldapserv2.biochem.mpg.de:636,ldaps://ldapserv3.biochem.mpg.de:636
Environment=LDAP_BASE_DN=dc=biochem,dc=mpg,dc=de
```

**Local mode**

```
[Service]
Environment=AUTH_MODE=local
```

Apply changes:

```
sudo systemctl restart shiny-server
sudo systemctl show shiny-server --property=Environment
```

### F) Apache proxy issues

**1) `/sequencing-app/` returns 404**

Symptoms:

- `curl -Ik -u USER https://host/sequencing-app/` returns 404
- `curl -I http://localhost:3838/sequencing-app/` returns 200

Cause:

Conflicting `ProxyPass /` rules or backup config files in `sites-enabled`.

Fix:

1. Ensure only these lines are active:

```
ProxyPass /sequencing-app/ http://localhost:3838/sequencing-app/
ProxyPassReverse /sequencing-app/ http://localhost:3838/sequencing-app/
```

2. Remove or move backup files from `/etc/apache2/sites-enabled`.

3. Restart Apache:

```
sudo apache2ctl -t
sudo systemctl restart apache2
```

**2) Redirect to `/` shows "No UI defined"**

Cause:

Root path is not proxied correctly.

Fix:

Use `/sequencing-app/` as the app path and update redirects accordingly.

### G) Shiny app issues

**1) App works locally but fails via Apache**

Check:

- Apache logs for LDAP errors
- Shiny logs for app startup errors

**2) LDAP mode enabled but no user**

Cause:

Shiny does not receive a user identity.

Fix:

- Use `/sequencing-app/?auth_user=<user>` redirect fallback.
- Confirm redirect works with `curl -Ik -u USER https://host/`.

**3) Missing environment variables in Shiny**

Check:

```
sudo systemctl show shiny-server --property=Environment
```

Restart after changes:

```
sudo systemctl restart shiny-server
```

### H) Deployment issues

**1) Deploy script ran but app unchanged**

Fix:

- Verify `deploy.sh` ran successfully.
- Confirm files in `/srv/shiny-server/sequencing-app/` updated.

**2) Database overwritten**

Fix:

- Ensure `deploy.sh` excludes `sequencing_projects.db`.
- Keep `*.db` ignored in git.

### Quick validation commands

```
# Apache
sudo apache2ctl -t
sudo apache2ctl -S

# LDAP
ldapsearch -x -H ldaps://ldapserv1.biochem.mpg.de:636 \
  -b "dc=biochem,dc=mpg,dc=de" "(uid=USER)" mail

# App (proxy)
curl -Ik -u USER https://ngs-testing-vm.biochem.mpg.de/sequencing-app/

# App (backend)
curl -I http://localhost:3838/sequencing-app/
```

### References

- `Server_preparations.qmd`
- `notes/sql-handling.qmd`
- `notes/ubuntu-bare-server-setup-howto.qmd`
