---
title: "VM Rollout Summary (2026-02-09)"
execute:
  eval: false
---

## VM Rollout Summary (2026-02-09)

**Scope**

Validated the full LDAP-authenticated Shiny app rollout on the VM, fixed Apache proxy conflicts, and confirmed user mapping + email routing behavior.

**What changed**

1. Apache vhost now proxies the app under `/sequencing-app/` and redirects the root URL to `/sequencing-app/?auth_user=<LDAP user>`.
2. Removed a conflicting backup Apache config from `sites-enabled` that was overriding proxy rules.
3. Quieted Apache LDAP logging by default and kept debug logging opt-in only.
4. Restricted LDAP debug output in the Shiny app to `APP_ENV=dev` and `LDAP_DEBUG=1`.
5. Expanded documentation with VM validation notes and a comprehensive error-checking checklist.

**Key VM actions**

1. Verified LDAP prompt and redirect behavior with `curl` and a real browser login.
2. Confirmed the app is reachable at `http://localhost:3838/sequencing-app/` and via Apache at `https://ngs-testing-vm.biochem.mpg.de/sequencing-app/`.
3. Removed backup Apache config from `/etc/apache2/sites-enabled/` to eliminate conflicting `ProxyPass /` rules.
4. Restarted Apache after each config change and validated with `apache2ctl -t`.

**Validation results**

1. LDAP login prompt appears and redirects to `/sequencing-app/?auth_user=<user>`.
2. `yeroslaviz` is mapped to Cox and the correct PI.
3. `yeroslaviz-test` (OU = NGS Facility) is treated as service group (no PI match).
4. Email routing works for both cases (PI + NGS for research groups; admin fallback for service groups).
5. Project creation works with LDAP-authenticated users.

**Notes and decisions**

1. The Shiny app does not reliably receive custom headers from Apache, so the query parameter fallback remains the most reliable method.
2. Apache must not parse backup configs inside `/etc/apache2/sites-enabled`.
3. LDAP debug logging is kept off in production to avoid noisy logs.

**AI handoff snapshot (use this to resume later)**

1. Repo: `/home/yeroslaviz/BCFNGS-project-management` on the VM and `/Users/yeroslaviz/Documents/Github/BCFNGS-project-management` locally.
2. App path on VM: `/srv/shiny-server/sequencing-app/` (Shiny server `site_dir`).
3. Apache vhost in use: `/etc/apache2/sites-enabled/01-main.conf` (copied from repo root `01-main.conf`).
4. Proxy rules in the active vhost: `/sequencing-app/` is proxied to `http://localhost:3838/sequencing-app/` and the root `/` redirects to `/sequencing-app/?auth_user=<REMOTE_USER>`.
5. LDAP auth is enabled in Apache with `AuthLDAPURL` pointing to `ldaps://ldapserv1.biochem.mpg.de:636/dc=biochem,dc=mpg,dc=de?uid?sub?(objectClass=posixAccount)`.
6. LDAP trust is configured in `/etc/ldap/ldap.conf` with `TLS_CACERTDIR /etc/ssl/certs` (typo fixed earlier).
7. Shiny env vars (production): `AUTH_MODE=ldap`, `LDAP_URI=ldaps://ldapserv1...`, `LDAP_BASE_DN=dc=biochem,dc=mpg,dc=de`.
8. Debug is opt-in only: set `APP_ENV=dev` and `LDAP_DEBUG=1` to enable debug logs in Shiny.
9. Validation checks succeeded: `curl -Ik https://HOST/` returns 401, `curl -Ik -u USER https://HOST/` returns 302 to `/sequencing-app/?auth_user=USER`, and `curl -Ik -u USER https://HOST/sequencing-app/` returns 200.
10. User mapping and email routing are confirmed working for both a research group user and a service group user.
11. Admin access in LDAP mode is done by promoting LDAP users in SQLite (see `Server_preparations.qmd` and `notes/vm-troubleshooting-guide.md`).
12. Auth mode switching is done via `systemctl edit shiny-server` by changing `AUTH_MODE` (LDAP vs local) and restarting the service.

**AI restart recipe**

1. Read this file plus `notes/ubuntu-bare-server-setup-howto.md` and `notes/vm-troubleshooting-guide.md`.
2. On VM, confirm Apache config with `sudo apache2ctl -S` and proxy rules with `sudo grep -n "ProxyPass" -R /etc/apache2/sites-enabled /etc/apache2/conf-enabled`.
3. Confirm Shiny env vars with `sudo systemctl show shiny-server --property=Environment`.
4. Re-run the validation `curl` commands listed above to confirm the flow.

**References**

- `notes/ubuntu-bare-server-setup-howto.md`
- `notes/vm-troubleshooting-guide.md`
