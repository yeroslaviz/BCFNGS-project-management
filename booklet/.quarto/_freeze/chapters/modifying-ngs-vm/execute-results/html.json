{
  "hash": "ed63b5d2613c4cbec695b7d83e96bab2",
  "result": {
    "engine": "jupyter",
    "markdown": "---\ntitle: \"Modifying NGS-VM\"\nexecute:\n  eval: false\n---\n\n## Background\n\nin our NGS-VM we need some intensive modifications. \n\nWe would like to clean it a bit and remove projects we dont need anymore, as well as add new projects. \n\nMore important we would like to be able to add a cost estimation, calculation of the costs per samples. Each time, a project is created, an email with this cost etimation will be sned to the use/supervisor. \n\n\nThe NGS-VM contains a DB created mit PostgreSQL. We have multiple tables in there with dependencies between them. In order for me to be able to add information I need to understand a lot more SQL. \n\nFor that we created a backup VM, called ngs-testing. It is identical to the original VM, just fewer projects, as it is not being updated each time. \n\nWeb page for original VM - [https://ngs-vm.biochem.mpg.de/information.cgi](https://ngs-vm.biochem.mpg.de/information.cgi).\nThe back VM can be reached via [https://ngs-testing-vm.biochem.mpg.de/admin.cgi](https://ngs-testing-vm.biochem.mpg.de/admin.cgi)\n\nBoth machines can be logged-in directly via ssh\n\n```{bash}\n\nssh yeroslaviz@ngs-testing-vm.biochem.mpg.de\n\n```\n\nThis is a clone of the original machine. The clone was done on 11 March 2025.\n\n\n## The GUI\n\nto see which data base the GUI is accessing, I can call for the apache2' config file under \n` /etc/apache2/sites-available/auth_ldap.conf`\n\n```\n LDAPConnectionTimeout 3\n LDAPTimeout 10\n\n<Directory /www/mpiseq2/web>\n#<Directory /var/www/html/auth-ldap>\n    SSLRequireSSL\n#    AuthName \"LDAP Authentication Example\"\n    AuthName \"LDAP Authentication\"\n    AuthType Basic\n    AuthBasicProvider ldap\n    AuthLDAPURL \"ldaps://ldapserv1.biochem.mpg.de ldapserv2.biochem.mpg.de ldapserv3.biochem.mpg.de/dc=biochem,dc=mpg,dc=de?uid?sub?(objectClass=posixAccount)\"\n    Require valid-user\n </Directory>\n/etc/apache2/sites-available/auth_ldap.conf (END)\n```\n\n\nHere all the files are listed:\n\n```{bash}\n$ ll /www/mpiseq2/web/\ntotal 208\ndrwxr-xr-x 9 letunic b_mcf  4096 Mar  3 08:57 ./\ndrwxr-xr-x 9 letunic b_mcf  4096 Oct  4  2022 ../\n-rwxr-xr-x 1 letunic b_mcf  1368 Oct  4  2022 404.cgi*\n-rwxr-xr-x 1 letunic b_mcf  1434 Oct  4  2022 505.cgi*\n-rwxr-xr-x 1 letunic b_mcf  1139 Oct  4  2022 about.cgi*\n-rwxr-xr-x 1 letunic b_mcf  1862 Oct  4  2022 account.cgi*\n-rwxr-xr-x 1 letunic b_mcf  2839 Oct  4  2022 addProjectFile.cgi*\ndrwxr-xr-x 2 letunic b_mcf  4096 Apr 28  2023 admin/\n-rwxr-xr-x 1 letunic b_mcf  7494 Oct  4  2022 admin.cgi*\ndrwxr-xr-x 2 letunic b_mcf  4096 Apr 28  2023 ajax/\n-rwxr-xr-x 1 letunic b_mcf  2182 Oct  4  2022 barcodeIDlist.cgi*\ndrwxr-xr-x 2 letunic b_mcf  4096 Oct  4  2022 css/\n-rwxr-xr-x 1 letunic b_mcf 10019 Apr 28  2023 dataRelease.cgi*\n-rwxr-xr-x 1 letunic b_mcf 21653 Jun 10  2024 demultiplex.cgi*\n-rwxr-xr-x 1 letunic b_mcf  1163 Oct  4  2022 downloadSampleSheet.cgi*\n-rwxr-xr-x 1 letunic b_mcf 12203 Oct  4  2022 genome_mapping.cgi*\n-rwxr-xr-x 1 letunic b_mcf  3354 Mar  3 08:57 help.html*\ndrwxr-xr-x 2 letunic b_mcf  4096 Oct  4  2022 img/\n-rwxr-xr-x 1 letunic b_mcf  1967 Oct  4  2022 index.cgi*\n-rwxr-xr-x 1 letunic b_mcf   963 Oct  4  2022 information.cgi*\ndrwxr-xr-x 3 letunic b_mcf  4096 Jan 23 13:40 js/\n-rwxr-xr-x 1 letunic b_mcf  5350 Oct  4  2022 login.cgi*\ndrwxr-xr-x 2 letunic b_mcf  4096 Oct  4  2022 metadata/\n-rwxr-xr-x 1 letunic b_mcf 10681 Oct  4  2022 processAdminSamplesFile.cgi*\n-rwxr-xr-x 1 letunic b_mcf 16152 Oct  4  2022 processSamplesFile.cgi*\n-rwxr-xr-x 1 letunic b_mcf 10213 Oct 11  2022 projectAdmin.cgi*\n-rwxr-xr-x 1 letunic b_mcf  8097 Oct  4  2022 projectDetails.cgi*\n-rwxr-xr-x 1 letunic b_mcf  7679 Feb  5 12:01 register.cgi*\ndrwxr-xr-x 2 letunic b_mcf  4096 Oct 17  2022 templates/\n-rwxr-xr-x 1 letunic b_mcf  1261 Oct  4  2022 t.pl*\n-rwxr-xr-x 1 letunic b_mcf  2263 Oct  4  2022 userDetails.cgi*\n-rwxr-xr-x 1 letunic b_mcf  1512 Oct  4  2022 viewProjectFile.cgi*\n```\n\n\nStarting t understand the DB structure\n\n### Change used database\n\nunder `/www/mpiseq2/lib/` the perl packages used for the tool are stored. \n\nhere we can see where the path to the DB is deifned. \n\n```\npackage mpiseqWWW;\n...\nuse strict;\nuse warnings;\nuse CGI;\nuse mpiseqGlobals;\nuse CGI::Session ( '-ip_match' );\n\nmy $base_dir = $mpiseqGlobals::base_dir;\nmy $session_dir = $mpiseqGlobals::session_dir;\n```\n\nand following that we look inside mpiseqGlobals\n\n```\npackage mpiseqGlobals;\n\nuse Exporter ();\n@ISA = qw(Exporter);\n\n@EXPORT = qw(\n    $base_dir\n    $session_dir\n    $session_name\n    $tree_root\n    $data_root\n    $project_files\n    $raw_sequence_root\n    $processed_sequence_root\n    $user_data_root\n    $data_release_step\n    $db_driver\n    $db_name\n    $db_host\n    $db_user\n    $db_port\n    $db_pass\n    $admin_email\n    $send_notifications\n    $ldap_server\n    $ldap_base\n    $bcl2fastq_bin\n    $fastqc_bin\n    $demultiplex_bin\n    $mapping_bin\n    $cpus\n    );\n\n\n#directories\n$base_dir = '/www/mpiseq2/web';\n\n#sequening data folders, for data release\n$raw_sequence_root = \"/fs/pool/pool-bcfngs/Raw_data/\";\n$processed_sequence_root = \"/fs/pool/pool-bcfngs/fastq_files/\";\n$user_data_root = \"/fs/pool/pool-dnaseq/user/\";\n#$user_data_root = \"/fs/pool/pool-dnaseq/\";\n```\n\n## modify specific tables\n\na  lot of information I can modify in the GUI. \n\nfor example the sample types I can change in the admin page \n\n![change sample type in the admin page](Figures/admin_change_sample_type.png)\n\nBy clicking on Edit, one can change any rows available.\n\nI want to add a column here with the costs per sample\n\n\nHOW?\n\n\n```{bash}\nALTER TABLE project.sample_type \nADD COLUMN costs integer NOT NULL DEFAULT 0;\n```\n\n\n### log in \n\n```{bash}\n\npsql -h 127.0.0.1 -p 5432 -U admin_user -d mpiseq2_db\npsql -h 127.0.0.1 -p 5432 -U letunic -d mpiseq2_db # gives sudo rights\n\nGRANT USAGE ON SCHEMA people, project TO admin_user;\n\n```\n\n\n## PostgreSQL commands\n\n```{bash}\n\n\\l # show list of data bases\n\n\\s # show history of command used inside the DB\n\n\\c mpiseq2_db # connect to a dabase\n\n\\dn: #Lists all Schemas in the database. \n\n\\dt project.* # lists all tables from the schema `project`\n\n\\d # show table structure ( column names)\n```\n\nTo show all information from a specific table we can use the following SQL command\n\n```{bash}\n\nSELECT * FROM people.lab\n\n```\n\n\n## Adding a sequencing platform\n\nin order for a new sequencing platform to be added we need to change the `js/mpiseq.js` file in the web/ folder\n\n```\n            {label: 'Sequencing platform', name: 'sequencing_platform' , type: 'select', options: [\n                    {label: 'NovaSeq 6000'},\n                    {label:'NextSeq 500'},\n                    {label:'Aviti'},\n                    {label:'Nanopore'}\n```\n\nThis already adds the needed machine in the UI on the web page.\n\nto see how many projects were used which machine, one can look in the SQL DB\n\n```{bash}\n# Check distinct values currently in the database\nSELECT DISTINCT sequencing_platform, COUNT(*)\nFROM project.project\nGROUP BY sequencing_platform\nORDER BY COUNT(*) DESC;\n\n```\n\n```\n sequencing_platform | count\n---------------------+-------\n Aviti               |    31\n New Sequencer       |    24\n NextSeq 500         |    55\n NovaSeq 6000        |   287\n                     |   406\n```\n\nI want to manually change netries in the DB. For example Now, I need to change the sequencing platform for two projects\n\n```{bash}\n SELECT id, sequencing_platform\nFROM project.project\nWHERE id IN ('985', '986');\n```\n\n```\n id  | sequencing_platform\n-----+---------------------\n 985 | NextSeq 500\n 986 | NovaSeq 6000\n ```\n\nBut both these projects are Nanopore.\n\nSo we need to cahnge the entries in the DB\n\n\n```{bash}\n-- Using transaction for safety\nBEGIN;\n\nUPDATE project.project \nSET sequencing_platform = 'Nanopore' \nWHERE id IN ('985', '986');\n\n-- Verify the changes\nSELECT id, sequencing_platform, sequencing_kit\nFROM project.project \nWHERE id IN ('985', '986');\n\n-- If everything looks correct, commit\nCOMMIT;\n\n-- If something looks wrong, rollback instead:\n-- ROLLBACK;\n```\n\n\n```{bash}\n-- Using transaction for safety\nBEGIN;\n\nUPDATE project.project \nSET sequencing_kit = 'ONT' \nWHERE id IN ('985', '986');\n\n-- Verify the changes\nSELECT id, sequencing_platform, sequencing_kit\nFROM project.project \nWHERE id IN ('985', '986');\n\n-- If everything looks correct, commit\nCOMMIT;\n\n-- If something looks wrong, rollback instead:\n-- ROLLBACK;\n\n```\n\n",
    "supporting": [
      "modifying-ngs-vm_files"
    ],
    "filters": [],
    "includes": {}
  }
}