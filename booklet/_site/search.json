[
  {
    "objectID": "index.html#how-to-render",
    "href": "index.html#how-to-render",
    "title": "NGS Sequencing App Ops Booklet",
    "section": "0.1 How to render",
    "text": "0.1 How to render\nRender the entire booklet (all pages):\npython3 booklet/update_book_sources.py\nquarto render booklet/"
  },
  {
    "objectID": "index.html#sources",
    "href": "index.html#sources",
    "title": "NGS Sequencing App Ops Booklet",
    "section": "0.2 Sources",
    "text": "0.2 Sources\nThe book chapters are generated from these source files:\n\nQuick Start (How to run the app)\nServer Preparations\nLDAP Setup Summary (2026-02-06)\nSQL Handling\nVM Troubleshooting Guide\nUbuntu Bare Server Setup HOWTO"
  },
  {
    "objectID": "chapters/quick-start.html",
    "href": "chapters/quick-start.html",
    "title": "2  Quick Start (How to run the app)",
    "section": "",
    "text": "2.0.1 Quick Start (How to run the app)\n\n2.0.1.1 Local dev — local mode\nSys.setenv(APP_ENV = \"dev\", AUTH_MODE = \"local\")\nshiny::runApp(\"sequencing-app\")\n\n\n2.0.1.2 Local dev — LDAP simulation\nSys.setenv(\n  APP_ENV = \"dev\",\n  AUTH_MODE = \"ldap\",\n  DEV_REMOTE_USER = \"your_username\",\n  LDAP_URI = \"ldaps://ldapserv1.biochem.mpg.de:636,ldaps://ldapserv2.biochem.mpg.de:636,ldaps://ldapserv3.biochem.mpg.de:636\",\n  LDAP_BASE_DN = \"dc=biochem,dc=mpg,dc=de\"\n)\nshiny::runApp(\"sequencing-app\")\n\n\n2.0.1.3 Local dev — unset\nSys.unsetenv(c(\n  \"APP_ENV\",\"AUTH_MODE\",\"DEV_REMOTE_USER\",\n  \"LDAP_BIND_DN\",\"LDAP_BIND_PW\",\n  \"LDAP_URI\",\"LDAP_BASE_DN\",\"LDAP_DEBUG\"\n))\n\n\n2.0.1.4 VM — LDAP mode (production)\nsudo systemctl edit shiny-server\n[Service]\nEnvironment=AUTH_MODE=ldap\nEnvironment=LDAP_URI=ldaps://ldapserv1.biochem.mpg.de:636,ldaps://ldapserv2.biochem.mpg.de:636,ldaps://ldapserv3.biochem.mpg.de:636\nEnvironment=LDAP_BASE_DN=dc=biochem,dc=mpg,dc=de\nsudo systemctl restart shiny-server\n\n\n2.0.1.5 VM — local mode (maintenance)\n[Service]\nEnvironment=AUTH_MODE=local\nsudo systemctl restart shiny-server\n\n\n2.0.1.6 VM — unset (clear overrides)\nsudo systemctl edit shiny-server\n# remove AUTH_MODE/LDAP_* lines, save, then:\nsudo systemctl restart shiny-server"
  },
  {
    "objectID": "chapters/server-preparations.html#server-infrastructure",
    "href": "chapters/server-preparations.html#server-infrastructure",
    "title": "3  Server Preparations",
    "section": "3.1 Server Infrastructure",
    "text": "3.1 Server Infrastructure\n\n3.1.1 SQL handling (moved)\nAll SQL database commands and explanations were moved to notes/sql-handling.qmd.\nThis includes:\n\nDB rebuild procedure\nAdmin user promotion in LDAP mode\nBudget holder updates (CSV vs DB)\nSQLite inspection and maintenance commands ### Install required system dependencies\n\n\n\nCode\n\nsudo apt install -y libssl-dev libxml2-dev libcurl4-openssl-dev libudunits2-dev libgdal-dev\n\n\n\n\n3.1.2 Changing hostname to fit the apache2 config file\n\n\nCode\n\n# Change the hostname\nsudo hostnamectl set-hostname ngs-testing-vm.biochem.mpg.de\n\n# Verify the change\nhostnamectl status\n\n\n\n\nCode\nnslookup ngs-testing-vm.biochem.mpg.de\nping ngs-testing-vm.biochem.mpg.de\n\n\nServer:     127.0.0.53\nAddress:    127.0.0.53#53\n\nNon-authoritative answer:\nName:   ngs-testing-vm.biochem.mpg.de\nAddress: 10.33.0.60\n\nPING ngs-testing-vm.biochem.mpg.de (10.33.0.60) 56(84) bytes of data.\n64 bytes from ngs-testing-vm.biochem.mpg.de (10.33.0.60): icmp_seq=1 ttl=64 time=0.079 ms\n64 bytes from ngs-testing-vm.biochem.mpg.de (10.33.0.60): icmp_seq=2 ttl=64 time=0.074 ms\n\n\nCode\n\nsudo systemctl restart apache2\n\n\n\n\n3.1.3 Automatic start-up\n\n\nCode\n\nsudo systemctl enable apache2\nsudo systemctl enable shiny-server"
  },
  {
    "objectID": "chapters/server-preparations.html#monitoring",
    "href": "chapters/server-preparations.html#monitoring",
    "title": "3  Server Preparations",
    "section": "3.2 Monitoring",
    "text": "3.2 Monitoring\nThe shiny app server writes log files specific with date and time in the /var/log/shiny-server folder.\n\n\nCode\n\n# Monitor Shiny Server logs\nsudo tail -f /var/log/shiny-server/sequencing-app*.log\n\n# Monitor Apache logs\nsudo tail -f /var/log/apache2/sequencing-app-error.log"
  },
  {
    "objectID": "chapters/server-preparations.html#regular-backups",
    "href": "chapters/server-preparations.html#regular-backups",
    "title": "3  Server Preparations",
    "section": "3.3 Regular backups",
    "text": "3.3 Regular backups\nThe VM is regularly back-up every night. The SQL database backup setting are in the script, but for now commented out, as we’re not in productive version.\n\n3.3.1 cron job for data base backup\nIf needed, we can also set up a cron job to backup the data base\n\n\nCode\n\n# Create backup script\nsudo tee /usr/local/bin/backup_sequencing_db.sh &lt;&lt;'EOF'\n#!/bin/bash\nTIMESTAMP=$(date +%Y%m%d_%H%M%S)\nBACKUP_DIR=\"/var/backups/sequencing-app\"\nmkdir -p $BACKUP_DIR\ncp /srv/shiny-server/sequencing-app/sequencing_projects.db $BACKUP_DIR/sequencing_projects.db.$TIMESTAMP\n# Keep only last 30 days of backups\nfind $BACKUP_DIR -name \"sequencing_projects.db.*\" -mtime +30 -delete\nEOF\n\nsudo chmod +x /usr/local/bin/backup_sequencing_db.sh\n\n# Add to crontab for daily backups at 2 AM\nsudo crontab -l | { cat; echo \"0 2 * * * /usr/local/bin/backup_sequencing_db.sh\"; } | sudo crontab -"
  },
  {
    "objectID": "chapters/server-preparations.html#required-server-setup",
    "href": "chapters/server-preparations.html#required-server-setup",
    "title": "3  Server Preparations",
    "section": "3.4 Required Server Setup",
    "text": "3.4 Required Server Setup\n/srv/shiny-server/\n├── sequencing-app/\n│ ├── app.R\n│ ├── setup_database.R\n│ ├── sequencing_projects.db\n│ └── www/\n  │ ├── logo.png\n  │ └── minerva.png"
  },
  {
    "objectID": "chapters/server-preparations.html#github-repository",
    "href": "chapters/server-preparations.html#github-repository",
    "title": "3  Server Preparations",
    "section": "3.5 Github repository",
    "text": "3.5 Github repository\n\n3.5.1 Step 1: Generate SSH keys\n\n\nCode\n\n# on the local machine (mac mini at work!!!)\ncd ~/.ssh/\nssh-keygen -t ed25519 -C \"yeroslaviz@biochem.mpg.de\" -f ngs-testing-vm.id_macMini_rsa\n\n# on the VM\ncd ~/.ssh/\nssh-keygen -t ed25519 -C \"yeroslaviz@biochem.mpg.de\" -f ngs-testing-vm.id_rsa\n\n\nIf agent needs to be activated\n\n\nCode\neval \"$(ssh-agent -s)\"\nssh-add ~/.ssh/ngs-testing-vm.id_rsa # or the name of the local key\n\n\n\n\n3.5.2 Add both keys to the github repository\nCopy for each of the two keys the *pub version and add it under Settings → SSH and GPG keys → New SSH key.\n\n\n3.5.3 Make sure we clone using ssh (not html)\nFirst test if the connection exists already.\n\n\nCode\ngit remote -v\n\n\nIf the result is\norigin  https://github.com/username/repository.git (fetch)\norigin  https://github.com/username/repository.git (push)\nit must be changed to ssh\n\n\nCode\ngit remote set-url origin git@github.com:username/repository.git\n\n\nIf we see\norigin  git@github.com:yeroslaviz/BCFNGS-project-management.git (fetch)\norigin  git@github.com:yeroslaviz/BCFNGS-project-management.git (push)\nthen we already use ssh.\n\n\n3.5.4 Test and check the connection\n\n\nCode\nssh -T git@github.com\n\n\nthis should return something like\nHi yeroslaviz! You've successfully authenticated, but GitHub does not provide shell access.\n\n\n3.5.5 Pulling/Pushing\nthe repository can be managed from the path /home/yeroslaviz/BCFNGS-project-management (the VM path is mentioned here).\ninside the Folder we can pull/push the changes we made to the repo from the local computer (AT WORK!!!).\nthe github repository on the local computer is at /Users/yeroslaviz/Documents/Github/BCFNGS-project-management.\nTo redeploy the server, one follows the following steps:\n\nmake the changes on the local computer (AT WORK!!!).\ncommit and push the changes to the github repo\ngo to the folder /home/yeroslaviz/BCFNGS-project-management on the VM ngs-testing-vm and pull the changes.\nExecute the deploy.sh script to copy the new changes to the shiny-server folder and restart both apache2 and the shiny-server.\n\n\n\n3.5.6 Production rollout checklist (quick reference)\nThis is the short checklist I use on production. Details for each step are below in the VM rollout HOW‑TO section.\n\nConfirm GitHub access and pull latest code.\n\n\n\nCode\nssh -T git@github.com\ncd /home/yeroslaviz/BCFNGS-project-management\ngit pull origin main\n\n\n\nTake backups (app folder, SQLite DB, Apache config).\n\n\n\nCode\nsudo rsync -av /srv/shiny-server/sequencing-app/ /srv/shiny-server/sequencing-app.backup_$(date +%Y%m%d_%H%M)/\ncp /srv/shiny-server/sequencing-app/sequencing_projects.db \\\n  /srv/shiny-server/sequencing_projects.db.backup_$(date +%Y%m%d_%H%M)\nsudo cp /etc/apache2/sites-enabled/01-main.conf \\\n  /etc/apache2/sites-enabled/01-main.conf.backup_$(date +%Y%m%d_%H%M)\n\n\n\nDeploy.\n\n\n\nCode\n./deploy.sh\n\n\n\nRestart services.\n\n\n\nCode\nsudo systemctl restart shiny-server\nsudo systemctl restart apache2\n\n\n\nSmoke‑test login and app behavior.\n\n\n\nCode\ncurl -Ik https://ngs-testing-vm.biochem.mpg.de/\ncurl -Ik -u USER https://ngs-testing-vm.biochem.mpg.de/\ncurl -Ik -u USER https://ngs-testing-vm.biochem.mpg.de/sequencing-app/\n\n\n\nRoll back from backups if needed.\n\n\n\nCode\nsudo rsync -av --delete /srv/shiny-server/sequencing-app.backup_YYYYMMDD_HHMM/ /srv/shiny-server/sequencing-app/\nsudo systemctl restart shiny-server\nsudo systemctl restart apache2\n\n\n\n\n3.5.7 VM rollout HOW‑TO (Git + deploy + safety)\nThis is the repeatable checklist I use when rolling out to a VM (first ngs-testing-vm, then ngs-vm).\n\n3.5.7.1 1) Make sure GitHub access works on the VM\nCheck which remote is set:\n\n\nCode\ngit -C /home/yeroslaviz/BCFNGS-project-management remote -v\n\n\nIf the remote is SSH (git@github.com:...), verify SSH access:\n\n\nCode\nssh -T git@github.com\n\n\nIf SSH works but git pull still says Permission denied (publickey), the VM key is not added to the repo. The fix is to add the VM public key as a Deploy Key:\n\n\nCode\ncat ~/.ssh/id_ed25519.pub\n\n\nThen add that key in GitHub: Repo → Settings → Deploy keys → Add deploy key (read‑only is enough for pull).\n\n\n3.5.7.2 2) Pull latest code\n\n\nCode\ncd /home/yeroslaviz/BCFNGS-project-management\ngit pull origin main\n\n\nIf Git says divergent branches, I set merge as the default and pull again:\n\n\nCode\ngit config pull.rebase false\ngit pull origin main\n\n\nIf Git refuses because of the local SQLite DB file, I stop tracking the DB on the VM:\n\n\nCode\ngit rm --cached sequencing-app/sequencing_projects.db\ngit commit -m \"Stop tracking local SQLite DB on VM\"\ngit pull origin main\n\n\nThis does not delete the local DB file. It just removes it from Git so future pulls work.\n\n\n3.5.7.3 3) Production safety backups (fast rollback)\n\n\nCode\nsudo rsync -av /srv/shiny-server/sequencing-app/ /srv/shiny-server/sequencing-app.backup_$(date +%Y%m%d_%H%M)/\ncp /srv/shiny-server/sequencing-app/sequencing_projects.db \\\n  /srv/shiny-server/sequencing-app/sequencing_projects.db.backup_$(date +%Y%m%d_%H%M)\nsudo cp /etc/apache2/sites-enabled/01-main.conf \\\n  /etc/apache2/sites-enabled/01-main.conf.backup_$(date +%Y%m%d_%H%M)\n\n\n\n\n3.5.7.4 4) Deploy\n\n\nCode\n./deploy.sh\n\n\n\n\n3.5.7.5 5) Restart and smoke‑test\n\n\nCode\nsudo systemctl restart shiny-server\nsudo systemctl restart apache2\n\n\nThen open the app URL and verify: - LDAP prompt appears - login works - app loads\n\n\n3.5.7.6 6) Rollback (if needed)\n\n\nCode\nsudo rsync -av --delete /srv/shiny-server/sequencing-app.backup_YYYYMMDD_HHMM/ /srv/shiny-server/sequencing-app/\nsudo systemctl restart shiny-server\nsudo systemctl restart apache2"
  },
  {
    "objectID": "chapters/server-preparations.html#security",
    "href": "chapters/server-preparations.html#security",
    "title": "3  Server Preparations",
    "section": "3.6 Security",
    "text": "3.6 Security\nNot sure, if this is all necessary, will consult the IT when it is appropriate\n\n3.6.1 Backup older settings\n\n\nCode\n\n# Backup your current configuration\nsudo cp /etc/apache2/sites-enabled/01-main.conf /etc/apache2/sites-enabled/01-main.conf.backup\n\n# Remove old SSL certificates (optional - keep for backup)\nsudo mkdir -p /etc/ssl/backup/\nsudo mv /etc/ssl/certs/********.pem /etc/ssl/backup/\nsudo mv /etc/ssl/private/********.pem /etc/ssl/backup/\nsudo mv /etc/apache2/certificate/********.cer /etc/ssl/backup/\n\n\n./\n├── 01-main.conf -&gt; ../sites-available/default-ssl.conf\n├── 01-main.conf.backup\n├── 02-testing.conf -&gt; ../sites-available/02-testing.conf\n└── auth_ldap.conf -&gt; ../sites-available/auth_ldap.conf\n\n\n3.6.2 Applying for a new certificate from MPI/MPG\nThe new setting of the certificates. I have three files.\nThe private key I created when applying for the certificate. The other two were downloaded, when the emial came from Harica (the certificate provider).\nthe PEM is the pem file and the DER (issuer) is the chain file. Both of them are needed.\nSetting for the readability of the files:\ncd /etc/apache2/certificate/2026\n-rw------- 1 yeroslaviz b_mcf 3272 Nov 10 15:58 private-key.pem # udo chmod 600 /path/to/private.key  # Readable only by root\n-rw-r--r-- 1 yeroslaviz b_mcf 1545 Nov 14 12:12 NGS_2026_Issuer_ChainFile.cer # sudo chmod 644 /path/to/chain.crt  # Readable by all\n-rw-r--r-- 1 yeroslaviz b_mcf 2796 Nov 14 12:34 NGS_2026_Cert.pem # sudo chmod 644 /path/to/certificate.crt # Readable by all\nAll the files are saved under /etc/apache2/certificate/2026.\nNow I created soft links for each of these files.\n\n\nCode\nsudo ln -s /etc/apache2/certificate/2026/private-key.pem /etc/ssl/private/2026_private-key.pem\nsudo ln -s /etc/apache2/certificate/2026/NGS_2026_Cert.pem /etc/ssl/certs/2026_NGS_Cert.pem\n\n\n\n\n3.6.3 Firewall\nat the moment is not active, but maybe in the future.\n\n\nCode\n\nsudo ufw allow 3838\nsudo ufw allow 80\nsudo ufw allow 443"
  },
  {
    "objectID": "chapters/server-preparations.html#change-connection-to-shiny-server-folder-to-https",
    "href": "chapters/server-preparations.html#change-connection-to-shiny-server-folder-to-https",
    "title": "3  Server Preparations",
    "section": "3.7 Change connection to shiny server folder to https",
    "text": "3.7 Change connection to shiny server folder to https\nThe shiny app takes information from the config file under /etc/shiny-server/shiny-server.conf. Here we can see where the log files are written into and where the directory of the shiny app are stored.\n\n\nCode\nsudo usermod -a -G shiny $USER # add user yeroslaviz to group shiny\nsudo chown -R $USER:shiny sequencing-app/ # make group shiny able to execute the scripts in the folder\nsudo mv /srv/shiny-server/sequencing-app/ /srv/shiny-server/sequencing-app.backup # move the actual hard-coded folder to a backup (just in case)\n\n\nThe sequencing-app folder must be copied to the correct place after each modification was done and the new files were pulled to the VM.\nFor that I have created a script called deploy.sh. The script synchronizes the files from the github repo folder /home/yeroslaviz/BCFNGS-project-management/sequencing-app/ to where the Shiny app needs them to be: /srv/shiny-server/sequencing-app/.\nThe deploy script must be activated when loaded\n\n\nCode\nchmod +x deploy.sh\n\n\nThe deploy.sh script uses rsync and excludes sequencing_projects.db so the production database is not overwritten during deploys.\nIf rsync is not installed on the VM:\n\n\nCode\nsudo apt install -y rsync\n\n\nIt then resets permissions for all files (the DB file remains in place and keeps its permissions).\nWhen this is done, it restart the shiny server.\nThis script must be run each time the files inside the sequencing-app folder were changed, but not if other changed were made in the repo.\nRule of thumb after git pull:\n\nRun ./deploy.sh if anything under sequencing-app/ changed (e.g. app.R, setup_database.R, CSS, images).\nSkip ./deploy.sh if only docs changed (.qmd, .md, notes/) or other non‑app files."
  },
  {
    "objectID": "chapters/server-preparations.html#changes-on-13.02.2026",
    "href": "chapters/server-preparations.html#changes-on-13.02.2026",
    "title": "3  Server Preparations",
    "section": "3.8 Changes on 13.02.2026",
    "text": "3.8 Changes on 13.02.2026\n\nNew project emails now prefix the subject with the project ID (e.g., P2 - ...).\nProject description (if provided) is appended to the email body.\nEmail recipients changed to budget holder + project creator + ngs@biochem.mpg.de.\nAdmin broadcast is retained in the code but commented out for easy rollback.\nNotes were converted from .md to .qmd with a consistent header template, and the booklet generator now reads the .qmd sources."
  },
  {
    "objectID": "chapters/server-preparations.html#changes-on-12.02.2026",
    "href": "chapters/server-preparations.html#changes-on-12.02.2026",
    "title": "3  Server Preparations",
    "section": "3.9 Changes on 12.02.2026",
    "text": "3.9 Changes on 12.02.2026\n\nFixed LDAP URL impersonation risk by enforcing canonical auth_user handling in Apache: tampered ?auth_user= values are rewritten to the authenticated LDAP user.\nFixed redirect-loop behavior in the Apache auth rewrite logic and validated canonical redirect behavior with curl (expected 302 to the authenticated user).\nConfirmed and documented required shiny-server environment for LDAP mode:\n\nAUTH_MODE=ldap\nTRUST_PROXY_AUTH_USER_QUERY=1\n\nExtended deploy.sh with post-deploy LDAP smoke tests (canonical redirect, tampered query rewrite, final 200 response) and actionable failure hints.\nAdded/merged troubleshooting guidance for LDAP login failures, disconnects, and redirect loops into the VM troubleshooting documentation.\nImproved Projects table readability in the Shiny UI (sequencing-app/app.R):\n\nexplicit DT column widths\nwrapped long cell text\nreliable column reflow on tab switch and resize\npreserved horizontal scrolling and existing formatting."
  },
  {
    "objectID": "chapters/server-preparations.html#changes-on-11.02.2026",
    "href": "chapters/server-preparations.html#changes-on-11.02.2026",
    "title": "3  Server Preparations",
    "section": "3.10 Changes on 11.02.2026",
    "text": "3.10 Changes on 11.02.2026\n\nAdded a production rollout checklist with the exact commands for pull, backup, deploy, restart, and smoke‑tests.\nAdded a dedicated section for admin access in LDAP mode (pre‑create vs promote after first login).\nAdded a dedicated section on switching between LDAP and local auth on the VM (AUTH_MODE via systemd override).\nAdded the full pre‑create admin example that includes password/email for NOT NULL constraints.\nUpdated the canonical server path to /srv/shiny-server and corrected repo path on the local machine.\nMoved legacy/obsolete content to the end of the document under Obsolete / now wrong.\nReplaced the old deploy script reference (deploy_shiny_server.sh) with deploy.sh."
  },
  {
    "objectID": "chapters/server-preparations.html#changes-on-09.02.2026",
    "href": "chapters/server-preparations.html#changes-on-09.02.2026",
    "title": "3  Server Preparations",
    "section": "3.11 Changes on 09.02.2026",
    "text": "3.11 Changes on 09.02.2026\n\nAdded a VM rollout HOW‑TO (GitHub SSH/deploy keys, divergent branches, DB tracking fix, backups, deploy, restart, rollback).\nDocumented production safeguards (app folder backup, DB backup, Apache config backup).\nUpdated deploy.sh to restart Shiny only if rsync succeeds (prevents restarts on failed deploys).\nCleaned up Apache LDAP logging (default to quiet logs; debug only when explicitly enabled).\nMade LDAP debug output in the Shiny app conditional on both APP_ENV=dev and LDAP_DEBUG=1 to avoid production log noise.\nDocumented the VM LDAP validation test (real user + service group user, and email routing behavior).\n\n\n3.11.1 VM rollout validation (what I tested and confirmed)\nI verified end‑to‑end behavior on the VM after fixing the Apache proxy path:\n\nLDAP login works: the browser prompts for username/password and redirects to /sequencing-app/?auth_user=&lt;user&gt;.\nUser mapping works: yeroslaviz (OU contains Cox) is mapped to the Cox group and the correct PI.\nUser mapping works: yeroslaviz-test (OU = NGS Facility) is treated as a service‑group user (no PI match).\nEmail routing works: research group users trigger mail to the PI and NGS.\nEmail routing works: service group users (no PI match) trigger mail to the administrator.\n\nIf all three happen, the LDAP→app→email flow is working as intended."
  },
  {
    "objectID": "chapters/server-preparations.html#possible-errors-and-fixes-vm-ldap-rollout",
    "href": "chapters/server-preparations.html#possible-errors-and-fixes-vm-ldap-rollout",
    "title": "3  Server Preparations",
    "section": "3.12 Possible errors and fixes (VM LDAP rollout)",
    "text": "3.12 Possible errors and fixes (VM LDAP rollout)\nThis section captures the real errors I hit during the VM rollout and the fixes that worked. It is meant as a troubleshooting reference.\n\n3.12.1 1) Apache won’t restart after LDAP change\nSymptom\nAH00526: Syntax error ... Bad LDAP URL while parsing.\nCause\nApache’s AuthLDAPURL is very strict. Each URL must be complete (host + base DN + query), and some Apache builds don’t accept multiple URLs in a single directive.\nFix\nUse a single server (most stable on my VM):\nAuthLDAPURL \"ldaps://ldapserv1.biochem.mpg.de:636/dc=biochem,dc=mpg,dc=de?uid?sub?(objectClass=posixAccount)\"\nIf the multi‑server line fails, I keep one server and fall back manually if needed.\n\n\n3.12.2 2) LDAPTLS_CACERTDIR breaks Apache\nSymptom\nInvalid command 'LDAPTLS_CACERTDIR'\nCause\nLDAPTLS_CACERTDIR is not an Apache directive. It belongs to the OpenLDAP client config.\nFix\nRemove it from Apache. If I need TLS trust, I configure it in /etc/ldap/ldap.conf instead.\n\n\n3.12.3 3) LDAP login shows 500 Internal Server Error\nSymptom\n\nBrowser shows Internal Server Error\nApache log shows:\n\nldap_simple_bind() failed][Can't contact LDAP server]\nCause\nLDAP TLS handshake fails (certificate trust not configured).\nFix\n\nConfirm port reachability:\n\nnc -vz ldapserv1.biochem.mpg.de 636\n\nTest LDAP with TLS bypass to confirm trust problem:\n\nLDAPTLS_REQCERT=never ldapsearch -x -H ldaps://ldapserv1.biochem.mpg.de:636 \\\n  -b \"dc=biochem,dc=mpg,dc=de\" \"(uid=USER)\" mail\n\nFix trust in /etc/ldap/ldap.conf:\n\nTLS_CACERTDIR /etc/ssl/certs\nImportant: I had a typo (TLS_CACERETDIR) which prevented TLS trust from loading. Fixing the spelling made LDAP work.\n\nVerify normal LDAP now works:\n\nldapsearch -x -H ldaps://ldapserv1.biochem.mpg.de:636 \\\n  -b \"dc=biochem,dc=mpg,dc=de\" \"(uid=USER)\" mail\nThen restart Apache:\nsudo systemctl restart apache2\n\n\n3.12.4 4) Shiny app runs locally but crashes via Apache\nSymptom\n\nApp works with shiny::runApp()\nBut Apache shows 500 and Shiny worker terminates\n\nCause\nLDAP authentication failure in Apache (not an app crash).\nFix\nCheck Apache log for authnz_ldap errors and fix TLS trust as above.\n\n\n3.12.5 5) LDAP works, but /sequencing-app/ returns 404\nSymptom\n\ncurl -Ik -u USER https://host/sequencing-app/ returns 404\ncurl -I http://localhost:3838/sequencing-app/ returns 200\n\nCause\nApache is proxying the wrong path (often due to an older ProxyPass / rule or a backup file in sites-enabled).\nFix\n\nEnsure only these lines exist in the active config:\n\nProxyPass /sequencing-app/ http://localhost:3838/sequencing-app/\nProxyPassReverse /sequencing-app/ http://localhost:3838/sequencing-app/\n\nRemove or move any backup config files out of /etc/apache2/sites-enabled (Apache can accidentally parse them).\nRestart Apache:\n\nsudo apache2ctl -t\nsudo systemctl restart apache2\n\n\n3.12.6 6) Debug logging too noisy (Apache or Shiny)\nSymptom\nLots of LDAP debug output in logs during normal use.\nFix (Apache)\nIn 01-main.conf, use normal logging:\nLogLevel warn\n# LogLevel authnz_ldap:debug ldap:debug   # enable only when debugging\nFix (Shiny app)\nThe app only prints LDAP debug logs when both are set:\n\nAPP_ENV=dev\nLDAP_DEBUG=1\n\nSo for production:\n\nRemove LDAP_DEBUG=1 from /home/shiny/.Renviron (or set it to 0).\nRestart Shiny:\n\nsudo systemctl restart shiny-server\nIf I need debugging later, I can temporarily set:\nAPP_ENV=dev\nLDAP_DEBUG=1\nand restart the service again.\n\n\n3.12.7 Comprehensive error‑checking checklist (VM LDAP + Shiny)\nWhen something breaks, I run through this list in order:\n\nApache syntax\n\nsudo apache2ctl -t\n\nWhich vhost is active\n\nsudo apache2ctl -S\n\nProxy path\n\nsudo grep -n \"ProxyPass\" -R /etc/apache2/sites-enabled /etc/apache2/conf-enabled\n\nLDAP connectivity + TLS\n\nnc -vz ldapserv1.biochem.mpg.de 636\nldapsearch -x -H ldaps://ldapserv1.biochem.mpg.de:636 \\\n  -b \"dc=biochem,dc=mpg,dc=de\" \"(uid=USER)\" mail\nIf that fails, verify /etc/ldap/ldap.conf has:\nTLS_CACERTDIR /etc/ssl/certs\n\nLDAP auth prompt vs app redirect\n\ncurl -Ik https://HOST/\ncurl -Ik -u USER https://HOST/\nExpected: 401 without user, 302 to /sequencing-app/?auth_user=USER with user.\n\nShiny backend is reachable\n\ncurl -I http://localhost:3838/sequencing-app/\n\nApache app path\n\ncurl -Ik -u USER https://HOST/sequencing-app/\n\nShiny logs\n\nsudo ls -t /var/log/shiny-server/ | head -n 1\nsudo tail -n 200 /var/log/shiny-server/FILE.log\n\nShiny environment variables\n\nsudo systemctl show shiny-server --property=Environment\n\nDatabase permissions\n\nls -l /srv/shiny-server/sequencing-app/sequencing_projects.db\n\nReload after config change\n\nsudo systemctl restart apache2\nsudo systemctl restart shiny-server"
  },
  {
    "objectID": "chapters/server-preparations.html#changes-on-06.02.2026",
    "href": "chapters/server-preparations.html#changes-on-06.02.2026",
    "title": "3  Server Preparations",
    "section": "3.13 Changes on 06.02.2026",
    "text": "3.13 Changes on 06.02.2026\n\nAdded LDAP login flow in the Shiny app (auto‑login via X-Remote-User, local dev simulation, and optional attribute lookup).\nLDAP attribute lookup now works with anonymous bind; uses ldapsearch fallback for older ldapr versions.\nAdded dev tools toggle (dev only) to switch between LDAP and local auth while testing.\nMapped LDAP ou values to budget holders, auto‑selecting the correct PI in the project form (with partial match fallback).\nAdded budget holder notices for multiple cost centers and missing cost center values.\nAdded “Other / not listed” budget holder option so users can enter a new PI (name/surname required; cost center optional with a warning).\nUpdated deploy.sh to use rsync and exclude sequencing_projects.db.\nUpdated Apache LDAP configuration template and added local dev testing instructions + env var cleanup.\nI do not track SQLite DB files in git because they change constantly, are environment‑specific (local vs VM), and can contain sensitive data. I ignore *.db/*.sqlite and keep only the schema/seed files in git."
  },
  {
    "objectID": "chapters/server-preparations.html#changes-on-14.11.2026",
    "href": "chapters/server-preparations.html#changes-on-14.11.2026",
    "title": "3  Server Preparations",
    "section": "3.14 Changes on 14.11.2026",
    "text": "3.14 Changes on 14.11.2026\nSQL‑related commands and explanations (admin email updates, service cost updates, registration/budget holder DB updates, and DB inspection) were moved to notes/sql-handling.qmd."
  },
  {
    "objectID": "chapters/server-preparations.html#ssl-certificate-for-https",
    "href": "chapters/server-preparations.html#ssl-certificate-for-https",
    "title": "3  Server Preparations",
    "section": "3.15 SSL Certificate (for HTTPS)",
    "text": "3.15 SSL Certificate (for HTTPS)\nthe new setting of the certificates. I have three files.\nThe private key I created when applying for the certificate. The other two were downloaded, when the emial came from Harica (the certificate provider).\nthe PEM is the pem file and the DER (issuer) is the chain file. Both of them are needed.\nSetting for the readability of the files:\ncd /etc/apache2/certificate/2026\n-rw------- 1 yeroslaviz b_mcf 3272 Nov 10 15:58 private-key.pem # udo chmod 600 /path/to/private.key  # Readable only by root\n-rw-r--r-- 1 yeroslaviz b_mcf 1545 Nov 14 12:12 NGS_2026_Issuer_ChainFile.cer # sudo chmod 644 /path/to/chain.crt  # Readable by all\n-rw-r--r-- 1 yeroslaviz b_mcf 2796 Nov 14 12:34 NGS_2026_Cert.pem # sudo chmod 644 /path/to/certificate.crt # Readable by all\nAll the files are saved under /etc/apache2/certificate/2026.\nNow I created soft links for each of these files.\n\n\nCode\nsudo ln -s /etc/apache2/certificate/2026/private-key.pem /etc/ssl/private/2026_private-key.pem\nsudo ln -s /etc/apache2/certificate/2026/NGS_2026_Cert.pem /etc/ssl/certs/2026_NGS_Cert.pem"
  },
  {
    "objectID": "chapters/server-preparations.html#ldap",
    "href": "chapters/server-preparations.html#ldap",
    "title": "3  Server Preparations",
    "section": "3.16 LDAP",
    "text": "3.16 LDAP\nThe app uses Apache LDAP authentication in front of Shiny. The Apache config template is in 01-main.conf.\nEnable required Apache modules:\n\n\nCode\nsudo a2enmod ldap authnz_ldap headers\nsudo systemctl reload apache2\n\n\nTest whether anonymous LDAP search works:\n\n\nCode\nldapsearch -x -H ldaps://ldapserv1.biochem.mpg.de -b \"dc=biochem,dc=mpg,dc=de\" \"(uid=YOURUSER)\"\n\n\nIf anonymous search fails, use bind credentials from IT and add them to the Apache config:\nAuthLDAPBindDN \"cn=binduser,dc=biochem,dc=mpg,dc=de\"\nAuthLDAPBindPassword \"REDACTED\"\n\n\n\n\n\n\nWarning\n\n\n\nFor production, do not use a personal account for LDAP binding. Ask IT for a dedicated service bind account with read‑only permissions and store those credentials securely.\n\n\nSet app environment variables for Shiny Server (systemd override recommended):\n\n\nCode\nsudo systemctl edit shiny-server\n\n\n[Service]\nEnvironment=AUTH_MODE=ldap\nEnvironment=LDAP_URI=ldaps://ldapserv1.biochem.mpg.de:636,ldaps://ldapserv2.biochem.mpg.de:636,ldaps://ldapserv3.biochem.mpg.de:636\nEnvironment=LDAP_BASE_DN=dc=biochem,dc=mpg,dc=de\n# If you want to restrict search to the user OU:\n# Environment=LDAP_BASE_DN=ou=People,dc=biochem,dc=mpg,dc=de\n# Optional bind credentials (only if anonymous LDAP search is blocked):\n# Environment=LDAP_BIND_DN=cn=binduser,dc=biochem,dc=mpg,dc=de\n# Environment=LDAP_BIND_PW=REDACTED\nRestart services after config changes:\n\n\nCode\nsudo systemctl restart apache2\nsudo systemctl restart shiny-server\n\n\n\n3.16.1 Admin access in LDAP mode (VM)\nMoved to notes/sql-handling.qmd (admin promotion and verification commands).\n\n\n3.16.2 Switch between LDAP and local modes (VM)\nI switch auth modes by changing the AUTH_MODE environment variable for the shiny-server service and restarting it.\nOpen the systemd override:\n\n\nCode\nsudo systemctl edit shiny-server\n\n\nLDAP mode (production):\n[Service]\nEnvironment=AUTH_MODE=ldap\nEnvironment=LDAP_URI=ldaps://ldapserv1.biochem.mpg.de:636,ldaps://ldapserv2.biochem.mpg.de:636,ldaps://ldapserv3.biochem.mpg.de:636\nEnvironment=LDAP_BASE_DN=dc=biochem,dc=mpg,dc=de\nLocal mode (maintenance/testing):\n[Service]\nEnvironment=AUTH_MODE=local\nApply changes:\n\n\nCode\nsudo systemctl restart shiny-server\nsudo systemctl show shiny-server --property=Environment\n\n\nIf I switch back to LDAP, I also remove any dev‑only variables like DEV_REMOTE_USER.\n\n\n3.16.3 Local dev testing (LDAP mode)\nTo test LDAP integration on your local machine without affecting production, run the app in dev mode and simulate the authenticated user. If LDAP attribute lookup is needed, provide a bind DN/password (personal credentials are OK for local testing only).\nSys.setenv(\n  APP_ENV = \"dev\",\n  AUTH_MODE = \"ldap\",\n  DEV_REMOTE_USER = \"your_username\",\n  LDAP_BIND_DN = \"uid=your_username,ou=YourGroup,ou=Research Group,ou=People,dc=biochem,dc=mpg,dc=de\",\n  LDAP_BIND_PW = \"YOUR_PASSWORD\"\n)\nshiny::runApp(\"sequencing-app\")\nTo switch back to normal local login (no LDAP), run:\nSys.setenv(APP_ENV = \"dev\", AUTH_MODE = \"local\")\nshiny::runApp(\"sequencing-app\")\nTo fully clear the LDAP/testing variables in your R session:\nSys.unsetenv(c(\n  \"APP_ENV\", \"AUTH_MODE\", \"DEV_REMOTE_USER\",\n  \"LDAP_BIND_DN\", \"LDAP_BIND_PW\",\n  \"LDAP_URI\", \"LDAP_BASE_DN\", \"LDAP_DEBUG\"\n))\n\n\n3.16.4 How I run the app locally (my notes)\nWhen I want the normal local login, I run:\nSys.setenv(APP_ENV = \"dev\", AUTH_MODE = \"local\")\nshiny::runApp(\"sequencing-app\")\nWhen I want to simulate production LDAP login, I run:\nSys.setenv(\n  APP_ENV = \"dev\",\n  AUTH_MODE = \"ldap\",\n  DEV_REMOTE_USER = \"my_username\",\n  LDAP_URI = \"ldaps://ldapserv1.biochem.mpg.de:636,ldaps://ldapserv2.biochem.mpg.de:636,ldaps://ldapserv3.biochem.mpg.de:636\",\n  LDAP_BASE_DN = \"dc=biochem,dc=mpg,dc=de\"\n)\nshiny::runApp(\"sequencing-app\")\nIf I want to fully reset the session, I clear the env vars:\nSys.unsetenv(c(\n  \"APP_ENV\", \"AUTH_MODE\", \"DEV_REMOTE_USER\",\n  \"LDAP_BIND_DN\", \"LDAP_BIND_PW\",\n  \"LDAP_URI\", \"LDAP_BASE_DN\", \"LDAP_DEBUG\"\n))\nLocal vs LDAP mode (practical difference for me):\n\nLocal mode uses the SQLite users/passwords and shows the normal login screen.\nLDAP mode auto‑logs in with the LDAP user, pulls email/phone/OU, and hides the local login UI.\nLDAP mode needs network access to the institute LDAP servers.\n\nDev badge: In dev mode, I see a small badge in the app header that shows DEV · LDAP or DEV · LOCAL, so I always know which mode I’m running.\n\n\n3.16.5 Budget holder auto-assignment (first login)\nOn first LDAP login, the app attempts to map the user to a budget holder based on the LDAP ou value.\nIf the ou contains a group key in parentheses (e.g., (... Cox)), the app matches that key against budget_holders and stores the full PI name (e.g., Cox Juergen) in users.research_group.\nWhen a new project is created, this research_group value is used to auto‑select the budget holder (and thus the cost center).\nIf multiple cost centers exist for the same PI, the first match is selected by default and can be adjusted during project creation."
  },
  {
    "objectID": "chapters/server-preparations.html#obsolete-now-wrong-kept-for-reference",
    "href": "chapters/server-preparations.html#obsolete-now-wrong-kept-for-reference",
    "title": "3  Server Preparations",
    "section": "3.17 Obsolete / now wrong (kept for reference)",
    "text": "3.17 Obsolete / now wrong (kept for reference)\nThese sections are retained to understand the history but should not be followed anymore.\n\n3.17.1 Legacy environment variable location (no longer used)\n\n\nCode\n\n# /var/shiny-server/.Renviron\nTZ=Europe/Berlin\nLANG=en_US.UTF-8\nLC_ALL=en_US.UTF-8\n\n\n\n\n3.17.2 Legacy folder layout (/var/shiny-server)\n/var/shiny-server/\n├── sequencing-app/\n│ ├── app.R\n│ ├── setup_database.R\n│ ├── sequencing_projects.db\n│ └── www/\n  │ ├── logo.png\n  │ └── minerva.png\n\n\n3.17.3 Legacy install steps (nginx-based, superseded by Apache setup)\n\n\nCode\n\n# Install Shiny Server on Ubuntu\nsudo apt update\nsudo apt install -y r-base nginx\nsudo apt install -y libfontconfig1-dev libfreetype6-dev libpng-dev libtiff5-dev \\\n    libjpeg-dev build-essential pkg-config libharfbuzz-dev libfribidi-dev\nsudo apt install -y libldap2-dev libsasl2-dev\n\nsudo su - -c \"R -e \\\"install.packages('shiny')\\\"\"\nsudo su - -c \"R -e \\\"install.packages('shinyjs')\\\"\"\n# ... install all your R packages\nsudo R -e \"install.packages(c('shiny', 'shinyjs', 'DBI', 'RSQLite', 'digest', 'DT', 'shinyWidgets', 'mailR'))\"\n# these two packages were added later on for the connection of the app to the LDAP server\nsudo R -e \"install.packages(c('devtools'))\"\nsudo R -e \"devtools::install_github('liamgilbey/ldapr')\"\n\n# Download and install Shiny Server\nwget https://download3.rstudio.org/ubuntu-20.04/x86_64/shiny-server-1.5.23.1030-amd64.deb\nsudo gdebi shiny-server-1.5.23.1030-amd64.deb\n\n\n\n\n3.17.4 Legacy Apache config (old ProxyPass / path)\n\n\nCode\n&lt;VirtualHost *:80&gt;\n    ServerName ngs-testing-vm\n    ServerAlias ngs-testing-vm.biochem.mpg.de\n    # Redirect all HTTP traffic to HTTPS\n    Redirect permanent / https://ngs-testing-vm/\n&lt;/VirtualHost&gt;\n\n&lt;VirtualHost *:443&gt;\n    ServerName ngs-testing-vm\n    ServerAlias ngs-testing-vm.biochem.mpg.de\n\n    # SSL Configuration\n    SSLEngine on\n    SSLCertificateFile /etc/ssl/certs/2026_NGS_Cert.pem\n    SSLCertificateKeyFile /etc/ssl/private/2026_private-key.pem\n    SSLCertificateChainFile /etc/apache2/certificate/2026/NGS_2026_Issuer_ChainFile.cer\n\n    # Modern SSL configuration\n    SSLProtocol all -SSLv3 -TLSv1 -TLSv1.1\n    SSLCipherSuite ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384\n    SSLHonorCipherOrder off\n\n    # Reverse proxy for Shiny app\n    ProxyPreserveHost On\n    ProxyRequests Off\n    ProxyPass / http://localhost:3838/sequencing-app/\n    ProxyPassReverse / http://localhost:3838/sequencing-app/\n\n    # WebSocket support\n    RewriteEngine on\n    RewriteCond %{HTTP:Upgrade} websocket [NC]\n    RewriteCond %{HTTP:Connection} upgrade [NC]\n    RewriteRule ^/(.*) \"ws://localhost:3838/sequencing-app/$1\" [P,L]\n\n    # Security headers\n    Header always set Strict-Transport-Security \"max-age=63072000; includeSubDomains\"\n    Header always set X-Content-Type-Options nosniff\n    Header always set X-Frame-Options SAMEORIGIN\n    Header always set Referrer-Policy \"strict-origin-when-cross-origin\"\n\n    ErrorLog ${APACHE_LOG_DIR}/sequencing-app-ssl-error.log\n    CustomLog ${APACHE_LOG_DIR}/sequencing-app-ssl-access.log combined\n&lt;/VirtualHost&gt;\n\n\n\n\n3.17.5 Legacy deployment script name\nThe old notes referenced deploy_shiny_server.sh. This has been replaced by deploy.sh in the repo root.\n\n\n3.17.6 Legacy tree output (old VM layout example)\n$ tree -L 1\n.\n├── BCFNGS-project-management\n├── chemata\n├── miniconda3\n└── scripts\n    └── deploy_shiny_server.sh\n\n\n3.17.7 Legacy git pull via HTTPS + PAT (no longer used)\n\n\nCode\n git pull origin main\n# Username for 'https://github.com': yeroslaviz\n# Password for 'https://yeroslaviz@github.com':  HERE WE MUST INPUT THE PAT from above!!!\n ...\n\n\n\n\n3.17.8 Legacy note: dedicated user (superseded)\nAs we’re planning to use the LDAP, I’m not sure, this is necessary. I need a method to add specific users as admin."
  },
  {
    "objectID": "chapters/ldap-setup-summary-2026-02-06.html#ldap-project-management-app-summary-2026-02-06",
    "href": "chapters/ldap-setup-summary-2026-02-06.html#ldap-project-management-app-summary-2026-02-06",
    "title": "4  LDAP Setup Summary (2026-02-06)",
    "section": "4.1 LDAP + Project Management App Summary (2026-02-06)",
    "text": "4.1 LDAP + Project Management App Summary (2026-02-06)\n\n4.1.1 What Changed\n\nAdded LDAP login flow with auto-login via X-Remote-User and local dev simulation via DEV_REMOTE_USER.\nLDAP attribute lookup now works without a bind account (anonymous bind), and falls back to ldapsearch for older ldapr versions.\nAdded a dev-only auth toggle and mode badge (DEV · LDAP / DEV · LOCAL).\nMapped LDAP ou values to budget holders, auto-selecting the correct PI in the project form (with partial match fallback).\nAdded notices when a PI has multiple cost centers or missing cost center.\nAdded “Other / not listed” budget holder option so users can enter a new PI (name + surname required; cost center optional with warning).\ndeploy.sh now uses rsync and excludes the SQLite DB.\nDocs updated with LDAP setup, local testing, and env cleanup.\n.gitignore updated to ignore DB files and backup folders.\n\n\n\n4.1.2 Files Updated\n\nsequencing-app/app.R\ndeploy.sh\n01-main.conf\nServer_preparations.qmd\n.gitignore\nsequencing-app/budget_holders.csv\n\n\n\n4.1.3 Local Run: Local Mode\nSys.setenv(APP_ENV = \"dev\", AUTH_MODE = \"local\")\nshiny::runApp(\"sequencing-app\")\nImplications - Uses SQLite users/passwords. - Shows normal login form. - Works offline.\n\n\n4.1.4 Local Run: LDAP Mode (simulate production)\nSys.setenv(\n  APP_ENV = \"dev\",\n  AUTH_MODE = \"ldap\",\n  DEV_REMOTE_USER = \"your_username\",\n  LDAP_URI = \"ldaps://ldapserv1.biochem.mpg.de:636,ldaps://ldapserv2.biochem.mpg.de:636,ldaps://ldapserv3.biochem.mpg.de:636\",\n  LDAP_BASE_DN = \"dc=biochem,dc=mpg,dc=de\"\n)\nshiny::runApp(\"sequencing-app\")\nImplications - Auto-login (no local password). - Pulls mail, telephoneNumber, and ou via LDAP. - Auto-creates user in SQLite if missing. - Matches production behavior.\n\n\n4.1.5 Clear Dev Environment Variables\nSys.unsetenv(c(\n  \"APP_ENV\", \"AUTH_MODE\", \"DEV_REMOTE_USER\",\n  \"LDAP_BIND_DN\", \"LDAP_BIND_PW\",\n  \"LDAP_URI\", \"LDAP_BASE_DN\", \"LDAP_DEBUG\"\n))\n\n\n4.1.6 SQL handling (moved)\nAll SQL database commands and explanations were moved to notes/sql-handling.qmd.\n\n\n4.1.7 Budget Holder Behavior\n\nOn first LDAP login, the app maps LDAP ou to a PI name in budget_holders.\nIf multiple cost centers exist for a PI, the app displays a notice.\nIf cost center is missing (N.A./empty), the app displays a warning.\n“Other / not listed” allows users to enter a new PI and inserts into budget_holders automatically.\n\n\n\n4.1.8 Deploy (VM)\ncd /home/yeroslaviz/BCFNGS-project-management\ngit pull\n./deploy.sh\ndeploy.sh uses rsync and does not overwrite the SQLite DB.\n\n\n4.1.9 LDAP on VM (when ready)\n\nUpdate Apache config (template in 01-main.conf).\nEnable modules:\nsudo a2enmod ldap authnz_ldap headers\nsudo systemctl reload apache2\nSet Shiny env vars:\nsudo systemctl edit shiny-server\n[Service]\nEnvironment=AUTH_MODE=ldap\nEnvironment=LDAP_URI=ldaps://ldapserv1.biochem.mpg.de:636,ldaps://ldapserv2.biochem.mpg.de:636,ldaps://ldapserv3.biochem.mpg.de:636\nEnvironment=LDAP_BASE_DN=dc=biochem,dc=mpg,dc=de\n# Optional: restrict to People OU\n# Environment=LDAP_BASE_DN=ou=People,dc=biochem,dc=mpg,dc=de\nRestart services:\nsudo systemctl restart apache2\nsudo systemctl restart shiny-server\n\n\n\n4.1.10 Switching Modes on VM\nsudo systemctl edit shiny-server\n\nLDAP mode: Environment=AUTH_MODE=ldap\nLocal mode: Environment=AUTH_MODE=local (or remove the line)\n\nRestart:\nsudo systemctl restart shiny-server\n\n\n4.1.11 Why DB Files Are Ignored (moved)\nSee notes/sql-handling.qmd for the full rationale and git commands.\n\n\n4.1.12 Tools Needed\n\nldapsearch is required for LDAP attribute fallback:\n\nUbuntu: sudo apt install -y ldap-utils\nmacOS: brew install openldap"
  },
  {
    "objectID": "chapters/sql-handling.html#sql-handling",
    "href": "chapters/sql-handling.html#sql-handling",
    "title": "5  SQL Handling",
    "section": "5.1 SQL handling",
    "text": "5.1 SQL handling\n\n5.1.1 Contents\n\nDatabase locations\nInspect database structure\nAdmin users in LDAP mode\nUpdate budget holders (CSV vs DB)\nRebuild the database (when/why/how)\nBackups and retention\nGit tracking for DB files\nCommon fixes\n\n\n\n5.1.2 Database locations\n\nLocal dev: sequencing-app/sequencing_projects.db\nVM: /srv/shiny-server/sequencing-app/sequencing_projects.db\n\nOn the VM, run SQL commands as the shiny user:\nsudo -u shiny sqlite3 /srv/shiny-server/sequencing-app/sequencing_projects.db \"SELECT 1;\"\n\n\n5.1.3 Inspect database structure\nShow all tables\nsudo -u shiny sqlite3 /srv/shiny-server/sequencing-app/sequencing_projects.db \".tables\"\nShow table schema\nsudo -u shiny sqlite3 /srv/shiny-server/sequencing-app/sequencing_projects.db \\\n\"PRAGMA table_info(users);\"\nShow CREATE statement\nsudo -u shiny sqlite3 /srv/shiny-server/sequencing-app/sequencing_projects.db \\\n\".schema users\"\nPreview rows\nsudo -u shiny sqlite3 /srv/shiny-server/sequencing-app/sequencing_projects.db \\\n\"SELECT username, email, is_admin FROM users LIMIT 20;\"\n\n\n5.1.4 Admin users in LDAP mode\nWhen AUTH_MODE=ldap is enabled, local login is disabled.\nTo grant admin access, mark the LDAP user as admin in SQLite.\nOption 1: Pre‑create the user as admin (before first login)\nsudo -u shiny sqlite3 /srv/shiny-server/sequencing-app/sequencing_projects.db \\\n\"INSERT OR IGNORE INTO users (username, is_admin) VALUES ('soyer', 1);\"\nIf the insert is ignored because password/email are NOT NULL, use:\nsudo -u shiny sqlite3 /srv/shiny-server/sequencing-app/sequencing_projects.db \\\n\"INSERT OR IGNORE INTO users (username, password, email, is_admin) VALUES ('soyer', 'ldap-only', 'soyer@biochem.mpg.de', 1);\"\nOption 2: Promote after first login\nsudo -u shiny sqlite3 /srv/shiny-server/sequencing-app/sequencing_projects.db \\\n\"UPDATE users SET is_admin=1 WHERE username='soyer';\"\nList all admin users\nsudo -u shiny sqlite3 /srv/shiny-server/sequencing-app/sequencing_projects.db \\\n\"SELECT username, email, is_admin FROM users WHERE is_admin = 1;\"\n\n\n5.1.5 Update budget holders (CSV vs DB)\nThe app reads budget holders from the SQLite DB, not directly from the CSV.\nEditing the Excel/CSV file does not change the running app unless you rebuild the DB.\nOption A — Update via the app (safe, no rebuild)\nUse Administer Projects → Manage Budget Holders. Changes are written to the DB immediately.\nOption B — Update via SQL (safe, no rebuild)\n# Update cost center\nsudo -u shiny sqlite3 /srv/shiny-server/sequencing-app/sequencing_projects.db \\\n\"UPDATE budget_holders SET cost_center='P350' WHERE name='Cox' AND surname='Juergen';\"\n\n# Add a new PI\nsudo -u shiny sqlite3 /srv/shiny-server/sequencing-app/sequencing_projects.db \\\n\"INSERT INTO budget_holders (name, surname, cost_center, email) VALUES ('NewPI','Lastname','P999','newpi@biochem.mpg.de');\"\nOption C — Rebuild DB from CSV (destructive)\nSee the rebuild section below.\n\n\n5.1.6 Rebuild the database (when/why/how)\nYou only need a full rebuild when the schema changes (e.g., CHECK constraints, new columns, removed columns).\nWhen a rebuild makes sense\n\nTest instance and it’s OK to reset.\nsetup_database.R changed and you want a clean schema.\nYou want to permanently remove a legacy status/constraint.\n\nWhen not to rebuild\n\nYou already have production data.\nYou only changed app logic/UI.\n\nRebuild procedure (VM)\nThe rebuild must run inside /srv/shiny-server/sequencing-app so relative paths (e.g., budget_holders.csv) resolve correctly.\nsudo systemctl stop shiny-server\n\n# Backup first\ncp /srv/shiny-server/sequencing-app/sequencing_projects.db \\\n  /srv/shiny-server/sequencing_projects.db.backup_$(date +%Y%m%d_%H%M)\n\n# Remove DB\nrm /srv/shiny-server/sequencing-app/sequencing_projects.db\n\n# Recreate DB from schema (run in the live app folder)\ncd /srv/shiny-server/sequencing-app\nsudo -u shiny Rscript setup_database.R\n\nsudo systemctl start shiny-server\n\n\n5.1.7 Backups and retention\nIf the VM backup script is enabled, it typically copies the DB with a timestamp and deletes old backups:\ncp /srv/shiny-server/sequencing-app/sequencing_projects.db $BACKUP_DIR/sequencing_projects.db.$TIMESTAMP\nfind $BACKUP_DIR -name \"sequencing_projects.db.*\" -mtime +30 -delete\n\n\n5.1.8 Git tracking for DB files\nSQLite DB files change constantly and are environment‑specific.\nThey should not be tracked in git.\nIf a DB file is accidentally tracked:\ngit rm --cached sequencing-app/sequencing_projects.db\ngit commit -m \"Stop tracking local SQLite DB\"\nThis does not delete the local DB file — it only stops tracking it.\n\n\n5.1.9 Common fixes\nReadonly database error\nRun SQL as the shiny user and fix permissions:\nsudo chown shiny:shiny /srv/shiny-server/sequencing-app/sequencing_projects.db\nsudo chmod 664 /srv/shiny-server/sequencing-app/sequencing_projects.db\nUpdate admin email\nsudo -u shiny sqlite3 /srv/shiny-server/sequencing-app/sequencing_projects.db \\\n\"UPDATE users SET email='newadmin@institute.org' WHERE username='admin';\"\nUpdate service type costs\nsudo -u shiny sqlite3 /srv/shiny-server/sequencing-app/sequencing_projects.db \\\n\"UPDATE service_types SET costs_per_sample = 55 WHERE service_type = 'single cell/low mRNAseq';\"\nVerify LDAP user attributes in SQLite\ncon &lt;- DBI::dbConnect(RSQLite::SQLite(), \"sequencing-app/sequencing_projects.db\")\nDBI::dbGetQuery(con, \"SELECT username, email, phone, research_group FROM users WHERE username='your_username'\")\nDBI::dbDisconnect(con)"
  },
  {
    "objectID": "chapters/vm-troubleshooting-guide.html#vm-troubleshooting-guide-github-ldap-apache-shiny",
    "href": "chapters/vm-troubleshooting-guide.html#vm-troubleshooting-guide-github-ldap-apache-shiny",
    "title": "6  VM Troubleshooting Guide",
    "section": "6.1 VM Troubleshooting Guide (GitHub, LDAP, Apache, Shiny)",
    "text": "6.1 VM Troubleshooting Guide (GitHub, LDAP, Apache, Shiny)\nThis checklist covers the most common issues we hit and how to fix them quickly.\n\n6.1.1 AI session restart (quick resume)\nIf I need to resume work in a new AI session, I point it to:\n\nServer_preparations.qmd for the current state and validation.\nnotes/sql-handling.qmd for DB operations and maintenance.\nnotes/ubuntu-bare-server-setup-howto.qmd for the full setup flow.\n\n\n\n6.1.2 A) Git / GitHub sync problems\n1) Permission denied (publickey)\nSymptoms:\n\ngit@github.com: Permission denied (publickey)\nfatal: Could not read from remote repository\n\nFix:\n\nVerify SSH auth:\n\nssh -T git@github.com\n\nConfirm repo URL:\n\ngit remote -v\n\nEnsure the correct SSH key is loaded (or add it to ~/.ssh/config).\n\n2) Divergent branches during pull\nSymptoms:\nfatal: Need to specify how to reconcile divergent branches.\nFix:\ngit config pull.rebase false\n# or git config pull.rebase true\n3) Local changes block pull\nSymptoms:\nerror: Your local changes ... would be overwritten by merge\nFix:\ngit stash push -m \"vm local changes\"\ngit pull origin main\ngit stash pop\nResolve conflicts if they appear.\n4) Merge conflict in config files\nFix options:\n# Keep repo version\ngit checkout --ours &lt;file&gt;\n\n# Keep local version\ngit checkout --theirs &lt;file&gt;\n5) Untracked files in the VM\nSymptoms:\n?? sequencing-app/test_detailed.R\nFix:\n\nIgnore, delete, or add to .gitignore.\n\n\n\n6.1.3 B) Apache / LDAP authentication issues\n1) Apache won’t restart after LDAP change\nSymptoms:\nAH00526: Syntax error ... Bad LDAP URL while parsing.\nFix:\nUse a single, complete LDAP URL:\nAuthLDAPURL \"ldaps://ldapserv1.biochem.mpg.de:636/dc=biochem,dc=mpg,dc=de?uid?sub?(objectClass=posixAccount)\"\n2) Invalid command ‘LDAPTLS_CACERTDIR’\nCause:\nLDAPTLS_CACERTDIR is not an Apache directive.\nFix:\nRemove from Apache config. Put TLS trust in /etc/ldap/ldap.conf instead.\n3) ldap_simple_bind() failed: Can’t contact LDAP server\nFix:\n\nCheck port:\n\nnc -vz ldapserv1.biochem.mpg.de 636\n\nTest TLS bypass:\n\nLDAPTLS_REQCERT=never ldapsearch -x -H ldaps://ldapserv1.biochem.mpg.de:636 \\\n  -b \"dc=biochem,dc=mpg,dc=de\" \"(uid=USER)\" mail\n\nFix /etc/ldap/ldap.conf:\n\nTLS_CACERTDIR /etc/ssl/certs\n4) LDAPTrustedGlobalCert error\nSymptoms:\nLDAPTrustedGlobalCert cannot occur within &lt;VirtualHost&gt; section\nFix:\nMove it to a global Apache config or comment it out (if not needed).\n\n\n6.1.4 C) SQL handling (moved)\nAll SQL database commands and explanations were moved to notes/sql-handling.qmd.\nThis includes admin promotion in LDAP mode, SQLite inspection commands, and budget holder updates.\n\n\n6.1.5 D) Switching between LDAP and local auth\nLDAP mode\nsudo systemctl edit shiny-server\n[Service]\nEnvironment=AUTH_MODE=ldap\nEnvironment=LDAP_URI=ldaps://ldapserv1.biochem.mpg.de:636,ldaps://ldapserv2.biochem.mpg.de:636,ldaps://ldapserv3.biochem.mpg.de:636\nEnvironment=LDAP_BASE_DN=dc=biochem,dc=mpg,dc=de\nLocal mode\n[Service]\nEnvironment=AUTH_MODE=local\nApply changes:\nsudo systemctl restart shiny-server\nsudo systemctl show shiny-server --property=Environment\n\n\n6.1.6 F) Apache proxy issues\n1) /sequencing-app/ returns 404\nSymptoms:\n\ncurl -Ik -u USER https://host/sequencing-app/ returns 404\ncurl -I http://localhost:3838/sequencing-app/ returns 200\n\nCause:\nConflicting ProxyPass / rules or backup config files in sites-enabled.\nFix:\n\nEnsure only these lines are active:\n\nProxyPass /sequencing-app/ http://localhost:3838/sequencing-app/\nProxyPassReverse /sequencing-app/ http://localhost:3838/sequencing-app/\n\nRemove or move backup files from /etc/apache2/sites-enabled.\nRestart Apache:\n\nsudo apache2ctl -t\nsudo systemctl restart apache2\n2) Redirect to / shows “No UI defined”\nCause:\nRoot path is not proxied correctly.\nFix:\nUse /sequencing-app/ as the app path and update redirects accordingly.\n\n\n6.1.7 G) Shiny app issues\n1) App works locally but fails via Apache\nCheck:\n\nApache logs for LDAP errors\nShiny logs for app startup errors\n\n2) LDAP mode enabled but no user\nCause:\nShiny does not receive a user identity.\nFix:\n\nUse /sequencing-app/?auth_user=&lt;user&gt; redirect fallback.\nConfirm redirect works with curl -Ik -u USER https://host/.\n\n3) Missing environment variables in Shiny\nCheck:\nsudo systemctl show shiny-server --property=Environment\nRestart after changes:\nsudo systemctl restart shiny-server\n\n\n6.1.8 H) Deployment issues\n1) Deploy script ran but app unchanged\nFix:\n\nVerify deploy.sh ran successfully.\nConfirm files in /srv/shiny-server/sequencing-app/ updated.\n\n2) Database overwritten\nFix:\n\nEnsure deploy.sh excludes sequencing_projects.db.\nKeep *.db ignored in git.\n\n\n\n6.1.9 Quick validation commands\n# Apache\nsudo apache2ctl -t\nsudo apache2ctl -S\n\n# LDAP\nldapsearch -x -H ldaps://ldapserv1.biochem.mpg.de:636 \\\n  -b \"dc=biochem,dc=mpg,dc=de\" \"(uid=USER)\" mail\n\n# App (proxy)\ncurl -Ik -u USER https://ngs-testing-vm.biochem.mpg.de/sequencing-app/\n\n# App (backend)\ncurl -I http://localhost:3838/sequencing-app/\n\n\n6.1.10 References\n\nServer_preparations.qmd\nnotes/sql-handling.qmd\nnotes/ubuntu-bare-server-setup-howto.qmd"
  },
  {
    "objectID": "chapters/ubuntu-bare-server-setup-howto.html#ubuntu-bare-server-setup-howto-shiny-ldap",
    "href": "chapters/ubuntu-bare-server-setup-howto.html#ubuntu-bare-server-setup-howto-shiny-ldap",
    "title": "7  Ubuntu Bare Server Setup HOWTO",
    "section": "7.1 Ubuntu Bare Server Setup HOWTO (Shiny + LDAP)",
    "text": "7.1 Ubuntu Bare Server Setup HOWTO (Shiny + LDAP)\n\n7.1.1 AI session restart (quick resume)\nIf I ever need to resume this work with a new AI tool or a new chat session:\n\nRead notes/vm-rollout-summary-2026-02-09.md for the current system state.\nRead notes/vm-troubleshooting-guide.md for common failures and fixes.\nRe-run the validation curl commands in the summary to confirm the stack is still working.\n\n\n\n7.1.2 1) Base OS prep\nsudo apt update\nsudo apt upgrade -y\nInstall common tools and libraries:\nsudo apt install -y \\\n  git rsync curl ca-certificates \\\n  build-essential \\\n  libcurl4-openssl-dev libssl-dev libxml2-dev \\\n  sqlite3 libsqlite3-dev \\\n  ldap-utils \\\n  apache2 apache2-utils\nIf mail sending via mailR is needed, install a Java runtime:\nsudo apt install -y default-jre\nIf LDAP-related R packages need OpenLDAP headers, install:\nsudo apt install -y libldap2-dev libsasl2-dev\n\n\n7.1.3 2) Install R\nsudo apt install -y r-base\nIf you need a newer R version than the Ubuntu default, add the CRAN repo and install from there (optional).\n\n\n7.1.4 3) Install Shiny Server\nDownload the latest Shiny Server .deb from Posit and install it:\n# Example pattern (replace filename with the current version)\n# wget https://download3.rstudio.org/ubuntu-22.04/x86_64/shiny-server-&lt;version&gt;.deb\n# sudo dpkg -i shiny-server-&lt;version&gt;.deb\n# sudo apt -f install -y\nStart and enable the service:\nsudo systemctl enable shiny-server\nsudo systemctl start shiny-server\n\n\n7.1.5 4) Clone the repo\ncd /home/&lt;your-user&gt;\ngit clone git@github.com:yeroslaviz/BCFNGS-project-management.git\n\n\n7.1.6 5) Configure the Shiny app folder\nsudo usermod -a -G shiny $USER\nsudo mv /srv/shiny-server/sequencing-app /srv/shiny-server/sequencing-app.backup 2&gt;/dev/null || true\nsudo mkdir -p /srv/shiny-server/sequencing-app\nsudo chown -R $USER:shiny /srv/shiny-server/sequencing-app\nDeploy the app files:\ncd /home/&lt;your-user&gt;/BCFNGS-project-management\n./deploy.sh\n\n\n7.1.7 6) Install required R packages\nFrom R (or R -q -e):\ninstall.packages(c(\n  \"shiny\",\n  \"shinyjs\",\n  \"DBI\",\n  \"RSQLite\",\n  \"digest\",\n  \"DT\",\n  \"shinyWidgets\",\n  \"mailR\",\n  \"ldapr\"\n))\nIf any package fails, install missing system libraries and retry.\n\n\n7.1.8 7) Configure Shiny Server environment variables\nRecommended: systemd drop-in (production-safe).\nsudo systemctl edit shiny-server\nAdd:\n[Service]\nEnvironment=AUTH_MODE=ldap\nEnvironment=LDAP_URI=ldaps://ldapserv1.biochem.mpg.de:636,ldaps://ldapserv2.biochem.mpg.de:636,ldaps://ldapserv3.biochem.mpg.de:636\nEnvironment=LDAP_BASE_DN=dc=biochem,dc=mpg,dc=de\n# Optional debug (dev only):\n# Environment=APP_ENV=dev\n# Environment=LDAP_DEBUG=1\nThen restart:\nsudo systemctl restart shiny-server\nAlternative: /home/shiny/.Renviron (simpler, less explicit).\n\n\n7.1.9 8) Configure LDAP trust (OpenLDAP client)\nEdit /etc/ldap/ldap.conf and ensure:\nBASE            dc=biochem,dc=mpg,dc=de\nURI             ldaps://ldapserv1.biochem.mpg.de ldaps://ldapserv2.biochem.mpg.de ldaps://ldapserv3.biochem.mpg.de\nTLS_REQCERT     hard\nTLS_CACERTDIR   /etc/ssl/certs\nTest:\nldapsearch -x -H ldaps://ldapserv1.biochem.mpg.de:636 \\\n  -b \"dc=biochem,dc=mpg,dc=de\" \"(uid=USER)\" mail\n\n\n7.1.10 9) Configure Apache reverse proxy + LDAP auth\nCopy the repo Apache config and enable required modules:\nsudo cp /home/&lt;your-user&gt;/BCFNGS-project-management/01-main.conf /etc/apache2/sites-enabled/01-main.conf\nsudo a2enmod proxy proxy_http proxy_wstunnel rewrite ssl headers ldap authnz_ldap\nsudo apache2ctl -t\nsudo systemctl restart apache2\n\n\n7.1.11 10) Validate the full flow\ncurl -Ik https://ngs-testing-vm.biochem.mpg.de/\n# Expect 401\n\ncurl -Ik -u USER https://ngs-testing-vm.biochem.mpg.de/\n# Expect 302 to /sequencing-app/?auth_user=USER\n\ncurl -Ik -u USER https://ngs-testing-vm.biochem.mpg.de/sequencing-app/\n# Expect 200\n\ncurl -I http://localhost:3838/sequencing-app/\n# Expect 200\n\n\n7.1.12 11) Routine updates\ncd /home/&lt;your-user&gt;/BCFNGS-project-management\ngit pull origin main\n./deploy.sh\n\n\n7.1.13 12) Production hygiene\n\nUse a service bind account if LDAP requires bind credentials.\nKeep DB files out of git.\nKeep Apache debug logs off unless diagnosing a problem.\n\n\n\n7.1.14 References\n\nnotes/vm-troubleshooting-guide.md\nServer_preparations.qmd"
  }
]