<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.315">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>NGS Sequencing App Ops Booklet - 3&nbsp; Server Preparations</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../chapters/ldap-setup-summary-2026-02-06.html" rel="next">
<link href="../chapters/quick-start.html" rel="prev">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../chapters/server-preparations.html"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Server Preparations</span></a></li></ol></nav>
        <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="../">NGS Sequencing App Ops Booklet</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Operations Booklet</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/quick-start.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Quick Start (How to run the app)</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/server-preparations.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Server Preparations</span></span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
 <span class="menu-text">Operational Notes</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/ldap-setup-summary-2026-02-06.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">LDAP Setup Summary (2026-02-06)</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/sql-handling.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">SQL Handling</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/vm-troubleshooting-guide.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">VM Troubleshooting Guide</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/ubuntu-bare-server-setup-howto.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Ubuntu Bare Server Setup HOWTO</span></span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#server-infrastructure" id="toc-server-infrastructure" class="nav-link active" data-scroll-target="#server-infrastructure"><span class="header-section-number">3.1</span> Server Infrastructure</a>
  <ul class="collapse">
  <li><a href="#sql-handling-moved" id="toc-sql-handling-moved" class="nav-link" data-scroll-target="#sql-handling-moved"><span class="header-section-number">3.1.1</span> SQL handling (moved)</a></li>
  <li><a href="#changing-hostname-to-fit-the-apache2-config-file" id="toc-changing-hostname-to-fit-the-apache2-config-file" class="nav-link" data-scroll-target="#changing-hostname-to-fit-the-apache2-config-file"><span class="header-section-number">3.1.2</span> Changing hostname to fit the apache2 config file</a></li>
  <li><a href="#automatic-start-up" id="toc-automatic-start-up" class="nav-link" data-scroll-target="#automatic-start-up"><span class="header-section-number">3.1.3</span> Automatic start-up</a></li>
  </ul></li>
  <li><a href="#monitoring" id="toc-monitoring" class="nav-link" data-scroll-target="#monitoring"><span class="header-section-number">3.2</span> Monitoring</a></li>
  <li><a href="#regular-backups" id="toc-regular-backups" class="nav-link" data-scroll-target="#regular-backups"><span class="header-section-number">3.3</span> Regular backups</a>
  <ul class="collapse">
  <li><a href="#cron-job-for-data-base-backup" id="toc-cron-job-for-data-base-backup" class="nav-link" data-scroll-target="#cron-job-for-data-base-backup"><span class="header-section-number">3.3.1</span> cron job for data base backup</a></li>
  </ul></li>
  <li><a href="#required-server-setup" id="toc-required-server-setup" class="nav-link" data-scroll-target="#required-server-setup"><span class="header-section-number">3.4</span> Required Server Setup</a></li>
  <li><a href="#github-repository" id="toc-github-repository" class="nav-link" data-scroll-target="#github-repository"><span class="header-section-number">3.5</span> Github repository</a>
  <ul class="collapse">
  <li><a href="#step-1-generate-ssh-keys" id="toc-step-1-generate-ssh-keys" class="nav-link" data-scroll-target="#step-1-generate-ssh-keys"><span class="header-section-number">3.5.1</span> Step 1: Generate SSH keys</a></li>
  <li><a href="#add-both-keys-to-the-github-repository" id="toc-add-both-keys-to-the-github-repository" class="nav-link" data-scroll-target="#add-both-keys-to-the-github-repository"><span class="header-section-number">3.5.2</span> Add both keys to the github repository</a></li>
  <li><a href="#make-sure-we-clone-using-ssh-not-html" id="toc-make-sure-we-clone-using-ssh-not-html" class="nav-link" data-scroll-target="#make-sure-we-clone-using-ssh-not-html"><span class="header-section-number">3.5.3</span> Make sure we clone using ssh (not html)</a></li>
  <li><a href="#test-and-check-the-connection" id="toc-test-and-check-the-connection" class="nav-link" data-scroll-target="#test-and-check-the-connection"><span class="header-section-number">3.5.4</span> Test and check the connection</a></li>
  <li><a href="#pullingpushing" id="toc-pullingpushing" class="nav-link" data-scroll-target="#pullingpushing"><span class="header-section-number">3.5.5</span> Pulling/Pushing</a></li>
  <li><a href="#production-rollout-checklist-quick-reference" id="toc-production-rollout-checklist-quick-reference" class="nav-link" data-scroll-target="#production-rollout-checklist-quick-reference"><span class="header-section-number">3.5.6</span> Production rollout checklist (quick reference)</a></li>
  <li><a href="#vm-rollout-howto-git-deploy-safety" id="toc-vm-rollout-howto-git-deploy-safety" class="nav-link" data-scroll-target="#vm-rollout-howto-git-deploy-safety"><span class="header-section-number">3.5.7</span> VM rollout HOW‑TO (Git + deploy + safety)</a></li>
  </ul></li>
  <li><a href="#security" id="toc-security" class="nav-link" data-scroll-target="#security"><span class="header-section-number">3.6</span> Security</a>
  <ul class="collapse">
  <li><a href="#backup-older-settings" id="toc-backup-older-settings" class="nav-link" data-scroll-target="#backup-older-settings"><span class="header-section-number">3.6.1</span> Backup older settings</a></li>
  <li><a href="#applying-for-a-new-certificate-from-mpimpg" id="toc-applying-for-a-new-certificate-from-mpimpg" class="nav-link" data-scroll-target="#applying-for-a-new-certificate-from-mpimpg"><span class="header-section-number">3.6.2</span> Applying for a new certificate from MPI/MPG</a></li>
  <li><a href="#firewall" id="toc-firewall" class="nav-link" data-scroll-target="#firewall"><span class="header-section-number">3.6.3</span> Firewall</a></li>
  </ul></li>
  <li><a href="#change-connection-to-shiny-server-folder-to-https" id="toc-change-connection-to-shiny-server-folder-to-https" class="nav-link" data-scroll-target="#change-connection-to-shiny-server-folder-to-https"><span class="header-section-number">3.7</span> Change connection to shiny server folder to https</a></li>
  <li><a href="#changes-on-13.02.2026" id="toc-changes-on-13.02.2026" class="nav-link" data-scroll-target="#changes-on-13.02.2026"><span class="header-section-number">3.8</span> Changes on 13.02.2026</a></li>
  <li><a href="#changes-on-12.02.2026" id="toc-changes-on-12.02.2026" class="nav-link" data-scroll-target="#changes-on-12.02.2026"><span class="header-section-number">3.9</span> Changes on 12.02.2026</a></li>
  <li><a href="#changes-on-11.02.2026" id="toc-changes-on-11.02.2026" class="nav-link" data-scroll-target="#changes-on-11.02.2026"><span class="header-section-number">3.10</span> Changes on 11.02.2026</a></li>
  <li><a href="#changes-on-09.02.2026" id="toc-changes-on-09.02.2026" class="nav-link" data-scroll-target="#changes-on-09.02.2026"><span class="header-section-number">3.11</span> Changes on 09.02.2026</a>
  <ul class="collapse">
  <li><a href="#vm-rollout-validation-what-i-tested-and-confirmed" id="toc-vm-rollout-validation-what-i-tested-and-confirmed" class="nav-link" data-scroll-target="#vm-rollout-validation-what-i-tested-and-confirmed"><span class="header-section-number">3.11.1</span> VM rollout validation (what I tested and confirmed)</a></li>
  </ul></li>
  <li><a href="#possible-errors-and-fixes-vm-ldap-rollout" id="toc-possible-errors-and-fixes-vm-ldap-rollout" class="nav-link" data-scroll-target="#possible-errors-and-fixes-vm-ldap-rollout"><span class="header-section-number">3.12</span> Possible errors and fixes (VM LDAP rollout)</a>
  <ul class="collapse">
  <li><a href="#apache-wont-restart-after-ldap-change" id="toc-apache-wont-restart-after-ldap-change" class="nav-link" data-scroll-target="#apache-wont-restart-after-ldap-change"><span class="header-section-number">3.12.1</span> 1) Apache won’t restart after LDAP change</a></li>
  <li><a href="#ldaptls_cacertdir-breaks-apache" id="toc-ldaptls_cacertdir-breaks-apache" class="nav-link" data-scroll-target="#ldaptls_cacertdir-breaks-apache"><span class="header-section-number">3.12.2</span> 2) <code>LDAPTLS_CACERTDIR</code> breaks Apache</a></li>
  <li><a href="#ldap-login-shows-500-internal-server-error" id="toc-ldap-login-shows-500-internal-server-error" class="nav-link" data-scroll-target="#ldap-login-shows-500-internal-server-error"><span class="header-section-number">3.12.3</span> 3) LDAP login shows 500 Internal Server Error</a></li>
  <li><a href="#shiny-app-runs-locally-but-crashes-via-apache" id="toc-shiny-app-runs-locally-but-crashes-via-apache" class="nav-link" data-scroll-target="#shiny-app-runs-locally-but-crashes-via-apache"><span class="header-section-number">3.12.4</span> 4) Shiny app runs locally but crashes via Apache</a></li>
  <li><a href="#ldap-works-but-sequencing-app-returns-404" id="toc-ldap-works-but-sequencing-app-returns-404" class="nav-link" data-scroll-target="#ldap-works-but-sequencing-app-returns-404"><span class="header-section-number">3.12.5</span> 5) LDAP works, but <code>/sequencing-app/</code> returns 404</a></li>
  <li><a href="#debug-logging-too-noisy-apache-or-shiny" id="toc-debug-logging-too-noisy-apache-or-shiny" class="nav-link" data-scroll-target="#debug-logging-too-noisy-apache-or-shiny"><span class="header-section-number">3.12.6</span> 6) Debug logging too noisy (Apache or Shiny)</a></li>
  <li><a href="#comprehensive-errorchecking-checklist-vm-ldap-shiny" id="toc-comprehensive-errorchecking-checklist-vm-ldap-shiny" class="nav-link" data-scroll-target="#comprehensive-errorchecking-checklist-vm-ldap-shiny"><span class="header-section-number">3.12.7</span> Comprehensive error‑checking checklist (VM LDAP + Shiny)</a></li>
  </ul></li>
  <li><a href="#changes-on-06.02.2026" id="toc-changes-on-06.02.2026" class="nav-link" data-scroll-target="#changes-on-06.02.2026"><span class="header-section-number">3.13</span> Changes on 06.02.2026</a></li>
  <li><a href="#changes-on-14.11.2026" id="toc-changes-on-14.11.2026" class="nav-link" data-scroll-target="#changes-on-14.11.2026"><span class="header-section-number">3.14</span> Changes on 14.11.2026</a></li>
  <li><a href="#ssl-certificate-for-https" id="toc-ssl-certificate-for-https" class="nav-link" data-scroll-target="#ssl-certificate-for-https"><span class="header-section-number">3.15</span> SSL Certificate (for HTTPS)</a></li>
  <li><a href="#ldap" id="toc-ldap" class="nav-link" data-scroll-target="#ldap"><span class="header-section-number">3.16</span> LDAP</a>
  <ul class="collapse">
  <li><a href="#admin-access-in-ldap-mode-vm" id="toc-admin-access-in-ldap-mode-vm" class="nav-link" data-scroll-target="#admin-access-in-ldap-mode-vm"><span class="header-section-number">3.16.1</span> Admin access in LDAP mode (VM)</a></li>
  <li><a href="#switch-between-ldap-and-local-modes-vm" id="toc-switch-between-ldap-and-local-modes-vm" class="nav-link" data-scroll-target="#switch-between-ldap-and-local-modes-vm"><span class="header-section-number">3.16.2</span> Switch between LDAP and local modes (VM)</a></li>
  <li><a href="#local-dev-testing-ldap-mode" id="toc-local-dev-testing-ldap-mode" class="nav-link" data-scroll-target="#local-dev-testing-ldap-mode"><span class="header-section-number">3.16.3</span> Local dev testing (LDAP mode)</a></li>
  <li><a href="#how-i-run-the-app-locally-my-notes" id="toc-how-i-run-the-app-locally-my-notes" class="nav-link" data-scroll-target="#how-i-run-the-app-locally-my-notes"><span class="header-section-number">3.16.4</span> How I run the app locally (my notes)</a></li>
  <li><a href="#budget-holder-auto-assignment-first-login" id="toc-budget-holder-auto-assignment-first-login" class="nav-link" data-scroll-target="#budget-holder-auto-assignment-first-login"><span class="header-section-number">3.16.5</span> Budget holder auto-assignment (first login)</a></li>
  </ul></li>
  <li><a href="#obsolete-now-wrong-kept-for-reference" id="toc-obsolete-now-wrong-kept-for-reference" class="nav-link" data-scroll-target="#obsolete-now-wrong-kept-for-reference"><span class="header-section-number">3.17</span> Obsolete / now wrong (kept for reference)</a>
  <ul class="collapse">
  <li><a href="#legacy-environment-variable-location-no-longer-used" id="toc-legacy-environment-variable-location-no-longer-used" class="nav-link" data-scroll-target="#legacy-environment-variable-location-no-longer-used"><span class="header-section-number">3.17.1</span> Legacy environment variable location (no longer used)</a></li>
  <li><a href="#legacy-folder-layout-varshiny-server" id="toc-legacy-folder-layout-varshiny-server" class="nav-link" data-scroll-target="#legacy-folder-layout-varshiny-server"><span class="header-section-number">3.17.2</span> Legacy folder layout (/var/shiny-server)</a></li>
  <li><a href="#legacy-install-steps-nginx-based-superseded-by-apache-setup" id="toc-legacy-install-steps-nginx-based-superseded-by-apache-setup" class="nav-link" data-scroll-target="#legacy-install-steps-nginx-based-superseded-by-apache-setup"><span class="header-section-number">3.17.3</span> Legacy install steps (nginx-based, superseded by Apache setup)</a></li>
  <li><a href="#legacy-apache-config-old-proxypass-path" id="toc-legacy-apache-config-old-proxypass-path" class="nav-link" data-scroll-target="#legacy-apache-config-old-proxypass-path"><span class="header-section-number">3.17.4</span> Legacy Apache config (old ProxyPass / path)</a></li>
  <li><a href="#legacy-deployment-script-name" id="toc-legacy-deployment-script-name" class="nav-link" data-scroll-target="#legacy-deployment-script-name"><span class="header-section-number">3.17.5</span> Legacy deployment script name</a></li>
  <li><a href="#legacy-tree-output-old-vm-layout-example" id="toc-legacy-tree-output-old-vm-layout-example" class="nav-link" data-scroll-target="#legacy-tree-output-old-vm-layout-example"><span class="header-section-number">3.17.6</span> Legacy tree output (old VM layout example)</a></li>
  <li><a href="#legacy-git-pull-via-https-pat-no-longer-used" id="toc-legacy-git-pull-via-https-pat-no-longer-used" class="nav-link" data-scroll-target="#legacy-git-pull-via-https-pat-no-longer-used"><span class="header-section-number">3.17.7</span> Legacy git pull via HTTPS + PAT (no longer used)</a></li>
  <li><a href="#legacy-note-dedicated-user-superseded" id="toc-legacy-note-dedicated-user-superseded" class="nav-link" data-scroll-target="#legacy-note-dedicated-user-superseded"><span class="header-section-number">3.17.8</span> Legacy note: dedicated user (superseded)</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Server Preparations</span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>

<section id="server-infrastructure" class="level2" data-number="3.1">
<h2 data-number="3.1" class="anchored" data-anchor-id="server-infrastructure"><span class="header-section-number">3.1</span> Server Infrastructure</h2>
<section id="sql-handling-moved" class="level3" data-number="3.1.1">
<h3 data-number="3.1.1" class="anchored" data-anchor-id="sql-handling-moved"><span class="header-section-number">3.1.1</span> SQL handling (moved)</h3>
<p>All SQL database commands and explanations were moved to <strong><code>notes/sql-handling.qmd</code></strong>.<br>
This includes:</p>
<ul>
<li>DB rebuild procedure</li>
<li>Admin user promotion in LDAP mode</li>
<li>Budget holder updates (CSV vs DB)</li>
<li>SQLite inspection and maintenance commands ### Install required system dependencies</li>
</ul>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> apt install <span class="at">-y</span> libssl-dev libxml2-dev libcurl4-openssl-dev libudunits2-dev libgdal-dev</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="changing-hostname-to-fit-the-apache2-config-file" class="level3" data-number="3.1.2">
<h3 data-number="3.1.2" class="anchored" data-anchor-id="changing-hostname-to-fit-the-apache2-config-file"><span class="header-section-number">3.1.2</span> Changing hostname to fit the apache2 config file</h3>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Change the hostname</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> hostnamectl set-hostname ngs-testing-vm.biochem.mpg.de</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Verify the change</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="ex">hostnamectl</span> status</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="ex">nslookup</span> ngs-testing-vm.biochem.mpg.de</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ping</span> ngs-testing-vm.biochem.mpg.de</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<pre><code>Server:     127.0.0.53
Address:    127.0.0.53#53

Non-authoritative answer:
Name:   ngs-testing-vm.biochem.mpg.de
Address: 10.33.0.60

PING ngs-testing-vm.biochem.mpg.de (10.33.0.60) 56(84) bytes of data.
64 bytes from ngs-testing-vm.biochem.mpg.de (10.33.0.60): icmp_seq=1 ttl=64 time=0.079 ms
64 bytes from ngs-testing-vm.biochem.mpg.de (10.33.0.60): icmp_seq=2 ttl=64 time=0.074 ms</code></pre>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> systemctl restart apache2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="automatic-start-up" class="level3" data-number="3.1.3">
<h3 data-number="3.1.3" class="anchored" data-anchor-id="automatic-start-up"><span class="header-section-number">3.1.3</span> Automatic start-up</h3>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> systemctl enable apache2</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> systemctl enable shiny-server</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
</section>
<section id="monitoring" class="level2" data-number="3.2">
<h2 data-number="3.2" class="anchored" data-anchor-id="monitoring"><span class="header-section-number">3.2</span> Monitoring</h2>
<p>The shiny app server writes log files specific with date and time in the <code>/var/log/shiny-server</code> folder.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Monitor Shiny Server logs</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> tail <span class="at">-f</span> /var/log/shiny-server/sequencing-app<span class="pp">*</span>.log</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Monitor Apache logs</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> tail <span class="at">-f</span> /var/log/apache2/sequencing-app-error.log</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="regular-backups" class="level2" data-number="3.3">
<h2 data-number="3.3" class="anchored" data-anchor-id="regular-backups"><span class="header-section-number">3.3</span> Regular backups</h2>
<p>The VM is regularly back-up every night. The SQL database backup setting are in the script, but for now commented out, as we’re not in productive version.</p>
<section id="cron-job-for-data-base-backup" class="level3" data-number="3.3.1">
<h3 data-number="3.3.1" class="anchored" data-anchor-id="cron-job-for-data-base-backup"><span class="header-section-number">3.3.1</span> cron job for data base backup</h3>
<p>If needed, we can also set up a cron job to backup the data base</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Create backup script</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> tee /usr/local/bin/backup_sequencing_db.sh <span class="op">&lt;&lt;'EOF'</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="st">#!/bin/bash</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="st">TIMESTAMP=$(date +%Y%m%d_%H%M%S)</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="st">BACKUP_DIR="/var/backups/sequencing-app"</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="st">mkdir -p $BACKUP_DIR</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a><span class="st">cp /srv/shiny-server/sequencing-app/sequencing_projects.db $BACKUP_DIR/sequencing_projects.db.$TIMESTAMP</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a><span class="st"># Keep only last 30 days of backups</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a><span class="st">find $BACKUP_DIR -name "sequencing_projects.db.*" -mtime +30 -delete</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a><span class="op">EOF</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> chmod +x /usr/local/bin/backup_sequencing_db.sh</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Add to crontab for daily backups at 2 AM</span></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> crontab <span class="at">-l</span> <span class="kw">|</span> <span class="kw">{</span> <span class="fu">cat</span><span class="kw">;</span> <span class="bu">echo</span> <span class="st">"0 2 * * * /usr/local/bin/backup_sequencing_db.sh"</span><span class="kw">;</span> <span class="kw">}</span> <span class="kw">|</span> <span class="fu">sudo</span> crontab <span class="at">-</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
</section>
<section id="required-server-setup" class="level2" data-number="3.4">
<h2 data-number="3.4" class="anchored" data-anchor-id="required-server-setup"><span class="header-section-number">3.4</span> Required Server Setup</h2>
<pre><code>/srv/shiny-server/
├── sequencing-app/
│ ├── app.R
│ ├── setup_database.R
│ ├── sequencing_projects.db
│ └── www/
  │ ├── logo.png
  │ └── minerva.png</code></pre>
</section>
<section id="github-repository" class="level2" data-number="3.5">
<h2 data-number="3.5" class="anchored" data-anchor-id="github-repository"><span class="header-section-number">3.5</span> Github repository</h2>
<section id="step-1-generate-ssh-keys" class="level3" data-number="3.5.1">
<h3 data-number="3.5.1" class="anchored" data-anchor-id="step-1-generate-ssh-keys"><span class="header-section-number">3.5.1</span> Step 1: Generate SSH keys</h3>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="co"># on the local machine (mac mini at work!!!)</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> ~/.ssh/</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="fu">ssh-keygen</span> <span class="at">-t</span> ed25519 <span class="at">-C</span> <span class="st">"yeroslaviz@biochem.mpg.de"</span> <span class="at">-f</span> ngs-testing-vm.id_macMini_rsa</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a><span class="co"># on the VM</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> ~/.ssh/</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a><span class="fu">ssh-keygen</span> <span class="at">-t</span> ed25519 <span class="at">-C</span> <span class="st">"yeroslaviz@biochem.mpg.de"</span> <span class="at">-f</span> ngs-testing-vm.id_rsa</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>If agent needs to be activated</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="bu">eval</span> <span class="st">"</span><span class="va">$(</span><span class="fu">ssh-agent</span> <span class="at">-s</span><span class="va">)</span><span class="st">"</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ssh-add</span> ~/.ssh/ngs-testing-vm.id_rsa <span class="co"># or the name of the local key</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="add-both-keys-to-the-github-repository" class="level3" data-number="3.5.2">
<h3 data-number="3.5.2" class="anchored" data-anchor-id="add-both-keys-to-the-github-repository"><span class="header-section-number">3.5.2</span> Add both keys to the github repository</h3>
<p>Copy for each of the two keys the <code>*pub</code> version and add it under <code>Settings → SSH and GPG keys → New SSH key</code>.</p>
</section>
<section id="make-sure-we-clone-using-ssh-not-html" class="level3" data-number="3.5.3">
<h3 data-number="3.5.3" class="anchored" data-anchor-id="make-sure-we-clone-using-ssh-not-html"><span class="header-section-number">3.5.3</span> Make sure we clone using ssh (not html)</h3>
<p>First test if the connection exists already.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> remote <span class="at">-v</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>If the result is</p>
<pre><code>origin  https://github.com/username/repository.git (fetch)
origin  https://github.com/username/repository.git (push)</code></pre>
<p>it must be changed to ssh</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> remote set-url origin git@github.com:username/repository.git</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>If we see</p>
<pre><code>origin  git@github.com:yeroslaviz/BCFNGS-project-management.git (fetch)
origin  git@github.com:yeroslaviz/BCFNGS-project-management.git (push)</code></pre>
<p>then we already use ssh.</p>
</section>
<section id="test-and-check-the-connection" class="level3" data-number="3.5.4">
<h3 data-number="3.5.4" class="anchored" data-anchor-id="test-and-check-the-connection"><span class="header-section-number">3.5.4</span> Test and check the connection</h3>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ssh</span> <span class="at">-T</span> git@github.com</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>this should return something like</p>
<pre><code>Hi yeroslaviz! You've successfully authenticated, but GitHub does not provide shell access.</code></pre>
</section>
<section id="pullingpushing" class="level3" data-number="3.5.5">
<h3 data-number="3.5.5" class="anchored" data-anchor-id="pullingpushing"><span class="header-section-number">3.5.5</span> Pulling/Pushing</h3>
<p>the repository can be managed from the path <code>/home/yeroslaviz/BCFNGS-project-management</code> (the VM path is mentioned here).</p>
<p>inside the Folder we can pull/push the changes we made to the repo from the local computer (AT WORK!!!).</p>
<p>the github repository on the local computer is at <code>/Users/yeroslaviz/Documents/Github/BCFNGS-project-management</code>.</p>
<p>To redeploy the server, one follows the following steps:</p>
<ol type="1">
<li>make the changes on the local computer (AT WORK!!!).</li>
<li><strong>commit</strong> and <strong>push</strong> the changes to the github repo</li>
<li>go to the folder <code>/home/yeroslaviz/BCFNGS-project-management</code> on the VM <code>ngs-testing-vm</code> and pull the changes.</li>
<li>Execute the <code>deploy.sh</code> script to copy the new changes to the shiny-server folder and restart both apache2 and the shiny-server.</li>
</ol>
</section>
<section id="production-rollout-checklist-quick-reference" class="level3" data-number="3.5.6">
<h3 data-number="3.5.6" class="anchored" data-anchor-id="production-rollout-checklist-quick-reference"><span class="header-section-number">3.5.6</span> Production rollout checklist (quick reference)</h3>
<p>This is the short checklist I use on production. Details for each step are below in the VM rollout HOW‑TO section.</p>
<ol type="1">
<li>Confirm GitHub access and pull latest code.</li>
</ol>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ssh</span> <span class="at">-T</span> git@github.com</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> /home/yeroslaviz/BCFNGS-project-management</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> pull origin main</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<ol start="2" type="1">
<li>Take backups (app folder, SQLite DB, Apache config).</li>
</ol>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> rsync <span class="at">-av</span> /srv/shiny-server/sequencing-app/ /srv/shiny-server/sequencing-app.backup_<span class="va">$(</span><span class="fu">date</span> +%Y%m%d_%H%M<span class="va">)</span>/</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cp</span> /srv/shiny-server/sequencing-app/sequencing_projects.db <span class="dt">\</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>  /srv/shiny-server/sequencing_projects.db.backup_<span class="va">$(</span><span class="fu">date</span> +%Y%m%d_%H%M<span class="va">)</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> cp /etc/apache2/sites-enabled/01-main.conf <span class="dt">\</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>  /etc/apache2/sites-enabled/01-main.conf.backup_<span class="va">$(</span><span class="fu">date</span> +%Y%m%d_%H%M<span class="va">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<ol start="3" type="1">
<li>Deploy.</li>
</ol>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="ex">./deploy.sh</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<ol start="4" type="1">
<li>Restart services.</li>
</ol>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> systemctl restart shiny-server</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> systemctl restart apache2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<ol start="5" type="1">
<li>Smoke‑test login and app behavior.</li>
</ol>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="ex">curl</span> <span class="at">-Ik</span> https://ngs-testing-vm.biochem.mpg.de/</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="ex">curl</span> <span class="at">-Ik</span> <span class="at">-u</span> USER https://ngs-testing-vm.biochem.mpg.de/</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="ex">curl</span> <span class="at">-Ik</span> <span class="at">-u</span> USER https://ngs-testing-vm.biochem.mpg.de/sequencing-app/</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<ol start="6" type="1">
<li>Roll back from backups if needed.</li>
</ol>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> rsync <span class="at">-av</span> <span class="at">--delete</span> /srv/shiny-server/sequencing-app.backup_YYYYMMDD_HHMM/ /srv/shiny-server/sequencing-app/</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> systemctl restart shiny-server</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> systemctl restart apache2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="vm-rollout-howto-git-deploy-safety" class="level3" data-number="3.5.7">
<h3 data-number="3.5.7" class="anchored" data-anchor-id="vm-rollout-howto-git-deploy-safety"><span class="header-section-number">3.5.7</span> VM rollout HOW‑TO (Git + deploy + safety)</h3>
<p>This is the repeatable checklist I use when rolling out to a VM (first <code>ngs-testing-vm</code>, then <code>ngs-vm</code>).</p>
<section id="make-sure-github-access-works-on-the-vm" class="level4" data-number="3.5.7.1">
<h4 data-number="3.5.7.1" class="anchored" data-anchor-id="make-sure-github-access-works-on-the-vm"><span class="header-section-number">3.5.7.1</span> 1) Make sure GitHub access works on the VM</h4>
<p>Check which remote is set:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> <span class="at">-C</span> /home/yeroslaviz/BCFNGS-project-management remote <span class="at">-v</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>If the remote is SSH (<code>git@github.com:...</code>), verify SSH access:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ssh</span> <span class="at">-T</span> git@github.com</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>If SSH works but <code>git pull</code> still says <strong>Permission denied (publickey)</strong>, the VM key is <strong>not added</strong> to the repo. The fix is to add the VM public key as a <strong>Deploy Key</strong>:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span> ~/.ssh/id_ed25519.pub</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Then add that key in GitHub: <code>Repo → Settings → Deploy keys → Add deploy key</code> (read‑only is enough for pull).</p>
</section>
<section id="pull-latest-code" class="level4" data-number="3.5.7.2">
<h4 data-number="3.5.7.2" class="anchored" data-anchor-id="pull-latest-code"><span class="header-section-number">3.5.7.2</span> 2) Pull latest code</h4>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> /home/yeroslaviz/BCFNGS-project-management</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> pull origin main</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>If Git says <strong>divergent branches</strong>, I set merge as the default and pull again:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> config pull.rebase false</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> pull origin main</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>If Git refuses because of the local SQLite DB file, I stop tracking the DB on the VM:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> rm <span class="at">--cached</span> sequencing-app/sequencing_projects.db</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> commit <span class="at">-m</span> <span class="st">"Stop tracking local SQLite DB on VM"</span></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> pull origin main</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>This does <strong>not</strong> delete the local DB file. It just removes it from Git so future pulls work.</p>
</section>
<section id="production-safety-backups-fast-rollback" class="level4" data-number="3.5.7.3">
<h4 data-number="3.5.7.3" class="anchored" data-anchor-id="production-safety-backups-fast-rollback"><span class="header-section-number">3.5.7.3</span> 3) Production safety backups (fast rollback)</h4>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> rsync <span class="at">-av</span> /srv/shiny-server/sequencing-app/ /srv/shiny-server/sequencing-app.backup_<span class="va">$(</span><span class="fu">date</span> +%Y%m%d_%H%M<span class="va">)</span>/</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cp</span> /srv/shiny-server/sequencing-app/sequencing_projects.db <span class="dt">\</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>  /srv/shiny-server/sequencing-app/sequencing_projects.db.backup_<span class="va">$(</span><span class="fu">date</span> +%Y%m%d_%H%M<span class="va">)</span></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> cp /etc/apache2/sites-enabled/01-main.conf <span class="dt">\</span></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>  /etc/apache2/sites-enabled/01-main.conf.backup_<span class="va">$(</span><span class="fu">date</span> +%Y%m%d_%H%M<span class="va">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="deploy" class="level4" data-number="3.5.7.4">
<h4 data-number="3.5.7.4" class="anchored" data-anchor-id="deploy"><span class="header-section-number">3.5.7.4</span> 4) Deploy</h4>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="ex">./deploy.sh</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="restart-and-smoketest" class="level4" data-number="3.5.7.5">
<h4 data-number="3.5.7.5" class="anchored" data-anchor-id="restart-and-smoketest"><span class="header-section-number">3.5.7.5</span> 5) Restart and smoke‑test</h4>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> systemctl restart shiny-server</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> systemctl restart apache2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Then open the app URL and verify: - LDAP prompt appears - login works - app loads</p>
</section>
<section id="rollback-if-needed" class="level4" data-number="3.5.7.6">
<h4 data-number="3.5.7.6" class="anchored" data-anchor-id="rollback-if-needed"><span class="header-section-number">3.5.7.6</span> 6) Rollback (if needed)</h4>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> rsync <span class="at">-av</span> <span class="at">--delete</span> /srv/shiny-server/sequencing-app.backup_YYYYMMDD_HHMM/ /srv/shiny-server/sequencing-app/</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> systemctl restart shiny-server</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> systemctl restart apache2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
</section>
</section>
<section id="security" class="level2" data-number="3.6">
<h2 data-number="3.6" class="anchored" data-anchor-id="security"><span class="header-section-number">3.6</span> Security</h2>
<p>Not sure, if this is all necessary, will consult the IT when it is appropriate</p>
<section id="backup-older-settings" class="level3" data-number="3.6.1">
<h3 data-number="3.6.1" class="anchored" data-anchor-id="backup-older-settings"><span class="header-section-number">3.6.1</span> Backup older settings</h3>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Backup your current configuration</span></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> cp /etc/apache2/sites-enabled/01-main.conf /etc/apache2/sites-enabled/01-main.conf.backup</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Remove old SSL certificates (optional - keep for backup)</span></span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> mkdir <span class="at">-p</span> /etc/ssl/backup/</span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> mv /etc/ssl/certs/<span class="pp">********</span>.pem /etc/ssl/backup/</span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> mv /etc/ssl/private/<span class="pp">********</span>.pem /etc/ssl/backup/</span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> mv /etc/apache2/certificate/<span class="pp">********</span>.cer /etc/ssl/backup/</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<pre><code>./
├── 01-main.conf -&gt; ../sites-available/default-ssl.conf
├── 01-main.conf.backup
├── 02-testing.conf -&gt; ../sites-available/02-testing.conf
└── auth_ldap.conf -&gt; ../sites-available/auth_ldap.conf</code></pre>
</section>
<section id="applying-for-a-new-certificate-from-mpimpg" class="level3" data-number="3.6.2">
<h3 data-number="3.6.2" class="anchored" data-anchor-id="applying-for-a-new-certificate-from-mpimpg"><span class="header-section-number">3.6.2</span> Applying for a new certificate from MPI/MPG</h3>
<p>The new setting of the certificates. I have three files.</p>
<p>The private key I created when applying for the certificate. The other two were downloaded, when the emial came from Harica (the certificate provider).</p>
<p>the <code>PEM</code> is the pem file and the <code>DER (issuer)</code> is the chain file. Both of them are needed.</p>
<p>Setting for the readability of the files:</p>
<pre><code>cd /etc/apache2/certificate/2026
-rw------- 1 yeroslaviz b_mcf 3272 Nov 10 15:58 private-key.pem # udo chmod 600 /path/to/private.key  # Readable only by root
-rw-r--r-- 1 yeroslaviz b_mcf 1545 Nov 14 12:12 NGS_2026_Issuer_ChainFile.cer # sudo chmod 644 /path/to/chain.crt  # Readable by all
-rw-r--r-- 1 yeroslaviz b_mcf 2796 Nov 14 12:34 NGS_2026_Cert.pem # sudo chmod 644 /path/to/certificate.crt # Readable by all</code></pre>
<p>All the files are saved under <code>/etc/apache2/certificate/2026</code>.</p>
<p>Now I created soft links for each of these files.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> ln <span class="at">-s</span> /etc/apache2/certificate/2026/private-key.pem /etc/ssl/private/2026_private-key.pem</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> ln <span class="at">-s</span> /etc/apache2/certificate/2026/NGS_2026_Cert.pem /etc/ssl/certs/2026_NGS_Cert.pem</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="firewall" class="level3" data-number="3.6.3">
<h3 data-number="3.6.3" class="anchored" data-anchor-id="firewall"><span class="header-section-number">3.6.3</span> Firewall</h3>
<p>at the moment is not active, but maybe in the future.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> ufw allow 3838</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> ufw allow 80</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> ufw allow 443</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
</section>
<section id="change-connection-to-shiny-server-folder-to-https" class="level2" data-number="3.7">
<h2 data-number="3.7" class="anchored" data-anchor-id="change-connection-to-shiny-server-folder-to-https"><span class="header-section-number">3.7</span> Change connection to shiny server folder to https</h2>
<p>The shiny app takes information from the config file under <code>/etc/shiny-server/shiny-server.conf</code>. Here we can see where the log files are written into and where the directory of the shiny app are stored.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> usermod <span class="at">-a</span> <span class="at">-G</span> shiny <span class="va">$USER</span> <span class="co"># add user yeroslaviz to group shiny</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> chown <span class="at">-R</span> <span class="va">$USER</span>:shiny sequencing-app/ <span class="co"># make group shiny able to execute the scripts in the folder</span></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> mv /srv/shiny-server/sequencing-app/ /srv/shiny-server/sequencing-app.backup <span class="co"># move the actual hard-coded folder to a backup (just in case)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>The sequencing-app folder must be copied to the correct place after each modification was done and the new files were pulled to the VM.</p>
<p>For that I have created a script called <code>deploy.sh</code>. The script synchronizes the files from the github repo folder <code>/home/yeroslaviz/BCFNGS-project-management/sequencing-app/</code> to where the Shiny app needs them to be: <code>/srv/shiny-server/sequencing-app/</code>.</p>
<p>The deploy script must be activated when loaded</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="fu">chmod</span> +x deploy.sh</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>The deploy.sh script uses <code>rsync</code> and <strong>excludes</strong> <code>sequencing_projects.db</code> so the production database is not overwritten during deploys.</p>
<p>If <code>rsync</code> is not installed on the VM:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> apt install <span class="at">-y</span> rsync</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>It then resets permissions for all files (the DB file remains in place and keeps its permissions).</p>
<p>When this is done, it restart the shiny server.</p>
<p><strong>This script must be run each time the files inside the sequencing-app folder were changed</strong>, but not if other changed were made in the repo.</p>
<p><strong>Rule of thumb after <code>git pull</code>:</strong></p>
<ul>
<li><strong>Run <code>./deploy.sh</code></strong> if anything under <code>sequencing-app/</code> changed (e.g.&nbsp;<code>app.R</code>, <code>setup_database.R</code>, CSS, images).</li>
<li><strong>Skip <code>./deploy.sh</code></strong> if only docs changed (<code>.qmd</code>, <code>.md</code>, <code>notes/</code>) or other non‑app files.</li>
</ul>
</section>
<section id="changes-on-13.02.2026" class="level2" data-number="3.8">
<h2 data-number="3.8" class="anchored" data-anchor-id="changes-on-13.02.2026"><span class="header-section-number">3.8</span> Changes on 13.02.2026</h2>
<ol type="1">
<li>New project emails now <strong>prefix the subject with the project ID</strong> (e.g., <code>P2 - ...</code>).</li>
<li>Project description (if provided) is appended to the email body.</li>
<li>Email recipients changed to <strong>budget holder + project creator + <code>ngs@biochem.mpg.de</code></strong>.<br>
Admin broadcast is retained in the code but <strong>commented out</strong> for easy rollback.</li>
<li>Notes were converted from <code>.md</code> to <code>.qmd</code> with a consistent header template, and the booklet generator now reads the <code>.qmd</code> sources.</li>
</ol>
</section>
<section id="changes-on-12.02.2026" class="level2" data-number="3.9">
<h2 data-number="3.9" class="anchored" data-anchor-id="changes-on-12.02.2026"><span class="header-section-number">3.9</span> Changes on 12.02.2026</h2>
<ol type="1">
<li>Fixed LDAP URL impersonation risk by enforcing canonical <code>auth_user</code> handling in Apache: tampered <code>?auth_user=</code> values are rewritten to the authenticated LDAP user.</li>
<li>Fixed redirect-loop behavior in the Apache auth rewrite logic and validated canonical redirect behavior with <code>curl</code> (expected <code>302</code> to the authenticated user).</li>
<li>Confirmed and documented required shiny-server environment for LDAP mode:
<ul>
<li><code>AUTH_MODE=ldap</code></li>
<li><code>TRUST_PROXY_AUTH_USER_QUERY=1</code></li>
</ul></li>
<li>Extended <code>deploy.sh</code> with post-deploy LDAP smoke tests (canonical redirect, tampered query rewrite, final <code>200</code> response) and actionable failure hints.</li>
<li>Added/merged troubleshooting guidance for LDAP login failures, disconnects, and redirect loops into the VM troubleshooting documentation.</li>
<li>Improved Projects table readability in the Shiny UI (<code>sequencing-app/app.R</code>):
<ul>
<li>explicit DT column widths</li>
<li>wrapped long cell text</li>
<li>reliable column reflow on tab switch and resize</li>
<li>preserved horizontal scrolling and existing formatting.</li>
</ul></li>
</ol>
</section>
<section id="changes-on-11.02.2026" class="level2" data-number="3.10">
<h2 data-number="3.10" class="anchored" data-anchor-id="changes-on-11.02.2026"><span class="header-section-number">3.10</span> Changes on 11.02.2026</h2>
<ol type="1">
<li>Added a production rollout checklist with the exact commands for pull, backup, deploy, restart, and smoke‑tests.</li>
<li>Added a dedicated section for <strong>admin access in LDAP mode</strong> (pre‑create vs promote after first login).</li>
<li>Added a dedicated section on <strong>switching between LDAP and local auth</strong> on the VM (<code>AUTH_MODE</code> via systemd override).</li>
<li>Added the full <strong>pre‑create admin</strong> example that includes <code>password</code>/<code>email</code> for NOT NULL constraints.</li>
<li>Updated the canonical server path to <code>/srv/shiny-server</code> and corrected repo path on the local machine.</li>
<li>Moved legacy/obsolete content to the end of the document under <strong>Obsolete / now wrong</strong>.</li>
<li>Replaced the old deploy script reference (<code>deploy_shiny_server.sh</code>) with <code>deploy.sh</code>.</li>
</ol>
</section>
<section id="changes-on-09.02.2026" class="level2" data-number="3.11">
<h2 data-number="3.11" class="anchored" data-anchor-id="changes-on-09.02.2026"><span class="header-section-number">3.11</span> Changes on 09.02.2026</h2>
<ol type="1">
<li>Added a VM rollout HOW‑TO (GitHub SSH/deploy keys, divergent branches, DB tracking fix, backups, deploy, restart, rollback).</li>
<li>Documented production safeguards (app folder backup, DB backup, Apache config backup).</li>
<li>Updated <code>deploy.sh</code> to restart Shiny only if <code>rsync</code> succeeds (prevents restarts on failed deploys).</li>
<li>Cleaned up Apache LDAP logging (default to quiet logs; debug only when explicitly enabled).</li>
<li>Made LDAP debug output in the Shiny app conditional on <strong>both</strong> <code>APP_ENV=dev</code> and <code>LDAP_DEBUG=1</code> to avoid production log noise.</li>
<li>Documented the VM LDAP validation test (real user + service group user, and email routing behavior).</li>
</ol>
<section id="vm-rollout-validation-what-i-tested-and-confirmed" class="level3" data-number="3.11.1">
<h3 data-number="3.11.1" class="anchored" data-anchor-id="vm-rollout-validation-what-i-tested-and-confirmed"><span class="header-section-number">3.11.1</span> VM rollout validation (what I tested and confirmed)</h3>
<p>I verified end‑to‑end behavior on the VM after fixing the Apache proxy path:</p>
<ul>
<li><strong>LDAP login works</strong>: the browser prompts for username/password and redirects to <code>/sequencing-app/?auth_user=&lt;user&gt;</code>.</li>
<li><strong>User mapping works</strong>: <code>yeroslaviz</code> (OU contains Cox) is mapped to the <strong>Cox</strong> group and the correct PI.</li>
<li><strong>User mapping works</strong>: <code>yeroslaviz-test</code> (OU = <strong>NGS Facility</strong>) is treated as a service‑group user (no PI match).</li>
<li><strong>Email routing works</strong>: research group users trigger mail to the PI <strong>and</strong> NGS.</li>
<li><strong>Email routing works</strong>: service group users (no PI match) trigger mail to the <strong>administrator</strong>.</li>
</ul>
<p>If all three happen, the LDAP→app→email flow is working as intended.</p>
</section>
</section>
<section id="possible-errors-and-fixes-vm-ldap-rollout" class="level2" data-number="3.12">
<h2 data-number="3.12" class="anchored" data-anchor-id="possible-errors-and-fixes-vm-ldap-rollout"><span class="header-section-number">3.12</span> Possible errors and fixes (VM LDAP rollout)</h2>
<p>This section captures the real errors I hit during the VM rollout and the fixes that worked. It is meant as a troubleshooting reference.</p>
<section id="apache-wont-restart-after-ldap-change" class="level3" data-number="3.12.1">
<h3 data-number="3.12.1" class="anchored" data-anchor-id="apache-wont-restart-after-ldap-change"><span class="header-section-number">3.12.1</span> 1) Apache won’t restart after LDAP change</h3>
<p><strong>Symptom</strong></p>
<pre><code>AH00526: Syntax error ... Bad LDAP URL while parsing.</code></pre>
<p><strong>Cause</strong></p>
<p>Apache’s <code>AuthLDAPURL</code> is very strict. Each URL must be complete (host + base DN + query), and some Apache builds don’t accept multiple URLs in a single directive.</p>
<p><strong>Fix</strong></p>
<p>Use a single server (most stable on my VM):</p>
<pre><code>AuthLDAPURL "ldaps://ldapserv1.biochem.mpg.de:636/dc=biochem,dc=mpg,dc=de?uid?sub?(objectClass=posixAccount)"</code></pre>
<p>If the multi‑server line fails, I keep one server and fall back manually if needed.</p>
</section>
<section id="ldaptls_cacertdir-breaks-apache" class="level3" data-number="3.12.2">
<h3 data-number="3.12.2" class="anchored" data-anchor-id="ldaptls_cacertdir-breaks-apache"><span class="header-section-number">3.12.2</span> 2) <code>LDAPTLS_CACERTDIR</code> breaks Apache</h3>
<p><strong>Symptom</strong></p>
<pre><code>Invalid command 'LDAPTLS_CACERTDIR'</code></pre>
<p><strong>Cause</strong></p>
<p><code>LDAPTLS_CACERTDIR</code> is <strong>not</strong> an Apache directive. It belongs to the OpenLDAP client config.</p>
<p><strong>Fix</strong></p>
<p>Remove it from Apache. If I need TLS trust, I configure it in <code>/etc/ldap/ldap.conf</code> instead.</p>
</section>
<section id="ldap-login-shows-500-internal-server-error" class="level3" data-number="3.12.3">
<h3 data-number="3.12.3" class="anchored" data-anchor-id="ldap-login-shows-500-internal-server-error"><span class="header-section-number">3.12.3</span> 3) LDAP login shows 500 Internal Server Error</h3>
<p><strong>Symptom</strong></p>
<ul>
<li>Browser shows <code>Internal Server Error</code></li>
<li>Apache log shows:</li>
</ul>
<pre><code>ldap_simple_bind() failed][Can't contact LDAP server]</code></pre>
<p><strong>Cause</strong></p>
<p>LDAP TLS handshake fails (certificate trust not configured).</p>
<p><strong>Fix</strong></p>
<ol type="1">
<li>Confirm port reachability:</li>
</ol>
<pre><code>nc -vz ldapserv1.biochem.mpg.de 636</code></pre>
<ol start="2" type="1">
<li>Test LDAP with <strong>TLS bypass</strong> to confirm trust problem:</li>
</ol>
<pre><code>LDAPTLS_REQCERT=never ldapsearch -x -H ldaps://ldapserv1.biochem.mpg.de:636 \
  -b "dc=biochem,dc=mpg,dc=de" "(uid=USER)" mail</code></pre>
<ol start="3" type="1">
<li>Fix trust in <code>/etc/ldap/ldap.conf</code>:</li>
</ol>
<pre><code>TLS_CACERTDIR /etc/ssl/certs</code></pre>
<p><strong>Important:</strong> I had a typo (<code>TLS_CACERETDIR</code>) which prevented TLS trust from loading. Fixing the spelling made LDAP work.</p>
<ol start="4" type="1">
<li>Verify normal LDAP now works:</li>
</ol>
<pre><code>ldapsearch -x -H ldaps://ldapserv1.biochem.mpg.de:636 \
  -b "dc=biochem,dc=mpg,dc=de" "(uid=USER)" mail</code></pre>
<p>Then restart Apache:</p>
<pre><code>sudo systemctl restart apache2</code></pre>
</section>
<section id="shiny-app-runs-locally-but-crashes-via-apache" class="level3" data-number="3.12.4">
<h3 data-number="3.12.4" class="anchored" data-anchor-id="shiny-app-runs-locally-but-crashes-via-apache"><span class="header-section-number">3.12.4</span> 4) Shiny app runs locally but crashes via Apache</h3>
<p><strong>Symptom</strong></p>
<ul>
<li>App works with <code>shiny::runApp()</code></li>
<li>But Apache shows 500 and Shiny worker terminates</li>
</ul>
<p><strong>Cause</strong></p>
<p>LDAP authentication failure in Apache (not an app crash).</p>
<p><strong>Fix</strong></p>
<p>Check Apache log for <code>authnz_ldap</code> errors and fix TLS trust as above.</p>
</section>
<section id="ldap-works-but-sequencing-app-returns-404" class="level3" data-number="3.12.5">
<h3 data-number="3.12.5" class="anchored" data-anchor-id="ldap-works-but-sequencing-app-returns-404"><span class="header-section-number">3.12.5</span> 5) LDAP works, but <code>/sequencing-app/</code> returns 404</h3>
<p><strong>Symptom</strong></p>
<ul>
<li><code>curl -Ik -u USER https://host/sequencing-app/</code> returns <strong>404</strong></li>
<li><code>curl -I http://localhost:3838/sequencing-app/</code> returns <strong>200</strong></li>
</ul>
<p><strong>Cause</strong></p>
<p>Apache is proxying the wrong path (often due to an older <code>ProxyPass /</code> rule or a backup file in <code>sites-enabled</code>).</p>
<p><strong>Fix</strong></p>
<ol type="1">
<li>Ensure <strong>only</strong> these lines exist in the active config:</li>
</ol>
<pre><code>ProxyPass /sequencing-app/ http://localhost:3838/sequencing-app/
ProxyPassReverse /sequencing-app/ http://localhost:3838/sequencing-app/</code></pre>
<ol start="2" type="1">
<li>Remove or move any backup config files out of <code>/etc/apache2/sites-enabled</code> (Apache can accidentally parse them).</li>
<li>Restart Apache:</li>
</ol>
<pre><code>sudo apache2ctl -t
sudo systemctl restart apache2</code></pre>
</section>
<section id="debug-logging-too-noisy-apache-or-shiny" class="level3" data-number="3.12.6">
<h3 data-number="3.12.6" class="anchored" data-anchor-id="debug-logging-too-noisy-apache-or-shiny"><span class="header-section-number">3.12.6</span> 6) Debug logging too noisy (Apache or Shiny)</h3>
<p><strong>Symptom</strong></p>
<p>Lots of LDAP debug output in logs during normal use.</p>
<p><strong>Fix (Apache)</strong></p>
<p>In <code>01-main.conf</code>, use normal logging:</p>
<pre><code>LogLevel warn
# LogLevel authnz_ldap:debug ldap:debug   # enable only when debugging</code></pre>
<p><strong>Fix (Shiny app)</strong></p>
<p>The app only prints LDAP debug logs when <strong>both</strong> are set:</p>
<ul>
<li><code>APP_ENV=dev</code></li>
<li><code>LDAP_DEBUG=1</code></li>
</ul>
<p>So for production:</p>
<ul>
<li>Remove <code>LDAP_DEBUG=1</code> from <code>/home/shiny/.Renviron</code> (or set it to <code>0</code>).</li>
<li>Restart Shiny:</li>
</ul>
<pre><code>sudo systemctl restart shiny-server</code></pre>
<p>If I need debugging later, I can temporarily set:</p>
<pre><code>APP_ENV=dev
LDAP_DEBUG=1</code></pre>
<p>and restart the service again.</p>
</section>
<section id="comprehensive-errorchecking-checklist-vm-ldap-shiny" class="level3" data-number="3.12.7">
<h3 data-number="3.12.7" class="anchored" data-anchor-id="comprehensive-errorchecking-checklist-vm-ldap-shiny"><span class="header-section-number">3.12.7</span> Comprehensive error‑checking checklist (VM LDAP + Shiny)</h3>
<p>When something breaks, I run through this list in order:</p>
<ol type="1">
<li><strong>Apache syntax</strong></li>
</ol>
<pre><code>sudo apache2ctl -t</code></pre>
<ol start="2" type="1">
<li><strong>Which vhost is active</strong></li>
</ol>
<pre><code>sudo apache2ctl -S</code></pre>
<ol start="3" type="1">
<li><strong>Proxy path</strong></li>
</ol>
<pre><code>sudo grep -n "ProxyPass" -R /etc/apache2/sites-enabled /etc/apache2/conf-enabled</code></pre>
<ol start="4" type="1">
<li><strong>LDAP connectivity + TLS</strong></li>
</ol>
<pre><code>nc -vz ldapserv1.biochem.mpg.de 636
ldapsearch -x -H ldaps://ldapserv1.biochem.mpg.de:636 \
  -b "dc=biochem,dc=mpg,dc=de" "(uid=USER)" mail</code></pre>
<p>If that fails, verify <code>/etc/ldap/ldap.conf</code> has:</p>
<pre><code>TLS_CACERTDIR /etc/ssl/certs</code></pre>
<ol start="5" type="1">
<li><strong>LDAP auth prompt vs app redirect</strong></li>
</ol>
<pre><code>curl -Ik https://HOST/
curl -Ik -u USER https://HOST/</code></pre>
<p>Expected: 401 without user, 302 to <code>/sequencing-app/?auth_user=USER</code> with user.</p>
<ol start="6" type="1">
<li><strong>Shiny backend is reachable</strong></li>
</ol>
<pre><code>curl -I http://localhost:3838/sequencing-app/</code></pre>
<ol start="7" type="1">
<li><strong>Apache app path</strong></li>
</ol>
<pre><code>curl -Ik -u USER https://HOST/sequencing-app/</code></pre>
<ol start="8" type="1">
<li><strong>Shiny logs</strong></li>
</ol>
<pre><code>sudo ls -t /var/log/shiny-server/ | head -n 1
sudo tail -n 200 /var/log/shiny-server/FILE.log</code></pre>
<ol start="9" type="1">
<li><strong>Shiny environment variables</strong></li>
</ol>
<pre><code>sudo systemctl show shiny-server --property=Environment</code></pre>
<ol start="10" type="1">
<li><strong>Database permissions</strong></li>
</ol>
<pre><code>ls -l /srv/shiny-server/sequencing-app/sequencing_projects.db</code></pre>
<ol start="11" type="1">
<li><strong>Reload after config change</strong></li>
</ol>
<pre><code>sudo systemctl restart apache2
sudo systemctl restart shiny-server</code></pre>
</section>
</section>
<section id="changes-on-06.02.2026" class="level2" data-number="3.13">
<h2 data-number="3.13" class="anchored" data-anchor-id="changes-on-06.02.2026"><span class="header-section-number">3.13</span> Changes on 06.02.2026</h2>
<ol type="1">
<li>Added LDAP login flow in the Shiny app (auto‑login via <code>X-Remote-User</code>, local dev simulation, and optional attribute lookup).</li>
<li>LDAP attribute lookup now works with anonymous bind; uses <code>ldapsearch</code> fallback for older <code>ldapr</code> versions.</li>
<li>Added dev tools toggle (dev only) to switch between LDAP and local auth while testing.</li>
<li>Mapped LDAP <code>ou</code> values to budget holders, auto‑selecting the correct PI in the project form (with partial match fallback).</li>
<li>Added budget holder notices for multiple cost centers and missing cost center values.</li>
<li>Added “Other / not listed” budget holder option so users can enter a new PI (name/surname required; cost center optional with a warning).</li>
<li>Updated <code>deploy.sh</code> to use <code>rsync</code> and exclude <code>sequencing_projects.db</code>.</li>
<li>Updated Apache LDAP configuration template and added local dev testing instructions + env var cleanup.</li>
<li>I do <strong>not</strong> track SQLite DB files in git because they change constantly, are environment‑specific (local vs VM), and can contain sensitive data. I ignore <code>*.db</code>/<code>*.sqlite</code> and keep only the schema/seed files in git.</li>
</ol>
</section>
<section id="changes-on-14.11.2026" class="level2" data-number="3.14">
<h2 data-number="3.14" class="anchored" data-anchor-id="changes-on-14.11.2026"><span class="header-section-number">3.14</span> Changes on 14.11.2026</h2>
<p>SQL‑related commands and explanations (admin email updates, service cost updates, registration/budget holder DB updates, and DB inspection) were moved to <strong><code>notes/sql-handling.qmd</code></strong>.</p>
</section>
<section id="ssl-certificate-for-https" class="level2" data-number="3.15">
<h2 data-number="3.15" class="anchored" data-anchor-id="ssl-certificate-for-https"><span class="header-section-number">3.15</span> SSL Certificate (for HTTPS)</h2>
<p>the new setting of the certificates. I have three files.</p>
<p>The private key I created when applying for the certificate. The other two were downloaded, when the emial came from Harica (the certificate provider).</p>
<p>the <code>PEM</code> is the pem file and the <code>DER (issuer)</code> is the chain file. Both of them are needed.</p>
<p>Setting for the readability of the files:</p>
<pre><code>cd /etc/apache2/certificate/2026
-rw------- 1 yeroslaviz b_mcf 3272 Nov 10 15:58 private-key.pem # udo chmod 600 /path/to/private.key  # Readable only by root
-rw-r--r-- 1 yeroslaviz b_mcf 1545 Nov 14 12:12 NGS_2026_Issuer_ChainFile.cer # sudo chmod 644 /path/to/chain.crt  # Readable by all
-rw-r--r-- 1 yeroslaviz b_mcf 2796 Nov 14 12:34 NGS_2026_Cert.pem # sudo chmod 644 /path/to/certificate.crt # Readable by all</code></pre>
<p>All the files are saved under <code>/etc/apache2/certificate/2026</code>.</p>
<p>Now I created soft links for each of these files.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> ln <span class="at">-s</span> /etc/apache2/certificate/2026/private-key.pem /etc/ssl/private/2026_private-key.pem</span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> ln <span class="at">-s</span> /etc/apache2/certificate/2026/NGS_2026_Cert.pem /etc/ssl/certs/2026_NGS_Cert.pem</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="ldap" class="level2" data-number="3.16">
<h2 data-number="3.16" class="anchored" data-anchor-id="ldap"><span class="header-section-number">3.16</span> LDAP</h2>
<p>The app uses Apache LDAP authentication in front of Shiny. The Apache config template is in <code>01-main.conf</code>.</p>
<p>Enable required Apache modules:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> a2enmod ldap authnz_ldap headers</span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> systemctl reload apache2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Test whether anonymous LDAP search works:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="ex">ldapsearch</span> <span class="at">-x</span> <span class="at">-H</span> ldaps://ldapserv1.biochem.mpg.de <span class="at">-b</span> <span class="st">"dc=biochem,dc=mpg,dc=de"</span> <span class="st">"(uid=YOURUSER)"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>If anonymous search fails, use bind credentials from IT and add them to the Apache config:</p>
<div class="sourceCode" id="cb72"><pre class="sourceCode apache code-with-copy"><code class="sourceCode apache"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a>AuthLDAPBindDN<span class="st"> "cn=binduser,dc=biochem,dc=mpg,dc=de"</span></span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a>AuthLDAPBindPassword<span class="st"> "REDACTED"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Warning
</div>
</div>
<div class="callout-body-container callout-body">
<p>For production, <strong>do not use a personal account</strong> for LDAP binding. Ask IT for a dedicated <strong>service bind account</strong> with read‑only permissions and store those credentials securely.</p>
</div>
</div>
<p>Set app environment variables for Shiny Server (systemd override recommended):</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> systemctl edit shiny-server</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="sourceCode" id="cb74"><pre class="sourceCode ini code-with-copy"><code class="sourceCode ini"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="kw">[Service]</span></span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a><span class="dt">Environment</span><span class="ot">=</span><span class="st">AUTH_MODE=ldap</span></span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a><span class="dt">Environment</span><span class="ot">=</span><span class="st">LDAP_URI=ldaps://ldapserv1.biochem.mpg.de:636,ldaps://ldapserv2.biochem.mpg.de:636,ldaps://ldapserv3.biochem.mpg.de:636</span></span>
<span id="cb74-4"><a href="#cb74-4" aria-hidden="true" tabindex="-1"></a><span class="dt">Environment</span><span class="ot">=</span><span class="st">LDAP_BASE_DN=dc=biochem,dc=mpg,dc=de</span></span>
<span id="cb74-5"><a href="#cb74-5" aria-hidden="true" tabindex="-1"></a><span class="co"># If you want to restrict search to the user OU:</span></span>
<span id="cb74-6"><a href="#cb74-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Environment=LDAP_BASE_DN=ou=People,dc=biochem,dc=mpg,dc=de</span></span>
<span id="cb74-7"><a href="#cb74-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Optional bind credentials (only if anonymous LDAP search is blocked):</span></span>
<span id="cb74-8"><a href="#cb74-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Environment=LDAP_BIND_DN=cn=binduser,dc=biochem,dc=mpg,dc=de</span></span>
<span id="cb74-9"><a href="#cb74-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Environment=LDAP_BIND_PW=REDACTED</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Restart services after config changes:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> systemctl restart apache2</span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> systemctl restart shiny-server</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="admin-access-in-ldap-mode-vm" class="level3" data-number="3.16.1">
<h3 data-number="3.16.1" class="anchored" data-anchor-id="admin-access-in-ldap-mode-vm"><span class="header-section-number">3.16.1</span> Admin access in LDAP mode (VM)</h3>
<p>Moved to <strong><code>notes/sql-handling.qmd</code></strong> (admin promotion and verification commands).</p>
</section>
<section id="switch-between-ldap-and-local-modes-vm" class="level3" data-number="3.16.2">
<h3 data-number="3.16.2" class="anchored" data-anchor-id="switch-between-ldap-and-local-modes-vm"><span class="header-section-number">3.16.2</span> Switch between LDAP and local modes (VM)</h3>
<p>I switch auth modes by changing the <code>AUTH_MODE</code> environment variable for the <code>shiny-server</code> service and restarting it.</p>
<p>Open the systemd override:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> systemctl edit shiny-server</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p><strong>LDAP mode (production):</strong></p>
<div class="sourceCode" id="cb77"><pre class="sourceCode ini code-with-copy"><code class="sourceCode ini"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a><span class="kw">[Service]</span></span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a><span class="dt">Environment</span><span class="ot">=</span><span class="st">AUTH_MODE=ldap</span></span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a><span class="dt">Environment</span><span class="ot">=</span><span class="st">LDAP_URI=ldaps://ldapserv1.biochem.mpg.de:636,ldaps://ldapserv2.biochem.mpg.de:636,ldaps://ldapserv3.biochem.mpg.de:636</span></span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a><span class="dt">Environment</span><span class="ot">=</span><span class="st">LDAP_BASE_DN=dc=biochem,dc=mpg,dc=de</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Local mode (maintenance/testing):</strong></p>
<div class="sourceCode" id="cb78"><pre class="sourceCode ini code-with-copy"><code class="sourceCode ini"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a><span class="kw">[Service]</span></span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a><span class="dt">Environment</span><span class="ot">=</span><span class="st">AUTH_MODE=local</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Apply changes:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> systemctl restart shiny-server</span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> systemctl show shiny-server <span class="at">--property</span><span class="op">=</span>Environment</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>If I switch back to LDAP, I also remove any dev‑only variables like <code>DEV_REMOTE_USER</code>.</p>
</section>
<section id="local-dev-testing-ldap-mode" class="level3" data-number="3.16.3">
<h3 data-number="3.16.3" class="anchored" data-anchor-id="local-dev-testing-ldap-mode"><span class="header-section-number">3.16.3</span> Local dev testing (LDAP mode)</h3>
<p>To test LDAP integration on your local machine without affecting production, run the app in dev mode and simulate the authenticated user. If LDAP attribute lookup is needed, provide a bind DN/password (personal credentials are OK for <strong>local testing only</strong>).</p>
<div class="sourceCode" id="cb80"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a><span class="fu">Sys.setenv</span>(</span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">APP_ENV =</span> <span class="st">"dev"</span>,</span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">AUTH_MODE =</span> <span class="st">"ldap"</span>,</span>
<span id="cb80-4"><a href="#cb80-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">DEV_REMOTE_USER =</span> <span class="st">"your_username"</span>,</span>
<span id="cb80-5"><a href="#cb80-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">LDAP_BIND_DN =</span> <span class="st">"uid=your_username,ou=YourGroup,ou=Research Group,ou=People,dc=biochem,dc=mpg,dc=de"</span>,</span>
<span id="cb80-6"><a href="#cb80-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">LDAP_BIND_PW =</span> <span class="st">"YOUR_PASSWORD"</span></span>
<span id="cb80-7"><a href="#cb80-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb80-8"><a href="#cb80-8" aria-hidden="true" tabindex="-1"></a>shiny<span class="sc">::</span><span class="fu">runApp</span>(<span class="st">"sequencing-app"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>To switch back to normal local login (no LDAP), run:</p>
<div class="sourceCode" id="cb81"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a><span class="fu">Sys.setenv</span>(<span class="at">APP_ENV =</span> <span class="st">"dev"</span>, <span class="at">AUTH_MODE =</span> <span class="st">"local"</span>)</span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a>shiny<span class="sc">::</span><span class="fu">runApp</span>(<span class="st">"sequencing-app"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>To fully clear the LDAP/testing variables in your R session:</p>
<div class="sourceCode" id="cb82"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a><span class="fu">Sys.unsetenv</span>(<span class="fu">c</span>(</span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">"APP_ENV"</span>, <span class="st">"AUTH_MODE"</span>, <span class="st">"DEV_REMOTE_USER"</span>,</span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">"LDAP_BIND_DN"</span>, <span class="st">"LDAP_BIND_PW"</span>,</span>
<span id="cb82-4"><a href="#cb82-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">"LDAP_URI"</span>, <span class="st">"LDAP_BASE_DN"</span>, <span class="st">"LDAP_DEBUG"</span></span>
<span id="cb82-5"><a href="#cb82-5" aria-hidden="true" tabindex="-1"></a>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="how-i-run-the-app-locally-my-notes" class="level3" data-number="3.16.4">
<h3 data-number="3.16.4" class="anchored" data-anchor-id="how-i-run-the-app-locally-my-notes"><span class="header-section-number">3.16.4</span> How I run the app locally (my notes)</h3>
<p>When I want the <strong>normal local login</strong>, I run:</p>
<div class="sourceCode" id="cb83"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a><span class="fu">Sys.setenv</span>(<span class="at">APP_ENV =</span> <span class="st">"dev"</span>, <span class="at">AUTH_MODE =</span> <span class="st">"local"</span>)</span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a>shiny<span class="sc">::</span><span class="fu">runApp</span>(<span class="st">"sequencing-app"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>When I want to <strong>simulate production LDAP login</strong>, I run:</p>
<div class="sourceCode" id="cb84"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a><span class="fu">Sys.setenv</span>(</span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">APP_ENV =</span> <span class="st">"dev"</span>,</span>
<span id="cb84-3"><a href="#cb84-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">AUTH_MODE =</span> <span class="st">"ldap"</span>,</span>
<span id="cb84-4"><a href="#cb84-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">DEV_REMOTE_USER =</span> <span class="st">"my_username"</span>,</span>
<span id="cb84-5"><a href="#cb84-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">LDAP_URI =</span> <span class="st">"ldaps://ldapserv1.biochem.mpg.de:636,ldaps://ldapserv2.biochem.mpg.de:636,ldaps://ldapserv3.biochem.mpg.de:636"</span>,</span>
<span id="cb84-6"><a href="#cb84-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">LDAP_BASE_DN =</span> <span class="st">"dc=biochem,dc=mpg,dc=de"</span></span>
<span id="cb84-7"><a href="#cb84-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb84-8"><a href="#cb84-8" aria-hidden="true" tabindex="-1"></a>shiny<span class="sc">::</span><span class="fu">runApp</span>(<span class="st">"sequencing-app"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>If I want to fully reset the session, I clear the env vars:</p>
<div class="sourceCode" id="cb85"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a><span class="fu">Sys.unsetenv</span>(<span class="fu">c</span>(</span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">"APP_ENV"</span>, <span class="st">"AUTH_MODE"</span>, <span class="st">"DEV_REMOTE_USER"</span>,</span>
<span id="cb85-3"><a href="#cb85-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">"LDAP_BIND_DN"</span>, <span class="st">"LDAP_BIND_PW"</span>,</span>
<span id="cb85-4"><a href="#cb85-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">"LDAP_URI"</span>, <span class="st">"LDAP_BASE_DN"</span>, <span class="st">"LDAP_DEBUG"</span></span>
<span id="cb85-5"><a href="#cb85-5" aria-hidden="true" tabindex="-1"></a>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Local vs LDAP mode (practical difference for me):</strong></p>
<ul>
<li>Local mode uses the SQLite users/passwords and shows the normal login screen.</li>
<li>LDAP mode auto‑logs in with the LDAP user, pulls email/phone/OU, and hides the local login UI.</li>
<li>LDAP mode needs network access to the institute LDAP servers.</li>
</ul>
<p><strong>Dev badge:</strong> In dev mode, I see a small badge in the app header that shows <code>DEV · LDAP</code> or <code>DEV · LOCAL</code>, so I always know which mode I’m running.</p>
</section>
<section id="budget-holder-auto-assignment-first-login" class="level3" data-number="3.16.5">
<h3 data-number="3.16.5" class="anchored" data-anchor-id="budget-holder-auto-assignment-first-login"><span class="header-section-number">3.16.5</span> Budget holder auto-assignment (first login)</h3>
<p>On first LDAP login, the app attempts to map the user to a budget holder based on the LDAP <code>ou</code> value.<br>
If the <code>ou</code> contains a group key in parentheses (e.g., <code>(... Cox)</code>), the app matches that key against <code>budget_holders</code> and stores the <strong>full PI name</strong> (e.g., <code>Cox Juergen</code>) in <code>users.research_group</code>.</p>
<p>When a new project is created, this <code>research_group</code> value is used to auto‑select the budget holder (and thus the cost center).<br>
If multiple cost centers exist for the same PI, the first match is selected by default and can be adjusted during project creation.</p>
</section>
</section>
<section id="obsolete-now-wrong-kept-for-reference" class="level2" data-number="3.17">
<h2 data-number="3.17" class="anchored" data-anchor-id="obsolete-now-wrong-kept-for-reference"><span class="header-section-number">3.17</span> Obsolete / now wrong (kept for reference)</h2>
<p>These sections are retained to understand the history but should not be followed anymore.</p>
<section id="legacy-environment-variable-location-no-longer-used" class="level3" data-number="3.17.1">
<h3 data-number="3.17.1" class="anchored" data-anchor-id="legacy-environment-variable-location-no-longer-used"><span class="header-section-number">3.17.1</span> Legacy environment variable location (no longer used)</h3>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a><span class="co"># /var/shiny-server/.Renviron</span></span>
<span id="cb86-3"><a href="#cb86-3" aria-hidden="true" tabindex="-1"></a><span class="va">TZ</span><span class="op">=</span>Europe/Berlin</span>
<span id="cb86-4"><a href="#cb86-4" aria-hidden="true" tabindex="-1"></a><span class="va">LANG</span><span class="op">=</span>en_US.UTF-8</span>
<span id="cb86-5"><a href="#cb86-5" aria-hidden="true" tabindex="-1"></a><span class="va">LC_ALL</span><span class="op">=</span>en_US.UTF-8</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="legacy-folder-layout-varshiny-server" class="level3" data-number="3.17.2">
<h3 data-number="3.17.2" class="anchored" data-anchor-id="legacy-folder-layout-varshiny-server"><span class="header-section-number">3.17.2</span> Legacy folder layout (/var/shiny-server)</h3>
<pre><code>/var/shiny-server/
├── sequencing-app/
│ ├── app.R
│ ├── setup_database.R
│ ├── sequencing_projects.db
│ └── www/
  │ ├── logo.png
  │ └── minerva.png</code></pre>
</section>
<section id="legacy-install-steps-nginx-based-superseded-by-apache-setup" class="level3" data-number="3.17.3">
<h3 data-number="3.17.3" class="anchored" data-anchor-id="legacy-install-steps-nginx-based-superseded-by-apache-setup"><span class="header-section-number">3.17.3</span> Legacy install steps (nginx-based, superseded by Apache setup)</h3>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb88"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Install Shiny Server on Ubuntu</span></span>
<span id="cb88-3"><a href="#cb88-3" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> apt update</span>
<span id="cb88-4"><a href="#cb88-4" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> apt install <span class="at">-y</span> r-base nginx</span>
<span id="cb88-5"><a href="#cb88-5" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> apt install <span class="at">-y</span> libfontconfig1-dev libfreetype6-dev libpng-dev libtiff5-dev <span class="dt">\</span></span>
<span id="cb88-6"><a href="#cb88-6" aria-hidden="true" tabindex="-1"></a>    libjpeg-dev build-essential pkg-config libharfbuzz-dev libfribidi-dev</span>
<span id="cb88-7"><a href="#cb88-7" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> apt install <span class="at">-y</span> libldap2-dev libsasl2-dev</span>
<span id="cb88-8"><a href="#cb88-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-9"><a href="#cb88-9" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> su <span class="at">-</span> <span class="at">-c</span> <span class="st">"R -e </span><span class="dt">\"</span><span class="st">install.packages('shiny')</span><span class="dt">\"</span><span class="st">"</span></span>
<span id="cb88-10"><a href="#cb88-10" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> su <span class="at">-</span> <span class="at">-c</span> <span class="st">"R -e </span><span class="dt">\"</span><span class="st">install.packages('shinyjs')</span><span class="dt">\"</span><span class="st">"</span></span>
<span id="cb88-11"><a href="#cb88-11" aria-hidden="true" tabindex="-1"></a><span class="co"># ... install all your R packages</span></span>
<span id="cb88-12"><a href="#cb88-12" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> R <span class="at">-e</span> <span class="st">"install.packages(c('shiny', 'shinyjs', 'DBI', 'RSQLite', 'digest', 'DT', 'shinyWidgets', 'mailR'))"</span></span>
<span id="cb88-13"><a href="#cb88-13" aria-hidden="true" tabindex="-1"></a><span class="co"># these two packages were added later on for the connection of the app to the LDAP server</span></span>
<span id="cb88-14"><a href="#cb88-14" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> R <span class="at">-e</span> <span class="st">"install.packages(c('devtools'))"</span></span>
<span id="cb88-15"><a href="#cb88-15" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> R <span class="at">-e</span> <span class="st">"devtools::install_github('liamgilbey/ldapr')"</span></span>
<span id="cb88-16"><a href="#cb88-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-17"><a href="#cb88-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Download and install Shiny Server</span></span>
<span id="cb88-18"><a href="#cb88-18" aria-hidden="true" tabindex="-1"></a><span class="fu">wget</span> https://download3.rstudio.org/ubuntu-20.04/x86_64/shiny-server-1.5.23.1030-amd64.deb</span>
<span id="cb88-19"><a href="#cb88-19" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> gdebi shiny-server-1.5.23.1030-amd64.deb</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="legacy-apache-config-old-proxypass-path" class="level3" data-number="3.17.4">
<h3 data-number="3.17.4" class="anchored" data-anchor-id="legacy-apache-config-old-proxypass-path"><span class="header-section-number">3.17.4</span> Legacy Apache config (old ProxyPass / path)</h3>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb89"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;</span>VirtualHost <span class="ex">*:80</span><span class="op">&gt;</span></span>
<span id="cb89-2"><a href="#cb89-2" aria-hidden="true" tabindex="-1"></a>    <span class="ex">ServerName</span> ngs-testing-vm</span>
<span id="cb89-3"><a href="#cb89-3" aria-hidden="true" tabindex="-1"></a>    <span class="ex">ServerAlias</span> ngs-testing-vm.biochem.mpg.de</span>
<span id="cb89-4"><a href="#cb89-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Redirect all HTTP traffic to HTTPS</span></span>
<span id="cb89-5"><a href="#cb89-5" aria-hidden="true" tabindex="-1"></a>    <span class="ex">Redirect</span> permanent / https://ngs-testing-vm/</span>
<span id="cb89-6"><a href="#cb89-6" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;</span>/VirtualHost<span class="op">&gt;</span></span>
<span id="cb89-7"><a href="#cb89-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-8"><a href="#cb89-8" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;</span>VirtualHost <span class="ex">*:443</span><span class="op">&gt;</span></span>
<span id="cb89-9"><a href="#cb89-9" aria-hidden="true" tabindex="-1"></a>    <span class="ex">ServerName</span> ngs-testing-vm</span>
<span id="cb89-10"><a href="#cb89-10" aria-hidden="true" tabindex="-1"></a>    <span class="ex">ServerAlias</span> ngs-testing-vm.biochem.mpg.de</span>
<span id="cb89-11"><a href="#cb89-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-12"><a href="#cb89-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># SSL Configuration</span></span>
<span id="cb89-13"><a href="#cb89-13" aria-hidden="true" tabindex="-1"></a>    <span class="ex">SSLEngine</span> on</span>
<span id="cb89-14"><a href="#cb89-14" aria-hidden="true" tabindex="-1"></a>    <span class="ex">SSLCertificateFile</span> /etc/ssl/certs/2026_NGS_Cert.pem</span>
<span id="cb89-15"><a href="#cb89-15" aria-hidden="true" tabindex="-1"></a>    <span class="ex">SSLCertificateKeyFile</span> /etc/ssl/private/2026_private-key.pem</span>
<span id="cb89-16"><a href="#cb89-16" aria-hidden="true" tabindex="-1"></a>    <span class="ex">SSLCertificateChainFile</span> /etc/apache2/certificate/2026/NGS_2026_Issuer_ChainFile.cer</span>
<span id="cb89-17"><a href="#cb89-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-18"><a href="#cb89-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Modern SSL configuration</span></span>
<span id="cb89-19"><a href="#cb89-19" aria-hidden="true" tabindex="-1"></a>    <span class="ex">SSLProtocol</span> all <span class="at">-SSLv3</span> <span class="at">-TLSv1</span> <span class="at">-TLSv1.1</span></span>
<span id="cb89-20"><a href="#cb89-20" aria-hidden="true" tabindex="-1"></a>    <span class="ex">SSLCipherSuite</span> ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384</span>
<span id="cb89-21"><a href="#cb89-21" aria-hidden="true" tabindex="-1"></a>    <span class="ex">SSLHonorCipherOrder</span> off</span>
<span id="cb89-22"><a href="#cb89-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-23"><a href="#cb89-23" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Reverse proxy for Shiny app</span></span>
<span id="cb89-24"><a href="#cb89-24" aria-hidden="true" tabindex="-1"></a>    <span class="ex">ProxyPreserveHost</span> On</span>
<span id="cb89-25"><a href="#cb89-25" aria-hidden="true" tabindex="-1"></a>    <span class="ex">ProxyRequests</span> Off</span>
<span id="cb89-26"><a href="#cb89-26" aria-hidden="true" tabindex="-1"></a>    <span class="ex">ProxyPass</span> / http://localhost:3838/sequencing-app/</span>
<span id="cb89-27"><a href="#cb89-27" aria-hidden="true" tabindex="-1"></a>    <span class="ex">ProxyPassReverse</span> / http://localhost:3838/sequencing-app/</span>
<span id="cb89-28"><a href="#cb89-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-29"><a href="#cb89-29" aria-hidden="true" tabindex="-1"></a>    <span class="co"># WebSocket support</span></span>
<span id="cb89-30"><a href="#cb89-30" aria-hidden="true" tabindex="-1"></a>    <span class="ex">RewriteEngine</span> on</span>
<span id="cb89-31"><a href="#cb89-31" aria-hidden="true" tabindex="-1"></a>    <span class="ex">RewriteCond</span> %{HTTP:Upgrade} websocket <span class="pp">[</span><span class="ss">NC</span><span class="pp">]</span></span>
<span id="cb89-32"><a href="#cb89-32" aria-hidden="true" tabindex="-1"></a>    <span class="ex">RewriteCond</span> %{HTTP:Connection} upgrade <span class="pp">[</span><span class="ss">NC</span><span class="pp">]</span></span>
<span id="cb89-33"><a href="#cb89-33" aria-hidden="true" tabindex="-1"></a>    <span class="ex">RewriteRule</span> ^/<span class="er">(</span><span class="bu">.</span><span class="pp">*</span><span class="kw">)</span> <span class="st">"ws://localhost:3838/sequencing-app/</span><span class="va">$1</span><span class="st">"</span> <span class="pp">[</span><span class="ss">P,L</span><span class="pp">]</span></span>
<span id="cb89-34"><a href="#cb89-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-35"><a href="#cb89-35" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Security headers</span></span>
<span id="cb89-36"><a href="#cb89-36" aria-hidden="true" tabindex="-1"></a>    <span class="ex">Header</span> always set Strict-Transport-Security <span class="st">"max-age=63072000; includeSubDomains"</span></span>
<span id="cb89-37"><a href="#cb89-37" aria-hidden="true" tabindex="-1"></a>    <span class="ex">Header</span> always set X-Content-Type-Options nosniff</span>
<span id="cb89-38"><a href="#cb89-38" aria-hidden="true" tabindex="-1"></a>    <span class="ex">Header</span> always set X-Frame-Options SAMEORIGIN</span>
<span id="cb89-39"><a href="#cb89-39" aria-hidden="true" tabindex="-1"></a>    <span class="ex">Header</span> always set Referrer-Policy <span class="st">"strict-origin-when-cross-origin"</span></span>
<span id="cb89-40"><a href="#cb89-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-41"><a href="#cb89-41" aria-hidden="true" tabindex="-1"></a>    <span class="ex">ErrorLog</span> <span class="va">${APACHE_LOG_DIR}</span>/sequencing-app-ssl-error.log</span>
<span id="cb89-42"><a href="#cb89-42" aria-hidden="true" tabindex="-1"></a>    <span class="ex">CustomLog</span> <span class="va">${APACHE_LOG_DIR}</span>/sequencing-app-ssl-access.log combined</span>
<span id="cb89-43"><a href="#cb89-43" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;</span>/VirtualHost<span class="op">&gt;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="legacy-deployment-script-name" class="level3" data-number="3.17.5">
<h3 data-number="3.17.5" class="anchored" data-anchor-id="legacy-deployment-script-name"><span class="header-section-number">3.17.5</span> Legacy deployment script name</h3>
<p>The old notes referenced <code>deploy_shiny_server.sh</code>. This has been replaced by <code>deploy.sh</code> in the repo root.</p>
</section>
<section id="legacy-tree-output-old-vm-layout-example" class="level3" data-number="3.17.6">
<h3 data-number="3.17.6" class="anchored" data-anchor-id="legacy-tree-output-old-vm-layout-example"><span class="header-section-number">3.17.6</span> Legacy tree output (old VM layout example)</h3>
<pre><code>$ tree -L 1
.
├── BCFNGS-project-management
├── chemata
├── miniconda3
└── scripts
    └── deploy_shiny_server.sh</code></pre>
</section>
<section id="legacy-git-pull-via-https-pat-no-longer-used" class="level3" data-number="3.17.7">
<h3 data-number="3.17.7" class="anchored" data-anchor-id="legacy-git-pull-via-https-pat-no-longer-used"><span class="header-section-number">3.17.7</span> Legacy git pull via HTTPS + PAT (no longer used)</h3>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb91"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a> <span class="fu">git</span> pull origin main</span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Username for 'https://github.com': yeroslaviz</span></span>
<span id="cb91-3"><a href="#cb91-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Password for 'https://yeroslaviz@github.com':  HERE WE MUST INPUT THE PAT from above!!!</span></span>
<span id="cb91-4"><a href="#cb91-4" aria-hidden="true" tabindex="-1"></a> <span class="ex">...</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="legacy-note-dedicated-user-superseded" class="level3" data-number="3.17.8">
<h3 data-number="3.17.8" class="anchored" data-anchor-id="legacy-note-dedicated-user-superseded"><span class="header-section-number">3.17.8</span> Legacy note: dedicated user (superseded)</h3>
<p>As we’re planning to use the LDAP, I’m not sure, this is necessary. I need a method to add specific users as admin.</p>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        for (let i = 0; i < 2; i++) {
          container.appendChild(note.children[i].cloneNode(true));
        }
        return container.innerHTML
      } else {
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      return note.innerHTML;
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        console.log("RESIZE");
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="../chapters/quick-start.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Quick Start (How to run the app)</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../chapters/ldap-setup-summary-2026-02-06.html" class="pagination-link">
        <span class="nav-page-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">LDAP Setup Summary (2026-02-06)</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->




</body></html>