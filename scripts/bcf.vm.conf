<VirtualHost *:80>
    ServerName bcf-vm
    ServerAlias bcf-vm.biochem.mpg.de
    Redirect permanent / https://bcf-vm/
</VirtualHost>

<VirtualHost *:443>
    ServerName bcf-vm
    ServerAlias bcf-vm.biochem.mpg.de

    SSLEngine on
    SSLCertificateFile /etc/ssl/localcerts/bcf-vm.crt
    SSLCertificateKeyFile /etc/ssl/localcerts/bcf-vm.key

    RewriteEngine On
    RewriteRule ^/$ /sequencing-app/ [R=302,L]

    ProxyPreserveHost On
    ProxyRequests Off
    ProxyPass /sequencing-app/ http://127.0.0.1:3838/sequencing-app/
    ProxyPassReverse /sequencing-app/ http://127.0.0.1:3838/sequencing-app/

    <Location /sequencing-app/>
        AuthType Basic
        AuthName "LDAP Authentication"
        AuthBasicProvider ldap
        AuthLDAPURL "ldaps://ldapserv1.biochem.mpg.de:636/dc=biochem,dc=mpg,dc=de?uid?sub?(objectClass=posixAccount)"
        Require valid-user

        RequestHeader unset X-Remote-User
        RequestHeader unset X-Forwarded-User
        RequestHeader edit Cookie "(^|;\\s*)auth_user=[^;]*" ""
        RequestHeader set X-Remote-User "%{REMOTE_USER}e"
        RequestHeader set X-Forwarded-User "%{REMOTE_USER}e"

        RewriteEngine On
        SetEnvIfExpr "%{QUERY_STRING} =~ /(?:^|&)auth_user=([^&]*)/" QS_AUTH_USER=$1
        RewriteCond %{REMOTE_USER} (.+)
        RewriteRule ^ - [E=AUTH_CANONICAL_USER:%1]
        RewriteCond %{IS_SUBREQ} =false
        RewriteCond %{REQUEST_URI} ^/sequencing-app/?$
        RewriteCond %{ENV:AUTH_CANONICAL_USER} !^$
        RewriteCond expr "%{ENV:QS_AUTH_USER} != %{ENV:AUTH_CANONICAL_USER}"
        RewriteRule ^ /sequencing-app/?auth_user=%{ENV:AUTH_CANONICAL_USER} [R=302,L,NE,QSD]
    </Location>

    RewriteCond %{HTTP:Upgrade} websocket [NC]
    RewriteCond %{HTTP:Connection} upgrade [NC]
    RewriteRule ^/sequencing-app/(.*) "ws://127.0.0.1:3838/sequencing-app/$1" [P,L]

    Header always set X-Content-Type-Options nosniff
    Header always set X-Frame-Options SAMEORIGIN
    Header always set Referrer-Policy "strict-origin-when-cross-origin"

    LogLevel warn
    ErrorLog ${APACHE_LOG_DIR}/bcf-vm-ssl-error.log
    CustomLog ${APACHE_LOG_DIR}/bcf-vm-ssl-access.log combined
</VirtualHost>

